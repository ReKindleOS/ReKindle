<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #e5e5e5;
            /* Background managed by settings */

            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
            box-sizing: border-box;
        }

        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
        }

        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }



        /* CONTROLS (Right side of Title Bar) */
        .title-controls {
            position: absolute;
            right: 10px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
            flex-shrink: 0;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* Icon State Toggles */
        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        /* ADD BTN */
        .add-btn {
            z-index: 2;
            background: white;
            border: 2px solid black;
            font-weight: bold;
            padding: 2px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            box-shadow: 2px 2px 0 black;
            display: none;
            /* Only show in Native Mode */
        }

        .add-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(1px, 1px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid black;
            background: #eee;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            border-right: 1px solid black;
            background: #eee;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .tab-btn:last-child {
            border-right: none;
        }

        .tab-btn.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
            z-index: 10;
        }

        #content-area {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            background: white;
            display: flex;
            flex-direction: column;
        }

        /* --- VIEW STYLES --- */

        /* AGENDA */
        .agenda-container {
            padding: 20px;
        }

        .day-group {
            margin-bottom: 25px;
        }

        .day-header {
            font-size: 1.1rem;
            font-weight: 900;
            border-bottom: 4px double black;
            padding-bottom: 5px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .event {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #ccc;
            font-size: 1rem;
            align-items: baseline;
            position: relative;
        }

        .event:last-child {
            border-bottom: none;
        }

        .event-time {
            font-weight: bold;
            width: 140px;
            /* Widened for ranges */
            flex-shrink: 0;
            font-size: 0.9rem;
            margin-right: 15px;
            /* Bigger gap */
        }

        .event-title {
            flex-grow: 1;
            font-weight: normal;
        }

        .del-event-btn {
            color: #999;
            cursor: pointer;
            padding: 0 10px;
            font-weight: bold;
        }

        .del-event-btn:hover {
            color: red;
        }

        /* NAV HEADER (For Month/Day) */
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #eee;
            border-bottom: 2px solid black;
            flex-shrink: 0;
        }

        .nav-title {
            font-weight: bold;
            font-size: 1rem;
            text-transform: uppercase;
        }

        .nav-arrow {
            background: white;
            border: 2px solid black;
            padding: 4px 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 2px 2px 0 black;
        }

        .nav-arrow:active {
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* MONTH GRID */
        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            flex-grow: 1;
            border-bottom: 2px solid black;
            /* Fix bottom border visual */
        }

        .weekday-label {
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            padding: 5px 0;
            border-bottom: 2px solid black;
            background: #f0f0f0;
        }

        .calendar-day {
            border-right: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            min-height: 60px;
            position: relative;
            padding: 4px;
            cursor: pointer;
            background: white;
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        /* Remove right border on last col */
        .calendar-day:active {
            background: #000;
            color: white;
        }

        .calendar-day.empty {
            background: #f9f9f9;
            cursor: default;
        }

        .calendar-day.today {
            background: #ddd;
        }

        .day-number {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .day-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 4px;
        }

        .event-dot {
            width: 6px;
            height: 6px;
            background: black;
            border-radius: 50%;
        }

        .calendar-day:active .event-dot {
            background: white;
        }

        .month-event {
            font-size: 0.7rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: transparent;
            margin-top: 1px;
            line-height: 1.1;
        }

        /* DAY VIEW */
        .day-schedule {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .hour-slot {
            display: flex;
            border-bottom: 1px dotted #ccc;
            min-height: 40px;
        }

        .slot-time {
            width: 60px;
            border-right: 2px solid #ccc;
            padding: 10px 5px;
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            margin-right: 10px;
        }

        .slot-events {
            flex-grow: 1;
            padding: 5px;
        }

        .day-event-chip {
            background: black;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 2px;
            font-size: 0.9rem;
        }

        #status-bar {
            background: #eee;
            border-top: 2px solid black;
            padding: 5px;
            font-size: 0.8rem;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            padding: 5px 15px;
        }

        #auth-overlay {
            position: absolute;
            top: 35px;
            left: 0;
            width: 100%;
            height: calc(100% - 35px);
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 4px 10px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
        }

        .sys-btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* MODAL */
        #modal-overlay,
        #sync-choice-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-box input {
            width: 90%;
            padding: 8px;
            margin: 5px 0;
            border: 2px solid black;
            font-family: inherit;
        }

        .modal-btns {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        /* STANDARD MODAL SYSTEM */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            font-family: "Geneva", "Verdana", sans-serif;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            padding: 20px;
            box-shadow: 6px 6px 0 black;
            max-width: 300px;
            width: 80%;
            text-align: center;
        }

        .modal-text {
            margin-bottom: 20px;
            font-weight: bold;
            line-height: 1.4;
            color: black;
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            background: white;
            border: 2px solid black;
            padding: 6px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-family: inherit;
        }

        .modal-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }
    </style>
    <script src="time.js"></script>
    <script src="theme.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text" id="app-title">Calendar</span>
            <div class="title-controls">
                <button class="add-btn" id="add-btn" onclick="openAddModal()">+ Add</button>
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1" />
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-btn active" onclick="switchView('agenda')">Agenda</div>
            <div class="tab-btn" onclick="switchView('day')">Day</div>
            <div class="tab-btn" onclick="switchView('month')">Month</div>
        </div>

        <div id="content-area"></div>

        <div id="status-bar">
            <span id="status-msg">Ready.</span>
            <button class="sys-btn" onclick="refreshData()">Sync</button>
        </div>

        <!-- AUTH OVERLAY -->
        <div id="auth-overlay">
            <h2 style="margin-bottom:10px;">Google Calendar</h2>
            <p style="margin-bottom:20px; font-size:0.9rem;">Log in to sync.</p>
            <button class="sys-btn" onclick="oauthSignIn()">Log In</button>
        </div>
    </div>

    <!-- ADD MODAL -->
    <div id="modal-overlay">
        <div class="modal-box">
            <h3>New Event</h3>
            <div class="modal-btns">
                <!-- Using grid/flex for inputs -->
            </div>
            <input type="text" id="evt-title" placeholder="Title">
            <input type="date" id="evt-date" placeholder="Date">
            <div style="display:flex; gap:10px;">
                <input type="time" id="evt-time" placeholder="Start" title="Start Time">
                <input type="time" id="evt-end-time" placeholder="End" title="End Time">
            </div>
            <div class="modal-btns">
                <button class="sys-btn" onclick="saveNativeEvent()">Save</button>
                <button class="sys-btn"
                    onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <!-- SYNC CHOICE MODAL -->
    <div id="sync-choice-modal">
        <div class="modal-box">
            <h3>Google Calendar Integration</h3>
            <p style="margin:15px 0;">Enable Google Calendar sync or continue with Local Storage?</p>
            <div class="modal-btns">
                <button class="sys-btn" onclick="setSyncPreference(true)">Use Google</button>
                <button class="sys-btn" onclick="setSyncPreference(false)">Use Local</button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        // --- CONFIG ---
        function showModal(msg, isConfirm = false, callback = null) {
            const overlay = document.getElementById('modal-overlay');
            const messageEl = document.getElementById('modal-message');
            const btnsEl = document.getElementById('modal-btns');
            messageEl.textContent = msg;
            if (isConfirm) {
                btnsEl.innerHTML = '<button class="modal-btn" id="modal-cancel">Cancel</button><button class="modal-btn" id="modal-ok">OK</button>';
                document.getElementById('modal-cancel').onclick = () => { overlay.style.display = 'none'; if (callback) callback(false); };
                document.getElementById('modal-ok').onclick = () => { overlay.style.display = 'none'; if (callback) callback(true); };
            } else {
                btnsEl.innerHTML = '<button class="modal-btn" onclick="hideModal()">OK</button>';
                if (callback) document.querySelector('.modal-btn').onclick = () => { hideModal(); callback(); };
            }
            overlay.style.display = 'flex';
        }
        function hideModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        // --- GOOGLE CONFIG ---
        const CLIENT_ID = '1000949048966-kkjtgmrsdonk3bm89rvlo0punc519vgj.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

        let googleEnabled = false;
        let calDavUrl = localStorage.getItem('rekindle_caldav_url');

        // --- TIMEZONE HANDLING ---
        // --- TIMEZONE HANDLING ---
        // --- TIMEZONE HANDLING ---
        // Delegated to time.js

        function getZonedDate(date) {
            return window.rekindleGetZonedDate(date);
        }

        function formatZonedTime(date) {
            return window.rekindleFormatTime(date, {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function formatZonedDate(date, options) {
            return window.rekindleFormatTime(date, options);
        }

        function getUTCFromWallClock(dateStr, timeStr) {
            // dateStr is YYYY-MM-DD, timeStr is HH:mm

            // 1. Construct wall clock date
            const [y, m, d] = dateStr.split('-').map(Number);
            const [h, min] = (timeStr || '00:00').split(':').map(Number);
            const wallDate = new Date(y, m - 1, d, h, min, 0);

            // 2. Get offset of current time in target zone relative to local system
            const now = new Date();
            const zonedNow = window.rekindleGetZonedDate(now);
            const offsetMs = zonedNow.getTime() - now.getTime();

            // 3. Apply reverse offset
            return new Date(wallDate.getTime() - offsetMs).toISOString();
        }

        // --- STATE ---
        let events = []; // Unified structure: { id, title, start: Date }
        let currentView = 'agenda';
        let viewDate = getZonedDate(); // Tracks currently viewed month/day

        // --- INIT ---
        window.onload = function () {
            loadWallpaper();

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();

            // Enable Offline Persistence
            /*
            db.enablePersistence({ synchronizeTabs: true }).catch(err => {
                if (err.code == 'failed-precondition') {
                    console.warn("Persistence failed: Multiple tabs open");
                } else if (err.code == 'unimplemented') {
                    console.warn("Persistence failed: Browser not supported");
                }
            });
            */

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    checkSyncSettings();
                } else {
                    document.getElementById('status-msg').innerText = "Guest Mode";
                    initNativeMode();
                }
            });
        };


        function checkSyncSettings() {
            const setting = localStorage.getItem('rekindle_google_calendar_enabled');

            if (setting === 'true') {
                googleEnabled = true;
                initGoogleMode();
            } else if (setting === 'false') {
                googleEnabled = false;
                document.getElementById('status-msg').innerText = "Synced: " + currentUser.email;
                initNativeMode();
            } else {
                // Not set
                document.getElementById('sync-choice-modal').style.display = 'flex';
            }
        }

        function setSyncPreference(enableGoogle) {
            document.getElementById('sync-choice-modal').style.display = 'none';
            localStorage.setItem('rekindle_google_calendar_enabled', enableGoogle);

            // Save preference to cloud
            db.collection('users').doc(currentUser.uid).collection('settings').doc('integrations').set({
                google_calendar: enableGoogle
            }, { merge: true });

            if (enableGoogle) {
                googleEnabled = true;
                initGoogleMode();
            } else {
                googleEnabled = false;
                document.getElementById('status-msg').innerText = "Synced: " + currentUser.email;
                initNativeMode();
            }
        }

        function refreshData() {
            clearTimeZoneCache(); // Ensure we pick up any timezone changes
            if (googleEnabled) loadGoogleEvents();
            else if (calDavUrl) loadCalDAVEvents();
            else if (currentUser) loadCloudEvents();
            else loadLocalEvents();
        }

        window.onfocus = function () {
            clearTimeZoneCache();
        };

        function switchView(view) {
            currentView = view;

            // Reset viewDate to today on switching unless already in day/month flow
            if (view === 'agenda') {
                // Agenda doesn't use viewDate in the same way, usually shows list starting now
                viewDate = getZonedDate();
            }

            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active');
                if (b.innerText.toLowerCase() === view) b.classList.add('active');
            });
            renderView();
        }

        function renderView() {
            const container = document.getElementById('content-area');
            container.innerHTML = '';

            // Sort events by date
            events.sort((a, b) => new Date(a.start) - new Date(b.start));

            // OPTIMIZATION: Build an efficient lookup map
            // Key: "Year-MonthIdx-Day" (e.g. "2023-0-15" for Jan 15)
            // This avoids O(N) lookup inside the O(D) day loop
            const eventsMap = {};
            events.forEach(e => {
                const z = getZonedDate(new Date(e.start));
                const key = z.getFullYear() + '-' + z.getMonth() + '-' + z.getDate();
                if (!eventsMap[key]) eventsMap[key] = [];
                eventsMap[key].push(e);
            });

            if (currentView === 'agenda') {
                renderAgenda(container, eventsMap);
            } else if (currentView === 'month') {
                renderMonthView(container, eventsMap);
            } else if (currentView === 'day') {
                renderDayView(container, eventsMap);
            }
        }

        // --- AGENDA RENDERER ---
        function renderAgenda(container) {
            const wrapper = document.createElement('div');
            wrapper.className = 'agenda-container';

            // Filter events: Today onwards only (using Zoned Today)
            const todayZoned = getZonedDate();
            todayZoned.setHours(0, 0, 0, 0);

            // Filter logic: Check if event's zoned start time is >= todayZoned
            const filteredEvents = events.filter(e => {
                const z = getZonedDate(new Date(e.start));
                return z >= todayZoned;
            });

            if (filteredEvents.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">No upcoming events.</div>';
                return;
            }

            const grouped = {};
            filteredEvents.forEach(e => {
                // IMPORTANT: Group by the DATE as it appears in the TARGET ZONE
                const z = getZonedDate(new Date(e.start));
                // Use a string key based on the zoned date values
                // ISO string slice is risky if z is local time, so build manually or use formatted
                const dateKey = z.getFullYear() + '-' + (z.getMonth() + 1).toString().padStart(2, '0') + '-' + z.getDate().toString().padStart(2, '0');

                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(e);
            });

            // Sort keys to ensure chronological order
            const sortedKeys = Object.keys(grouped).sort();

            // Iterate over grouped events
            sortedKeys.forEach(dateKey => {
                const list = grouped[dateKey];
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-group';

                // Construct a date object from the key parts to format it
                // dateKey is YYYY-MM-DD
                const [y, m, d] = dateKey.split('-').map(Number);
                const loopDate = new Date(y, m - 1, d); // Local construction is fine as we just want to format it

                const dayLabel = formatZonedDate(loopDate, { weekday: 'long', month: 'short', day: 'numeric' });

                let html = `<div class="day-header">${dayLabel}</div>`;
                list.forEach(e => {
                    let timeStr;
                    if (e.isAllDay) {
                        timeStr = "All day";
                    } else {
                        // Format Start - End
                        const startStr = formatZonedTime(e.start);
                        const endStr = e.end ? formatZonedTime(e.end) : formatZonedTime(new Date(new Date(e.start).getTime() + 3600000)); // Default 1h
                        timeStr = `${startStr} – ${endStr}`;
                    }

                    // Add delete button only for Native mode (not google, not caldav)
                    const isReadOnly = googleEnabled || calDavUrl;
                    const delBtn = (!isReadOnly) ? `<span class="del-event-btn" onclick="deleteEvent('${e.id}')">×</span>` : '';
                    html += `
                        <div class="event">
                            <div class="event-time">${timeStr}</div>
                            <div class="event-title">${e.title}</div>
                            ${delBtn}
                        </div>
                    `;
                });
                dayDiv.innerHTML = html;
                wrapper.appendChild(dayDiv);
            });
            container.appendChild(wrapper);
        }

        // --- MONTH RENDERER ---
        function renderMonthView(container, eventsMap) {
            // Header Controls
            const header = document.createElement('div');
            header.className = 'nav-header';
            const monthLabel = formatZonedDate(viewDate, { month: 'long', year: 'numeric' });
            header.innerHTML = `
                <button class="nav-arrow" onclick="changeMonth(-1)">&lt;</button>
                <div class="nav-title">${monthLabel}</div>
                <button class="nav-arrow" onclick="changeMonth(1)">&gt;</button>
            `;
            container.appendChild(header);

            // Weekday Headers
            const grid = document.createElement('div');
            grid.className = 'month-grid';

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(d => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'weekday-label';
                dayHeader.innerText = d;
                grid.appendChild(dayHeader);
            });

            // Calculate Grid
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const startDayIndex = firstDay.getDay(); // 0-6
            const totalDays = lastDay.getDate();

            // Empty slots before first day
            for (let i = 0; i < startDayIndex; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }

            // Days
            for (let i = 1; i <= totalDays; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';

                // Check for Today
                const today = getZonedDate();
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('today');
                }

                // Find Events - OPTIMIZED
                const key = year + '-' + month + '-' + i;
                const dayEvents = (eventsMap && eventsMap[key]) ? eventsMap[key] : [];

                let eventsHtml = '';
                // Limit to 4 events to avoid overflow
                const maxEvents = 4;
                for (let j = 0; j < Math.min(dayEvents.length, maxEvents); j++) {
                    const evt = dayEvents[j];
                    eventsHtml += `<div class="month-event">${evt.title}</div>`;
                }
                if (dayEvents.length > maxEvents) {
                    eventsHtml += `<div class="month-event" style="text-align:center;">+${dayEvents.length - maxEvents} more</div>`;
                }


                cell.innerHTML = `<div class="day-number">${i}</div>${eventsHtml}`;
                cell.onclick = () => jumpToDay(i);
                grid.appendChild(cell);
            }

            container.appendChild(grid);
        }

        // --- DAY RENDERER ---
        function renderDayView(container, eventsMap) {
            // Header
            const header = document.createElement('div');
            header.className = 'nav-header';
            const dateLabel = formatZonedDate(viewDate, { weekday: 'long', month: 'short', day: 'numeric' });
            header.innerHTML = `
                <button class="nav-arrow" onclick="changeDay(-1)">&lt;</button>
                <div class="nav-title">${dateLabel}</div>
                <button class="nav-arrow" onclick="changeDay(1)">&gt;</button>
            `;
            container.appendChild(header);

            // Filter Events - OPTIMIZED
            const key = viewDate.getFullYear() + '-' + viewDate.getMonth() + '-' + viewDate.getDate();
            const dayEvents = (eventsMap && eventsMap[key]) ? eventsMap[key] : [];

            // Content List (Hourly blocks or just a list)
            // A scrollable list of time slots is cleaner for E-ink than a complex grid
            const list = document.createElement('div');
            list.className = 'day-schedule';

            // Create slots for hours 6 AM to 10 PM (simplified view)
            // Or just list the events sorted
            if (dayEvents.length === 0) {
                list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No events scheduled.</div>';
            } else {
                // Group by hour for a structured look
                for (let hour = 0; hour < 24; hour++) {
                    const hourEvents = dayEvents.filter(e => {
                        const d = new Date(e.start);
                        const zoned = getZonedDate(d);
                        return zoned.getHours() === hour;
                    });

                    if (hourEvents.length > 0) {
                        const slot = document.createElement('div');
                        slot.className = 'hour-slot';

                        const displayHour = hour === 0 ? '12 AM' : (hour > 12 ? (hour - 12) + ' PM' : hour + ' AM');

                        let eventHtml = '';
                        hourEvents.forEach(e => {
                            let timeStr;
                            if (e.isAllDay) {
                                timeStr = "All day";
                            } else {
                                const startStr = formatZonedTime(e.start);
                                const endStr = e.end ? formatZonedTime(e.end) : formatZonedTime(new Date(new Date(e.start).getTime() + 3600000));
                                timeStr = `${startStr} – ${endStr}`;
                            }
                            eventHtml += `<div class="day-event-chip">${timeStr} - ${e.title}</div>`;
                        });

                        slot.innerHTML = `
                            <div class="slot-time">${displayHour}</div>
                            <div class="slot-events">${eventHtml}</div>
                        `;
                        list.appendChild(slot);
                    }
                }
            }
            container.appendChild(list);
        }

        // --- NAVIGATION LOGIC ---
        function changeMonth(delta) {
            viewDate.setMonth(viewDate.getMonth() + delta);
            renderView();
        }

        function changeDay(delta) {
            viewDate.setDate(viewDate.getDate() + delta);
            renderView();
        }

        function jumpToDay(dayNum) {
            viewDate.setDate(dayNum);
            switchView('day');
        }

        // ==========================================
        //  GOOGLE MODE
        // ==========================================
        function initGoogleMode() {
            document.getElementById('app-title').innerText = "Calendar (Google)";
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });

                const fragmentString = location.hash.substring(1);
                const params = new URLSearchParams(fragmentString);
                const newAccessToken = params.get('access_token');

                if (newAccessToken) {
                    localStorage.setItem('google_calendar_token', newAccessToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    gapi.client.setToken({ access_token: newAccessToken });
                    document.getElementById('auth-overlay').style.display = 'none';
                    loadGoogleEvents();
                } else {
                    const token = localStorage.getItem('google_calendar_token');
                    if (token) {
                        gapi.client.setToken({ access_token: token });
                        document.getElementById('auth-overlay').style.display = 'none';
                        loadGoogleEvents();
                    } else {
                        // Auto-login logic
                        if (!location.hash.includes('error=')) {
                            // Show connecting state
                            document.getElementById('auth-overlay').style.display = 'flex';
                            document.querySelector('#auth-overlay h2').innerText = "Redirecting...";
                            document.querySelector('#auth-overlay p').innerText = "Refreshing Google Session";
                            oauthSignIn();
                        } else {
                            document.getElementById('auth-overlay').style.display = 'flex';
                        }
                    }
                }
            });
        }

        function oauthSignIn() {
            const endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';
            const form = document.createElement('form');
            form.setAttribute('method', 'GET');
            form.setAttribute('action', endpoint);
            const params = { 'client_id': CLIENT_ID, 'redirect_uri': window.location.href.split('#')[0], 'response_type': 'token', 'scope': SCOPES };
            for (var p in params) {
                var input = document.createElement('input');
                input.setAttribute('type', 'hidden');
                input.setAttribute('name', p);
                input.setAttribute('value', params[p]);
                form.appendChild(input);
            }
            document.body.appendChild(form);
            form.submit();
        }

        async function loadGoogleEvents() {
            document.getElementById('status-msg').innerText = "Syncing...";
            try {
                // Fetch a broader range for month view (e.g., current month +/- 1)
                // For simplicity, we just fetch a bunch of events starting from "now"
                // Ideally, this should refetch when changing months, but static load is safer for rate limits
                const res = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': (new Date(getZonedDate().setMonth(getZonedDate().getMonth() - 1))).toISOString(), // 1 month ago
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 200,
                    'orderBy': 'startTime'
                });

                events = (res.result.items || []).map(i => {
                    let start;
                    if (i.start.date) {
                        // All-day event (YYYY-MM-DD). Use target zone midnight.
                        start = getUTCFromWallClock(i.start.date, '00:00');
                    } else {
                        // Timed event (ISO string)
                        start = i.start.dateTime;
                    }

                    return {
                        id: i.id,
                        title: i.summary,
                        start: start,
                        isAllDay: !!i.start.date
                    };
                });
                renderView();
                document.getElementById('status-msg').innerText = "Synced.";
            } catch (e) {
                console.error(e);
                document.getElementById('status-msg').innerText = "Error.";
                if (e.status === 401) {
                    // Token expired during use -> Re-auth
                    oauthSignIn();
                }
            }
        }

        // ==========================================
        //  NATIVE / CALDAV MODE
        // ==========================================
        function initNativeMode() {
            document.getElementById('app-title').innerText = "Calendar";

            // If CalDAV is set, hide Add button (read-only)
            if (calDavUrl) {
                document.getElementById('add-btn').style.display = 'none';
                loadCalDAVEvents();
            } else {
                document.getElementById('add-btn').style.display = 'block';
                if (currentUser) loadCloudEvents();
                else loadLocalEvents();
            }
        }

        function loadLocalEvents() {
            events = JSON.parse(localStorage.getItem('rekindle_events_local')) || [];
            renderView();
        }

        function loadCloudEvents() {
            db.collection('users').doc(currentUser.uid).collection('events')
                .onSnapshot(snap => {
                    events = [];
                    snap.forEach(doc => {
                        const d = doc.data();
                        events.push({ id: doc.id, title: d.title, start: d.start, end: d.end, isAllDay: d.isAllDay });
                    });
                    renderView();
                });
        }

        async function loadCalDAVEvents() {
            document.getElementById('status-msg').innerText = "Fetching CalDAV...";
            // We use the same proxy pattern as other apps to bypass CORS
            const proxyUrl = `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(calDavUrl)}`;

            try {
                const res = await fetch(proxyUrl);
                const text = await res.text();

                if (!text || text.trim() === "") throw new Error("Empty response");

                events = parseICS(text);
                document.getElementById('status-msg').innerText = "Synced (CalDAV)";
                renderView();
            } catch (e) {
                console.error(e);
                document.getElementById('status-msg').innerText = "CalDAV Error";
                // Fallback to local
                if (!events.length && currentUser) loadCloudEvents();
                else if (!events.length) loadLocalEvents();
            }
        }

        function parseICS(icsData) {
            // Simple regex parser for basic event data
            // VEVENT ... SUMMARY: ... DTSTART: ... END:VEVENT
            const eventsFound = [];
            const veventRegex = /BEGIN:VEVENT([\s\S]*?)END:VEVENT/g;

            let match;
            while ((match = veventRegex.exec(icsData)) !== null) {
                const block = match[1];

                const summaryMatch = /SUMMARY:(.*)/.exec(block);
                const dtStartMatch = /DTSTART(?:;.*)?:(\w+)/.exec(block);
                const dtEndMatch = /DTEND(?:;.*)?:(\w+)/.exec(block);

                if (summaryMatch && dtStartMatch) {
                    const title = summaryMatch[1].trim();
                    const rawDate = dtStartMatch[1].trim();
                    const rawEndDate = dtEndMatch ? dtEndMatch[1].trim() : null;

                    // Basic date parsing (YYYYMMDDTHHMMSS or YYYYMMDD)
                    let isoDate = null;
                    let isoEndDate = null;
                    let isAllDay = false;

                    const parseICSTime = (raw) => {
                        if (raw.length === 8) {
                            // Date only
                            return { date: `${raw.slice(0, 4)}-${raw.slice(4, 6)}-${raw.slice(6, 8)}`, allDay: true };
                        } else if (raw.length >= 15) {
                            // DateTime
                            return { date: `${raw.slice(0, 4)}-${raw.slice(4, 6)}-${raw.slice(6, 8)}T${raw.slice(9, 11)}:${raw.slice(11, 13)}:${raw.slice(13, 15)}`, allDay: false };
                        }
                        return null;
                    };

                    const startObj = parseICSTime(rawDate);
                    if (startObj) {
                        isoDate = startObj.date;
                        isAllDay = startObj.allDay;
                    }

                    if (rawEndDate) {
                        const endObj = parseICSTime(rawEndDate);
                        if (endObj) isoEndDate = endObj.date;
                    }


                    if (isoDate) {
                        eventsFound.push({
                            id: 'caldav_' + Math.random(), // generate temp id
                            title: title,
                            start: isoDate,
                            end: isoEndDate,
                            isAllDay: isAllDay
                        });
                    }
                }
            }
            return eventsFound;
        }

        function openAddModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('evt-title').value = '';
            // Default to currently viewed date if in month/day view
            const defaultDate = viewDate.toISOString().split('T')[0];
            document.getElementById('evt-date').value = defaultDate;
            document.getElementById('evt-time').value = '';
            document.getElementById('evt-end-time').value = '';
        }

        function saveNativeEvent() {
            const title = document.getElementById('evt-title').value;
            const date = document.getElementById('evt-date').value;
            const time = document.getElementById('evt-time').value;
            const endTime = document.getElementById('evt-end-time').value;

            if (!title || !date) return showModal("Title and Date required");

            let isAllDay = false;
            let startDateTime, endDateTime;

            if (!time) {
                isAllDay = true;
                // Treat as all day
                startDateTime = getUTCFromWallClock(date, "00:00");
                // End is next day 00:00 for storage consistency? Or just null if we handle it
                // Let's increment date by 1 for end
                const d = new Date(date);
                d.setDate(d.getDate() + 1);
                // Simple YYYY-MM-DD next day
                const nextDay = d.toISOString().split('T')[0];
                endDateTime = getUTCFromWallClock(nextDay, "00:00");
            } else {
                startDateTime = getUTCFromWallClock(date, time);
                if (endTime) {
                    endDateTime = getUTCFromWallClock(date, endTime); // Assume same day for simplicity in this Basic UI
                } else {
                    // Default 1 hour
                    const s = new Date(startDateTime);
                    s.setHours(s.getHours() + 1);
                    endDateTime = s.toISOString();
                }
            }

            const newEvt = { title: title, start: startDateTime, end: endDateTime, isAllDay: isAllDay };

            if (currentUser) {
                db.collection('users').doc(currentUser.uid).collection('events').add(newEvt);
            } else {
                newEvt.id = Date.now().toString();
                events.push(newEvt);
                localStorage.setItem('rekindle_events_local', JSON.stringify(events));
                renderView();
            }
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function deleteEvent(id) {
            showModal("Delete event?", true, (confirmed) => {
                if (!confirmed) return;
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).collection('events').doc(id).delete();
                } else {
                    events = events.filter(e => e.id !== id);
                    localStorage.setItem('rekindle_events_local', JSON.stringify(events));
                    renderView();
                }
            });
        }

    </script>

    <script>
        // Helper to sanitize background image URLs from localStorage
        function sanitizeBackgroundImage(imageString) {
            if (!imageString) return '';
            if (imageString.startsWith('url("data:image/png;base64,')) {
                return imageString;
            }
            if (imageString.startsWith('url("') && imageString.endsWith('")')) {
                const url = imageString.substring(5, imageString.length - 2);
                if ((url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) && !url.includes('javascript:')) {
                    return imageString;
                }
            }
            return '';
        }


        loadWallpaper();

        function toggleFullScreen() {
            document.querySelector('.window').classList.toggle('fullscreen');
        }

        function loadWallpaper() {
            const wallpaperImg = localStorage.getItem('rekindle_bg_image');
            const wallpaperSize = localStorage.getItem('rekindle_bg_size');
            if (wallpaperImg) {
                document.body.style.backgroundImage = wallpaperImg;
            }
            if (wallpaperSize) {
                document.body.style.backgroundSize = wallpaperSize;
            }
        }
    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>
    <!-- STANDARD MODAL POPUP -->
    <div id="modal-overlay">
        <div class="modal-box">
            <div id="modal-message" class="modal-text"></div>
            <div id="modal-btns" class="modal-btns"></div>
        </div>
    </div>
</body>

</html>