<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta charset="UTF-8">

    <title>AirType</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="js/i18n.js"></script>

    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
            --kindle-font: "Bookerly", "Georgia", serif;
            --ui-font: "Geneva", "Verdana", sans-serif;
        }

        body {
            font-family: var(--ui-font);
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;

            /* Pixel Art Rendering */
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            width: 95%;
            height: 90vh;
            max-width: 800px;
            position: relative;
        }

        /* FOR MONITOR MODE: FULL SCREEN WINDOW */
        .window.full-monitor {
            width: 100%;
            height: 100vh;
            max-width: none;
            border: none;
            box-shadow: none;
            padding: 0;
            margin: -20px;
            /* Counteract body padding */
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        /* CLOSE BUTTON */
        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* SYSTEM BUTTON */
        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 1rem;
            font-family: var(--ui-font);
        }

        .sys-btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* MINI BTN for Title Bar */
        .mini-btn {
            background: white;
            border: 2px solid black;
            padding: 2px 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
            font-family: var(--ui-font);
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* APP CONTROLS (Right side of Title Bar) */
        .app-controls {
            position: absolute;
            right: 10px;
            z-index: 2;
            display: none;
            /* Hidden by default (Phone) */
            gap: 5px;
        }

        .window.fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            z-index: 2000;
            box-shadow: none;
            border: 2px solid black;
            box-sizing: border-box;
            transform-origin: top left;
        }

        .sys-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        .icon-btn {
            width: 24px;
            height: 24px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
            flex-shrink: 0;
            font-family: var(--ui-font);
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* Icon State Toggles */
        .icon-contract {
            display: none;
        }

        .window.fullscreen-mode .icon-expand {
            display: none;
        }

        .window.fullscreen-mode .icon-contract {
            display: inline;
        }

        /* CONTENT VIEWS */
        .view-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* NOTE LIST VIEW (Replaces Landing) */
        #note-list-view {
            overflow-y: auto;
            align-items: stretch;
            /* List items take full width */
        }

        .note-item {
            padding: 15px;
            border-bottom: 1px solid #ccc;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-item:hover {
            background-color: #f0f0f0;
        }

        .note-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .note-date {
            font-size: 0.8rem;
            color: #666;
        }

        /* KEYBOARD VIEW */
        #keyboard-view {
            display: none;
        }

        .info-bar {
            background: #eee;
            border-bottom: 2px solid black;
            padding: 10px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .code-box {
            font-family: "Courier New", monospace;
            font-weight: bold;
            font-size: 1.1rem;
            background: white;
            border: 2px solid black;
            padding: 2px 8px;
        }

        #title-input {
            width: 100%;
            border: none;
            border-bottom: 2px solid black;
            font-family: var(--ui-font);
            font-size: 1.2rem;
            font-weight: bold;
            padding: 10px;
            box-sizing: border-box;
            outline: none;
            background: #fff;
        }

        #editor-wrapper {

            flex-grow: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        #input-area {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            font-family: var(--kindle-font);
            font-size: 1.3rem;
            line-height: 1.5;
            outline: none;
            flex-grow: 1;
            /* Expand to fill space */
            background: white;
            white-space: pre-wrap;
            overflow-y: auto;
        }

        #input-area:empty:before {
            content: attr(data-placeholder);
            color: #888;
        }

        /* CONNECT VIEW */
        #connect-view {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .connect-input {
            font-size: 2rem;
            text-align: center;
            letter-spacing: 5px;
            border: 2px solid black;
            padding: 10px;
            width: 200px;
            font-family: "Courier New", monospace;
            box-shadow: 2px 2px 0 #ccc;
        }

        /* MONITOR VIEW */
        #monitor-view {
            display: none;
            padding: 40px;
            /* Kindle margins */
            overflow-y: auto;
            background: white;
        }

        #paper {
            font-family: var(--kindle-font);
            font-size: 2rem;
            /* Big for Kindle */
            line-height: 1.4;
            max-width: 900px;
            margin: 0 auto;
            white-space: pre-wrap;
            padding-bottom: 80vh;
            /* Allow generous scrolling past end */
        }

        /* CURSOR */
        #cursor-caret {
            display: inline-block;
            width: 12px;
            height: 1.8rem;
            background: black;
            vertical-align: text-bottom;
            margin-left: 2px;
            animation: blink 1s step-end infinite;
        }

        /* MODALS */
        #modal-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 999;
            align-items: center;
            justify-content: center;

            /* Fix for Title Bar Visibility */
            top: 35px;
            height: calc(100% - 35px);
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 350px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .modal-buttons>*+* {
            margin-left: 10px;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* GUEST OVERLAY */
        #guest-overlay {
            position: absolute;
            top: 35px;
            /* Below title bar */
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 3000;
            display: none;
            /* Default hidden */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        #guest-overlay h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }
    </style>
    <script src="theme.js"></script>
    <script src="pro-gate.js"></script>
</head>

<body>

    <div class="window" id="main-window">
        <!-- PAYWALL OVERLAY -->
        <div id="paywall-overlay"
            style="display:none; position:absolute; top:35px; left:0; width:100%; height:calc(100% - 35px); background:rgba(255,255,255,0.98); z-index:9000; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box;">
            <h2 style="margin-top:0;" data-i18n="airtype.paywall.title">ReKindle+</h2>
            <p data-i18n="airtype.paywall.body">Support ReKindle development and get<br>access to exclusive apps.</p>
            <button class="sys-btn" onclick="window.location.href='pay.html'" data-i18n="airtype.paywall.btn">Subscribe
                / Login</button>
            <p style="font-size:0.8rem; margin-top:20px; color:#666;" id="paywall-status"
                data-i18n="airtype.paywall.status">Checking subscription...</p>
        </div>
        <!-- TITLE BAR -->
        <div class="title-bar" id="app-title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="tryExit()">X</div>
            <span class="title-text">AirType</span>

            <!-- RESET DEVICE TYPE BUTTON -->
            <button class="mini-btn" style="position:absolute; right:10px; z-index:2;"
                onclick="resetDeviceType()">Reset</button>

            <!-- GLOBAL APP CONTROLS -->
            <div class="app-controls" id="top-controls">
                <button class="mini-btn" onclick="changeFontSize(-2)">A-</button>
                <button class="mini-btn" onclick="changeFontSize(2)">A+</button>
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1"></path>
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- VIEW 1: NOTE LIST (DEFAULT) -->
        <div id="note-list-view" class="view-content">
            <div style="padding:10px; border-bottom:1px solid #ccc; background:#f9f9f9;">
                <button class="sys-btn" style="width:100%;" onclick="handleNewNote()" data-i18n="airtype.btn.new_note">+
                    New Note</button>
            </div>
            <div id="note-list-container">
                <div style="padding:20px; text-align:center; color:#666;" data-i18n="airtype.status.loading">Loading
                    notes...</div>
            </div>
        </div>

        <!-- VIEW 2: KEYBOARD (HOST) -->
        <div id="keyboard-view" class="view-content">
            <div class="info-bar">
                <span><span data-i18n="airtype.label.session">Session:</span> <span id="host-code"
                        class="code-box">...</span></span>
                <span id="sync-indicator" data-i18n="airtype.status.ready">Ready</span>
                <span id="ping-ticker" style="font-size: 0.8rem; color: #666; margin-left:10px;"></span>
            </div>
            <div id="editor-wrapper">
                <input type="text" id="title-input" placeholder="Untitled Story" oninput="handleInput()"
                    data-i18n-placeholder="airtype.placeholder.title">
                <div id="input-area" contenteditable="true" data-placeholder="Type here..." oninput="handleInput()"
                    data-i18n-placeholder="airtype.placeholder.body"></div>
            </div>
        </div>

        <!-- VIEW 3: CONNECT (MONITOR SETUP) -->
        <div id="connect-view" class="view-content">
            <h2 data-i18n="airtype.header.enter_code">Enter Code</h2>
            <input type="text" id="connect-code-input" class="connect-input" maxlength="6" placeholder="000000"
                data-i18n-placeholder="airtype.placeholder.code">
            <div style="display: flex">
                <button class="sys-btn" onclick="connectToSession()" data-i18n="airtype.btn.connect">Connect</button>
                <button class="sys-btn" onclick="location.reload()" data-i18n="airtype.btn.back"
                    style="margin-left: 10px">Back</button>
            </div>
        </div>

        <!-- VIEW 3C: SCANNER VIEW -->
        <div id="scanner-view" class="view-content"
            style="display:none; flex-direction:column; align-items:center; justify-content:center;">
            <h2 data-i18n="airtype.header.scan">Scan QR Code</h2>
            <div id="reader" style="width:300px; height:300px; border:2px solid black;"></div>
            <button class="sys-btn" style="margin-top:20px;" onclick="stopScanner()"
                data-i18n="airtype.btn.cancel">Cancel</button>
        </div>

        <!-- VIEW 3B: QR CONNECT SETUP -->
        <!-- This is now used as an overlay or switched view for Tablets/Monitors -->
        <div id="qr-setup-view" class="view-content"
            style="display:none; align-items:center; justify-content:center; flex-direction:column; gap:20px; text-align:center;">
            <h2 id="qr-status-text" data-i18n="airtype.header.qr_setup">Scan to Connect</h2>
            <div id="qrcode" style="padding:10px; background:white; border:2px solid black;"></div>
            <p style="font-family:var(--kindle-font); max-width:300px;" data-i18n="airtype.body.qr_setup">Scan this with
                your phone to start writing
                immediately.</p>
            <div style="font-size:1.5rem; font-family:'Courier New'; font-weight:bold; letter-spacing:2px;"
                id="qr-session-code"></div>
            <button class="sys-btn" onclick="location.reload()" data-i18n="airtype.btn.cancel">Cancel</button>
        </div>

        <!-- VIEW 4: MONITOR (PAPER) -->
        <div id="monitor-view" class="view-content">
            <!-- Content injected here -->
            <h1 id="paper-title" style="text-align:center; margin-bottom: 1rem; display:none;"></h1>
            <div id="paper"></div>
        </div>

        <!-- GUEST OVERLAY HTML -->
        <div id="guest-overlay">
            <h2 data-i18n="airtype.guest.title">You need to be logged in to use AirType</h2>
            <br>
            <button class="sys-btn" onclick="window.location.href='index?login=true'" data-i18n="airtype.btn.login">Log
                In</button>
        </div>

        <!-- GENERIC MODAL -->
        <div id="modal-overlay">
            <div class="modal-box" id="modal-content">
                <h3 id="modal-title" data-i18n="airtype.modal.alert">Alert</h3>
                <p id="modal-text">Message</p>
                <div class="modal-buttons" id="modal-actions">
                    <button class="sys-btn" onclick="closeModal()" data-i18n="airtype.btn.ok">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77",
            databaseURL: "https://rekindle-dd1fa-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Configure for Safari/Mac compatibility (fixes CORS errors)
        try {
            db.settings({
                experimentalForceLongPolling: true,
                merge: true
            });
        } catch (e) {
            // This might still error if another script called it first, but we catch it silently
            console.warn("Firestore settings already initialized:", e);
        }
        const rtdb = firebase.database();
        const auth = firebase.auth();

        // --- STATE ---
        let currentUser = null;
        let sessionId = null;
        let typeTimer = null;
        let saveTimer = null; // Separate timer for cloud save
        let sessionRef = null; // Ref for Monitor Sync
        let noteRef = null;    // Ref for Persistent Storage
        let baseFontSize = 32; // Default 2rem = 32px approx, keep track in px for easier math
        let notes = [];
        let html5QrCode = null;
        let selectedNoteData = null; // Store note data when clicked
        let userDeviceType = null;   // 'Phone' or 'Tablet'
        let initialJoinAttempted = false;
        let isPro = false;

        function checkSubscription() {
            const overlay = document.getElementById('paywall-overlay');
            const status = document.getElementById('paywall-status');

            // Buttons to update
            const btnDisplay = document.getElementById('btn-startup-display');
            const btnInput = document.getElementById('btn-startup-input');

            function updateButtons(pro) {
                if (btnDisplay) btnDisplay.disabled = !pro;
                if (btnInput) btnInput.disabled = !pro;
            }

            // 1. CACHE CHECK (Instant)
            try {
                const cachedExpiry = localStorage.getItem('rekindle_pro_expiry');
                if (cachedExpiry && parseInt(cachedExpiry) > Date.now()) {
                    isPro = true;
                    updateButtons(true);
                    overlay.style.display = 'none';
                }
            } catch (e) { }

            if (typeof firebase === 'undefined') {
                status.innerText = window.t('airtype.modal.error.firebase', "Error: Firebase not loaded.");
                overlay.style.display = 'flex';
                return;
            }

            if (!currentUser) {
                // Not logged in is handled by guest overlay usually
                overlay.style.display = 'none';
                return;
            }

            // Timeout fallback
            const timeoutId = setTimeout(() => {
                if (!isPro) {
                    console.warn("Subscription check timed out");
                    // Don't block, just leave disabled
                    overlay.style.display = 'none';
                }
            }, 10000);

            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    clearTimeout(timeoutId);
                    if (doc.exists) {
                        const data = doc.data();
                        const now = Date.now();
                        let expires = 0;
                        if (data.proExpiresAt) {
                            expires = typeof data.proExpiresAt.toMillis === 'function'
                                ? data.proExpiresAt.toMillis()
                                : new Date(data.proExpiresAt).getTime();
                        }

                        // UPDATE CACHE
                        if (expires > now) {
                            localStorage.setItem('rekindle_pro_expiry', expires.toString());
                        } else {
                            localStorage.removeItem('rekindle_pro_expiry');
                        }

                        if (expires > now) {
                            isPro = true;
                            updateButtons(true);
                        } else {
                            isPro = false;
                            updateButtons(false);
                        }
                    } else {
                        isPro = false;
                        updateButtons(false);
                    }
                    // Hide overlay regardless, access controlled by buttons
                    overlay.style.display = 'none';
                })
                .catch(e => {
                    clearTimeout(timeoutId);
                    console.error("Error checking sub", e);
                    // Hide overlay, features disabled
                    overlay.style.display = 'none';
                });
        }

        // --- AUTH & INIT ---
        auth.onAuthStateChanged(user => {
            currentUser = user;

            // Check for join intent (URL params)
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');
            const sessionParam = urlParams.get('session');
            const isJoining = (modeParam === 'host' && sessionParam);

            if (user) {
                document.getElementById('guest-overlay').style.display = 'none';
                loadCloudNotes();
                checkSubscription();

                // If we are joining via URL and haven't done so yet
                if (isJoining && !initialJoinAttempted) {
                    initialJoinAttempted = true;
                    startHostWithId(sessionParam);
                }
            } else {
                document.getElementById('guest-overlay').style.display = 'flex';
                // renderNoteList(); // Disabled for guests
            }
        });

        // --- NAVIGATION ---
        function switchView(viewId) {
            document.querySelectorAll('.view-content').forEach(el => el.style.display = 'none');
            // Flex for everything centered, Block for Paper/Notes
            const flexViews = ['connect-view', 'qr-setup-view', 'scanner-view'];
            document.getElementById(viewId).style.display = flexViews.includes(viewId) ? 'flex' : 'block';

            // Show controls ONLY in Monitor View
            const controls = document.getElementById('top-controls');
            if (controls) {
                controls.style.display = (viewId === 'monitor-view') ? 'flex' : 'none';
            }
        }

        function tryExit() {
            window.location.href = 'index';
        }

        // --- WALLPAPER LOGIC ---

        function sanitizeBackgroundImage(imageString) {
            if (!imageString) return '';
            if (imageString.startsWith('url("data:image/png;base64,')) {
                return imageString;
            }
            if (imageString.startsWith('url("') && imageString.endsWith('")')) {
                const url = imageString.substring(5, imageString.length - 2);
                if ((url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) && !url.includes('javascript:')) {
                    return imageString;
                }
            }
            return '';
        }

        // --- MODAL UTILS ---
        function showModal(title, text, buttonsHtml) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            if (buttonsHtml) {
                document.getElementById('modal-actions').innerHTML = buttonsHtml;
            } else {
                document.getElementById('modal-actions').innerHTML = '<button class="sys-btn" onclick="closeModal()">OK</button>';
            }
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        // --- DEVICE DETECTION & ENTRY FLOW ---

        function showStartupDetection() {
            // Check persistence first
            const savedType = localStorage.getItem('rekindle_airtype_device_type');
            if (savedType) {
                onStartupConfirmed(savedType);
                return;
            }

            // Map internal values: Display -> 'Tablet', Input Device -> 'Phone'
            // Added IDs and initial disabled state rooted in isPro logic
            const disabledAttr = isPro ? '' : 'disabled';
            const displayLabel = window.t('airtype.modal.setup.display', "Display");
            const inputLabel = window.t('airtype.modal.setup.input', "Input Device");
            const btnDisplay = `<button id="btn-startup-display" class="sys-btn" onclick="onStartupConfirmed('Tablet')" ${disabledAttr}>${displayLabel}</button>`;
            const btnInput = `<button id="btn-startup-input" class="sys-btn" onclick="onStartupConfirmed('Phone')" ${disabledAttr}>${inputLabel}</button>`;

            const setupTitle = window.t('airtype.modal.setup_title', "Device Setup");
            const setupBody = window.t('airtype.modal.setup_body', "Will you use this device as a display or as an input device?");
            showModal(setupTitle, setupBody, `${btnDisplay} ${btnInput}`);
        }

        function onStartupConfirmed(type) {
            userDeviceType = type;
            localStorage.setItem('rekindle_airtype_device_type', type);
            closeModal();
            if (type === 'Phone') {
                showPhoneOptions();
            }
            // Tablet just stays on Note List
        }

        // Reset device type and re-prompt
        function resetDeviceType() {
            localStorage.removeItem('rekindle_airtype_device_type');
            userDeviceType = null;
            showStartupDetection();
        }

        // Triggered by Note Click or New Note
        function initEntryFlow(noteData = null) {
            selectedNoteData = noteData; // Null means New Note

            if (!userDeviceType) {
                // Should not happen if flow is correct, but fallback
                showStartupDetection();
                return;
            }

            if (userDeviceType === 'Tablet') {
                // Tablet logic: Immediate QR
                startMonitorQR();
            } else {
                // Phone logic: Scan or Code
                showPhoneOptions();
            }
        }

        function showPhoneOptions() {
            // Host Mode Options
            const enterLabel = window.t('airtype.header.enter_code', "Enter Code");
            const scanLabel = window.t('airtype.header.scan', "Scan QR Code");
            const btnEnter = `<button class="sys-btn" onclick="closeModal(); startMonitor();">${enterLabel}</button>`; // Reusing logic but naming it Enter Code
            const btnScan = `<button class="sys-btn" onclick="closeModal(); startScanFlow();">${scanLabel}</button>`;

            const connectTitle = window.t('airtype.modal.connect_title', "Connect to Display");
            const connectBody = window.t('airtype.modal.connect_body', "How do you want to connect?");
            showModal(connectTitle, connectBody, `${btnEnter} ${btnScan}`);
        }

        function startScanFlow() {
            switchView('scanner-view');
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Handle the scanned code
            // Expected format: URL?mode=host&session=ID or just URL
            // Or maybe just the session ID if we want to be simple?
            // The generator makes a full URL. Let's parse it.

            stopScanner(false); // Stop scanning, but DO NOT navigate away yet

            try {
                const url = new URL(decodedText);
                const session = url.searchParams.get('session');
                if (session) {
                    startHostWithId(session);
                } else {
                    const errTitle = window.t('airtype.modal.alert', "Error");
                    const errMsg = window.t('airtype.modal.error.qr_format', "Invalid QR Code format.");
                    showModal(errTitle, errMsg);
                }
            } catch (e) {
                // Maybe it's just the ID?
                if (decodedText.length === 6 && !isNaN(decodedText)) {
                    startHostWithId(decodedText);
                } else {
                    const errTitle = window.t('airtype.modal.alert', "Error");
                    const errMsg = window.t('airtype.modal.error.qr_parse', "Could not parse QR Code.");
                    showModal(errTitle, errMsg);
                }
            }
        }



        function stopScanner(shouldNavigateHome = true) {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    if (shouldNavigateHome) switchView('note-list-view');
                }).catch(err => {
                    console.log("Failed to stop scanner", err);
                    if (shouldNavigateHome) switchView('note-list-view');
                });
            } else {
                if (shouldNavigateHome) switchView('note-list-view');
            }
        }

        // --- NOTE LIST LOGIC ---
        function loadCloudNotes() {
            db.collection('users').doc(currentUser.uid).collection('notes')
                .orderBy('updated', 'desc')
                .onSnapshot((snapshot) => {
                    notes = [];
                    snapshot.forEach(doc => {
                        let data = doc.data();
                        data.id = doc.id;
                        notes.push(data);
                    });
                    renderNoteList();
                }, (error) => {
                    console.error("Error getting notes: ", error);
                    // document.getElementById('status-bar').innerText = "Sync Error. Using Local.";
                });
        }

        function renderNoteList() {
            const container = document.getElementById('note-list-container');
            container.innerHTML = '';
            if (notes.length === 0) {
                const noneMsg = window.t('airtype.status.none', "No notes found.");
                container.innerHTML = `<div style="padding:40px; text-align:center; font-style:italic;">${noneMsg}</div>`;
                return;
            }

            notes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'note-item';

                const title = note.title || window.t('airtype.label.untitled', 'Untitled Note');
                const date = note.updated ? new Date(note.updated).toLocaleDateString() : '';

                div.innerHTML = `
                    <span class="note-title">${title}</span>
                    <span class="note-date">${date}</span>
                `;
                div.onclick = () => handleNoteClick(note);
                container.appendChild(div);
            });
        }

        function handleNewNote() {
            initEntryFlow(null);
        }

        function handleNoteClick(note) {
            initEntryFlow(note);
        }

        function openNote(note) {
            // Logic to actually open the note (called after connection or if we were doing solo - but we removed solo option for now per request?)
            // Wait, the prompt says "remove write solo". So they MUST connect?
            // If they are on Phone and connect, we load this note into the input.
            // If they are on Tablet and start Monitor, we technically display this note?
            // Let's assume after connection established, we load the content.

            // For now, let's keep the load logic in startHost/Monitor flow
        }

        // --- HOST LOGIC ---
        async function startHost() {
            if (!currentUser) {
                const errTitle = window.t('airtype.modal.error.access', "Access Denied");
                const errMsg = window.t('airtype.modal.error.access_body', "Please log in to system first.");
                showModal(errTitle, errMsg);
                return;
            }

            sessionId = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('host-code').innerText = sessionId;
            switchView('keyboard-view');

            // 1. Create Cloud Session (Ephemeral / Sync)
            sessionRef = rtdb.ref('freewrite_sessions/' + sessionId);

            // Pre-populate if note selected
            let initialTitle = "";
            let initialContent = "";
            let originalNoteId = null;

            if (selectedNoteData) {
                initialTitle = selectedNoteData.title || "";
                initialContent = selectedNoteData.content || "";
                originalNoteId = selectedNoteData.id;

                // Also Update Input Fields locally
                document.getElementById('title-input').value = initialTitle;
                document.getElementById('input-area').innerHTML = initialContent;

                // Set noteRef to existing note
                noteRef = db.collection('users').doc(currentUser.uid).collection('notes').doc(selectedNoteData.id);
            } else {
                // New Note
                noteRef = db.collection('users').doc(currentUser.uid).collection('notes').doc();
            }

            await sessionRef.set({
                ownerId: currentUser.uid,
                title: initialTitle,
                content: initialContent,
                originalNoteId: originalNoteId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Initial save to reserve the spot (if new)
            if (!selectedNoteData) {
                await noteRef.set({
                    title: "",
                    content: "",
                    updated: Date.now()
                });
            }

            // Clean up on unload
            window.onbeforeunload = () => {
                // optional cleanup
            };
        }

        async function startHostWithId(id) {
            if (!currentUser) {
                // Wait for auth if not ready, or just alert?
                // Simple retry logic for auto-connect
                if (!currentUser) {
                    // One retry? No, let's just show modal if not logged in.
                    // But auth might assume async. Let's give it a short moment or check if auth is indeterminate.
                    // For now, if null, show LOGIN REQUIRED.
                    const errTitle = window.t('airtype.modal.error.login', "Login Required");
                    const errMsg = window.t('airtype.modal.error.login_body', "You must be logged in to join a session.");
                    showModal(errTitle, errMsg);
                    return;
                }
            }

            sessionId = id;
            document.getElementById('host-code').innerText = sessionId;
            switchView('keyboard-view');

            // 1. Fetch Cloud Session
            sessionRef = rtdb.ref('freewrite_sessions/' + sessionId);

            try {
                const snapshot = await sessionRef.get();
                let initialTitle = "";
                let initialContent = "";
                let linkedNoteId = null;
                let sessionOwner = null;

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    // PRIORITY FIX: If the phone ALREADY has a note selected, use it.
                    // Otherwise, take what's in the session (e.g. from the monitor).
                    if (!selectedNoteData) {
                        initialTitle = data.title || "";
                        initialContent = data.content || "";
                        linkedNoteId = data.originalNoteId || null;
                    } else {
                        initialTitle = selectedNoteData.title || "";
                        initialContent = selectedNoteData.content || "";
                        linkedNoteId = selectedNoteData.id;
                    }
                    sessionOwner = data.ownerId;
                } else if (selectedNoteData) {
                    // Fallback if session doesn't exist yet but phone has data
                    initialTitle = selectedNoteData.title || "";
                    initialContent = selectedNoteData.content || "";
                    linkedNoteId = selectedNoteData.id;
                }

                // CHECK OWNERSHIP
                if (sessionOwner && sessionOwner !== currentUser.uid) {
                    const errTitle = window.t('airtype.modal.error.account', "Account Mismatch");
                    const errMsg = window.t('airtype.modal.error.account_body', "This device is logged into a different account than the monitor.");
                    showModal(errTitle, errMsg);
                    // Invalidate session ref so we don't sync
                    sessionRef = null;
                    // Go back?
                    return;
                }

                // Update Local UI
                document.getElementById('title-input').value = initialTitle;
                const inputArea = document.getElementById('input-area');
                inputArea.innerHTML = initialContent;
                inputArea.focus(); // Auto-focus for immediate typing

                // 2. Set Up Data
                // If we found a linked note, use it.
                if (linkedNoteId) {
                    noteRef = db.collection('users').doc(currentUser.uid).collection('notes').doc(linkedNoteId);
                } else {
                    // No linked note? Create new one or leaving it detached?
                    // Let's create new to be safe.
                    noteRef = db.collection('users').doc(currentUser.uid).collection('notes').doc();
                }

                // 3. Update Session with OUR ownership and content
                // If we selected a note on the phone, push its content to the session now
                await sessionRef.update({
                    ownerId: currentUser.uid,
                    title: initialTitle,
                    content: initialContent,
                    originalNoteId: linkedNoteId,
                    status: 'connected', // Signal to Tablet to switch view
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

            } catch (e) {
                console.error("Error joining session", e);
                const errTitle = window.t('airtype.modal.alert', "Error");
                const errMsg = window.t('airtype.modal.error.join', "Could not join session.");
                showModal(errTitle, errMsg);
            }
        }

        function handleInput() {
            const title = document.getElementById('title-input').value;
            const text = document.getElementById('input-area').innerHTML;
            const indicator = document.getElementById('sync-indicator');

            indicator.innerText = "â€¢";

            // DEBOUNCE: 100ms for monitor update (Faster than Firestore, but batched for efficiency)
            clearTimeout(typeTimer);
            typeTimer = setTimeout(() => {
                updateSession(title, text);
            }, 100);

            // DEBOUNCE: 2000ms for persistent cloud save (reduce write pressure)
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                saveToCloud(title, text);
            }, 2000);
        }

        async function updateSession(title, text) {
            if (!sessionRef) return;
            try {
                // 1. Update Monitor Session (Fast)
                await sessionRef.update({
                    title: title,
                    content: text,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                // No specific UI feedback for this, it just happens
            } catch (e) {
                console.error("Session sync error", e);
            }
        }

        async function saveToCloud(title, text) {
            if (!noteRef) return;
            try {
                const now = Date.now();
                // 2. Update Persistent Note (Slow/Batched)
                await noteRef.set({
                    title: title,
                    content: text,
                    updated: now
                }, { merge: true });

                const latency = Date.now() - now;
                document.getElementById('sync-indicator').innerText = window.t('airtype.status.synced', "Synced");
                document.getElementById('ping-ticker').innerText = `${latency}ms`;
            } catch (e) {
                console.error("Save error", e);
                document.getElementById('sync-indicator').innerText = window.t('airtype.status.error', "Save Error");
            }
        }

        // --- MONITOR LOGIC ---
        function startMonitor() {
            switchView('connect-view');
        }

        function connectToSession() {
            const code = document.getElementById('connect-code-input').value.trim();
            if (code.length !== 6) {
                const errTitle = window.t('airtype.modal.alert', "Error");
                const errMsg = window.t('airtype.modal.error.qr_format', "Invalid Code");
                return showModal(errTitle, errMsg);
            }

            // BUG FIX: If user is on Phone, "Connect" means "Enter Host Mode with this Code"
            if (userDeviceType === 'Phone') {
                startHostWithId(code);
                return;
            }

            // Tablet/Monitor Logic
            sessionId = code;
            switchView('monitor-view');

            // Listen for changes
            rtdb.ref('freewrite_sessions/' + sessionId)
                .on('value', snapshot => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();

                        // CHECK ACCOUNT MISMATCH (If user logs in or session changes owner)
                        if (currentUser && data.ownerId && data.ownerId !== currentUser.uid) {
                            const errTitle = window.t('airtype.modal.error.account', "Account Mismatch");
                            const errMsg = window.t('airtype.modal.error.account_body', "The connected device is using a different account.");
                            showModal(errTitle, errMsg);
                            // Maybe disconnect?
                            return;
                        }

                        renderPaper(data.title, data.content);
                    }
                });
        }

        function renderPaper(title, text) {
            const paper = document.getElementById('paper');
            const titleEl = document.getElementById('paper-title');

            if (title) {
                titleEl.textContent = title;
                titleEl.style.display = 'block';
            } else {
                titleEl.style.display = 'none';
            }

            paper.innerHTML = text;

            // Append visual cursor
            const cursor = document.createElement('span');
            cursor.id = 'cursor-caret';
            paper.appendChild(cursor);

            // Auto scroll logic (Kindle optimized)
            // Ensure layout is calculated
            const monitorView = document.getElementById('monitor-view');
            const cursorRect = cursor.getBoundingClientRect();
            const containerRect = monitorView.getBoundingClientRect();

            // Calculate active position relative to the container's viewport
            const relativeTop = cursorRect.top - containerRect.top;

            // If cursor is near the bottom (within last 10% or below view)
            if (relativeTop > containerRect.height * 0.9) {
                // Scroll so the cursor aligns with ~25% of the viewport height
                // Delta needed = Current Relative Top - Target Relative Top
                const targetRelativeTop = containerRect.height * 0.25;
                const scrollAmount = relativeTop - targetRelativeTop;
                monitorView.scrollTop += scrollAmount;
            } else if (relativeTop > containerRect.height || relativeTop < 0) {
                // Fallback: just ensure it's visible if it's totally off-screen
                cursor.scrollIntoView({ block: "end" });
            }
        }

        // --- UTILS ---
        function changeFontSize(delta) {
            // Apply to Paper (Monitor)
            const paper = document.getElementById('paper');
            const paperSize = parseFloat(window.getComputedStyle(paper).fontSize);
            const newPaperSize = paperSize + delta;
            if (newPaperSize > 10 && newPaperSize < 100) {
                paper.style.fontSize = newPaperSize + 'px';
            }

            // Apply to Input Area (Host)
            const input = document.getElementById('input-area');
            const inputSize = parseFloat(window.getComputedStyle(input).fontSize);
            const newInputSize = inputSize + delta;

            if (newInputSize > 10 && newInputSize < 100) {
                input.style.fontSize = newInputSize + 'px';
            }

            // Save preference (using paper size as reference for restoration)
            localStorage.setItem('rekindle_freewrite_fontsize', newPaperSize);
        }

        function toggleFullScreen() {
            // CSS Class toggle method per request ("keep border, remove padding")
            document.getElementById('main-window').classList.toggle('fullscreen-mode');
        }

        // Restore Font Size
        const savedSize = localStorage.getItem('rekindle_freewrite_fontsize');
        if (savedSize) {
            document.getElementById('paper').style.fontSize = savedSize + 'px';
        }

        // Init & URL Handling
        window.onload = () => {
            loadWallpaper();

            // Check URL Params for direct Host link
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');
            const sessionParam = urlParams.get('session');

            if (modeParam === 'host' && sessionParam) {
                // Do nothing here. Authentication listener will handle the join
                // once the user state is confirmed.
            } else {
                // Show Startup Detection immediately if not joining
                showStartupDetection();
            }
        };

        // QR Monitor Logic
        function startMonitorQR() {
            // Need to set session ID first
            if (!sessionId) {
                sessionId = Math.floor(100000 + Math.random() * 900000).toString();
            }

            // Push content and ID to session
            const sessionData = {
                ownerId: currentUser.uid,
                title: selectedNoteData ? (selectedNoteData.title || "") : "",
                content: selectedNoteData ? (selectedNoteData.content || "") : "",
                status: "waiting", // Wait for phone
                originalNoteId: selectedNoteData ? selectedNoteData.id : null,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            rtdb.ref('freewrite_sessions/' + sessionId).set(sessionData);

            if (selectedNoteData) {
                // Also render it locally just in case execution is fast
                renderPaper(selectedNoteData.title, selectedNoteData.content);
            }

            switchView('qr-setup-view');

            document.getElementById('qr-session-code').innerText = sessionId;

            // Generate QR
            // URL format: [BaseURL]?mode=host&session=[ID]
            const baseUrl = window.location.href.split('?')[0];
            const connectUrl = `${baseUrl}?mode=host&session=${sessionId}`;

            // Clear prev
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: connectUrl,
                width: 128,
                height: 128
            });

            // Start listening immediately as Monitor
            rtdb.ref('freewrite_sessions/' + sessionId)
                .on('value', snapshot => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();

                        // Update diagnostic text
                        const qrStatus = document.getElementById('qr-status-text');
                        if (qrStatus && data.status === 'connected') {
                            qrStatus.innerText = window.t('airtype.status.connected', "Connected! Loading...");
                        }
                        if (currentUser && data.ownerId && data.ownerId !== currentUser.uid) {
                            const errTitle = window.t('airtype.modal.error.account', "Account Mismatch");
                            const errMsg = window.t('airtype.modal.error.account_body', "The connected device is using a different account.");
                            showModal(errTitle, errMsg);
                            return;
                        }

                        // Always render to keep synced
                        renderPaper(data.title, data.content);

                        // Switch to monitor view if status becomes connected OR if content starts arriving
                        if (data.status === 'connected' || (data.content && data.content.length > 0)) {
                            switchView('monitor-view');
                        }
                    }
                });
        }
    </script>

    <script>
        // Helper to sanitize background image URLs from localStorage
        function sanitizeBackgroundImage(imageString) {
            if (!imageString) return '';
            if (imageString.startsWith('url("data:image/png;base64,')) {
                return imageString;
            }
            if (imageString.startsWith('url("') && imageString.endsWith('")')) {
                const url = imageString.substring(5, imageString.length - 2);
                if ((url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) && !url.includes('javascript:')) {
                    return imageString;
                }
            }
            return '';
        }


        loadWallpaper();

        function loadWallpaper() {
            const wallpaperImg = localStorage.getItem('rekindle_bg_image');
            const wallpaperSize = localStorage.getItem('rekindle_bg_size');
            if (wallpaperImg) {
                document.body.style.backgroundImage = wallpaperImg;
            }
            if (wallpaperSize) {
                document.body.style.backgroundSize = wallpaperSize;
            }
        }
    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>


</body>

</html>