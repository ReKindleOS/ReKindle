<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Neighbourhood</title>
    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: pixelated;
            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 600px;
            position: relative;
        }

        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            box-shadow: none;
            transform: translate(1px, 1px);
            background: black;
            color: white;
        }

        .content {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .toolbar {
            padding: 10px;
            border-bottom: 2px solid black;
            display: flex;
            justify-content: center;
            gap: 10px;
            background: #eee;
        }

        .tab-btn {
            background: white;
            border: 2px solid black;
            padding: 5px 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
        }

        .tab-btn.active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        .view-panel {
            display: none;
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .view-panel.active {
            display: flex;
            flex-direction: column;
        }

        /* ANIMATIONS & AVATAR */
        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .avatar-canvas {
            border: 2px solid black;
            box-shadow: 2px 2px 0 #ccc;
            flex-shrink: 0;
            background: white;
            image-rendering: pixelated;
        }

        .user-card {
            border: 2px solid black;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            box-shadow: 2px 2px 0 #ccc;
            animation: popIn 0.3s ease-out backwards;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .user-card:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 #999;
        }

        .post-card {
            border: 2px solid black;
            padding: 10px;
            margin-bottom: 12px;
            background: white;
            box-shadow: 3px 3px 0 #ccc;
            position: relative;
        }

        .card-content {
            flex-grow: 1;
            min-width: 0;
        }

        /* --- USER THEMES --- */
        /* Developer Theme: White on Black with Alternating Dotted Outline */
        .developer {
            background: black !important;
            color: white !important;
            border: 2px solid black !important;
            outline: 2px dotted white !important;
            outline-offset: -2px !important;
            box-shadow: 4px 4px 0 white, 4px 4px 0 2px black !important;
        }

        .developer a,
        .developer small,
        .developer strong,
        .developer span {
            color: white !important;
        }

        /* Supporter Theme: Double Border */
        .supporter {
            border: 3px double black !important;
            box-shadow: 4px 4px 0px #000;
        }

        /* Ensure links/text in black backgrounds are visible */
        .developer a {
            text-decoration: underline;
        }

        .user-handle {
            color: #666;
        }

        .developer .user-handle {
            color: #ccc !important;
        }

        /* Developer Tag */
        .dev-tag {
            font-size: 0.7rem;
            background: black;
            color: white;
            padding: 1px 4px;
            border-radius: 4px;
            margin-right: 5px;
            vertical-align: middle;
            font-weight: bold;
        }

        /* Invert for developer theme (Black BG -> White Text normally, so make tag White BG -> Black Text) */
        .developer .dev-tag {
            background: white !important;
            color: black !important;
        }

        .supporter-crown {
            width: 14px;
            height: 14px;
            display: inline-block;
            vertical-align: middle;
            fill: currentColor;
            margin-right: 4px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid black;
            font-family: inherit;
            box-sizing: border-box;
            background: white;
        }

        .input-field:focus {
            outline: none;
            background: #f0f0f0;
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 8px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 3px 3px 0 black;
            font-family: inherit;
            font-size: 0.9rem;
            /* align-self: flex-start; removed to fix centering */
        }

        .sys-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(3px, 3px);
        }

        /* REVERTED TO STANDARD STYLES */

        #login-overlay {
            display: flex;
            position: absolute;
            top: 35px;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        .badge-plus {
            display: inline-block;
            background: black;
            color: white;
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 2px;
            margin-left: 5px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .dual-column {
            display: flex;
            gap: 20px;
            width: 100%;
        }

        .column {
            flex: 1;
            min-width: 0;
        }

        .header-sep {
            font-weight: bold;
            border-bottom: 2px solid black;
            margin-bottom: 15px;
            padding-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .card-location {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
            font-style: italic;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            border: 1px solid black;
            background: #eee;
        }

        /* COMMENTS */
        .comments-section {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px dashed #ccc;
        }

        .comments-toggle {
            font-size: 0.75rem;
            color: #666;
            cursor: pointer;
            user-select: none;
        }

        .comments-toggle:hover {
            text-decoration: underline;
        }

        .comments-list {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .comment-item {
            font-size: 0.8rem;
            padding: 5px 8px;
            background: white;
            color: black;
            border: 1px solid black;
            position: relative;
        }

        .comment-item strong {
            cursor: pointer;
        }

        .comment-input-row {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .comment-input-row input {
            flex: 1;
            padding: 5px;
            border: 1px solid black;
            font-size: 0.8rem;
        }

        .comment-input-row button {
            padding: 5px 10px;
            font-size: 0.75rem;
        }

        /* Override inherited white text from developer posts for standard comments */
        .comment-item:not(.developer) a,
        .comment-item:not(.developer) small,
        .comment-item:not(.developer) strong,
        .comment-item:not(.developer) span {
            color: black !important;
        }

        /* PIXEL EDITOR MODAL */
        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            width: 256px;
            height: 256px;
            border: 2px solid black;
            background: white;
            margin: 15px auto;
            touch-action: none;
        }

        .pixel {
            border: 1px solid #eee;
            background: white;
            cursor: pointer;
        }

        .pixel.active {
            background: black;
            border-color: black;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 6px 6px 0 black;
            padding: 20px;
            width: 300px;
            /* Increased to fit 256px grid */
            text-align: center;
        }

        .editor-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .interest-pill {
            display: inline-block;
            padding: 4px 10px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 12px;
            font-size: 0.7rem;
            margin: 0 4px 4px 0;
            cursor: pointer;
            user-select: none;
        }

        .interest-pill:hover {
            background: #eee;
            border-color: black;
        }

        .interest-pill.selected {
            background: black;
            color: white;
            border-color: black;
        }

        .social-links {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        .social-icon {
            text-decoration: none;
            color: black;
            font-weight: bold;
            font-size: 0.8rem;
            border: 1px solid #ccc;
            padding: 2px 6px;
            border-radius: 4px;
            background: #f9f9f9;
        }

        .social-icon:hover {
            background: black;
            color: white;
            border-color: black;
        }
    </style>

    <!-- FIREBASE (WITH RTDB) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="theme.js"></script>
    <script src="bad_words.js?v=2"></script>
    <script src="js/i18n.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text" data-i18n="neighbourhood.title">Neighbourhood <small
                    style="font-size: 0.6em; opacity: 0.7;" data-i18n="neighbourhood.beta"> (BETA)</small></span>
            <div id="admin-toggle-container" style="display:none; position: absolute; right: 10px; z-index: 5;">
                <label
                    style="font-size:0.8rem; cursor:pointer; background: white; border: 2px solid black; padding: 2px 5px; font-weight: bold;">
                    <input type="checkbox" id="admin-mode-check" onchange="toggleAdminMode(this.checked)">
                    Admin Mode
                </label>
            </div>
        </div>

        <div class="content">
            <div class="toolbar">
                <div id="btn-posts" class="tab-btn active" onclick="switchTab('posts')"
                    data-i18n="neighbourhood.btn.view_posts">Posts</div>
                <div id="btn-list" class="tab-btn" onclick="switchTab('list')" data-i18n="neighbourhood.btn.view_list">
                    Find
                    Neighbours</div>
                <div id="btn-profile" class="tab-btn" onclick="switchTab('profile')"
                    data-i18n="neighbourhood.btn.view_profile">My Profile</div>
            </div>

            <!-- PROFILE TAB -->
            <div id="view-profile" class="view-panel">
                <!-- READ ONLY PROFILE VIEW -->
                <div id="profile-read-only">
                    <div
                        style="text-align:center; padding-bottom:20px; border-bottom:2px solid black; margin-bottom:20px;">
                        <canvas id="profile-view-avatar" class="avatar-canvas" width="128" height="128"
                            style="width:128px; height:128px; display:block; margin:0 auto; box-shadow: 4px 4px 0px #ccc;"></canvas>

                        <h2 id="profile-view-name" style="margin:15px 0 5px 0; font-family:'Geneva', sans-serif;"></h2>
                        <div id="profile-view-pronouns" style="color:#666; font-size:0.9rem;"></div>

                        <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                            <button id="btn-edit-profile" class="sys-btn" onclick="toggleEditMode(true)"
                                data-i18n="neighbourhood.btn.edit">Edit Profile</button>
                            <button id="btn-message-profile" class="sys-btn" onclick="messageUser()"
                                style="display:none;" data-i18n="neighbourhood.btn.message">Message</button>
                            <button id="btn-repair-handles" class="sys-btn" onclick="repairHandles()"
                                style="display:none; background:#000; color:#fff;">Repair Handles</button>
                        </div>
                    </div>

                    <div class="dual-column">
                        <div class="column">
                            <div class="header-sep" data-i18n="neighbourhood.header.about">About</div>
                            <div id="profile-view-bio"
                                style="margin-bottom:15px; font-style:italic; white-space: pre-wrap;"></div>

                            <div
                                style="display:grid; grid-template-columns: auto 1fr; gap: 5px 15px; font-size: 0.9rem;">
                                <b data-i18n="neighbourhood.lbl.age">Age:</b> <span id="profile-view-age">-</span>
                                <b data-i18n="neighbourhood.lbl.location">Location:</b> <span
                                    id="profile-view-location">-</span>
                                <b data-i18n="neighbourhood.lbl.occupation">Occupation:</b> <span
                                    id="profile-view-occupation">-</span>
                                <b data-i18n="neighbourhood.lbl.hometown">Hometown:</b> <span
                                    id="profile-view-hometown">-</span>
                                <b data-i18n="neighbourhood.lbl.language">Languages:</b> <span
                                    id="profile-view-language">-</span>
                            </div>

                            <div class="header-sep" style="margin-top:20px;" data-i18n="neighbourhood.header.social">
                                Socials</div>
                            <div id="profile-view-socials" class="social-links" style="flex-wrap:wrap;"></div>
                        </div>

                        <div class="column">
                            <div class="header-sep" data-i18n="neighbourhood.lbl.interests">Interests</div>
                            <div id="profile-view-interests" class="tag-container" style="margin-bottom:20px;"></div>

                            <div class="header-sep" data-i18n="neighbourhood.header.favorites">Favorites</div>
                            <div id="profile-view-favorites" style="display:flex; flex-direction:column; gap:10px;">
                            </div>

                            <div class="header-sep" style="margin-top:20px;" data-i18n="neighbourhood.lbl.travel">Travel
                                History</div>
                            <div id="profile-view-travel" style="white-space: pre-wrap; font-size:0.9rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- EDIT MODE (Hidden by default) -->
                <div id="profile-edit-mode" style="display:none;">

                    <!-- HEADER / AVATAR SECTION -->
                    <div
                        style="text-align:center; padding-bottom:20px; border-bottom:2px solid black; margin-bottom:20px;">
                        <h3 style="margin:0 0 15px 0;" data-i18n="neighbourhood.header.edit_profile">Edit Profile</h3>

                        <div style="display:flex; justify-content:center; align-items:center; gap:20px;">
                            <canvas id="my-avatar" class="avatar-canvas" width="128" height="128"
                                style="width:128px; height:128px; box-shadow: 4px 4px 0px #ccc;"></canvas>
                            <div class="avatar-controls" style="display:flex; flex-direction:column; gap:8px;">
                                <button class="sys-btn" onclick="openAvatarModal()" data-i18n="neighbourhood.btn.draw"
                                    style="font-size:0.75rem; padding:6px 12px;">Draw Icon</button>
                                <button class="sys-btn" onclick="regenerateAvatar()"
                                    data-i18n="neighbourhood.btn.regenerate"
                                    style="font-size:0.75rem; padding:6px 12px;">Regenerate</button>
                                <button class="sys-btn" onclick="clearCustomAvatar()"
                                    data-i18n="neighbourhood.btn.clear_avatar"
                                    style="font-size:0.75rem; padding:6px 12px;">Clear</button>
                                <button class="sys-btn" id="btn-toggle-privacy" onclick="toggleProfilePrivacy()"
                                    style="font-size:0.75rem; padding:6px 12px; margin-top:5px;">üîì Public</button>
                            </div>
                        </div>

                        <div style="margin-top:15px; max-width:300px; margin-left:auto; margin-right:auto;">
                            <label class="form-label" data-i18n="neighbourhood.lbl.name">Display Name</label>
                            <input type="text" id="input-name" class="input-field" placeholder="Make it catchy..."
                                data-i18n-placeholder="neighbourhood.ph.name" maxlength="30" style="text-align:center;">

                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <div style="flex:1;">
                                    <label class="form-label" data-i18n="neighbourhood.lbl.pronouns"
                                        style="font-size:0.8rem;">Pronouns</label>
                                    <input type="text" id="input-pronouns" class="input-field" placeholder="he/him"
                                        maxlength="30" style="font-size:0.8rem;">
                                </div>
                                <div style="flex:1;">
                                    <label class="form-label" data-i18n="neighbourhood.lbl.pronunciation"
                                        style="font-size:0.8rem;">Pronunciation</label>
                                    <input type="text" id="input-pronunciation" class="input-field"
                                        placeholder="Tim-oh-thee" maxlength="50" style="font-size:0.8rem;">
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                            <button class="sys-btn" onclick="toggleEditMode(false)"
                                data-i18n="status.cancel">Cancel</button>
                            <button class="sys-btn primary" onclick="saveProfile()"
                                data-i18n="neighbourhood.btn.save_profile">Save Changes</button>
                            <div id="save-status" style="margin-left:10px; font-weight:bold; align-self:center;"></div>
                        </div>
                    </div>

                    <div class="dual-column">
                        <!-- LEFT COLUMN: Bio, Details, Socials -->
                        <div class="column">
                            <div class="header-sep" data-i18n="neighbourhood.header.about">About</div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="neighbourhood.lbl.bio">Bio / Status</label>
                                <textarea id="input-bio" class="input-field" style="height: 80px; resize: none;"
                                    maxlength="140" placeholder="What are you up to?"></textarea>
                            </div>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:15px;">
                                <div>
                                    <label class="form-label" data-i18n="neighbourhood.lbl.birthday">Birthday
                                        (Private)</label>
                                    <input type="text" id="input-birthday" class="input-field" placeholder="DD/MM/YYYY"
                                        maxlength="20">
                                </div>
                                <div>
                                    <label class="form-label" data-i18n="neighbourhood.lbl.location">Location</label>
                                    <div style="display:flex; gap:5px;">
                                        <input type="text" id="input-location" class="input-field" readonly
                                            placeholder="City, Country" style="cursor:pointer;"
                                            onclick="openCityPicker('input-location')">
                                    </div>

                                </div>
                                <div>
                                    <label class="form-label"
                                        data-i18n="neighbourhood.lbl.occupation">Occupation</label>
                                    <input type="text" id="input-occupation" class="input-field"
                                        placeholder="What do you do?" maxlength="50">
                                </div>
                                <div>
                                    <label class="form-label" data-i18n="neighbourhood.lbl.hometown">Hometown</label>
                                    <div style="display:flex; gap:5px;">
                                        <input type="text" id="input-hometown" class="input-field" readonly
                                            placeholder="City, Country" style="cursor:pointer;"
                                            onclick="openCityPicker('input-hometown')">
                                    </div>
                                </div>
                                <div style="grid-column: span 2;">
                                    <label class="form-label" data-i18n="neighbourhood.lbl.language">Languages</label>
                                    <input type="text" id="input-language" class="input-field"
                                        placeholder="English, Spanish..." maxlength="100">
                                </div>
                                <div style="grid-column: span 2;">
                                    <label class="form-label" data-i18n="neighbourhood.lbl.gender">Gender</label>
                                    <input type="text" id="input-gender" class="input-field"
                                        placeholder="Male/Female/NB/etc" maxlength="30">
                                </div>
                            </div>

                            <div class="header-sep" data-i18n="neighbourhood.lbl.social">Social Links</div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <input type="text" id="input-goodreads" class="input-field" placeholder="Goodreads">
                                <input type="text" id="input-instagram" class="input-field" placeholder="Instagram">
                                <input type="text" id="input-youtube" class="input-field" placeholder="YouTube">
                                <input type="text" id="input-twitch" class="input-field" placeholder="Twitch">
                                <input type="text" id="input-pinterest" class="input-field" placeholder="Pinterest">
                                <input type="text" id="input-tumblr" class="input-field" placeholder="Tumblr">
                                <input type="text" id="input-website" class="input-field" placeholder="Website"
                                    style="grid-column: span 2;">
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: Interests, Favorites, Travel -->
                        <div class="column">
                            <div class="header-sep" data-i18n="neighbourhood.lbl.interests">Interests</div>
                            <div class="form-group">
                                <div
                                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                    <label class="form-label" style="margin:0;">Select:</label>
                                    <span id="interest-counter" style="font-size:0.75rem; color:#666;">0</span>
                                </div>
                                <div id="suggested-interests"
                                    style="display:flex; flex-wrap:wrap; gap:5px; max-height:200px; overflow-y:auto;">
                                </div>
                            </div>

                            <div class="header-sep" data-i18n="neighbourhood.header.favorites">Favorites</div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="neighbourhood.lbl.fav_music">Music</label>
                                <textarea id="input-fav-music" class="input-field" style="height:40px; resize:none;"
                                    placeholder="Bands, Genres..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="neighbourhood.lbl.fav_tv">TV Shows</label>
                                <textarea id="input-fav-tv" class="input-field" style="height:40px; resize:none;"
                                    placeholder="Series you love..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="neighbourhood.lbl.fav_movies">Movies</label>
                                <textarea id="input-fav-movies" class="input-field" style="height:40px; resize:none;"
                                    placeholder="Films you love..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="neighbourhood.lbl.fav_games">Games</label>
                                <textarea id="input-fav-games" class="input-field" style="height:40px; resize:none;"
                                    placeholder="Video games..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="neighbourhood.lbl.fav_sports">Sports</label>
                                <textarea id="input-fav-sports" class="input-field" style="height:40px; resize:none;"
                                    placeholder="Teams, Sports..."></textarea>
                            </div>

                            <div class="header-sep" style="margin-top:20px;" Data-i18n="neighbourhood.lbl.travel">Travel
                                History</div>
                            <div class="form-group">
                                <textarea id="input-travel" class="input-field" style="height:60px; resize:none;"
                                    placeholder="Places you've been..."></textarea>
                            </div>
                        </div>
                    </div>
                </div> <!-- Close profile-edit-mode -->
            </div> <!-- Close view-profile -->

            <!-- LIST TAB -->
            <div id="view-list" class="view-panel">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="input-search" class="input-field"
                        data-i18n-placeholder="neighbourhood.ph.search" placeholder="Search neighbours..."
                        style="flex:1;" onkeyup="if(event.key === 'Enter') renderLists()" oninput="toggleSearchClear()">
                    <button id="btn-search" class="sys-btn" onclick="renderLists()"
                        data-i18n="neighbourhood.btn.search">Search</button>
                    <button id="btn-clear-search" class="sys-btn" onclick="clearSearch()"
                        style="display:none; padding:5px 10px;" title="Clear search">‚úï</button>
                </div>

                <div id="loading-msg" data-i18n="neighbourhood.msg.loading">Looking for neighbours...</div>

                <div id="dual-match-view" style="display:none; margin-bottom:20px;">
                    <div class="header-sep" data-i18n="neighbourhood.header.similar">Neighbours Like You</div>
                    <div id="similar-list"></div>
                </div>

                <div id="near-list" style="display:none;"></div>
                <!-- Legacy container kept hidden to prevent JS null ref if needed, though variable was removed from loadAllUsers usage -->

                <div class="header-sep" data-i18n="neighbourhood.header.all" style="margin-top: 20px;">All Neighbours
                </div>
                <div id="all-list"></div>
            </div>

            <!-- POSTS TAB -->
            <div id="view-posts" class="view-panel active">
                <div style="padding-bottom:15px; border-bottom:2px solid black; margin-bottom:15px;">
                    <textarea id="input-post" class="input-field" placeholder="What's happening?"
                        style="height:60px; resize:none; margin-bottom:10px;"></textarea>
                    <div style="display:flex; justify-content:flex-end;">
                        <button class="sys-btn" onclick="submitPost()" data-i18n="neighbourhood.btn.post">Post</button>
                    </div>
                </div>
                <div id="loading-posts" style="display:none; text-align:center; padding:20px;">Loading...</div>
                <div id="posts-feed" style="display:flex; flex-direction:column; gap:15px; padding-bottom: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- PROFILE POPUP MODAL -->
    <div id="profile-modal" class="modal-overlay" style="z-index: 100; background: rgba(0,0,0,0.3);">
        <div class="window"
            style="width: 85%; max-width: 500px; max-height: 75vh; box-shadow: 6px 6px 0 rgba(0,0,0,0.3);">
            <div class="title-bar">
                <div class="title-stripes"></div>
                <div class="close-box" onclick="closeProfileModal()">X</div>
                <span class="title-text">Profile View</span>
            </div>
            <div class="content" style="background:#fafafa; overflow-y:auto; padding:20px;">
                <!-- Reusing standard profile view structure dynamically filled -->
                <div id="popup-profile-content">
                    <div
                        style="text-align:center; padding-bottom:20px; border-bottom:2px solid black; margin-bottom:20px;">
                        <canvas id="popup-view-avatar" class="avatar-canvas" width="128" height="128"
                            style="width:128px; height:128px; display:block; margin:0 auto; box-shadow: 4px 4px 0px #ccc;"></canvas>
                        <h2 id="popup-view-name" style="margin:15px 0 5px 0; font-family:'Geneva', sans-serif;"></h2>
                        <div id="popup-view-pronouns" style="color:#666; font-size:0.9rem;"></div>
                        <div id="popup-view-bio" style="margin-bottom:15px; font-style:italic; white-space: pre-wrap;">
                        </div>
                    </div>

                    <div class="dual-column">
                        <div class="column">
                            <div
                                style="display:grid; grid-template-columns: auto 1fr; gap: 5px 15px; font-size: 0.9rem;">
                                <b data-i18n="neighbourhood.lbl.age">Age:</b> <span id="popup-view-age">-</span>
                                <b data-i18n="neighbourhood.lbl.location">Location:</b> <span
                                    id="popup-view-location">-</span>
                                <b data-i18n="neighbourhood.lbl.occupation">Occupation:</b> <span
                                    id="popup-view-occupation">-</span>
                                <b data-i18n="neighbourhood.lbl.hometown">Hometown:</b> <span
                                    id="popup-view-hometown">-</span>
                                <b data-i18n="neighbourhood.lbl.language">Languages:</b> <span
                                    id="popup-view-language">-</span>
                            </div>
                            <div class="header-sep" style="margin-top:20px;" data-i18n="neighbourhood.header.social">
                                Socials</div>
                            <div id="popup-view-socials" class="social-links" style="flex-wrap:wrap;"></div>
                        </div>
                        <div class="column">
                            <div class="header-sep" data-i18n="neighbourhood.lbl.interests">Interests</div>
                            <div id="popup-view-interests" class="tag-container" style="margin-bottom:20px;"></div>

                            <div class="header-sep" data-i18n="neighbourhood.header.favorites">Favorites</div>
                            <div id="popup-view-favorites" style="display:flex; flex-direction:column; gap:10px;"></div>

                            <div class="header-sep" style="margin-top:20px;" data-i18n="neighbourhood.lbl.travel">Travel
                                History</div>
                            <div id="popup-view-travel" style="white-space: pre-wrap; font-size:0.9rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Message Button -->
                <div style="margin-top:20px; text-align:center; border-top:2px solid black; padding-top:15px;">
                    <button id="popup-message-btn" class="sys-btn"
                        style="padding:10px 25px; font-size:0.9rem; background:black; color:white;">
                        ‚úâÔ∏è Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AVATAR EDITOR MODAL -->
    <div id="avatar-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 data-i18n="neighbourhood.modal.draw_title">Draw Profile Icon</h3>
            <div id="pixel-grid" class="pixel-grid"></div>
            <div class="editor-controls">
                <button class="sys-btn" onclick="clearGrid()" style="flex:1;">Clear</button>
                <button class="sys-btn" onclick="saveCustomAvatar()"
                    style="flex:1; background:black; color:white;">Save</button>
            </div>
            <button class="sys-btn" onclick="closeAvatarModal()" style="margin-top:10px; width:100%;">Cancel</button>
        </div>
    </div>
    <div id="login-overlay" style="display: none;"> <!-- Hidden by default, shown by JS -->
        <h2 data-i18n="suggestions.msg.login_required">Please Log In</h2>
        <p data-i18n="suggestions.msg.login_desc">You need to be logged in to enable suggestions.</p>
        <button class="sys-btn" onclick="window.location.href='index?login=true'" data-i18n="suggestions.btn.login">Log
            In</button>
    </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77",
            databaseURL: "https://rekindle-dd1fa-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database(); // RTDB

        // Mock Kindle+ check (In real app, check claims or subscription status)
        // For now, let's treat everyone as potentially plus if they have the flag, 
        // or we could auto-grant for testing.
        function isKindlePlus(user) {
            // Placeholder: Check specific UID or custom claim if available.
            // For this demo, let's assume it's stored in the public profile for display.
            return false;
        }

        // Init Standard Features
        if (window.rekindleApplyTheme) window.rekindleApplyTheme();
        if (window.rekindleApplyScale) window.rekindleApplyScale();
        if (window.rekindleAutoDetectScale) window.rekindleAutoDetectScale();
        if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();

        let currentUser = null;
        let isPlus = false;
        let myProfile = {};
        let currentDrawMode = 1;
        let isDrawing = false;
        let tempPixelData = new Array(64).fill(0);
        let cachedUsers = []; // Cache for search/filtering
        let supporterUsers = {}; // Store supporter usernames as object for ES5 compatibility

        function fetchSupporters() {
            const fs = firebase.firestore();
            try {
                if (fs.settings) {
                    fs.settings({ experimentalForceLongPolling: true });
                }
            } catch (e) { }
            return fs.collection('config').doc('supporters').get().then(function (doc) {
                if (doc.exists) {
                    var data = doc.data();
                    supporterUsers = {};
                    var now = Date.now();

                    function isValidPro(val) {
                        if (val === true) return true; // Legacy/Lifetime
                        if (val && val.expiresAt) {
                            var exp = 0;
                            if (typeof val.expiresAt.toMillis === 'function') {
                                exp = val.expiresAt.toMillis();
                            } else {
                                exp = new Date(val.expiresAt).getTime();
                            }
                            return exp > now;
                        }
                        return false;
                    }

                    if (data.usernames && Array.isArray(data.usernames)) {
                        for (var i = 0; i < data.usernames.length; i++) {
                            supporterUsers[data.usernames[i]] = true;
                        }
                    } else {
                        // Map format: keys are usernames
                        for (var key in data) {
                            if (key !== 'usernames' && key !== 'list') {
                                if (isValidPro(data[key])) {
                                    supporterUsers[key] = true;
                                }
                            }
                        }
                    }
                }
            }).catch(function (e) {
                console.error("Error loading supporters:", e);
            });
        }

        const SUGGESTED_INTERESTS = [
            // Books & Writing
            "Reading", "Writing", "Poetry", "Fantasy", "Sci-Fi", "Romance", "Mystery", "Thriller", "Horror", "Non-Fiction", "Biography", "History", "Philosophy", "Self-Help",
            // Creative
            "Art", "Design", "Drawing", "Painting", "Illustration", "Calligraphy", "Photography", "Filmmaking", "Animation",
            // Tech
            "Coding", "Tech", "Startups", "AI", "Web Dev", "App Dev", "Gaming", "Retro Gaming", "VR", "3D Printing", "Open Source",
            // Music & Entertainment
            "Music", "Vinyl", "Guitar", "Piano", "Singing", "DJing", "Podcasts", "Films", "Cinema", "Theatre", "Anime", "Manga", "Comics", "K-Pop", "K-Drama",
            // Food & Drink
            "Cooking", "Baking", "Coffee", "Tea", "Wine", "Cocktails", "Vegan", "Vegetarian", "Foodie",
            // Wellness & Sport
            "Yoga", "Meditation", "Fitness", "Running", "Hiking", "Cycling", "Swimming", "Climbing", "Martial Arts", "Dance", "Sports", "Football", "Basketball", "Tennis", "Golf",
            // Hobbies
            "Travel", "Nature", "Outdoors", "Camping", "Gardening", "Pets", "Dogs", "Cats", "Birds", "Knitting", "Crochet", "Sewing", "DIY", "Woodworking", "Board Games", "Chess", "Puzzles", "Journaling", "Bullet Journal",
            // Academic
            "Languages", "Psychology", "Sociology", "Science", "Astronomy", "Space", "Economics", "Politics", "Sustainability", "Climate",
            // Finance
            "Investing", "Crypto", "FIRE", "Minimalism"
        ];

        // AUTH
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';

                // Initial Pro check from storage
                isPlus = localStorage.getItem('rekindle_is_pro') !== 'false';

                fetchSupporters().then(() => {
                    renderSuggestedInterests();
                    initAdminTools(user);
                    loadPosts();
                });
                loadMyProfile();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
            }
        });

        // Sync Pro Status across tabs
        window.addEventListener('storage', function (e) {
            if (e.key === 'rekindle_is_pro') {
                const newIsPlus = (e.newValue !== 'false');
                if (newIsPlus !== isPlus) {
                    isPlus = newIsPlus;
                    console.log("Pro Status Sync (Neighbourhood): ", isPlus);
                    reRenderRecentPosts();
                }
            }
        });

        function reRenderRecentPosts() {
            const feed = document.getElementById('posts-feed');
            if (!feed) return;
            const cards = feed.querySelectorAll('.post-card');
            cards.forEach(card => {
                const uid = card.dataset.uid; // I need to make sure I add data-uid to the card
                if (!uid) return;

                // Simple re-check logic (similar to renderPostItem)
                const postUser = cachedUsers.find(u => u.uid === uid) || (currentUser && uid === currentUser.uid ? myProfile : null);

                if (postUser) {
                    const isDev = (uid === 'ukiyo' || postUser.email === 'ukiyo@rekindle.ink' || postUser.displayName === 'ukiyo' || postUser.displayName === 'ukiyo@rekindle.ink') || (currentUser && uid === currentUser.uid && currentUser.email === 'ukiyo@rekindle.ink');
                    const isPro = postUser.kindlePlus || supporterUsers[postUser.displayName] || supporterUsers[postUser.email] || false;

                    card.classList.remove('developer', 'supporter');
                    if (isDev) card.classList.add('developer');
                    else if (isPro) card.classList.add('supporter');

                    // Note: We don't fully re-render innerHTML to avoid flickering/losing focus,
                    // but classes and shadows will update.
                    // For comments, we'd need to target individual comment items.
                    const commentLists = card.querySelectorAll('.comments-list');
                    commentLists.forEach(list => {
                        const items = list.querySelectorAll('.comment-item');
                        items.forEach(item => {
                            const cUid = item.dataset.uid; // Need data-uid here too
                            if (!cUuid) return;
                            const cu = cachedUsers.find(u => u.uid === cUid) || (currentUser && cUid === currentUser.uid ? myProfile : null);
                            if (cu) {
                                const cid = (cUuid === 'ukiyo' || cu.email === 'ukiyo@rekindle.ink' || cu.displayName === 'ukiyo' || cu.displayName === 'ukiyo@rekindle.ink') || (currentUser && cUid === currentUser.uid && currentUser.email === 'ukiyo@rekindle.ink');
                                const sip = cu.kindlePlus || supporterUsers[cu.displayName] || supporterUsers[cu.email] || false;
                                item.classList.remove('developer', 'supporter');
                                if (cid) item.classList.add('developer');
                                else if (sip) item.classList.add('supporter');
                            }
                        });
                    });
                }
            });
        }

        // UI TABS
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-panel').forEach(p => {
                p.classList.remove('active');
            });

            const btn = document.getElementById('btn-' + tab);
            const view = document.getElementById('view-' + tab);

            if (btn) btn.classList.add('active');
            if (view) {
                view.classList.add('active');
            }

            if (tab === 'list') {
                loadAllUsers();
            } else if (tab === 'posts') {
                loadPosts();
            }
        }

        // SAVE PROFILE
        function saveProfile() {
            if (!currentUser) return;

            const name = document.getElementById('input-name').value.trim();
            const bio = document.getElementById('input-bio').value.trim();

            // Get interests from toggle selection
            const interests = getSelectedInterests();

            const statusEl = document.getElementById('save-status');

            // Name validation - admin can use restricted words
            const isAdmin = currentUser.email === 'ukiyo@rekindle.ink';
            const restricted = ['ukiyo', 'rekindle'];
            const lowerName = name.toLowerCase();
            if (!isAdmin && restricted.some(r => lowerName.includes(r))) {
                statusEl.innerText = window.t('neighbourhood.msg.invalid_name', "This name contains restricted words.");
                statusEl.style.color = 'red';
                setTimeout(() => {
                    statusEl.innerText = '';
                    statusEl.style.color = '';
                }, 3000);
                return;
            }

            statusEl.innerText = window.t('neighbourhood.msg.saving', "Saving...");
            statusEl.style.color = '';

            // Generate avatar seed if not set
            if (!myProfile.avatarSeed) myProfile.avatarSeed = Math.floor(Math.random() * 10000);

            // Preserve existing plus status if any (or set based on logic)
            // Ideally backend sets this, but for the "vibe" lets allow it to persist
            const isPlus = myProfile.kindlePlus || false;

            const socialLinks = {
                goodreads: document.getElementById('input-goodreads').value.trim(),
                instagram: document.getElementById('input-instagram').value.trim(),
                youtube: document.getElementById('input-youtube').value.trim(),
                twitch: document.getElementById('input-twitch').value.trim(),
                pinterest: document.getElementById('input-pinterest').value.trim(),
                tumblr: document.getElementById('input-tumblr').value.trim(),
                website: document.getElementById('input-website').value.trim()
            };

            const profileData = {
                displayName: name || window.t('common.anonymous', 'Anonymous'),
                pronunciation: document.getElementById('input-pronunciation').value.trim(),
                bio: bio,
                occupation: document.getElementById('input-occupation').value.trim(),
                hometown: document.getElementById('input-hometown').value.trim(),
                birthday: document.getElementById('input-birthday').value.trim(),
                gender: document.getElementById('input-gender').value.trim(),
                pronouns: document.getElementById('input-pronouns').value.trim(),
                language: document.getElementById('input-language').value.trim(),
                favorites: {
                    music: document.getElementById('input-fav-music').value.trim(),
                    tv: document.getElementById('input-fav-tv').value.trim(),
                    movies: document.getElementById('input-fav-movies').value.trim(),
                    games: document.getElementById('input-fav-games').value.trim(),
                    sports: document.getElementById('input-fav-sports').value.trim()
                },
                travel: document.getElementById('input-travel').value.trim(),
                interests: interests,
                location: document.getElementById('input-location').value,
                avatarSeed: myProfile.avatarSeed,
                customAvatar: myProfile.customAvatar || null,
                socialLinks: socialLinks,
                kindlePlus: isPlus,
                isPrivate: myProfile.isPrivate || false,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            };

            // Write to /users_public/{uid}
            // Use update to avoid overwriting other nodes like favorite_topics
            db.ref('users_public/' + currentUser.uid).update(profileData)
                .then(() => {
                    statusEl.innerText = window.t('neighbourhood.msg.saved', "Profile Saved!");
                    myProfile = Object.assign(myProfile || {}, profileData); // Update local cache
                    // Return to view mode after 500ms
                    setTimeout(() => {
                        statusEl.innerText = '';
                        toggleEditMode(false);
                    }, 500);
                })
                .catch(err => {
                    console.error("Save error:", err);
                    statusEl.innerText = window.t('neighbourhood.msg.error_saving', "Error saving profile.");
                });
        }

        // LOAD MY PROFILE
        function loadMyProfile() {
            if (!currentUser) return;
            db.ref('users_public/' + currentUser.uid).once('value')
                .then(snapshot => {
                    var data = snapshot.val();
                    var fallbackName = (currentUser.email || currentUser.uid).split('@')[0];

                    if (!data) {
                        // Create basic profile if it doesn't exist (KindleChat style)
                        myProfile = {
                            displayName: currentUser.displayName || fallbackName,
                            email: currentUser.email || "",
                            avatarSeed: Math.floor(Math.random() * 10000),
                            lastActive: firebase.database.ServerValue.TIMESTAMP
                        };
                        db.ref('users_public/' + currentUser.uid).set(myProfile);
                    } else {
                        myProfile = data;
                        // Ensure email is synced if missing
                        if (!myProfile.email && currentUser.email) {
                            myProfile.email = currentUser.email;
                            db.ref('users_public/' + currentUser.uid).update({ email: currentUser.email });
                        }
                    }
                    // ensure favorite_topics is preserved in local cache if we save later
                    // actually update() handles that, but good to have complete object in myProfile

                    // Show repair button to ukiyo
                    if (currentUser.email === 'ukiyo@rekindle.ink') {
                        document.getElementById('btn-repair-handles').style.display = 'inline-block';
                    }

                    // Populate Inputs
                    const p = myProfile;
                    document.getElementById('input-name').value = p.displayName || '';
                    document.getElementById('input-bio').value = p.bio || '';

                    // Populate selectedInterests Set
                    selectedInterests.clear();
                    if (Array.isArray(p.interests)) {
                        p.interests.forEach(i => selectedInterests.add(i));
                    } else if (typeof p.interests === 'string' && p.interests) {
                        p.interests.split(',').map(s => s.trim()).filter(s => s).forEach(i => selectedInterests.add(i));
                    }

                    document.getElementById('input-location').value = p.location || '';
                    document.getElementById('input-pronunciation').value = p.pronunciation || '';
                    document.getElementById('input-occupation').value = p.occupation || '';
                    document.getElementById('input-hometown').value = p.hometown || '';
                    document.getElementById('input-birthday').value = p.birthday || '';
                    document.getElementById('input-gender').value = p.gender || '';
                    document.getElementById('input-pronouns').value = p.pronouns || '';
                    document.getElementById('input-language').value = p.language || '';

                    // Populate Favorites
                    if (p.favorites) {
                        document.getElementById('input-fav-music').value = p.favorites.music || '';
                        document.getElementById('input-fav-tv').value = p.favorites.tv || '';
                        document.getElementById('input-fav-movies').value = p.favorites.movies || '';
                        document.getElementById('input-fav-games').value = p.favorites.games || '';
                        document.getElementById('input-fav-sports').value = p.favorites.sports || '';
                    }
                    document.getElementById('input-travel').value = p.travel || '';

                    if (p.socialLinks) {
                        document.getElementById('input-goodreads').value = p.socialLinks.goodreads || '';
                        document.getElementById('input-instagram').value = p.socialLinks.instagram || '';
                        document.getElementById('input-youtube').value = p.socialLinks.youtube || '';
                        document.getElementById('input-twitch').value = p.socialLinks.twitch || '';
                        document.getElementById('input-pinterest').value = p.socialLinks.pinterest || '';
                        document.getElementById('input-tumblr').value = p.socialLinks.tumblr || '';
                        document.getElementById('input-website').value = p.socialLinks.website || '';
                    }

                    // Populate View Mode
                    renderProfileView(p, true); // true = isMe

                    drawAvatar('my-avatar', p.customAvatar || p.avatarSeed || currentUser.uid);
                    updatePrivacyButton();
                })
                .catch(err => {
                    console.error("Error loading profile:", err);
                });
        }

        // KINDLE NAME HELPER
        function getKindleName(user) {
            if (!user) return 'Anonymous';
            // If it's the current user, prioritize their active Auth email
            if (currentUser && user.uid === currentUser.uid && currentUser.email) {
                return currentUser.email.split('@')[0];
            }
            if (user.email) return user.email.split('@')[0];
            // Fallback to checking displayName if it looks like an email
            if (user.displayName && user.displayName.indexOf('@') !== -1) {
                return user.displayName.split('@')[0];
            }
            if (user.uid) return user.uid.split('@')[0].substring(0, 8);
            return 'Anonymous';
        }

        async function repairHandles() {
            if (!currentUser || currentUser.email !== 'ukiyo@rekindle.ink') return;
            if (!confirm("Start Handle Repair? This will scan public profiles and recent KindleChat reactions to fix missing handles.")) return;

            const btn = document.getElementById('btn-repair-handles');
            btn.disabled = true;
            btn.innerText = "Repairing...";

            try {
                // 1. Scan Public Profiles
                const snap = await db.ref('users_public').once('value');
                const users = snap.val();
                let fixCount = 0;

                for (let uid in users) {
                    const u = users[uid];
                    let needsSync = false;
                    let email = u.email;

                    // A. Email is empty but displayName is an email
                    if (!email && u.displayName && u.displayName.indexOf('@') !== -1) {
                        email = u.displayName;
                        needsSync = true;
                    }

                    if (needsSync && email) {
                        console.log(`[Repair] Syncing handle for ${uid} as ${email}`);
                        await db.ref('users_public/' + uid).update({ email: email });
                        fixCount++;
                    }
                }

                // 2. Scan Recent KindleChat Reactions
                // Reactions often store { reaction: "...", username: "handle" }
                // This is a great source of Truth for UIDs
                const reactionSnap = await db.ref('kindlechat/messages').limitToLast(200).once('value');
                const msgs = reactionSnap.val();
                for (let mid in msgs) {
                    const msg = msgs[mid];
                    if (msg.reactions) {
                        for (let rUid in msg.reactions) {
                            const r = msg.reactions[rUid];
                            if (r && typeof r === 'object' && r.username) {
                                // Check if this user needs repair
                                if (!users[rUid] || !users[rUid].email) {
                                    const emailVal = r.username.includes('@') ? r.username : r.username + '@rekindle.ink';
                                    console.log(`[Repair] Found handle in reaction for ${rUid}: ${emailVal}`);
                                    await db.ref('users_public/' + rUid).update({ email: emailVal });
                                    fixCount++;
                                }
                            }
                        }
                    }
                }

                showAlertModal(`Repair Complete! Processed ${fixCount} handles.`);
            } catch (e) {
                console.error("Repair Error:", e);
                showAlertModal("Repair Error: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Repair Handles";
            }
        }

        // VIEW / EDIT MODES
        function toggleEditMode(showEdit) {
            const readOnlyEl = document.getElementById('profile-read-only');
            const editModeEl = document.getElementById('profile-edit-mode');

            if (showEdit) {
                readOnlyEl.style.display = 'none';
                editModeEl.style.display = 'block';
            } else {
                readOnlyEl.style.display = 'block';
                editModeEl.style.display = 'none';
                // Reload profile to reset any unsaved changes
                loadMyProfile();
            }
        }

        function renderProfileView(profile, isMe) {
            const kName = getKindleName(profile);
            const dName = profile.displayName || 'Anonymous';

            // Badge Logic
            let badgeHtml = '';
            const isDev = (profile.uid === 'ukiyo' || profile.email === 'ukiyo@rekindle.ink' || dName === 'ukiyo' || dName === 'ukiyo@rekindle.ink') || (isMe && currentUser.email === 'ukiyo@rekindle.ink');
            // Check Pro: profile.kindlePlus might be present if it's 'myProfile', but for public profiles we need to rely on what's passed in or stored.
            // In renderProfileView, input 'profile' is usually from users_public.
            // We can also check global supporterUsers map if we have it here? 
            // supporterUsers is populated in fetchSupporters().
            const isPro = profile.kindlePlus || supporterUsers[dName] || (profile.email && supporterUsers[profile.email]);

            if (isDev) {
                badgeHtml = '<span class="dev-tag">DEV</span>';
            } else if (isPro) {
                badgeHtml = '<svg class="supporter-crown" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 4L5 18H19L22 4L15 11L12 4L9 11L2 4Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>';
            }

            const fullName = (dName === kName) ? escapeHtml(dName) :
                `${escapeHtml(dName)} <span style="font-size:0.8em; font-weight:normal; color:#666; margin-left:5px;">@${escapeHtml(kName)}</span>`;
            document.getElementById('profile-view-name').innerHTML = badgeHtml + fullName;

            const pronouns = profile.pronouns ? `(${profile.pronouns})` : '';
            const pronunciation = profile.pronunciation ? `‚Ä¢ /${profile.pronunciation}/` : '';
            document.getElementById('profile-view-pronouns').innerText = `${pronouns} ${pronunciation}`;

            document.getElementById('btn-edit-profile').style.display = isMe ? 'inline-block' : 'none';
            document.getElementById('btn-message-profile').style.display = (!isMe && profile.uid) ? 'inline-block' : 'none';
            if (!isMe && profile.uid) {
                document.getElementById('btn-message-profile').setAttribute('onclick', `messageUser('${profile.uid}')`);
            }

            document.getElementById('profile-view-bio').innerText = profile.bio || '';
            document.getElementById('profile-view-location').innerText = profile.location || '-';
            document.getElementById('profile-view-occupation').innerText = profile.occupation || '-';
            document.getElementById('profile-view-hometown').innerText = profile.hometown || '-';
            document.getElementById('profile-view-language').innerText = profile.language || '-';

            // Birthday -> Age
            let ageStr = '-';
            if (profile.birthday) {
                const age = calculateAge(profile.birthday);
                if (age !== null) ageStr = age;
            }
            document.getElementById('profile-view-age').innerText = ageStr;

            // Travel
            document.getElementById('profile-view-travel').innerText = profile.travel || '-';

            // Socials
            const socialsContainer = document.getElementById('profile-view-socials');
            socialsContainer.innerHTML = '';
            if (profile.socialLinks) {
                Object.entries(profile.socialLinks).forEach(([platform, handle]) => {
                    if (handle) {
                        const div = document.createElement('div');
                        div.className = 'social-pill';
                        div.innerText = `${platform}: ${handle}`; // Could improve with icons
                        socialsContainer.appendChild(div);
                    }
                });
            }

            // Interests
            const interestsContainer = document.getElementById('profile-view-interests');
            interestsContainer.innerHTML = '';
            if (profile.interests) {
                profile.interests.forEach(tag => {
                    renderInterestWithIcon(tag, interestsContainer);
                });
            }

            // Favorites
            const favContainer = document.getElementById('profile-view-favorites');
            favContainer.innerHTML = '';
            if (profile.favorites) {
                const map = { music: 'Music', tv: 'TV', movies: 'Movies', games: 'Games', sports: 'Sports' };
                const allowed = ['music', 'tv', 'movies', 'games', 'sports'];
                Object.entries(profile.favorites).forEach(([key, val]) => {
                    if (allowed.includes(key) && val) {
                        const row = document.createElement('div');
                        row.innerHTML = `<b>${map[key] || key}:</b> <span>${escapeHtml(val)}</span>`;
                        favContainer.appendChild(row);
                    }
                });
            }

            // Draw View Avatar
            drawAvatar('profile-view-avatar', profile.customAvatar || profile.avatarSeed || (profile.uid || ''));

            // Load Favorite Topics (Async)
            if (profile.uid) {
                loadProfileTopics(profile.uid);
            }
        }

        function messageUser(uid) {
            if (!uid) return;
            // Deep link to KindleChat
            // This relies on the new KindleChat integration we will build
            window.parent.postMessage({ type: 'open-app', app: 'kindlechat', params: { chat_with: uid } }, '*');
            // Fallback for standalone/direct usage if not in iframe or similar system
            window.location.href = `kindlechat?chat_with=${uid}`;
        }

        function loadProfileTopics(uid) {
            const container = document.getElementById('profile-view-favorites');
            // Check if we have favorites container, or create a specific one for Topics
            // The HTML structure has a 'Favorites' section for Music/TV etc. 
            // We should probably add a separate 'Topics' section or append to it.
            // "Interests" is tags. "Favorites" is Key:Value.
            // Let's create a NEW header "Favorite Topics" in the column if it doesn't exist.

            // Actually, let's append a new section dynamically to the RIGHT column (where Interests/Favorites are).
            // We need to target the parent column of 'profile-view-interests'.
            // The parent is the second .column in .dual-column.
            // We can append after 'profile-view-interests' container.

            const interestsContainer = document.getElementById('profile-view-interests');
            if (!interestsContainer) return;
            const column = interestsContainer.parentElement;

            // Remove existing topics section if any (re-render safety)
            const existing = document.getElementById('profile-view-topics-container');
            if (existing) existing.remove();

            const topicsSection = document.createElement('div');
            topicsSection.id = 'profile-view-topics-container';
            topicsSection.style.marginTop = '20px';
            topicsSection.style.display = 'none'; // Hide until loaded

            topicsSection.innerHTML = `<div class="header-sep" data-i18n="neighbourhood.header.fav_topics">Favorite Topics</div>
                                       <div id="profile-view-topics-list" style="display:flex; flex-wrap:wrap; gap:10px;"></div>`;

            // Insert after interests
            interestsContainer.parentNode.insertBefore(topicsSection, interestsContainer.nextSibling);

            db.ref('users_public/' + uid + '/favorite_topics').once('value').then(snap => {
                const favs = snap.val();
                if (!favs) return; // No favorites

                const topicIds = Object.keys(favs);
                if (topicIds.length === 0) return;

                topicsSection.style.display = 'block';
                const list = document.getElementById('profile-view-topics-list');

                topicIds.forEach(tid => {
                    // Fetch topic details (title, icon)
                    db.ref('topics/' + tid).once('value').then(tSnap => {
                        const topic = tSnap.val();
                        if (!topic) return;

                        const item = document.createElement('div');
                        item.className = 'topic-pill'; // We need to style this or reuse social-pill
                        item.style.display = 'flex';
                        item.style.alignItems = 'center';
                        item.style.gap = '5px';
                        item.style.border = '1px solid black';
                        item.style.padding = '4px 8px';
                        item.style.borderRadius = '15px';
                        item.style.cursor = 'pointer';
                        item.style.backgroundColor = 'white';
                        item.style.fontSize = '0.85rem';

                        // Icon
                        let iconSvg = ''; // Default?
                        if (topic.icon) {
                            // Check if it's an SVG string
                            if (topic.icon.startsWith('<svg') || topic.icon.startsWith('<SVG')) {
                                iconSvg = topic.icon;
                            }
                            // If it's a key like 'chat', we don't have access to TOPIC_ICONS here easily unless we copy them.
                            // Let's just use a default star if no SVG string, for safety.
                            else {
                                iconSvg = '<svg viewBox="0 0 24 24" style="width:14px;height:14px;"><circle cx="12" cy="12" r="10" stroke="black" fill="none"/></svg>';
                            }
                        }

                        // Extract SVG content and size it down
                        // Using a small div wrapper
                        const iconDiv = document.createElement('div');
                        iconDiv.style.width = '14px';
                        iconDiv.style.height = '14px';
                        iconDiv.innerHTML = iconSvg;
                        // Ensure svg fits
                        const svg = iconDiv.querySelector('svg');
                        if (svg) {
                            svg.setAttribute('width', '100%');
                            svg.setAttribute('height', '100%');
                            svg.style.fill = 'black';
                        }

                        const titleSpan = document.createElement('span');
                        titleSpan.innerText = topic.title;

                        item.appendChild(iconDiv);
                        item.appendChild(titleSpan);

                        item.onclick = () => {
                            window.parent.postMessage({ type: 'open-app', app: 'topics', params: { id: tid } }, '*');
                            // Fallback
                            window.location.href = `topics?id=${tid}`;
                        };

                        list.appendChild(item);
                    });
                });
            });
        }

        async function renderInterestWithIcon(tag, container) {
            const pill = document.createElement('div');
            pill.className = 'interest-pill';
            pill.style.display = 'flex';
            pill.style.alignItems = 'center';
            pill.style.gap = '5px';
            pill.innerHTML = `<span>Loading...</span> <span>${escapeHtml(tag)}</span>`;

            // Fetch icon
            try {
                const res = await fetch(`https://api.iconify.design/search?query=${encodeURIComponent(tag)}&limit=1&palette=false`);
                const data = await res.json();
                if (data.icons && data.icons.length > 0) {
                    const iconName = data.icons[0];
                    const iconUrl = `https://api.iconify.design/${iconName}.svg`;
                    const svgRes = await fetch(iconUrl);
                    const svgText = await svgRes.text();

                    pill.innerHTML = `<div style="width:16px; height:16px; display:flex;">${svgText}</div><div>${escapeHtml(tag)}</div>`;
                    const svg = pill.querySelector('svg');
                    if (svg) {
                        svg.style.width = '100%';
                        svg.style.height = '100%';
                        svg.style.fill = 'black';
                    }
                } else {
                    // No icon found
                    pill.innerHTML = `<span>‚Ä¢</span> <span>${escapeHtml(tag)}</span>`;
                }
            } catch (e) {
                console.error("Icon fetch failed", e);
                pill.innerHTML = `<span>‚Ä¢</span> <span>${escapeHtml(tag)}</span>`;
            }
            container.appendChild(pill);
        }

        function regenerateAvatar() {
            myProfile.avatarSeed = Math.floor(Math.random() * 100000);
            myProfile.customAvatar = null; // Clear custom avatar if regenerating
            drawAvatar('my-avatar', myProfile.avatarSeed);
        }

        let selectedInterests = new Set();

        function renderSuggestedInterests() {
            const container = document.getElementById('suggested-interests');
            container.innerHTML = '';
            SUGGESTED_INTERESTS.forEach(interest => {
                const pill = document.createElement('div');
                pill.className = 'interest-pill' + (selectedInterests.has(interest) ? ' selected' : '');
                pill.innerText = interest;
                pill.onclick = () => toggleInterest(interest, pill);
                container.appendChild(pill);
            });
            updateInterestCounter();
        }

        function toggleInterest(interest, pill) {
            if (selectedInterests.has(interest)) {
                selectedInterests.delete(interest);
                pill.classList.remove('selected');
            } else {
                // Limit removed
                selectedInterests.add(interest);
                pill.classList.add('selected');
            }
            updateInterestCounter();
        }

        function updateInterestCounter() {
            const counter = document.getElementById('interest-counter');
            if (counter) counter.innerText = `${selectedInterests.size}`;
        }

        function getSelectedInterests() {
            return Array.from(selectedInterests);
        }

        // --- PIXEL EDITOR LOGIC ---
        function initPixelGrid() {
            const grid = document.getElementById('pixel-grid');
            grid.innerHTML = '';
            // 16x16 = 256
            for (let i = 0; i < 256; i++) {
                const div = document.createElement('div');
                div.className = 'pixel';
                div.dataset.index = i;
                div.addEventListener('mousedown', (e) => startDraw(e, i));
                div.addEventListener('mouseenter', () => { if (isDrawing) updatePixel(i); });
                div.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e, i); }, { passive: false });
                grid.appendChild(div);
            }
            grid.addEventListener('touchmove', handleTouchMove, { passive: false });
            window.addEventListener('mouseup', () => isDrawing = false);
            window.addEventListener('touchend', () => isDrawing = false);
        }

        let drawMode = 1; // 1 = drawing, 0 = erasing

        function startDraw(e, index) {
            isDrawing = true;
            // Determine mode based on current state of clicked pixel
            drawMode = tempPixelData[index] === 1 ? 0 : 1;
            setPixel(index, drawMode);
        }

        function setPixel(index, value) {
            tempPixelData[index] = value;
            const pixel = document.querySelector(`#pixel-grid .pixel[data-index="${index}"]`);
            if (pixel) {
                if (value === 1) pixel.classList.add('active');
                else pixel.classList.remove('active');
            }
        }

        function updatePixel(index) {
            // Apply current draw mode (don't toggle)
            setPixel(index, drawMode);
        }

        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            if (element && element.classList.contains('pixel')) {
                const index = parseInt(element.dataset.index);
                setPixel(index, drawMode);
            }
        }

        function openAvatarModal() {
            // Default 16x16 = 256
            if (myProfile.customAvatar && myProfile.customAvatar.length === 256) {
                tempPixelData = [...myProfile.customAvatar];
            } else if (myProfile.customAvatar && myProfile.customAvatar.length === 64) {
                // Migrate 8x8 to 16x16?
                // Simple scaling: 2x2 pixels for each 1 pixel
                tempPixelData = new Array(256).fill(0);
                for (let i = 0; i < 64; i++) {
                    if (myProfile.customAvatar[i] === 1) {
                        const x = i % 8;
                        const y = Math.floor(i / 8);
                        // Map to 16x16
                        // (2x, 2y), (2x+1, 2y), (2x, 2y+1), (2x+1, 2y+1)
                        const startX = x * 2;
                        const startY = y * 2;
                        tempPixelData[startY * 16 + startX] = 1;
                        tempPixelData[startY * 16 + startX + 1] = 1;
                        tempPixelData[(startY + 1) * 16 + startX] = 1;
                        tempPixelData[(startY + 1) * 16 + startX + 1] = 1;
                    }
                }
            } else {
                tempPixelData = new Array(256).fill(0);
            }

            document.getElementById('avatar-modal').style.display = 'flex';
            initPixelGrid();
            renderGridUI();
        }

        function closeAvatarModal() {
            document.getElementById('avatar-modal').style.display = 'none';
        }

        function renderGridUI() {
            const pixels = document.querySelectorAll('#pixel-grid .pixel');
            tempPixelData.forEach((val, i) => {
                if (pixels[i]) {
                    if (val === 1) pixels[i].classList.add('active');
                    else pixels[i].classList.remove('active');
                }
            });
        }

        function clearGrid() {
            tempPixelData.fill(0);
            renderGridUI();
        }

        function saveCustomAvatar() {
            myProfile.customAvatar = [...tempPixelData];
            closeAvatarModal();
            drawAvatar('my-avatar', myProfile.customAvatar || myProfile.avatarSeed); // Redraw preview
            // Note: will be permanently saved when they hit "Save Profile"
        }

        function clearCustomAvatar() {
            myProfile.customAvatar = null;
            drawAvatar('my-avatar', myProfile.avatarSeed);
        }

        function toggleProfilePrivacy() {
            myProfile.isPrivate = !myProfile.isPrivate;
            updatePrivacyButton();
        }

        function updatePrivacyButton() {
            const btn = document.getElementById('btn-toggle-privacy');
            if (btn) {
                if (myProfile.isPrivate) {
                    btn.innerText = 'üîí Private';
                    btn.style.background = '#fee';
                } else {
                    btn.innerText = 'üîì Public';
                    btn.style.background = '';
                }
            }
        }

        // CITY PICKER LOGIC
        let pickerTargetId = null;
        let pickerTimeout;

        function openCityPicker(targetId) {
            pickerTargetId = targetId;
            document.getElementById('city-picker-modal').style.display = 'flex';
            document.getElementById('picker-search').value = '';
            document.getElementById('picker-results').style.display = 'none';
            document.getElementById('picker-search').focus();
        }

        function closeCityPicker() {
            document.getElementById('city-picker-modal').style.display = 'none';
            pickerTargetId = null;
        }

        function handleCitySearch(query) {
            clearTimeout(pickerTimeout);
            const resultsContainer = document.getElementById('picker-results');

            if (query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            resultsContainer.style.display = 'block';
            resultsContainer.innerHTML = '<div style="padding:10px; color:#666;">Searching...</div>';

            pickerTimeout = setTimeout(() => {
                fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`)
                    .then(res => res.json())
                    .then(data => {
                        renderPickerResults(data.results || []);
                    })
                    .catch(e => resultsContainer.innerHTML = 'Error');
            }, 500);
        }

        function renderPickerResults(results) {
            const container = document.getElementById('picker-results');
            container.innerHTML = '';
            if (results.length === 0) {
                container.innerHTML = '<div style="padding:10px;">No results</div>';
                return;
            }

            results.forEach(city => {
                const div = document.createElement('div');
                div.style.padding = '8px';
                div.style.borderBottom = '1px solid #eee';
                div.style.cursor = 'pointer';
                div.innerHTML = `<strong>${city.name}</strong> <small>${city.country || ''}</small>`;
                div.onclick = () => selectCity(city);
                container.appendChild(div);
            });
        }

        // --- CONFIRM MODAL ---
        let confirmCallback = null;
        function showConfirmModal(msg, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            const msgEl = document.getElementById('confirm-modal-message');
            if (msgEl) msgEl.innerText = msg;
            confirmCallback = onConfirm;
            if (modal) modal.style.display = 'flex';
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            confirmCallback = null;
        }

        function onConfirmYes() {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        }

        // --- PROMPT MODAL ---
        let promptCallback = null;
        function showPromptModal(msg, initialValue, onResult) {
            const modal = document.getElementById('prompt-modal');
            const msgEl = document.getElementById('prompt-modal-message');
            const inputEl = document.getElementById('prompt-modal-input');

            if (msgEl) msgEl.innerText = msg;
            if (inputEl) inputEl.value = initialValue || '';

            promptCallback = onResult;
            if (modal) modal.style.display = 'flex';
            if (inputEl) inputEl.focus();
        }

        function closePromptModal() {
            document.getElementById('prompt-modal').style.display = 'none';
            promptCallback = null;
        }

        function onPromptSubmit() {
            const inputEl = document.getElementById('prompt-modal-input');
            const val = inputEl ? inputEl.value : '';
            if (promptCallback) promptCallback(val);
            closePromptModal();
        }

        function selectCity(city) {
            if (pickerTargetId) {
                const input = document.getElementById(pickerTargetId);
                if (input) {
                    input.value = `${city.name}`; // Just name, or Name, Country? Original list was just names.
                    // But open-meteo returns detailed data. 
                    // Let's stick to Name for now to match style, but maybe append country code if ambiguous?
                    // Settings app stores full object but displays generic.
                    // For neighbourhood profile, let's just use the Name property for simplicity in display,
                    // or "Name, Country" if available.
                    if (city.country) input.value += `, ${city.country}`;
                }
            }
            closeCityPicker();
        }

        // LOAD ALL USERS & FIND SIMILAR/NEAR
        function loadAllUsers() {
            console.log("loadAllUsers called");
            const loadingMsg = document.getElementById('loading-msg');
            if (loadingMsg) loadingMsg.style.display = 'block';

            if (!currentUser) {
                if (loadingMsg) loadingMsg.innerText = "Error: Not logged in.";
                return;
            }

            db.ref('users_public').limitToLast(100).once('value')
                .then(snapshot => {
                    if (loadingMsg) loadingMsg.style.display = 'none';
                    cachedUsers = [];

                    snapshot.forEach(child => {
                        const u = child.val();
                        u.uid = child.key;
                        // Exclude self and private profiles
                        if (u.uid !== currentUser.uid && !u.isPrivate) {
                            cachedUsers.push(u);
                        }
                    });

                    // Sort by last active (newest first)
                    cachedUsers.reverse();

                    // Initial Render
                    renderLists();
                })
                .catch(err => {
                    console.error("Load error:", err);
                    if (loadingMsg) {
                        loadingMsg.style.display = 'block';
                        loadingMsg.innerText = "Error loading list: " + err.message;
                    }
                });
        }

        function toggleSearchClear() {
            const input = document.getElementById('input-search');
            const clearBtn = document.getElementById('btn-clear-search');
            if (input && clearBtn) {
                clearBtn.style.display = input.value.trim() ? 'inline-block' : 'none';
            }
        }

        function clearSearch() {
            const input = document.getElementById('input-search');
            if (input) {
                input.value = '';
                toggleSearchClear();
                renderLists();
            }
        }

        function renderLists() {
            const listContainer = document.getElementById('all-list');
            const similarContainer = document.getElementById('similar-list');
            const dualMatchView = document.getElementById('dual-match-view');
            const searchInput = document.getElementById('input-search');

            listContainer.innerHTML = '';
            similarContainer.innerHTML = '';

            if (cachedUsers.length === 0) {
                listContainer.innerHTML = '<div style="padding:20px; text-align:center;">No other users found.</div>';
                dualMatchView.style.display = 'none';
                return;
            }

            // FILTERING
            const term = searchInput ? searchInput.value.trim().toLowerCase() : '';
            const displayUsers = cachedUsers.filter(u => {
                if (!term) return true;
                const name = (u.displayName || '').toLowerCase();
                const loc = (u.location || '').toLowerCase();
                const interests = Array.isArray(u.interests) ? u.interests.join(' ').toLowerCase() : (u.interests || '').toLowerCase();
                const bio = (u.bio || '').toLowerCase();
                const occupation = (u.occupation || '').toLowerCase();
                const hometown = (u.hometown || '').toLowerCase();
                const language = (u.language || '').toLowerCase();

                return name.includes(term) || loc.includes(term) || interests.includes(term) ||
                    bio.includes(term) || occupation.includes(term) || hometown.includes(term) || language.includes(term);
            });

            if (displayUsers.length === 0) {
                listContainer.innerHTML = '<div style="padding:20px; text-align:center;">No users match your search.</div>';
                dualMatchView.style.display = 'none';
                return;
            }

            // Calculate Matches & Filtering
            // Normalize my interests to lowercase for case-insensitive matching
            const myTags = new Set((myProfile.interests || []).map(t => t.toLowerCase()));
            const myLoc = myProfile.location ? myProfile.location.toLowerCase() : '';
            const myAge = calculateAge(myProfile.birthday);

            const similarUsers = [];
            const shownInSpecial = new Set();

            displayUsers.forEach(u => {
                let score = 0;

                // Location match (+3 points) - case insensitive
                if (myLoc && u.location && u.location.toLowerCase() === myLoc) {
                    score += 3;
                }

                // Interests match (+1 point each) - case insensitive
                if (u.interests && myTags.size > 0) {
                    if (Array.isArray(u.interests)) {
                        u.interests.forEach(tag => {
                            if (myTags.has(tag.toLowerCase())) score++;
                        });
                    }
                }

                // Age match
                if (myAge !== null && u.birthday) {
                    const uAge = calculateAge(u.birthday);
                    if (uAge !== null) {
                        const ageDiff = Math.abs(myAge - uAge);
                        if (ageDiff <= 2) score += 5;
                        else if (ageDiff <= 5) score += 3;
                        else if (ageDiff <= 10) score += 1;
                    }
                }

                u.matchScore = score;
                if (score > 0) {
                    similarUsers.push(u);
                    shownInSpecial.add(u.uid);
                }
            });

            // Sort Similar by Score
            similarUsers.sort((a, b) => b.matchScore - a.matchScore);

            console.log("Matches found:", similarUsers.length);

            // Render Matches
            if (similarUsers.length > 0) {
                dualMatchView.style.display = 'block';

                // Clear and render similar list
                similarContainer.innerHTML = '';
                similarUsers.forEach((u, idx) => {
                    try { renderUserCard(u, similarContainer, true, idx * 50); }
                    catch (e) { console.error("Error rendering similar user", u, e); }
                });
            } else {
                dualMatchView.style.display = 'none';
            }

            // Render All List (Excluding those in special lists IF NOT SEARCHING? 
            // Actually, if searching, you probably want to see everyone in valid result list.
            // But let's keep the exclusion logic for cleaner UI where "Top Matches" are highlighted 
            // and removed from the general list below to avoid duplicates.

            let allIdx = 0;
            displayUsers.forEach(u => {
                if (!shownInSpecial.has(u.uid)) {
                    renderUserCard(u, listContainer, false, allIdx * 50);
                    allIdx++;
                }
            });
        }



        function renderUserCard(user, container, showMatch = false, delay = 0) {
            const div = document.createElement('div');
            div.className = 'user-card';
            div.style.animationDelay = delay + 'ms';
            div.style.cursor = 'pointer';
            div.onclick = (e) => {
                if (e.target.tagName === 'A') return;
                openUserProfile(user.uid);
            };

            // Match badge
            const matchBadge = showMatch && user.matchScore ? `<span style="font-size:0.7rem; background:#000; color:#fff; padding:2px 5px; margin-left:5px; border-radius:2px;">‚òÖ${user.matchScore}</span>` : '';

            // Badge Logic
            let badgeHtml = '';
            const dName = user.displayName || 'Anonymous';
            const isDev = (user.uid === 'ukiyo' || user.email === 'ukiyo@rekindle.ink' || dName === 'ukiyo' || dName === 'ukiyo@rekindle.ink');
            const isPro = user.kindlePlus || supporterUsers[dName] || (user.email && supporterUsers[user.email]);

            if (isDev) {
                badgeHtml = '<span class="dev-tag" style="margin-left:5px;">DEV</span>';
            } else if (isPro) {
                badgeHtml = '<span style="margin-left:5px; display:inline-block; vertical-align:middle;"><svg class="supporter-crown" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:14px; height:14px;"><path d="M2 4L5 18H19L22 4L15 11L12 4L9 11L2 4Z" stroke="currentColor" stroke-width="2" fill="none"/></svg></span>';
            }

            // Avatar ID
            const avatarId = 'avatar-' + (user.uid || Math.random().toString(36).substr(2));

            // Location & Age
            let subtitle = user.location || '';
            if (user.birthday) {
                const age = calculateAge(user.birthday);
                if (age !== null) subtitle += (subtitle ? ', ' : '') + age;
            }

            // Common Interests only (White text on black squares)
            let tagsHtml = '';
            if (user.interests && Array.isArray(user.interests)) {
                // Get my interests for intersection
                // myProfile is global
                const myInterests = new Set((myProfile.interests || []).map(i => i.toLowerCase()));

                // Filter for common
                const common = user.interests.filter(i => myInterests.has(i.toLowerCase()));

                if (common.length > 0) {
                    tagsHtml = '<div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:4px;">' +
                        common.map(t => `<span class="tag" style="font-size:0.75rem; background:black; color:white; border-color:black; padding:3px 6px;">${escapeHtml(t)}</span>`).join('') +
                        '</div>';
                }
            }

            div.innerHTML = `
                <canvas id="${avatarId}" width="64" height="64" style="width:64px; height:64px; border:2px solid black; image-rendering:pixelated; flex-shrink:0;"></canvas>
                <div style="flex-grow:1; min-width:0;">
                    <div style="font-weight:bold; font-size:1.1rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${(function () {
                    const kName = getKindleName(user);
                    const dName = user.displayName || 'Anonymous';
                    if (dName === kName) return escapeHtml(dName);
                    return `${escapeHtml(dName)} <span class="user-handle">@${escapeHtml(kName)}</span>`;
                })()}${matchBadge}${badgeHtml}
                    </div>
                    <div style="font-size:0.8rem; color:#666;">${escapeHtml(subtitle)}</div>
                    ${user.bio ? `<div style="font-size:0.8rem; color:#333; margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;">${escapeHtml(user.bio.substring(0, 60))}${user.bio.length > 60 ? '...' : ''}</div>` : ''}
                    ${tagsHtml}
                </div>
            `;
            container.appendChild(div);

            // Draw avatar after append
            setTimeout(() => {
                const avatarSeed = user.customAvatar || user.avatarSeed || user.uid;
                drawAvatar(avatarId, avatarSeed);
            }, 0);
        }

        function openUserProfile(uid) {
            // If it's me, go to my profile tab
            if (uid === currentUser.uid) {
                switchTab('profile');
                return;
            }

            // Open Modal instead of switching tabs
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'flex';

            // Show loading...
            document.getElementById('popup-view-name').innerText = "Loading...";
            document.getElementById('popup-view-bio').innerText = '';
            document.getElementById('popup-view-age').innerText = '-';
            document.getElementById('popup-view-location').innerText = '-';
            document.getElementById('popup-view-occupation').innerText = '-';
            document.getElementById('popup-view-hometown').innerText = '-';
            document.getElementById('popup-view-language').innerText = '-';
            document.getElementById('popup-view-socials').innerHTML = '';
            document.getElementById('popup-view-interests').innerHTML = '';
            document.getElementById('popup-view-favorites').innerHTML = '';
            document.getElementById('popup-view-travel').innerText = '';

            // Fetch user data
            db.ref('users_public/' + uid).once('value').then(snap => {
                if (snap.exists()) {
                    const user = snap.val();
                    user.uid = uid;
                    renderProfileInModal(user);
                } else {
                    showAlertModal("User not found.");
                    closeProfileModal();
                }
            });
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        function renderProfileInModal(user) {
            // Avatar
            const avatarSeed = user.customAvatar || user.avatarSeed || user.uid;
            drawAvatar('popup-view-avatar', avatarSeed);

            // Basic Info
            const kName = getKindleName(user);
            const dName = user.displayName || 'Anonymous';

            // Badge Logic
            let badgeHtml = '';
            const isDev = (user.uid === 'ukiyo' || user.email === 'ukiyo@rekindle.ink' || dName === 'ukiyo' || dName === 'ukiyo@rekindle.ink');
            const isPro = user.kindlePlus || supporterUsers[dName] || (user.email && supporterUsers[user.email]);

            if (isDev) {
                badgeHtml = '<span class="dev-tag">DEV</span>';
            } else if (isPro) {
                badgeHtml = '<svg class="supporter-crown" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 4L5 18H19L22 4L15 11L12 4L9 11L2 4Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>';
            }

            const fullName = (dName === kName) ? escapeHtml(dName) :
                `${escapeHtml(dName)} <span style="font-size:0.8em; font-weight:normal; color:#666; margin-left:5px;">@${escapeHtml(kName)}</span>`;

            document.getElementById('popup-view-name').innerHTML = badgeHtml + fullName;

            const pronouns = user.pronouns ? `(${escapeHtml(user.pronouns)})` : '';
            const pronunciation = user.pronunciation ? ` ‚Ä¢ <span style="font-style:italic;">"${escapeHtml(user.pronunciation)}"</span>` : '';
            document.getElementById('popup-view-pronouns').innerHTML = `${pronouns}${pronunciation}`;
            document.getElementById('popup-view-bio').innerText = user.bio || '';

            // Details
            if (user.birthday) {
                const age = calculateAge(user.birthday);
                document.getElementById('popup-view-age').innerText = age !== null ? age : '-';
            } else {
                document.getElementById('popup-view-age').innerText = '-';
            }

            document.getElementById('popup-view-location').innerText = user.location || '-';
            document.getElementById('popup-view-occupation').innerText = user.occupation || '-';
            document.getElementById('popup-view-hometown').innerText = user.hometown || '-';
            document.getElementById('popup-view-language').innerText = user.language || '-';

            // Socials
            const socialContainer = document.getElementById('popup-view-socials');
            socialContainer.innerHTML = '';
            if (user.socialLinks) {
                const s = user.socialLinks;
                if (s.goodreads) addSocialLink(socialContainer, 'GR', s.goodreads.includes('http') ? s.goodreads : 'https://www.goodreads.com/search?q=' + encodeURIComponent(s.goodreads));
                if (s.instagram) addSocialLink(socialContainer, 'IG', 'https://instagram.com/' + s.instagram.replace('@', ''));
                if (s.youtube) addSocialLink(socialContainer, 'YT', s.youtube.startsWith('http') ? s.youtube : 'https://youtube.com/@' + s.youtube);
                if (s.twitch) addSocialLink(socialContainer, 'Tw', 'https://twitch.tv/' + s.twitch);
                if (s.pinterest) addSocialLink(socialContainer, 'Pin', 'https://pinterest.com/' + s.pinterest);
                if (s.tumblr) addSocialLink(socialContainer, 'Tbl', 'https://' + s.tumblr + '.tumblr.com');
                if (s.website) addSocialLink(socialContainer, 'Web', s.website.startsWith('http') ? s.website : 'https://' + s.website);
            }

            // Interests
            const tagContainer = document.getElementById('popup-view-interests');
            tagContainer.innerHTML = '';
            if (user.interests) {
                const list = Array.isArray(user.interests) ? user.interests : [user.interests];
                list.forEach(tag => {
                    if (!tag) return;
                    const pill = document.createElement('span');
                    pill.className = 'tag';
                    pill.innerText = tag;
                    tagContainer.appendChild(pill);
                });
            }

            // Favorites
            const favContainer = document.getElementById('popup-view-favorites');
            favContainer.innerHTML = '';
            if (user.favorites) {
                const f = user.favorites;
                if (f.music) renderFavSection(favContainer, 'Music', f.music);
                if (f.tv) renderFavSection(favContainer, 'TV', f.tv);
                if (f.movies) renderFavSection(favContainer, 'Movies', f.movies);
                if (f.games) renderFavSection(favContainer, 'Games', f.games);
                if (f.sports) renderFavSection(favContainer, 'Sports', f.sports);
            }

            // Travel
            document.getElementById('popup-view-travel').innerText = user.travel || '';

            // Message button
            const msgBtn = document.getElementById('popup-message-btn');
            if (msgBtn) {
                msgBtn.onclick = () => {
                    // Open KindleChat with this user's UID and name for faster loading
                    const displayName = user.displayName || 'Anonymous';
                    window.location.href = `kindlechat.html?chat_with_uid=${user.uid}&name=${encodeURIComponent(displayName)}`;
                };
            }
        }

        function addSocialLink(container, text, url) {
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.className = 'social-icon';
            a.style.cssText = 'display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; border:2px solid black; margin:2px; text-decoration:none; color:black; font-weight:bold;';
            a.innerText = text;
            container.appendChild(a);
        }

        function renderFavSection(container, title, text) {
            if (!text) return;
            const div = document.createElement('div');
            div.style.fontSize = '0.9rem';
            div.innerHTML = `<b>${escapeHtml(title)}</b><br><span style="color:#333;">${escapeHtml(text)}</span>`;
            div.style.borderTop = '1px dashed #ccc';
            div.style.paddingTop = '4px';
            container.appendChild(div);
        }

        // ADMIN TOOLS (placeholder for future features)
        function initAdminTools(user) {
            // Admin features have been removed
        }

        function generateRandomUsers(count) {
            const cities = ["Amsterdam", "Berlin", "New York", "Tokyo", "London", "Paris", "Sydney", "Melbourne"];
            const interests = ["Reading", "Coding", "Music", "Travel", "Art", "Gaming", "Coffee", "Cinema", "Writing", "Photography"];
            const names = ["Alex", "Jordan", "Casey", "Riley", "Morgan", "Taylor", "Quinn", "Avery", "Blake", "Cameron"];

            for (let i = 0; i < count; i++) {
                const uid = 'test_' + Math.random().toString(36).substr(2, 9);
                const city = cities[Math.floor(Math.random() * cities.length)];
                const ints = [];
                for (let j = 0; j < 3; j++) {
                    const pick = interests[Math.floor(Math.random() * interests.length)];
                    if (!ints.includes(pick)) ints.push(pick);
                }

                const user = {
                    displayName: names[Math.floor(Math.random() * names.length)] + " " + Math.floor(Math.random() * 1000),
                    location: city,
                    interests: ints,
                    bio: "Auto-generated test user.",
                    avatarSeed: Math.floor(Math.random() * 10000)
                };

                db.ref('users_public/' + uid).set(user);
            }
            showAlertModal(`Generated ${count} test users. Refresh to see them.`);
        }

        // --- DRAW AVATAR ---
        function drawAvatar(canvasId, seed) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Clear
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#000';

            // Check if seed is a custom array
            if (Array.isArray(seed)) {
                // Determine grid size based on array length
                // 64 = 8x8, 256 = 16x16
                const gridSize = Math.sqrt(seed.length);
                const pixelSize = canvas.width / gridSize;

                for (let i = 0; i < seed.length; i++) {
                    if (seed[i] === 1) {
                        const x = i % gridSize;
                        const y = Math.floor(i / gridSize);
                        ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                    }
                }
                return;
            }

            // Procedural Logic (16x16 symmetric with fun patterns)
            let hash = 0;
            const str = String(seed);
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }

            // 16x16 grid, symmetric horizontally
            const gridSize = 16;
            const pixelSize = canvas.width / gridSize;

            // Generate pattern using hash - create face-like symmetric patterns
            for (let x = 0; x < 8; x++) { // Left half only, mirror for right
                for (let y = 0; y < gridSize; y++) {
                    // Use different bits from hash for variety
                    const bitIndex = (x * gridSize + y) % 32;
                    const secondary = ((hash >> 3) ^ (hash << 7)) + (y * 17);
                    const val = ((hash >> bitIndex) ^ (secondary >> (bitIndex % 16))) & 1;

                    // Add some structure - more likely to fill center area (face shape)
                    const distFromCenter = Math.abs(y - 8) + Math.abs(x - 4);
                    const fillChance = distFromCenter < 6 ? val : (val && ((hash >> (x + y)) & 3) === 0);

                    if (fillChance) {
                        ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                        // Mirror to right side
                        ctx.fillRect((gridSize - 1 - x) * pixelSize, y * pixelSize, pixelSize, pixelSize);
                    }
                }
            }
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return "";
            if (typeof text !== 'string') return String(text);
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function calculateAge(dateString) {
            if (!dateString) return null;

            // Try DD/MM/YYYY
            const parts = dateString.split('/');
            let birthDate;
            if (parts.length === 3) {
                // assume DD/MM/YYYY default
                let d = parseInt(parts[0], 10);
                let m = parseInt(parts[1], 10);
                let y = parseInt(parts[2], 10);

                // Support MM/DD/YYYY if user entered Month > 12 in the DD slot? 
                // Wait, standard is DD/MM/YYYY.
                // Input: 8/20/2013 -> parts[0]=8, parts[1]=20. 
                // Here m=20. If m > 12, it's definitely not a month.
                // Swap if d <= 12 (meaning d could be the month).
                if (m > 12 && d <= 12) {
                    const temp = d;
                    d = m;
                    m = temp;
                }

                birthDate = new Date(y, m - 1, d);
            } else {
                // Try YYYY-MM-DD
                birthDate = new Date(dateString);
            }

            if (isNaN(birthDate.getTime())) return null;

            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            // Sanity check
            if (age < 0 || age > 120) return null;
            return age;
        }

        // --- POSTS FEATURE ---
        let postsListener = null;
        let recentPosts = [];
        let isAdminMode = false;
        let openCommentsPosts = new Set(); // Track which posts have comments expanded

        function loadPosts() {
            // Check Admin capability
            if (currentUser && currentUser.email === 'ukiyo@rekindle.ink') {
                const toggler = document.getElementById('admin-toggle-container');
                if (toggler) toggler.style.display = 'block';
            }

            const feed = document.getElementById('posts-feed');
            const loader = document.getElementById('loading-posts');

            if (postsListener) return; // Already listening

            loader.style.display = 'block';
            feed.innerHTML = '';

            const postsRef = db.ref('neighbourhood_posts').limitToLast(50);

            postsListener = postsRef.on('value', snapshot => {
                loader.style.display = 'none';
                feed.innerHTML = '';

                recentPosts = [];
                snapshot.forEach(child => {
                    recentPosts.push({ id: child.key, ...child.val() });
                });

                recentPosts.reverse(); // Newest first

                if (recentPosts.length === 0) {
                    feed.innerHTML = '<div style="text-align:center; color:#666;">No posts yet. Be the first!</div>';
                    return;
                }

                recentPosts.forEach(post => {
                    renderPostItem(post, feed);
                });
            });
        }

        function toggleAdminMode(enabled) {
            isAdminMode = enabled;
            // Rerender list
            const feed = document.getElementById('posts-feed');
            feed.innerHTML = '';
            recentPosts.forEach(post => renderPostItem(post, feed));
        }

        async function renderPostItem(post, container) {
            const div = document.createElement('div');

            // Fetch user info
            let postUser = cachedUsers.find(u => u.uid === post.uid);
            if (!postUser && currentUser && post.uid === currentUser.uid) {
                postUser = myProfile;
                if (postUser) postUser.uid = currentUser.uid;
            }

            let bubbleClass = '';
            if (postUser) {
                const isDev = (post.uid === 'ukiyo' || postUser.email === 'ukiyo@rekindle.ink' || postUser.displayName === 'ukiyo' || postUser.displayName === 'ukiyo@rekindle.ink') || (currentUser && post.uid === currentUser.uid && currentUser.email === 'ukiyo@rekindle.ink');
                const isPro = postUser.kindlePlus || supporterUsers[postUser.displayName] || supporterUsers[postUser.email] || false;
                if (isDev) bubbleClass = 'developer';
                else if (isPro) bubbleClass = 'supporter';
            }

            div.className = 'post-card ' + bubbleClass;
            div.dataset.uid = post.uid; // Add for re-render sync
            div.style.position = 'relative'; // Ensure absolute children are positioned relative to this card

            // Placeholder while loading user
            div.innerHTML = `<div style="padding:10px;">Loading...</div>`;
            container.appendChild(div);

            if (!postUser) {
                try {
                    const snap = await db.ref('users_public/' + post.uid).once('value');
                    postUser = snap.val();
                    if (postUser) postUser.uid = post.uid;
                } catch (e) {
                    console.error(e);
                    postUser = { displayName: 'Unknown', uid: post.uid };
                }
            }

            if (!postUser) postUser = { displayName: 'Unknown', uid: post.uid };

            // Determine styles again after async fetch if needed
            if (bubbleClass === '') {
                const isDev = (post.uid === 'ukiyo' || postUser.email === 'ukiyo@rekindle.ink' || postUser.displayName === 'ukiyo' || postUser.displayName === 'ukiyo@rekindle.ink') || (currentUser && post.uid === currentUser.uid && currentUser.email === 'ukiyo@rekindle.ink');
                const isPro = postUser.kindlePlus || supporterUsers[postUser.displayName] || supporterUsers[postUser.email] || false;
                if (isDev) bubbleClass = 'developer';
                else if (isPro) bubbleClass = 'supporter';
                div.className = 'post-card ' + bubbleClass;
            }

            const kName = getKindleName(postUser);
            let dName = postUser.displayName;
            if (!dName || dName === 'Unknown' || dName === 'Anonymous') {
                dName = kName;
            }

            const avatarSeed = postUser.customAvatar || postUser.avatarSeed || post.uid;
            const date = new Date(post.timestamp);
            const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const avatarId = 'post-av-' + post.id;

            let adminControls = '';
            if (isAdminMode) {
                adminControls = `
                <div style="position:absolute; top:5px; right:5px; display:flex; gap:5px; z-index:10;">
                    <button class="sys-btn" style="padding:2px 5px; font-size:0.7rem;" onclick="editPost('${post.id}')">Edit</button>
                    <button class="sys-btn" style="padding:2px 5px; font-size:0.7rem; background:black; color:white;" onclick="deletePost('${post.id}')">Del</button>
                </div>
                `;
            }

            let displayText = post.text;
            const filterEnabled = localStorage.getItem('rekindle_profanity_filter') !== 'false';
            if (filterEnabled && window.filterBadWords) {
                displayText = window.filterBadWords(displayText);
            }

            let nameBadge = '';
            if (bubbleClass === 'developer') {
                nameBadge = '<span class="dev-tag">DEV</span>';
            } else if (bubbleClass === 'supporter') {
                nameBadge = '<svg class="supporter-crown" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 4L5 18H19L22 4L15 11L12 4L9 11L2 4Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>';
            }

            const handleHtml = (dName === kName) ? '' : `<span class="user-handle">@${escapeHtml(kName)}</span>`;

            div.innerHTML = `
                ${adminControls}
                <div style="display:flex; gap:10px; align-items:flex-start;">
                    <canvas id="${avatarId}" width="48" height="48" style="width:48px; height:48px; border:2px solid black; image-rendering:pixelated; flex-shrink:0; cursor:pointer;"></canvas>
                    <div style="flex:1; min-width:0;">
                         <div style="display:flex; justify-content:space-between; align-items:baseline;">
                            <div style="display:flex; align-items:center; gap:4px; cursor:pointer;" onclick="openUserProfile('${post.uid}')">
                                ${nameBadge}
                                <strong style="font-size:0.95rem;">${escapeHtml(dName)}</strong>
                                ${handleHtml}
                            </div>
                            <small style="color:#666; font-size:0.75rem; margin-right:${isAdminMode ? '70px' : '0'};">${timeStr}</small>
                         </div>
                         <div style="white-space:pre-wrap; font-size:0.9rem; line-height:1.4; margin-top:5px;">${escapeHtml(displayText)}</div>
                    </div>
                </div>
                <!-- COMMENTS SECTION -->
                <div class="comments-section">
                    <span class="comments-toggle" onclick="toggleComments('${post.id}', this)">
                        <svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align: middle; margin-right: 2px; display: inline-block;"><rect x="3" y="3" width="18" height="14" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 17v4l4-4" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        <span class="toggle-text">${openCommentsPosts.has(post.id) ? 'Hide Comments' : 'Comments'}</span><span id="comments-count-${post.id}"></span>
                    </span>
                    <div id="comments-area-${post.id}" style="display:${openCommentsPosts.has(post.id) ? 'block' : 'none'};">
                        <div id="comments-list-${post.id}" class="comments-list"></div>
                        <div class="comment-input-row">
                            <input type="text" id="comment-input-${post.id}" placeholder="Add a comment..." maxlength="200">
                            <button class="sys-btn" onclick="submitComment('${post.id}')">Add</button>
                        </div>
                    </div>
                </div>
            `;

            // Draw Avatar
            setTimeout(() => {
                drawAvatar(avatarId, avatarSeed);
                // click avatar to profile
                const cvs = document.getElementById(avatarId);
                if (cvs) cvs.onclick = () => openUserProfile(post.uid);
            }, 0);

            // Load comments for this post
            const commentsContainer = div.querySelector(`#comments-list-${post.id}`);
            loadComments(post.id, commentsContainer);
        }

        // --- COMMENTS ---
        function toggleComments(postId, toggleEl) {
            const area = document.getElementById('comments-area-' + postId);
            if (!area) return;
            const isHidden = area.style.display === 'none';
            area.style.display = isHidden ? 'block' : 'none';

            if (isHidden) {
                openCommentsPosts.add(postId);
            } else {
                openCommentsPosts.delete(postId);
            }

            const textEl = toggleEl.querySelector('.toggle-text');
            if (textEl) textEl.innerText = isHidden ? 'Hide Comments' : 'Comments';
        }

        function loadComments(postId, specificContainer = null) {
            const listContainer = specificContainer || document.getElementById('comments-list-' + postId);
            if (!listContainer) return;

            db.ref('neighbourhood_posts/' + postId + '/comments').orderByChild('timestamp').on('value', async snapshot => {
                listContainer.innerHTML = '';
                if (!snapshot.exists()) return;

                const comments = [];
                snapshot.forEach(child => {
                    comments.push({ id: child.key, ...child.val() });
                });

                // Update count in toggle
                const countEl = document.getElementById('comments-count-' + postId);
                if (countEl) {
                    countEl.innerText = comments.length > 0 ? ' (' + comments.length + ')' : '';
                }

                // Render each comment
                for (const comment of comments) {
                    await renderComment(comment, postId, listContainer);
                }
            });
        }

        async function renderComment(comment, postId, container) {
            // Fetch user info
            let commUser = cachedUsers.find(u => u.uid === comment.uid);
            if (!commUser && currentUser && comment.uid === currentUser.uid) {
                commUser = myProfile;
            }
            if (!commUser) {
                try {
                    const snap = await db.ref('users_public/' + comment.uid).once('value');
                    commUser = snap.val();
                } catch (e) {
                    commUser = { displayName: 'Unknown' };
                }
            }
            if (!commUser) commUser = { displayName: 'Unknown', uid: comment.uid };

            let kindleName = getKindleName(commUser);
            let displayName = commUser.displayName;
            if (!displayName || displayName === 'Unknown' || displayName === 'Anonymous') {
                displayName = kindleName;
            }

            const date = new Date(comment.timestamp);
            const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Profanity filter
            let displayText = comment.text;
            const filterEnabled = localStorage.getItem('rekindle_profanity_filter') !== 'false';
            if (filterEnabled && window.filterBadWords) {
                displayText = window.filterBadWords(displayText);
            }

            let isDev = (comment.uid === 'ukiyo' || commUser.email === 'ukiyo@rekindle.ink' || commUser.displayName === 'ukiyo' || commUser.displayName === 'ukiyo@rekindle.ink');
            if (!isDev && currentUser && comment.uid === currentUser.uid && currentUser.email === 'ukiyo@rekindle.ink') isDev = true;

            const isPro = commUser.kindlePlus || supporterUsers[displayName] || supporterUsers[commUser.email] || false;

            let nameBadge = '';
            let bubbleClass = '';

            if (isDev) {
                nameBadge = '<span class="dev-tag">DEV</span>';
                bubbleClass = 'developer';
            } else if (isPro) {
                const crownSvg = '<svg class="supporter-crown" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 4L5 18H19L22 4L15 11L12 4L9 11L2 4Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>';
                nameBadge = crownSvg;
                bubbleClass = 'supporter';
            }

            // Admin delete button
            let adminDelBtn = '';
            if (isAdminMode) {
                adminDelBtn = `<button class="sys-btn" style="position:absolute; right:3px; top:3px; padding:1px 4px; font-size:0.6rem; background:black; color:white;" onclick="deleteComment('${postId}', '${comment.id}')">Del</button>`;
            }

            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-item ' + bubbleClass;
            commentDiv.dataset.uid = comment.uid; // Add for re-render sync
            commentDiv.style.position = 'relative';

            const handleHtml = (displayName === kindleName) ? '' : `<span class="user-handle" style="margin-left:5px;">@${escapeHtml(kindleName)}</span>`;

            commentDiv.innerHTML = `
                ${adminDelBtn}
                <div style="display:flex; gap:8px;">
                    <strong style="font-size:0.85rem; display:flex; align-items:center; gap:3px; cursor:pointer;" onclick="openUserProfile('${comment.uid}')">
                        ${nameBadge}
                        ${escapeHtml(displayName)}
                        ${handleHtml}
                    </strong>
                    <small style="color:#666; font-size:0.7rem;">${timeStr}</small>
                </div>
                <div style="margin-top:2px; font-size:0.85rem; line-height:1.3;">${escapeHtml(displayText)}</div>
            `;
            container.appendChild(commentDiv);
        }

        function submitComment(postId) {
            if (!currentUser) { showAlertModal("Please log in to comment."); return; }
            if (!myProfile || !myProfile.displayName || myProfile.displayName === 'Anonymous') { showPublicProfileModal(); return; }

            const input = document.getElementById('comment-input-' + postId);
            const text = input.value.trim();

            if (!text) return;
            if (text.length < 2) { showAlertModal("Comment too short."); return; }
            if (text.length > 200) { showAlertModal("Comment too long (max 200 chars)."); return; }

            input.disabled = true;

            db.ref('neighbourhood_posts/' + postId + '/comments').push({
                uid: currentUser.uid,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                input.value = '';
                input.disabled = false;
            }).catch(err => {
                showAlertModal("Error posting comment: " + err.message);
                input.disabled = false;
            });
        }

        function deleteComment(postId, commentId) {
            showConfirmModal("Delete this comment?", () => {
                db.ref('neighbourhood_posts/' + postId + '/comments/' + commentId).remove()
                    .catch(e => showAlertModal("Delete failed: " + e.message, "Error"));
            });
        }

        // --- RESTRICTIONS & SPAM ---
        function canUserSend(history, currentUserId) {
            // Decay algorithm from KindleChat
            const MAX_SCORE = 3.0;
            const DECAY_RATE = 0.05;
            const SCAN_DEPTH = 50;

            let score = 0;
            if (!history || history.length === 0) return true;

            const limit = Math.min(history.length, SCAN_DEPTH);
            for (let i = 0; i < limit; i++) {
                if (history[i].uid === currentUserId) {
                    let weight = 1.0 - (i * DECAY_RATE);
                    if (weight <= 0) break;
                    score += weight;
                }
            }
            return score < MAX_SCORE;
        }

        function submitPost() {
            if (!currentUser) { showAlertModal("Please log in to post."); return; }

            // CHECK 0: Public Profile with proper name
            if (!myProfile || !myProfile.displayName || myProfile.displayName === 'Anonymous') {
                showPublicProfileModal();
                return;
            }

            const input = document.getElementById('input-post');
            const text = input.value.trim();

            if (!text) return;
            // CHECK 1: Min Word Count
            const wordCount = text.trim().split(/\s+/).length;
            if (wordCount < 10) return showAlertModal("Keep it meaningful! Minimum 10 words.");
            // CHECK 2: Max Length
            if (text.length > 280) { showAlertModal("Message too long (max 280 chars)."); return; }

            // CHECK 3: Back-to-Back
            if (recentPosts.length > 0 && recentPosts[0].uid === currentUser.uid) {
                showAlertModal("No double posting! Please wait for a neighbour to confirm.");
                return;
            }

            // CHECK 4: Spam Algo
            if (!canUserSend(recentPosts, currentUser.uid)) {
                showAlertModal("You're posting too frequently. Please slow down.");
                return;
            }

            const btn = document.querySelector('button[onclick="submitPost()"]');
            if (btn) btn.disabled = true;

            db.ref('neighbourhood_posts').push({
                uid: currentUser.uid,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                input.value = '';
                if (btn) btn.disabled = false;
            }).catch(err => {
                showAlertModal("Error posting: " + err.message);
                if (btn) btn.disabled = false;
            });
        }

        // --- ADMIN ACTIONS ---
        function deletePost(id) {
            showConfirmModal("Are you sure you want to delete this post?", () => {
                db.ref('neighbourhood_posts/' + id).remove()
                    .catch(e => showAlertModal("Delete failed: " + e.message, "Error"));
            });
        }

        function editPost(id) {
            const post = recentPosts.find(p => p.id === id);
            if (!post) return;

            showPromptModal("Edit Post Content:", post.text, (newText) => {
                if (newText !== null && newText.trim() !== "") {
                    db.ref('neighbourhood_posts/' + id).update({ text: newText.trim() })
                        .catch(e => showAlertModal("Update failed: " + e.message, "Error"));
                }
            });
        }

        function showPublicProfileModal() {
            const modal = document.getElementById('public-profile-modal');
            if (modal) modal.style.display = 'flex';
        }
        function closePublicProfileModal() {
            const modal = document.getElementById('public-profile-modal');
            if (modal) modal.style.display = 'none';
        }

        // --- GENERIC ALERT MODAL ---
        function showAlertModal(msg, title = "Alert") {
            const modal = document.getElementById('alert-modal');
            const titleEl = document.getElementById('alert-modal-title');
            const msgEl = document.getElementById('alert-modal-message');

            if (titleEl) titleEl.innerText = title;
            if (msgEl) msgEl.innerText = msg;
            if (modal) modal.style.display = 'flex';
        }

        function closeAlertModal() {
            const modal = document.getElementById('alert-modal');
            if (modal) modal.style.display = 'none';
        }
    </script>
    <!-- PUBLIC PROFILE MODAL -->
    <div id="public-profile-modal" class="modal-overlay"
        style="z-index: 20000; align-items:center; justify-content:center; display:none;">
        <div class="modal-box">
            <h3>Public Profile Required</h3>
            <p>You must have a public profile to post in the neighbourhood.</p>
            <div class="modal-buttons" style="margin-top: 15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="closePublicProfileModal()">OK</button>
            </div>
        </div>
    </div>
    <!-- GENERIC ALERT MODAL -->
    <div id="alert-modal" class="modal-overlay"
        style="z-index: 20002; align-items:center; justify-content:center; display:none;">
        <div class="modal-box">
            <h3 id="alert-modal-title">Alert</h3>
            <p id="alert-modal-message"></p>
            <div class="modal-buttons" style="margin-top: 15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="closeAlertModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div id="confirm-modal" class="modal-overlay"
        style="z-index: 20003; align-items:center; justify-content:center; display:none;">
        <div class="modal-box">
            <h3 data-i18n="modal.confirm_title">Confirmation</h3>
            <p id="confirm-modal-message"></p>
            <div class="modal-buttons" style="margin-top: 15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="onConfirmYes()" data-i18n="btn.yes">Yes</button>
                <button class="sys-btn" onclick="closeConfirmModal()" data-i18n="btn.no">No</button>
            </div>
        </div>
    </div>

    <!-- PROMPT MODAL -->
    <div id="prompt-modal" class="modal-overlay"
        style="z-index: 20004; align-items:center; justify-content:center; display:none;">
        <div class="modal-box">
            <h3 data-i18n="modal.edit_title">Edit</h3>
            <p id="prompt-modal-message"></p>
            <input type="text" id="prompt-modal-input" class="input-field" style="width: 100%; box-sizing: border-box;">
            <div class="modal-buttons" style="margin-top: 15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="onPromptSubmit()" data-i18n="btn.save">Save</button>
                <button class="sys-btn" onclick="closePromptModal()" data-i18n="btn.cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- CITY PICKER MODAL -->
    <div id="city-picker-modal" class="modal-overlay"
        style="z-index: 20000; align-items:center; justify-content:center;">
        <div class="modal-box">
            <h3 data-i18n="neighbourhood.modal.set_city">Set City</h3>
            <input type="text" id="picker-search" data-i18n-placeholder="neighbourhood.ph.search_city"
                placeholder="Search city..." autocomplete="off" class="input-field"
                oninput="handleCitySearch(this.value)">
            <div id="picker-results"
                style="max-height: 150px; overflow-y: auto; text-align: left; border: 1px solid #ccc; margin-top: 5px; display: none;">
            </div>
            <div class="modal-buttons" style="margin-top: 15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="closeCityPicker()" data-i18n="btn.cancel">Cancel</button>
            </div>
        </div>
    </div>
</body>

</html>