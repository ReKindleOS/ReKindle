<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta charset="UTF-8">

    <title data-i18n="app.mastodon.name">Mastodon</title>

    <style>
        /* E-INK COMPATIBILITY */
        * {
            transition: none !important;
            animation: none !important;
        }

        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            font-family: "Geneva", "Verdana", sans-serif;
            background-color: #e5e5e5;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-sizing: border-box;
            user-select: none;
        }

        .window {
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0px black;
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 90%;
            max-width: 650px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1rem;
        }

        .close-box,
        .icon-btn {
            position: absolute;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box {
            left: 10px;
        }

        .title-controls {
            position: absolute;
            right: 10px;
            z-index: 2;
            display: flex;
            align-items: center;
        }

        .icon-btn {
            position: static;
            padding: 0;
        }

        .close-box:active,
        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        /* CONTENT AREA */
        .content {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* LOGIN VIEW - Hidden by default for logic */
        #login-view {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
            background: white;
            z-index: 10;
        }

        input,
        textarea {
            width: 80%;
            max-width: 300px;
            padding: 8px;
            margin-bottom: 10px;
            border: 2px solid black;
            font-family: inherit;
            font-size: 1rem;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            background: white;
            color: black;
            border: 2px solid black;
            cursor: pointer;
            box-shadow: 4px 4px 0 black;
            font-family: inherit;
        }

        button:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 4px 4px 0 black;
        }

        button.btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
            box-shadow: 2px 2px 0 black;
        }

        /* APP VIEWS */
        .app-view {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .scroll-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: white;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            height: 50px;
            border-top: 2px solid black;
            display: none;
            /* Hidden by default until logged in */
            background: white;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
        }

        .nav-item {
            flex-grow: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-right: 1px solid #ccc;
        }

        .nav-item:last-child {
            border-right: none;
        }

        .nav-item:active,
        .nav-item.active {
            background: #eee;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* LIST ITEMS */
        .toot,
        .notification,
        .conversation,
        .account-row {
            border-bottom: 2px solid black;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .toot:last-child,
        .notification:last-child,
        .conversation:last-child,
        .account-row:last-child {
            border-bottom: none;
        }

        .account-row {
            flex-direction: row;
            align-items: center;
        }

        .account-row img {
            width: 32px;
            height: 32px;
            border: 2px solid black;
            margin-right: 10px;
        }

        .toot-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .toot-avatar {
            width: 40px;
            height: 40px;
            border: 2px solid black;
            margin-right: 10px;
            background: #eee;
            object-fit: cover;
            flex-shrink: 0;
        }

        .toot-author {
            font-weight: bold;
            font-size: 1rem;
        }

        .toot-handle {
            font-weight: normal;
            font-size: 0.8rem;
            color: #555;
        }

        .toot-content {
            font-size: 1rem;
            line-height: 1.4;
            word-wrap: break-word;
            margin-bottom: 10px;
        }

        .toot-content p {
            margin: 5px 0;
        }

        .toot-content a {
            color: black;
            text-decoration: underline;
        }

        /* PROFILE */
        .profile-header {
            padding: 20px;
            border-bottom: 2px solid black;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border: 2px solid black;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .profile-name {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .profile-handle {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
        }

        .stat-val {
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #555;
        }

        .sub-tabs {
            display: flex;
            width: 100%;
            border-bottom: 2px solid black;
            background: #ddd;
        }

        .sub-tab {
            flex: 1;
            text-align: center;
            padding: 5px;
            border-right: 1px solid black;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .sub-tab:last-child {
            border-right: none;
        }

        .sub-tab.active {
            background: white;
            font-weight: bold;
        }

        /* Media */
        .media-grid {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .media-item {
            border: 2px solid black;
            margin: 2px;
            max-width: 100%;
            height: auto;
            max-height: 200px;
            object-fit: cover;
        }

        /* Actions */
        .toot-actions {
            display: flex;
            flex-wrap: wrap;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            box-shadow: none;
            padding: 5px 10px 5px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: normal;
        }

        .action-btn:active {
            transform: none;
            background: none;
            color: black;
        }

        .action-btn:hover {
            text-decoration: underline;
        }

        .action-btn span {
            margin-left: 4px;
        }

        .action-btn.active,
        .action-btn.faved,
        .action-btn.boosted {
            color: black;
            font-weight: bold;
        }

        /* Compose */
        #compose-area {
            border-top: 2px solid black;
            padding: 10px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        #compose-input {
            width: 100%;
            max-width: none;
            height: 80px;
            resize: none;
            margin-bottom: 10px;
        }

        #compose-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        #char-count {
            margin-right: 15px;
            font-size: 0.8rem;
            color: #666;
        }

        /* Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #status-msg {
            color: red;
            margin-top: 10px;
            font-weight: bold;
            min-height: 1.2em;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
    </style>
    <link rel="stylesheet" href="css/custom-select.css">

    <!-- Dependencies -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="time.js"></script>
    <script src="theme.js"></script>
    <script src="pro-gate.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/custom-select.js"></script>
</head>

<body>

    <div class="window">
        <!-- TITLE BAR -->
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <button id="title-post-btn" onclick="openCompose()"
                style="display:none; position:absolute; left: 40px; top: 50%; transform: translateY(-50%); z-index:2; margin:0; font-size: 0.8rem; padding: 2px 6px; border: 2px solid black; background: white; cursor: pointer; box-shadow: 2px 2px 0 black; font-weight:bold; font-family:inherit;">New
                Post</button>
            <span class="title-text" data-i18n="app.mastodon.name">Mastodon</span>
            <div class="title-controls">
                <button id="title-logout-btn" onclick="logout()"
                    style="display:none; margin-right: 8px; font-size: 0.8rem; padding: 2px 6px; border: 2px solid black; background: white; cursor: pointer; box-shadow: 2px 2px 0 black; font-weight:bold; font-family:inherit;">Logout</button>
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1"></path>
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="content">
            <!-- LOGIN VIEW -->
            <div id="login-view">
                <h2 data-i18n="app.mastodon.name">Mastodon</h2>
                <p data-i18n="mastodon.login.desc" style="margin-bottom: 20px;">Enter your instance URL and Access
                    Token.</p>
                <input type="text" id="instance-url" data-i18n-placeholder="mastodon.ph.instance"
                    placeholder="Instance URL">
                <input type="password" id="access-token" data-i18n-placeholder="mastodon.ph.token"
                    placeholder="Access Token">
                <button onclick="login()" data-i18n="mastodon.btn.login" id="login-btn">Log In</button>
                <div id="status-msg"></div>
                <p style="font-size: 0.8rem; margin-top: 30px; color: #666; max-width: 300px; line-height: 1.4;">
                    <span data-i18n="mastodon.login.hint">Get a token from your instance's settings.</span>
                </p>
            </div>

            <!-- HOME VIEW -->
            <div id="timeline-view" class="app-view">
                <div id="timeline-list" class="scroll-list"></div>
            </div>

            <!-- TRENDING VIEW -->
            <div id="trending-view" class="app-view">
                <div id="trending-list" class="scroll-list"></div>
            </div>

            <!-- NOTIFICATIONS VIEW -->
            <div id="notifications-view" class="app-view">
                <div id="notifications-list" class="scroll-list"></div>
            </div>

            <!-- MESSAGES VIEW -->
            <div id="messages-view" class="app-view">
                <div id="conversations-list" class="scroll-list"></div>
            </div>

            <!-- PROFILE VIEW -->
            <div id="profile-view" class="app-view">
                <div class="profile-header" id="profile-header">
                    <!-- Populated by JS -->
                </div>
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="switchProfileSubTab('toots')">Posts</div>
                    <div class="sub-tab" onclick="switchProfileSubTab('following')">Following</div>
                    <div class="sub-tab" onclick="switchProfileSubTab('favorites')">Favorites</div>
                </div>
                <div id="profile-content" class="scroll-list"></div>
            </div>

            <!-- COMPOSE MODAL -->
            <div id="compose-modal" class="modal-overlay" style="display:none;">
                <div class="modal-box" style="padding:0; overflow:hidden;">
                    <div class="title-bar">
                        <div class="title-stripes"></div>
                        <div class="close-box" onclick="closeCompose()">X</div>
                        <span class="title-text">New Post</span>
                    </div>
                    <div style="padding:10px; display:flex; flex-direction:column;">
                        <textarea id="compose-input" style="width:100%; height:100px; resize:none; margin-bottom:10px;"
                            data-i18n-placeholder="mastodon.ph.compose" placeholder="What's on your mind?"></textarea>
                        <div id="compose-controls">
                            <span id="char-count" style="margin-right:10px;">0/500</span>
                            <button id="compose-btn" onclick="postToot()" data-i18n="mastodon.btn.post">Post</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div id="bottom-nav" class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('timeline')" title="Home">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <div class="nav-item" onclick="switchTab('trending')" title="Trending">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
            </div>
            <div class="nav-item" onclick="switchTab('messages')" title="Messages">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <div class="nav-item" onclick="switchTab('notifications')" title="Notifications">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
            </div>
            <div class="nav-item" onclick="switchTab('profile')" title="Profile">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
        </div>

        <!-- LOADING OVERLAY -->
        <div id="auth-loading"
            style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:100; align-items:center; justify-content:center; flex-direction:column;">
            <div class="spinner"></div>
            <p>Loading secure data...</p>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const SALT_STRING = 'rekindle-mastodon-salt';

        let instanceUrl = '';
        let accessToken = '';
        let currentUser = null;
        let accountId = null;
        let currentTab = 'timeline';
        let currentProfileSubTab = 'toots';

        // --- INIT ---
        window.onload = () => {
            if (window.I18n) window.I18n.init();
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            if (window.rekindleApplyScale) window.rekindleApplyScale();

            document.getElementById('compose-input').addEventListener('input', updateCharCount);

            rekindleProGate.check((isPro) => {
                if (isPro) {
                    initApp();
                } else {
                    // Not pro, maybe show generic login or limit access
                    showLogin();
                }
            });
        };

        function toggleFullScreen() {
            document.querySelector('.window').classList.toggle('fullscreen');
        }

        function updateCharCount() {
            const len = document.getElementById('compose-input').value.length;
            document.getElementById('char-count').innerText = `${len}/500`;
        }

        function switchTab(tabName) {
            currentTab = tabName;

            // UI Update (Bottom Nav)
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            const tabs = ['timeline', 'trending', 'messages', 'notifications', 'profile'];
            const idx = tabs.indexOf(tabName);
            if (idx >= 0) document.querySelectorAll('.nav-item')[idx].classList.add('active');

            // View Visibility
            document.querySelectorAll('.app-view').forEach(v => v.style.display = 'none');

            if (tabName === 'timeline') {
                document.getElementById('timeline-view').style.display = 'flex';
            } else if (tabName === 'trending') {
                document.getElementById('trending-view').style.display = 'flex';
                loadTrending();
            } else if (tabName === 'notifications') {
                document.getElementById('notifications-view').style.display = 'flex';
                loadNotifications();
            } else if (tabName === 'messages') {
                document.getElementById('messages-view').style.display = 'flex';
                loadConversations();
            } else if (tabName === 'profile') {
                document.getElementById('profile-view').style.display = 'flex';
                loadProfile();
            }
        }

        function switchProfileSubTab(subTab) {
            currentProfileSubTab = subTab;
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            if (subTab === 'toots') document.querySelectorAll('.sub-tab')[0].classList.add('active');
            if (subTab === 'following') document.querySelectorAll('.sub-tab')[1].classList.add('active');
            if (subTab === 'favorites') document.querySelectorAll('.sub-tab')[2].classList.add('active');

            loadProfileContent();
        }

        async function initApp() {
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadEncryptedCredentials(user);
                } else {
                    showLogin();
                }
            });
        }

        function showLogin() {
            document.getElementById('login-view').style.display = 'flex';
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelectorAll('.app-view').forEach(v => v.style.display = 'none');

            document.getElementById('title-logout-btn').style.display = 'none';
            document.getElementById('title-post-btn').style.display = 'none';
        }

        function showApp() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('bottom-nav').style.display = 'flex';

            document.getElementById('title-logout-btn').style.display = 'inline-block';
            document.getElementById('title-post-btn').style.display = 'inline-block';

            showTimeline();
        }

        async function logout() {
            if (currentUser) {
                try {
                    const db = firebase.firestore();
                    await db.collection('users').doc(currentUser.uid).collection('pro_data').doc('mastodon').delete();
                } catch (e) {
                    console.error("Error clearing credentials", e);
                }
            }
            instanceUrl = '';
            accessToken = '';
            accountId = null;
            // currentUser = null; // Keep Firebase user logged in
            showLogin();
        }

        function openCompose() {
            document.getElementById('compose-modal').style.display = 'flex';
            document.getElementById('compose-input').focus();
        }

        function closeCompose() {
            document.getElementById('compose-modal').style.display = 'none';
        }

        // --- ENCRYPTION (AES-GCM) ---
        async function encryptPassword(password, uid) {
            try {
                const encoder = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(uid), { name: 'PBKDF2' }, false, ['deriveKey']);
                const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: encoder.encode(SALT_STRING), iterations: 100000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt']);
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoder.encode(password));
                return btoa(String.fromCharCode(...iv) + String.fromCharCode(...new Uint8Array(encrypted)));
            } catch (e) { return null; }
        }

        async function decryptPassword(encryptedStr, uid) {
            try {
                const encoder = new TextEncoder();
                const data = Uint8Array.from(atob(encryptedStr), c => c.charCodeAt(0));
                const iv = data.slice(0, 12);
                const encrypted = data.slice(12);
                const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(uid), { name: 'PBKDF2' }, false, ['deriveKey']);
                const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: encoder.encode(SALT_STRING), iterations: 100000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['decrypt']);
                const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encrypted);
                return new TextDecoder().decode(decrypted);
            } catch (e) { return null; }
        }

        // --- PERSISTENCE ---
        async function loadEncryptedCredentials(user) {
            const overlay = document.getElementById('auth-loading');
            overlay.style.display = 'flex';
            try {
                const db = firebase.firestore();
                const doc = await db.collection('users').doc(user.uid).collection('pro_data').doc('mastodon').get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.instanceUrl && data.encryptedToken) {
                        try {
                            const decrypted = await decryptPassword(data.encryptedToken, user.uid);
                            if (decrypted) {
                                instanceUrl = data.instanceUrl;
                                accessToken = decrypted;

                                const acc = await verifyCreds();
                                if (acc) {
                                    accountId = acc.id;
                                    showApp();
                                    overlay.style.display = 'none';
                                    return;
                                }
                            }
                        } catch (err) { }
                    }
                }
            } catch (e) { }
            overlay.style.display = 'none';
            showLogin();
        }

        async function saveCredentials(url, token) {
            if (!currentUser) return;
            const encrypted = await encryptPassword(token, currentUser.uid);
            if (!encrypted) return;
            try {
                const db = firebase.firestore();
                await db.collection('users').doc(currentUser.uid).collection('pro_data').doc('mastodon').set({
                    instanceUrl: url,
                    encryptedToken: encrypted,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) { console.error(e); }
        }

        // --- API ---
        async function apiCall(endpoint, method = 'GET', body = null) {
            const opts = {
                method: method,
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
            };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(`${instanceUrl}${endpoint}`, opts);
            if (!res.ok) throw new Error('API Error');
            return res.json();
        }

        async function verifyCreds() {
            try { return await apiCall('/api/v1/accounts/verify_credentials'); } catch (e) { return null; }
        }

        async function login() {
            const urlIn = document.getElementById('instance-url').value.trim();
            const tokenIn = document.getElementById('access-token').value.trim();
            const statusMsg = document.getElementById('status-msg');
            const btn = document.getElementById('login-btn');

            if (!urlIn || !tokenIn) { statusMsg.innerText = "Enter URL and Token."; return; }

            let cleanUrl = urlIn.replace(/\/$/, '');
            if (!cleanUrl.startsWith('http')) cleanUrl = 'https://' + cleanUrl;

            btn.disabled = true;
            statusMsg.innerText = "Verifying...";

            try {
                const response = await fetch(`${cleanUrl}/api/v1/accounts/verify_credentials`, {
                    headers: { 'Authorization': `Bearer ${tokenIn}` }
                });

                if (response.ok) {
                    const acc = await response.json();
                    instanceUrl = cleanUrl;
                    accessToken = tokenIn;
                    accountId = acc.id;
                    await saveCredentials(cleanUrl, tokenIn);

                    showApp();
                } else {
                    statusMsg.innerText = "Authentication failed.";
                }
            } catch (e) {
                statusMsg.innerText = "Connection error.";
            } finally {
                btn.disabled = false;
            }
        }

        // --- TIMELINE ---
        async function showTimeline() {
            switchTab('timeline');
            const list = document.getElementById('timeline-list');
            list.innerHTML = '<div class="spinner"></div>';
            try {
                const toots = await apiCall('/api/v1/timelines/home?limit=20');
                renderToots(toots, list);
            } catch (e) {
                list.innerHTML = `<p style="text-align:center;">Error loading timeline.</p>`;
            }
        }

        // --- TRENDING ---
        async function loadTrending() {
            const list = document.getElementById('trending-list');
            list.innerHTML = '<div class="spinner"></div>';
            try {
                const toots = await apiCall('/api/v1/trends/statuses?limit=20');
                renderToots(toots, list);
            } catch (e) {
                list.innerHTML = `<p style="text-align:center;">Trending not available.</p>`;
            }
        }

        // --- NOTIFICATIONS ---
        async function loadNotifications() {
            const list = document.getElementById('notifications-list');
            list.innerHTML = '<div class="spinner"></div>';
            try {
                const notes = await apiCall('/api/v1/notifications?limit=20');
                renderNotifications(notes, list);
            } catch (e) {
                list.innerHTML = `<p style="text-align:center;">Error loading notifications.</p>`;
            }
        }

        // --- MESSAGES ---
        async function loadConversations() {
            const list = document.getElementById('conversations-list');
            list.innerHTML = '<div class="spinner"></div>';
            try {
                const convos = await apiCall('/api/v1/conversations?limit=20');
                if (!convos.length) {
                    list.innerHTML = '<p style="text-align:center;">No messages.</p>';
                    return;
                }
                list.innerHTML = '';
                convos.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'conversation';
                    const lastMsg = c.last_status ? c.last_status.content : 'Message';
                    const account = c.accounts[0];
                    el.innerHTML = `
                        <div style="font-weight:bold;">${account.display_name} (@${account.acct})</div>
                        <div style="font-size:0.9rem; color:#555;">${lastMsg}</div>
                    `;
                    list.appendChild(el);
                });
            } catch (e) {
                list.innerHTML = `<p style="text-align:center;">Error loading messages.</p>`;
            }
        }

        // --- PROFILE ---
        async function loadProfile() {
            if (!accountId) return;
            const header = document.getElementById('profile-header');
            header.innerHTML = '<div class="spinner"></div>';

            try {
                const acc = await apiCall(`/api/v1/accounts/${accountId}`);
                header.innerHTML = `
                   <img src="${acc.avatar}" class="profile-avatar">
                   <div class="profile-name">${acc.display_name}</div>
                   <div class="profile-handle">@${acc.acct}</div>
                   <div>${acc.note}</div>
                   <div class="profile-stats">
                       <div class="stat-item"><span class="stat-val">${acc.statuses_count}</span> <span class="stat-label">Posts</span></div>
                       <div class="stat-item"><span class="stat-val">${acc.following_count}</span> <span class="stat-label">Following</span></div>
                       <div class="stat-item"><span class="stat-val">${acc.followers_count}</span> <span class="stat-label">Followers</span></div>
                   </div>
                `;
                loadProfileContent();
            } catch (e) {
                header.innerHTML = 'Error loading profile.';
            }
        }

        async function loadProfileContent() {
            const list = document.getElementById('profile-content');
            list.innerHTML = '<div class="spinner"></div>';
            try {
                if (currentProfileSubTab === 'toots') {
                    const toots = await apiCall(`/api/v1/accounts/${accountId}/statuses`);
                    renderToots(toots, list);
                } else if (currentProfileSubTab === 'following') {
                    const accounts = await apiCall(`/api/v1/accounts/${accountId}/following`);
                    renderAccounts(accounts, list);
                } else if (currentProfileSubTab === 'favorites') {
                    const favs = await apiCall('/api/v1/favourites');
                    renderToots(favs, list);
                }
            } catch (e) {
                list.innerHTML = `<p style="text-align:center;">Error loading content.</p>`;
            }
        }

        // --- RENDERERS ---
        function renderToots(toots, container) {
            container.innerHTML = '';
            if (!toots || toots.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px;">No posts found.</p>';
                return;
            }
            toots.forEach(toot => container.appendChild(createTootElement(toot)));
        }

        function renderAccounts(accounts, container) {
            container.innerHTML = '';
            if (!accounts || accounts.length === 0) {
                container.innerHTML = '<p style="text-align:center;">Empty list.</p>';
                return;
            }
            accounts.forEach(acc => {
                const el = document.createElement('div');
                el.className = 'account-row';
                el.innerHTML = `
                    <img src="${acc.avatar}">
                    <div>
                        <div style="font-weight:bold;">${acc.display_name}</div>
                        <div style="font-size:0.8rem;">@${acc.acct}</div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function createTootElement(toot) {
            const el = document.createElement('div');
            el.className = 'toot';

            const displayToot = toot.reblog ? toot.reblog : toot;
            const reblogPrefix = toot.reblog ? `<div style="font-size:0.75rem; color:#666; margin-bottom:5px; margin-left:52px;">üîÅ ${toot.account.display_name} boosted</div>` : '';

            let mediaHtml = '';
            if (displayToot.media_attachments && displayToot.media_attachments.length > 0) {
                mediaHtml = '<div class="media-grid">';
                displayToot.media_attachments.forEach(m => {
                    if (m.type === 'image') mediaHtml += `<img src="${m.preview_url}" class="media-item">`;
                });
                mediaHtml += '</div>';
            }

            const isFaved = displayToot.favourited;
            const isBoosted = displayToot.reblogged;

            el.innerHTML = `
                ${reblogPrefix}
                <div class="toot-header">
                    <img src="${displayToot.account.avatar_static}" class="toot-avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0iI2Y1ZjVmNSI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIi8+PC9zdmc+'">
                    <div>
                        <div class="toot-author">${displayToot.account.display_name}</div>
                        <div class="toot-handle">@${displayToot.account.acct}</div>
                    </div>
                </div>
                <div class="toot-content">${displayToot.content}</div>
                ${mediaHtml}
                <div class="toot-actions">
                    <button class="action-btn ${isFaved ? 'faved' : ''}" onclick="toggleAction('${displayToot.id}', 'favourite', this)">
                        ${isFaved ? '‚òÖ' : '‚òÜ'} <span>${displayToot.favourites_count}</span>
                    </button>
                    <button class="action-btn ${isBoosted ? 'boosted' : ''}" onclick="toggleAction('${displayToot.id}', 'reblog', this)">
                        ${isBoosted ? 'üîÅ' : '‚áÑ'} <span>${displayToot.reblogs_count}</span>
                    </button>
                    <button class="action-btn" onclick="replyTo('${displayToot.id}', '${displayToot.account.acct}')">
                        üí¨ <span>Reply</span>
                    </button>
                </div>
            `;
            el.querySelectorAll('a').forEach(a => a.target = "_blank");
            return el;
        }

        function renderNotifications(notes, container) {
            container.innerHTML = '';
            if (!notes || notes.length === 0) {
                container.innerHTML = '<p style="text-align:center;">No notifications.</p>';
                return;
            }
            notes.forEach(note => {
                const el = document.createElement('div');
                el.className = 'notification';
                let icon = 'üîî'; let text = '';

                if (note.type === 'mention') { icon = 'üí¨'; text = `<strong>${note.account.display_name}</strong> mentioned you`; }
                else if (note.type === 'reblog') { icon = 'üîÅ'; text = `<strong>${note.account.display_name}</strong> boosted`; }
                else if (note.type === 'favourite') { icon = '‚òÖ'; text = `<strong>${note.account.display_name}</strong> favourited`; }
                else if (note.type === 'follow') { icon = 'üë§'; text = `<strong>${note.account.display_name}</strong> followed you`; }

                let contentHtml = '';
                if (note.status) contentHtml = `<div style="font-size:0.9rem; color:#555; margin-top:5px; border-left:2px solid #ccc; padding-left:8px;">${note.status.content}</div>`;

                el.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><span style="font-size:1.2rem; margin-right:10px;">${icon}</span><span>${text}</span></div>${contentHtml}`;
                container.appendChild(el);
            });
        }

        async function toggleAction(id, type, btn) {
            const isFaved = btn.classList.contains('faved');
            const isBoosted = btn.classList.contains('boosted');
            let endpoint = `${instanceUrl}/api/v1/statuses/${id}/${type}`;
            if (type === 'favourite' && isFaved) endpoint = `${instanceUrl}/api/v1/statuses/${id}/unfavourite`;
            if (type === 'reblog' && isBoosted) endpoint = `${instanceUrl}/api/v1/statuses/${id}/unreblog`;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (type === 'favourite') {
                        btn.classList.toggle('faved');
                        btn.innerHTML = (btn.classList.contains('faved') ? '‚òÖ' : '‚òÜ') + ' <span>' + data.favourites_count + '</span>';
                    } else {
                        btn.classList.toggle('boosted');
                        btn.innerHTML = (btn.classList.contains('boosted') ? 'üîÅ' : '‚áÑ') + ' <span>' + data.reblogs_count + '</span>';
                    }
                }
            } catch (e) { }
        }

        function replyTo(id, acct) {
            const input = document.getElementById('compose-input');
            input.value = `@${acct} ` + input.value;
            input.focus();
            document.querySelector('.content').scrollTop = 0;
        }

        async function postToot() {
            const input = document.getElementById('compose-input');
            const btn = document.getElementById('compose-btn');
            const status = input.value.trim();
            if (!status) return;
            btn.disabled = true;
            btn.innerText = "Posting...";

            try {
                await apiCall('/api/v1/statuses', 'POST', { status: status });
                input.value = '';
                updateCharCount();
                closeCompose();
                // Refresh only if on timeline/profile
                if (currentTab === 'timeline') showTimeline();
                btn.innerText = "Post";
            } catch (e) {
                console.error(e);
                const originalText = btn.innerText;
                btn.innerText = "Error";
                setTimeout(() => btn.innerText = "Post", 2000);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>