<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <script>
        (function () {
            var search = window.location.search || '';

            // 1. DETECT MESQUITE (Legacy Kindle / WebKit ~534)
            // Legacy Kindles do not support native Promises. 
            var isMesquite = typeof Promise === "undefined";
            if (isMesquite) {
                document.write('<style>#legacy-overlay { display: -webkit-box !important; display: flex !important; -webkit-box-align: center; -webkit-box-pack: center; z-index: 9999; }</style>');
                var count = 5;
                setInterval(function () {
                    count--;
                    var el = document.getElementById('legacy-countdown');
                    if (el) el.innerHTML = count;
                    if (count <= 0) window.location.href = "https://legacy.rekindle.ink/" + search;
                }, 1000);
                return;
            }

            // 2. DETECT KOBO / LITE DEVICES (Chrome ~44)
            // Chrome ~44 has Promises, but lacks async/await (added in Chrome 55).
            var isLite = false;
            try { eval("async function f(){}"); } catch (e) { isLite = true; }
            if (isLite) { window.location.href = "https://lite.rekindle.ink/" + search; return; }
        })();
    </script>
    <meta charset="UTF-8">

    <title>ReKindle</title>
    <link rel="manifest" href="manifest.json">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>

    <script src="icons.js" defer></script>
    <script src="icons-beta.js" defer></script>
    <script src="theme.js?v=14" defer></script>
    <script src="js/i18n.js" defer></script>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <style>
        /* COMPATIBILITY FIX: Global Animation Kill Switch for E-ink */
        *,
        *::before,
        *::after {
            transition: none !important;
            animation: none !important;
        }

        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --sidebar-width: 220px;
            --active-item: #000000;
            --active-text: #ffffff;
        }

        body {
            /* OPTIMIZATION: Consolidated rendering hints */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #e5e5e5;
            user-select: none;
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dashboard {
            display: flex;
            width: 96%;
            height: 94%;
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-width);
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            flex-shrink: 0;
            /* OPTIMIZATION: Isolate layout reflows */
            contain: content;
        }

        .system-header {
            padding: 15px;
            border-bottom: 2px solid black;
            text-align: center;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .os-title {
            font-size: 1.4rem;
            font-weight: 900;
            letter-spacing: 1px;
            margin: 0;
        }

        .user-info {
            font-size: 0.75rem;
            margin-top: 5px;
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-family: "Times New Roman", serif;
            font-style: italic;
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
        }

        .info-btn:active {
            background: black;
            color: white;
        }

        .nav-menu {
            flex-grow: 1;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 15px;
            border: 2px solid black;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.9rem;
            background: white;
            box-shadow: 2px 2px 0 black;
            margin-bottom: 10px;
        }

        .nav-item:active {
            box-shadow: none;
            background: black;
            color: white;
        }

        .nav-item.active {
            background: black;
            color: white;
            box-shadow: 2px 2px 0 black;
        }

        .nav-item.hidden {
            display: none;
        }

        #exit-btn {
            display: none;
        }

        .app-view {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: white;
            /* OPTIMIZATION: Isolate layout reflows */
            contain: content;
        }

        .view-header {
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 2px solid black;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grid-container {
            display: grid;
            /* Grid Gap IS supported in Chrome 75+ */
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            grid-auto-rows: 90px;
            gap: 15px;
            align-content: start;
        }

        #featured-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            grid-auto-rows: auto;
        }

        #favorites-grid {
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            grid-auto-rows: 90px;
            margin-bottom: 20px;
            border: 2px solid black;
            padding: 15px;
            box-shadow: 4px 4px 0 black;
        }

        #favorites-section {
            margin-bottom: 25px;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-decoration: none;
            color: black;
            cursor: pointer;
            position: relative;
            padding: 12px 5px 0 5px;
            border-radius: 4px;
        }

        .pro-locked {
            position: relative;
        }

        .pro-locked .icon-img-wrap,
        .pro-locked .featured-icon {
            position: relative;
            display: block;
            width: 42px;
            height: 42px;
        }

        .pro-locked .featured-icon {
            width: 40px;
            height: 40px;
        }

        .pro-locked .icon-img-wrap::after,
        .pro-locked .featured-icon::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(45deg, white 25%, transparent 25%),
                linear-gradient(-45deg, white 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, white 75%),
                linear-gradient(-45deg, transparent 75%, white 75%);
            background-size: 3px 3px;
            background-position: 0 0, 0 1.5px, 1.5px -1.5px, -1.5px 0px;
            pointer-events: none;
            z-index: 4;
        }

        .app-icon:active {
            background-color: black;
            color: white;
        }

        .app-icon:active svg {
            stroke: white;
            fill: white;
        }

        .icon-img {
            width: 42px;
            height: 42px;
            margin-bottom: 6px;
        }

        .icon-label {
            font-size: 0.8rem;
            text-align: center;
            font-weight: bold;
            line-height: 1.1;
        }

        .featured-box-container {
            border: 2px solid black;
            background: #fdfdfd;
            box-shadow: 4px 4px 0 black;
            padding: 15px;
            margin-bottom: 25px;
        }

        .featured-box-header {
            font-size: 1rem;
            font-weight: 900;
            border-bottom: 1px solid black;
            margin-bottom: 15px;
            padding-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .featured-card {
            display: flex;
            align-items: center;
            border: 2px solid black;
            padding: 12px;
            background: white;
            text-decoration: none;
            color: black;
            position: relative;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
        }

        .featured-card:active {
            background: black;
            color: white;
            box-shadow: none;
        }

        .featured-card:active svg {
            stroke: white;
        }

        .featured-card:active .featured-sub {
            color: #ccc;
        }

        .featured-icon {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .featured-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .featured-title {
            font-weight: 900;
            font-size: 1rem;
            line-height: 1.1;
        }

        .featured-sub {
            font-size: 0.75rem;
            font-style: italic;
            font-family: serif;
            margin-top: 3px;
            color: #555;
        }

        .beta-label,
        .new-label,
        .disabled-label {
            position: absolute;
            top: -4px;
            right: -8px;
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid black;
            font-weight: bold;
            z-index: 5;
            transform: rotate(10deg);
            box-shadow: 1px 1px 0 black;
        }

        .beta-label {
            background: black;
            color: white;
            box-shadow: 1px 1px 0 white;
        }

        .new-label {
            background: white;
            color: black;
        }

        .disabled-label {
            background: #999;
            color: white;
            font-size: 0.55rem;
        }

        .plus-label {
            position: absolute;
            top: 6px;
            right: 2px;
            background: white;
            color: black;
            font-size: 0.8rem;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid black;
            font-weight: bold;
            z-index: 5;
            box-shadow: 1px 1px 0 black;
            box-sizing: border-box;
            padding-bottom: 2px;
        }

        .favorite-toggle,
        .hide-toggle {
            position: absolute;
            top: 0px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
            display: none;
        }

        .favorite-toggle {
            left: 0px;
        }

        .hide-toggle {
            right: 0px;
        }

        .favorite-toggle.show-toggle,
        .hide-toggle.show-toggle {
            display: block;
        }

        .favorite-toggle svg,
        .hide-toggle svg {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: black;
            stroke-width: 2;
        }

        .favorite-toggle.is-favorite svg {
            fill: black;
            stroke-width: 1;
        }

        .hide-toggle.is-hidden svg {
            fill: black;
            stroke-width: 1;
        }

        .favorite-toggle:active svg,
        .hide-toggle:active svg {
            stroke-width: 1;
            fill: #999;
        }

        svg {
            fill: none;
        }

        .outlined-icon {
            stroke: black;
            stroke-width: 2.2;
            stroke-linecap: square;
            stroke-linejoin: miter;
        }

        @media (max-width: 520px) {
            .dashboard {
                display: grid;
                grid-template-rows: auto 1fr auto;
                grid-template-areas: "header" "main" "footer";
            }

            .sidebar {
                display: contents;
            }

            .system-header {
                grid-area: header;
            }

            .app-view {
                grid-area: main;
                min-height: 0;
            }

            .nav-menu {
                grid-area: footer;
                flex-direction: row;
                justify-content: center;
                padding: 5px;
                height: auto;
                border-top: 2px solid black;
            }

            .nav-menu>.nav-item {
                display: none !important;
            }

            .mobile-only-btn {
                display: block !important;
            }

            .nav-menu div[style*="flex-grow:1"] {
                display: none;
            }

            .nav-item {
                margin-bottom: 0;
                margin-left: 5px;
                margin-right: 5px;
            }
        }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 30px;
            width: 300px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 2px solid black;
            box-sizing: border-box;
            font-family: inherit;
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 8px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 3px 3px 0 black;
            font-family: inherit;
            margin-top: 10px;
        }

        .sys-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(3px, 3px);
        }

        .privacy-link {
            display: block;
            margin-top: 5px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: black;
            text-decoration: underline;
        }

        .mobile-only-btn {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <noscript>
        <style>
            #noscript-overlay {
                display: flex !important;
                z-index: 9999;
            }
        </style>
        <div id="noscript-overlay" class="modal-overlay">
            <div class="modal-box">
                <h2 style="margin-top:0; border-bottom: 2px solid black; padding-bottom:10px;">JavaScript Required</h2>
                <p>This application relies on JavaScript to function correctly.</p>
                <p>Please enable JavaScript in your browser settings and reload the page.</p>
            </div>
        </div>
    </noscript>

    <div id="legacy-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2 style="margin-top:0; border-bottom: 2px solid black; padding-bottom:10px;">Unsupported Device</h2>
            <p>ReKindle only officially supports firmware 5.16.4+ so expect issues.</p>
            <p style="font-size: 0.9rem; margin-top: 15px;">Redirecting to legacy site in <strong
                    id="legacy-countdown">5</strong>s...</p>
        </div>
    </div>

    <div class="dashboard">
        <div class="sidebar">
            <div class="system-header">
                <h1 class="os-title">ReKindle<span id="title-plus"
                        style="vertical-align: super; font-size: 0.6em; display: none;">+</span></h1>
                <div class="user-info" id="user-display" data-i18n="home.guest_mode">Guest Mode</div>
                <div class="info-btn" onclick="openAbout()">i</div>
            </div>

            <div class="nav-menu">
                <div class="nav-item active" id="nav-all" onclick="filterApps('all', this)"
                    data-i18n="home.nav.all_apps">All Apps</div>
                <div class="nav-item" id="nav-essentials" onclick="filterApps('essentials', this)"
                    data-i18n="home.nav.essentials">Essentials</div>
                <div class="nav-item" id="nav-tools" onclick="filterApps('tools', this)" data-i18n="home.nav.tools">
                    Tools</div>
                <div class="nav-item" id="nav-lifestyle" onclick="filterApps('lifestyle', this)"
                    data-i18n="home.nav.lifestyle">Lifestyle</div>
                <div class="nav-item" id="nav-games" onclick="filterApps('games', this)" data-i18n="home.nav.games">
                    Games</div>
                <div class="nav-item" id="nav-two_player" onclick="filterApps('two_player', this)"
                    data-i18n="home.nav.two_player">Two Player Games</div>

                <div style="flex-grow:1"></div>

                <div class="nav-item" onclick="location.href='settings'" data-i18n="home.nav.settings">Settings</div>
                <div class="nav-item" id="auth-btn" onclick="openLogin()" data-i18n="home.nav.login">Log In</div>
                <div class="nav-item" id="exit-btn" onclick="window.close()" data-i18n="home.nav.exit">Exit</div>
            </div>
        </div>

        <div class="app-view">
            <div id="featured-section" class="featured-box-container" style="display:none;">
                <div class="featured-box-header" data-i18n="home.header.featured">Featured</div>
                <div class="grid-container" id="featured-grid"></div>
            </div>

            <div id="favorites-section" style="display:none;">
                <div class="view-header">
                    <span id="favorites-title" data-i18n="home.header.favorites">â˜… Your Favorites</span>
                </div>
                <div class="grid-container" id="favorites-grid"></div>
            </div>

            <div class="view-header">
                <span id="category-title" data-i18n="home.header.all">All Applications</span>
                <div style="display:flex; align-items:center;">
                    <button class="sys-btn" id="reset-btn" onclick="openResetModal()"
                        style="box-shadow: 2px 2px 0 black; display:none; margin-right:10px; font-size:0.8rem;"
                        data-i18n="home.btn.reset">Reset</button>
                    <button class="sys-btn" id="edit-done-btn" onclick="toggleEditMode()"
                        style="box-shadow: 2px 2px 0 black;" data-i18n="home.btn.edit">Edit</button>
                </div>
            </div>

            <div class="grid-container" id="app-grid"></div>
        </div>

        <div id="login-modal" class="modal-overlay" style="z-index: 2000;">
            <div class="modal-box">
                <h2>Login / Register</h2>
                <p id="login-msg" style="font-size:0.8rem; margin-bottom:15px;">Enter your username &amp; password.</p>
                <input type="text" id="username" class="modal-input" placeholder="Username">
                <input type="password" id="password" class="modal-input" placeholder="Password">
                <div style="display: flex; justify-content: center">
                    <button class="sys-btn" onclick="doLogin()">Login</button>
                    <button class="sys-btn" onclick="doRegister()" style="margin-left: 10px">Register</button>
                </div>
                <div style="margin-top:15px;">
                    <button style="border:none; background:none; text-decoration:underline; cursor:pointer;"
                        onclick="closeModal('login-modal')">Cancel</button>
                </div>
            </div>
        </div>

        <div id="logout-modal" class="modal-overlay" style="z-index: 2000;">
            <div class="modal-box">
                <h3>Log Out?</h3>
                <p style="margin-bottom:20px;">Are you sure you want to sign out?</p>
                <div style="display: flex; justify-content: center">
                    <button class="sys-btn" onclick="confirmLogout()">Yes</button>
                    <button class="sys-btn" onclick="closeModal('logout-modal')" style="margin-left: 10px">No</button>
                </div>
            </div>
        </div>

        <div id="about-modal" class="modal-overlay" onclick="closeModal('about-modal')">
            <div class="modal-box" onclick="event.stopPropagation()">
                <div id="logo-container" style="width: 60px; height: 60px; margin: 0 auto;"></div>
                <h1 style="margin-top:5px;">ReKindle</h1>
                <p>Your Kindle Upgraded</p>
                <p style="font-size: 0.8rem; margin-top: 5px;">Made by <a href="https://ukiyomusic.com/links"
                        target="_blank" style="color: black;">Ukiyo</a></p>
                <div style="display: flex; justify-content: center; margin-bottom: 15px">
                    <a href="supporters" class="sys-btn"
                        style="text-decoration:none; box-shadow: 2px 2px 0 black; padding: 5px 10px; font-size: 0.8rem;">Supporters</a>
                    <button class="sys-btn" onclick="openDiscordModal()"
                        style="box-shadow: 2px 2px 0 black; padding: 5px 10px; font-size: 0.8rem;; margin-left: 10px">Discord</button>
                </div>
                <div class="mobile-only-btn" style="border-top: 2px solid black; padding-top: 15px; margin-top: 15px;">
                    <button class="sys-btn" onclick="location.href='settings'"
                        style="width: 100%; margin-bottom: 10px;">Settings</button>
                    <button class="sys-btn" id="modal-auth-btn" onclick="openLogin()" style="width: 100%;">Log
                        In</button>
                </div>
                <p style="font-size: 0.75rem; color: #666; margin-bottom: 5px; margin-top: 15px;">No data is, or ever
                    will be shared or sold by ReKindle.</p>
                <a href="privacy" class="privacy-link">Privacy Policy</a>
                <div style="margin: 15px auto; width: 120px; height: 120px;" id="qr-container"></div>
                <div style="font-size:0.7rem; font-weight:bold; margin-top:5px;">Scan to Donate</div>
                <a href="http://link.rekindle.ink/donate" target="_blank" class="privacy-link"
                    style="margin-top: 0;">Buy me a coffee</a>
                <button class="sys-btn" onclick="closeModal('about-modal')" style="margin-top:15px;">OK</button>
            </div>
        </div>

        <div id="discord-modal" class="modal-overlay" onclick="closeModal('discord-modal')">
            <div class="modal-box" onclick="event.stopPropagation()">
                <h2 style="margin-top:0; border-bottom: 2px solid black; padding-bottom:10px;"
                    data-i18n="discord.modal.title">Join our Discord</h2>
                <div style="margin: 15px auto; width: 150px; height: 150px;">
                    <img src="discord.svg" style="width:100%; height:100%; background:white;"
                        alt="Discord Invite QR Code">
                </div>
                <p style="font-size:0.9rem;">Scan to join the <a href="http://link.rekindle.ink/discord/"
                        target="_blank" style="color: black; text-decoration: underline;"
                        data-i18n="discord.link.text">ReKindle
                        community</a>!</p>
                <button class="sys-btn" onclick="closeModal('discord-modal')"
                    data-i18n="discord.btn.close">Close</button>
            </div>
        </div>

        <div id="generic-modal" class="modal-overlay" style="z-index: 3000;">
            <div class="modal-box">
                <h2 id="generic-title" style="margin-top:0; border-bottom: 2px solid black; padding-bottom:10px;">Notice
                </h2>
                <p id="generic-msg" style="font-size:1.1rem; line-height:1.5; margin: 20px 0;"></p>
                <button class="sys-btn" onclick="closeModal('generic-modal')">OK</button>
            </div>
        </div>

        <div id="reset-modal" class="modal-overlay" style="z-index: 2000;">
            <div class="modal-box">
                <h3>Reset Preferences?</h3>
                <p style="margin-bottom:20px;">This will clear all your favorites and unhide all hidden apps.</p>
                <div style="display: flex; justify-content: center">
                    <button class="sys-btn" onclick="confirmReset()">Yes</button>
                    <button class="sys-btn" onclick="closeModal('reset-modal')" style="margin-left: 10px">No</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Note: Global variables and logic mostly unchanged, specific fixes applied inside functions.
        let currentFilter = 'all';
        let currentUser = null;
        let gamesDisabled = false;
        let favoriteApps = [];
        let hiddenApps = [];

        try {
            const cached = JSON.parse(localStorage.getItem('rekindle_favorites'));
            if (Array.isArray(cached)) {
                favoriteApps = cached || [];
                hiddenApps = [];
            } else if (cached) {
                favoriteApps = cached.favorites || [];
                hiddenApps = cached.hidden || [];
            } else {
                favoriteApps = [];
                hiddenApps = [];
            }
        } catch (e) {
            console.error("Error loading favorites from cache", e);
            favoriteApps = [];
            hiddenApps = [];
        }

        let isEditMode = false;
        let isFirebaseAvailable = false;
        let isPro = (localStorage.getItem('rekindle_is_pro') === 'true');
        const ALLOWED_EXIT_AGENT = "MY_CUSTOM_AGENT";

        let auth, db;
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        window.onload = () => {
            // Safe Check: Wait for deferred Firebase
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    if (db.settings) {
                        try { db.settings({ experimentalForceLongPolling: true, merge: true }); }
                        catch (e) { console.warn("Settings error:", e); }
                    }
                    isFirebaseAvailable = true;
                    console.log("Firebase initialized successfully.");
                } else {
                    console.warn("Firebase SDK not loaded. Running in offline mode.");
                }
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                isFirebaseAvailable = false;
            }

            // MERGE BETA APPS
            if (typeof APPS !== 'undefined' && Array.isArray(APPS) &&
                typeof APPS_BETA !== 'undefined' && Array.isArray(APPS_BETA)) {
                APPS.push(...APPS_BETA);
            }

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('login') === 'true') {
                openLogin();
            }

            checkExitButtonVisibility();
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            gamesDisabled = areGamesDisabled();
            autoDetectScale();

            filterApps('all', document.querySelector('#nav-all'));
            renderAboutContent();
            updateProUI();

            let lastUid = localStorage.getItem('rekindle_uid');

            if (isFirebaseAvailable && auth) {
                auth.onAuthStateChanged(user => {
                    const currentUid = user ? user.uid : null;
                    if (currentUid !== lastUid) {
                        clearServiceWorkerCache();
                        lastUid = currentUid;
                    }

                    if (user) {
                        currentUser = user;
                        localStorage.setItem('rekindle_uid', user.uid);
                        let displayUser = user.email.split('@')[0];
                        if (user.email.endsWith("@rekindle.ink")) {
                            displayUser = user.email.replace("@rekindle.ink", "");
                        }
                        document.getElementById('user-display').innerText = "User: " + displayUser;
                        document.getElementById('auth-btn').innerText = "Log Out";
                        document.getElementById('auth-btn').onclick = openLogoutModal;

                        const modalAuthBtn = document.getElementById('modal-auth-btn');
                        if (modalAuthBtn) {
                            modalAuthBtn.innerText = "Log Out";
                            modalAuthBtn.onclick = openLogoutModal;
                        }

                        closeModal('login-modal');

                        const cachedFavs = localStorage.getItem('rekindle_favorites');
                        if (cachedFavs) {
                            try {
                                const parsed = JSON.parse(cachedFavs);
                                if (Array.isArray(parsed)) {
                                    favoriteApps = parsed;
                                    hiddenApps = [];
                                } else {
                                    favoriteApps = parsed.favorites || [];
                                    hiddenApps = parsed.hidden || [];
                                }
                                renderFavoriteSection();
                            } catch (e) { console.error("Error parsing favorites cache", e); }
                        }
                        monitorUserProfile(user.uid);
                    } else {
                        handleGuestMode();
                    }
                });
            } else {
                handleGuestMode();
                document.getElementById('user-display').innerText = "Offline Mode";
            }
            updateNavVisibility();
        };

        // ... [Helper functions like handleGuestMode, updateNavVisibility, etc. remain unchanged] ...

        function handleGuestMode() {
            const wasPro = isPro;
            isPro = false;
            localStorage.setItem('rekindle_is_pro', isPro.toString());
            localStorage.removeItem('rekindle_uid');

            document.getElementById('user-display').innerText = "Guest Mode";
            document.getElementById('auth-btn').innerText = "Log In";
            document.getElementById('auth-btn').onclick = openLogin;

            const modalAuthBtn = document.getElementById('modal-auth-btn');
            if (modalAuthBtn) {
                modalAuthBtn.innerText = "Log In";
                modalAuthBtn.onclick = openLogin;
            }

            const cached = JSON.parse(localStorage.getItem('rekindle_favorites'));
            if (Array.isArray(cached)) {
                favoriteApps = cached || [];
                hiddenApps = [];
            } else if (cached) {
                favoriteApps = cached.favorites || [];
                hiddenApps = cached.hidden || [];
            } else {
                favoriteApps = [];
                hiddenApps = [];
            }

            if (wasPro) {
                renderAppGrid(currentFilter);
                if (currentFilter === 'all') renderFeaturedSection();
            }
            renderFavoriteSection();
            updateProUI();
        }

        function updateNavVisibility() {
            gamesDisabled = areGamesDisabled();
            const gameNav = document.getElementById('nav-games');
            const twoPlayerNav = document.getElementById('nav-two_player');
            if (gamesDisabled) {
                gameNav.style.display = 'none';
                twoPlayerNav.style.display = 'none';
                if (currentFilter === 'games' || currentFilter === 'two_player') {
                    filterApps('all', document.getElementById('nav-all'));
                }
            } else {
                gameNav.style.display = 'block';
                twoPlayerNav.style.display = 'block';
            }
        }

        function renderAboutContent() {
            const logoContainer = document.getElementById('logo-container');
            if (logoContainer) logoContainer.innerHTML = '<img src="logo.svg" class="keep-white" style="width:100%; height:100%;" alt="ReKindle Logo">';
            const qrContainer = document.getElementById('qr-container');
            if (qrContainer) qrContainer.innerHTML = '<img src="donate.svg" style="width:100%; height:100%;" alt="Donate QR">';
        }

        // ... [Sync functions unchanged] ...

        function syncFavorites() {
            if (!currentUser || !isFirebaseAvailable || !db) return;
            db.collection('users').doc(currentUser.uid).collection('settings').doc('favorites')
                .get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        favoriteApps = data.appIds || [];
                        hiddenApps = data.hiddenIds || [];
                    } else { favoriteApps = []; hiddenApps = []; }
                    const cacheData = { favorites: favoriteApps, hidden: hiddenApps };
                    localStorage.setItem('rekindle_favorites', JSON.stringify(cacheData));
                    localStorage.setItem('rekindle_fav_last_sync', Date.now().toString());
                    renderFavoriteSection();
                    if (currentFilter === 'all') renderAppGrid('all');
                }).catch(err => console.error("Error fetching favorites:", err));
        }

        function syncGeneralSettings(serverTimestamp = null) {
            if (!currentUser || !isFirebaseAvailable || !db) return;
            db.collection('users').doc(currentUser.uid).collection('settings').doc('general').get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.manualLocation) localStorage.setItem('rekindle_location_manual', JSON.stringify(data.manualLocation));
                    if (data.unitSystem) localStorage.setItem('rekindle_unit_system', data.unitSystem);
                    if (data.themeMode) { localStorage.setItem('rekindle_theme_mode', data.themeMode); if (window.rekindleApplyTheme) window.rekindleApplyTheme(); }
                    if (data.disableGames !== undefined) localStorage.setItem('rekindle_disable_games', data.disableGames);
                    if (data.censorProfanity !== undefined) localStorage.setItem('rekindle_censor_profanity', data.censorProfanity);
                    if (data.defaultFullscreen !== undefined) localStorage.setItem('rekindle_default_fullscreen', data.defaultFullscreen);
                    if (data.rotation) { localStorage.setItem('rekindle_rotation', data.rotation); if (window.rekindleApplyRotation) window.rekindleApplyRotation(); }
                    if (data.customPattern && Array.isArray(data.customPattern)) {
                        localStorage.setItem('rekindle_pixel_data', JSON.stringify(data.customPattern));
                        if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
                    }
                    if (serverTimestamp) localStorage.setItem('rekindle_settings_last_sync', serverTimestamp.toString());
                    else localStorage.setItem('rekindle_settings_last_sync', Date.now().toString());
                }
            }).catch(err => console.error("Error fetching general settings:", err));
        }

        function monitorUserProfile(uid) {
            if (!isFirebaseAvailable || !db) return;
            db.collection('users').doc(uid).onSnapshot(doc => {
                const now = Date.now();
                let expires = 0;
                let newProStatus = false;
                let serverFavTimestamp = 0;
                let serverSettingsTimestamp = 0;

                if (doc.exists) {
                    const data = doc.data();
                    if (data.proExpiresAt) {
                        expires = typeof data.proExpiresAt.toMillis === 'function' ? data.proExpiresAt.toMillis() : new Date(data.proExpiresAt).getTime();
                    }
                    newProStatus = (expires > now);
                    if (data.favoritesLastUpdated) {
                        serverFavTimestamp = typeof data.favoritesLastUpdated.toMillis === 'function' ? data.favoritesLastUpdated.toMillis() : new Date(data.favoritesLastUpdated).getTime();
                    }
                    if (data.settingsLastUpdated) {
                        serverSettingsTimestamp = typeof data.settingsLastUpdated.toMillis === 'function' ? data.settingsLastUpdated.toMillis() : new Date(data.settingsLastUpdated).getTime();
                    }
                }

                const wasPro = isPro;
                isPro = newProStatus;
                if (wasPro !== isPro) {
                    localStorage.setItem('rekindle_is_pro', isPro.toString());
                    renderAppGrid(currentFilter);
                    if (currentFilter === 'all') renderFeaturedSection();
                    renderFavoriteSection();
                    updateProUI();
                }

                const localFavTimestamp = parseInt(localStorage.getItem('rekindle_fav_last_sync') || '0');
                if (serverFavTimestamp > localFavTimestamp || localFavTimestamp === 0) {
                    syncFavorites();
                }

                const localSettingsTimestamp = parseInt(localStorage.getItem('rekindle_settings_last_sync') || '0');
                if (serverSettingsTimestamp > localSettingsTimestamp || localSettingsTimestamp === 0) {
                    syncGeneralSettings(serverSettingsTimestamp);
                }
            });
        }

        function toggleFavorite(appId, event) {
            event.preventDefault(); event.stopPropagation();
            if (favoriteApps.includes(appId)) { favoriteApps = favoriteApps.filter(id => id !== appId); }
            else {
                favoriteApps.push(appId);
                favoriteApps.sort((idA, idB) => {
                    const a = APPS.find(app => app.id === idA);
                    const b = APPS.find(app => app.id === idB);
                    if (!a) return 1; if (!b) return -1;
                    return a.name.localeCompare(b.name);
                });
                if (hiddenApps.includes(appId)) hiddenApps = hiddenApps.filter(id => id !== appId);
            }
            saveFavorites(); renderFavoriteSection(); renderAppGrid(currentFilter);
        }

        function toggleHidden(appId, event) {
            event.preventDefault(); event.stopPropagation();
            if (hiddenApps.includes(appId)) { hiddenApps = hiddenApps.filter(id => id !== appId); }
            else {
                hiddenApps.push(appId);
                if (favoriteApps.includes(appId)) favoriteApps = favoriteApps.filter(id => id !== appId);
            }
            saveFavorites(); renderFavoriteSection(); renderAppGrid(currentFilter);
        }

        function saveFavorites() {
            const cacheData = { favorites: favoriteApps, hidden: hiddenApps };
            localStorage.setItem('rekindle_favorites', JSON.stringify(cacheData));
            if (currentUser && isFirebaseAvailable && db) {
                const now = Date.now();
                localStorage.setItem('rekindle_fav_last_sync', (now + 10000).toString());
                const batch = db.batch();
                const userRef = db.collection('users').doc(currentUser.uid);
                const favRef = userRef.collection('settings').doc('favorites');
                batch.set(favRef, { appIds: favoriteApps, hiddenIds: hiddenApps });
                batch.set(userRef, { favoritesLastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                batch.commit().catch(e => console.error("Error saving favorites:", e));
            }
        }

        function renderFavoriteSection() {
            const container = document.getElementById('favorites-section');
            const grid = document.getElementById('favorites-grid');
            grid.innerHTML = '';
            const favApps = favoriteApps.map(id => APPS.find(a => a.id === id)).filter(Boolean);
            const displayApps = gamesDisabled ? favApps.filter(app => app.cat !== 'games' && app.cat !== 'two_player') : favApps;

            if (displayApps.length > 0) {
                container.style.display = 'block';
                const fragment = document.createDocumentFragment();
                displayApps.forEach(app => fragment.appendChild(createAppElement(app)));
                grid.appendChild(fragment);
            } else {
                container.style.display = 'none';
            }
            if (isEditMode) document.getElementById('favorites-section').querySelectorAll('.favorite-toggle').forEach(t => t.classList.add('show-toggle'));
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-done-btn');
            const resetBtn = document.getElementById('reset-btn');
            if (isEditMode) {
                btn.innerText = "Done";
                if (resetBtn) resetBtn.style.display = 'block';
                document.querySelectorAll('.favorite-toggle').forEach(t => t.classList.add('show-toggle'));
                document.querySelectorAll('.hide-toggle').forEach(t => t.classList.add('show-toggle'));
                document.querySelectorAll('.beta-label, .new-label').forEach(l => l.style.display = 'none');
            } else {
                btn.innerText = "Edit";
                if (resetBtn) resetBtn.style.display = 'none';
                document.querySelectorAll('.favorite-toggle').forEach(t => t.classList.remove('show-toggle'));
                document.querySelectorAll('.hide-toggle').forEach(t => t.classList.remove('show-toggle'));
                document.querySelectorAll('.beta-label, .new-label').forEach(l => l.style.display = 'block');
            }
            renderAppGrid(currentFilter);
            renderFavoriteSection();
        }

        function openResetModal() {
            document.getElementById('reset-modal').style.display = 'flex';
        }

        function confirmReset() {
            favoriteApps = [];
            hiddenApps = [];
            saveFavorites();
            renderFavoriteSection();
            renderAppGrid(currentFilter);
            closeModal('reset-modal');
        }

        function createAppElement(app) {
            const a = document.createElement('a');
            a.href = `${app.id}.html`;
            a.className = 'app-icon';
            a.id = `icon-${app.id}`;
            if (app.id === 'discord') { a.onclick = (e) => { e.preventDefault(); openDiscordModal(); }; a.href = "javascript:void(0)"; }

            if (app.disabled) {
                a.onclick = (e) => {
                    e.preventDefault();
                    showGenericModal(app.name + " Unavailable", app.disabledMessage || "This service is currently unavailable.");
                };
                a.href = "javascript:void(0)";
                a.classList.add('pro-locked');
            } else if (app.plus && !isPro) {
                // OPTIMIZATION: Removed 'gap:10px' from inline style (Flex Gap not supported in Chrome 75)
                a.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById('generic-title').style.display = 'none';
                    document.getElementById('generic-msg').innerHTML =
                        `I'm committed to keeping ReKindle ad-free and open. To cover the growing server costs for AI and cloud-based tools, I'm introducing a supporter tier: ReKindle+. Upgrading helps keep development active and unlocks <b>${app.name}</b> & more.<br><br>` +
                        `The basic apps you know and love will remain free.<br><br>` +
                        `Donators check your Ko-Fi inbox for a coupon code.<br><br>` +
                        `<div style="display:flex; flex-wrap:wrap; justify-content:center;">` +
                        `<button class="sys-btn" onclick="location.href='pay.html'" style="margin:5px;">Subscribe Now</button>` +
                        `<button class="sys-btn" onclick="location.href='pay.html?plan=lifetime'" style="margin:5px;">I don't like subscriptions</button>` +
                        `</div>`;
                    document.getElementById('generic-modal').style.display = 'flex';
                };
                a.href = "javascript:void(0)";
                a.classList.add('pro-locked');
            }

            const isFav = favoriteApps.includes(app.id);
            const isHidden = hiddenApps.includes(app.id);
            const showToggleClass = isEditMode && currentFilter !== 'featured' ? 'show-toggle' : '';
            const isFavClass = isFav ? 'is-favorite' : '';
            const isHiddenClass = isHidden ? 'is-hidden' : '';

            if (isHidden) { a.style.opacity = '0.4'; a.style.filter = 'grayscale(100%)'; }

            let extraHtml = `
                <div class="favorite-toggle ${isFavClass} ${showToggleClass}" onclick="toggleFavorite('${app.id}', event)">
                    <svg viewBox="0 0 32 32"><path d="M16 2 L20 12 L30 13 L22 20 L24 30 L16 25 L8 30 L10 20 L2 13 L12 12 Z"/></svg>
                </div>
                <div class="hide-toggle ${isHiddenClass} ${showToggleClass}" onclick="toggleHidden('${app.id}', event)">
                    <svg viewBox="0 0 32 32">
                         <path d="M2 16C2 16 8 6 16 6C24 6 30 16 30 16C30 16 24 26 16 26C8 26 2 16 2 16Z M16 10C12.6863 10 10 12.6863 10 16C10 19.3137 12.6863 22 16 22C19.3137 22 22 19.3137 22 16C22 12.6863 19.3137 10 16 10Z M16 13C17.6569 13 19 14.3431 19 16C19 17.6569 17.6569 19 16 19C14.3431 19 13 17.6569 13 16C13 14.3431 14.3431 13 16 13Z"/>
                         <line x1="2" y1="2" x2="30" y2="30" stroke="black" stroke-width="2" class="slash" style="${isHidden ? '' : 'display:none'}"/>
                    </svg>
                </div>`;

            const showPlus = app.plus && !isPro;
            if (app.beta && !showPlus) extraHtml += `<div class="beta-label">BETA</div>`;
            if (app.newBadge && !showPlus) extraHtml += `<div class="new-label">NEW</div>`;
            if (app.disabled) extraHtml += `<div class="disabled-label">CLOSED</div>`;
            else if (showPlus) extraHtml += `<div class="plus-label">+</div>`;

            const viewBox = app.viewBox || "0 0 32 32";
            const svgClass = app.filled ? 'icon-img' : 'icon-img outlined-icon';

            a.innerHTML = `<span class="icon-img-wrap"><svg class="${svgClass}" viewBox="${viewBox}">${app.icon}</svg></span><span class="icon-label" data-i18n="app.${app.id}.name">${app.name}</span>${extraHtml}`;
            return a;
        }

        // ... [checkExitButtonVisibility, filterApps, renderFeaturedSection, renderAppGrid... unchanged except for Paywall modal fix applied above] ...

        function checkExitButtonVisibility() {
            const btn = document.getElementById('exit-btn');
            if (!btn) return;
            if (navigator.userAgent.indexOf(ALLOWED_EXIT_AGENT) === -1) btn.style.setProperty('display', 'none', 'important');
            else btn.style.setProperty('display', 'block', 'important');
        }

        function filterApps(category, btnElement) {
            updateNavVisibility();
            if (isEditMode) toggleEditMode();
            if (gamesDisabled && (category === 'games' || category === 'two_player')) { category = 'all'; btnElement = document.getElementById('nav-all'); }
            currentFilter = category;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (btnElement) btnElement.classList.add('active');
            const editBtn = document.getElementById('edit-done-btn');
            if (category === 'all') { editBtn.style.display = 'block'; editBtn.innerText = isEditMode ? "Done" : "Edit"; }
            else editBtn.style.display = 'none';

            if (category === 'all') renderFeaturedSection();
            else { document.getElementById('featured-section').style.display = 'none'; document.getElementById('favorites-section').style.display = 'none'; }
            renderAppGrid(category);
        }

        function renderFeaturedSection() {
            const featuredContainer = document.getElementById('featured-section');
            const featuredGrid = document.getElementById('featured-grid');
            featuredContainer.style.display = 'block';
            featuredGrid.innerHTML = '';
            const fragment = document.createDocumentFragment();
            let featuredApps = APPS.filter(a => a.featured);
            if (gamesDisabled) featuredApps = featuredApps.filter(app => app.cat !== 'games' && app.cat !== 'two_player');
            featuredApps.sort((a, b) => (a.featuredOrder || 999) - (b.featuredOrder || 999));

            featuredApps.forEach(app => {
                const a = document.createElement('a');
                a.href = `${app.id}.html`;
                if (app.id === 'discord') { a.onclick = (e) => { e.preventDefault(); openDiscordModal(); }; a.href = "javascript:void(0)"; }
                a.className = 'featured-card';
                const subheading = app.desc || '';
                let badgeHtml = '';
                if (app.plus && !isPro) badgeHtml = '<div class="plus-label" style="right:5px; top:5px;">+</div>';
                else if (app.newBadge) badgeHtml = '<div class="new-label">NEW</div>';

                if (app.plus && !isPro) {
                    // OPTIMIZATION: Removed 'gap:10px' from inline style here as well
                    a.onclick = (e) => {
                        e.preventDefault();
                        document.getElementById('generic-title').style.display = 'none';
                        document.getElementById('generic-msg').innerHTML =
                            `I'm committed to keeping ReKindle ad-free and open. To cover the growing server costs for AI and cloud-based tools, I'm introducing a supporter tier: ReKindle+. Upgrading helps keep development active and unlocks <b>${app.name}</b> & more.<br><br>` +
                            `The basic apps you know and love will remain free.<br><br>` +
                            `Donators check your Ko-Fi inbox for a coupon code.<br><br>` +
                            `<div style="display:flex; flex-wrap:wrap; justify-content:center;">` +
                            `<button class="sys-btn" onclick="location.href='pay.html'" style="margin:5px;">Subscribe Now</button>` +
                            `<button class="sys-btn" onclick="location.href='pay.html?plan=lifetime'" style="margin:5px;">I don't like subscriptions</button>` +
                            `</div>`;
                        document.getElementById('generic-modal').style.display = 'flex';
                    };
                    a.href = "javascript:void(0)";
                    a.classList.add('pro-locked');
                }
                a.innerHTML = `<div class="featured-icon"><svg viewBox="0 0 32 32" style="width:100%;height:100%;">${app.icon}</svg></div><div class="featured-info"><span class="featured-title" data-i18n="app.${app.id}.name">${app.name}</span><span class="featured-sub" data-i18n="app.${app.id}.desc">${subheading}</span></div>${badgeHtml}`;
                fragment.appendChild(a);
            });
            featuredGrid.appendChild(fragment);
            renderFavoriteSection();
        }

        function renderAppGrid(category) {
            const grid = document.getElementById('app-grid');
            grid.innerHTML = '';
            const titles = { all: "All Applications", productivity: "Productivity", essentials: "Essentials", tools: "Tools", lifestyle: "Lifestyle", games: "Games", two_player: "Two Player Games" };
            const fragment = document.createDocumentFragment();

            if (category === 'all') {
                document.getElementById('category-title').innerText = "All Applications";
                let baseList = APPS.filter(a => !a.featured && !favoriteApps.includes(a.id));
                if (!isEditMode) baseList = baseList.filter(a => !hiddenApps.includes(a.id));
                if (gamesDisabled) baseList = baseList.filter(app => app.cat !== 'games' && app.cat !== 'two_player');
                const games = baseList.filter(a => a.cat === 'games' || a.cat === 'two_player');
                const apps = baseList.filter(a => a.cat !== 'games' && a.cat !== 'two_player');
                apps.sort((a, b) => a.name.localeCompare(b.name));
                games.sort((a, b) => a.name.localeCompare(b.name));
                apps.forEach(app => fragment.appendChild(createAppElement(app)));

                if (games.length > 0) {
                    const header = document.createElement('div');
                    header.className = 'view-header';
                    header.style.gridColumn = '1 / -1'; header.style.marginTop = '25px'; header.style.marginBottom = '15px'; header.style.borderBottom = '2px solid black';
                    header.innerHTML = '<span style="font-size: 1.2rem; font-weight: bold;">All Games</span>';
                    fragment.appendChild(header);
                    games.forEach(app => fragment.appendChild(createAppElement(app)));
                }
            } else {
                let filtered = APPS.filter(a => a.cat === category);
                if (!isEditMode) filtered = filtered.filter(a => !hiddenApps.includes(a.id));
                if (gamesDisabled) filtered = filtered.filter(app => app.cat !== 'games' && app.cat !== 'two_player');
                filtered.sort((a, b) => a.name.localeCompare(b.name));
                document.getElementById('category-title').innerText = titles[currentFilter] || "Applications";
                filtered.forEach(app => fragment.appendChild(createAppElement(app)));
            }
            grid.appendChild(fragment);
            if (isEditMode) {
                document.getElementById('app-grid').querySelectorAll('.favorite-toggle').forEach(t => t.classList.add('show-toggle'));
                document.getElementById('app-grid').querySelectorAll('.hide-toggle').forEach(t => t.classList.add('show-toggle'));
                document.getElementById('app-grid').querySelectorAll('.beta-label, .new-label').forEach(l => l.style.display = 'none');
            }
        }

        // ... [Remaining helper functions openLogin, openAbout, etc. unchanged] ...
        function openLogin() { document.getElementById('login-modal').style.display = 'flex'; }
        function openAbout() { document.getElementById('about-modal').style.display = 'flex'; }
        function openDiscordModal() { document.getElementById('discord-modal').style.display = 'flex'; }
        function openLogoutModal() { document.getElementById('logout-modal').style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function showGenericModal(title, message) {
            document.getElementById('generic-title').innerText = title;
            document.getElementById('generic-msg').innerText = message;
            document.getElementById('generic-modal').style.display = 'flex';
        }
        function doLogin() {
            if (!isFirebaseAvailable || !auth) { document.getElementById('login-msg').innerText = "Error: Offline / No Database Connection"; return; }
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (!u || !p) { document.getElementById('login-msg').innerText = "Error: Please enter a valid username and password."; return; }
            const email = u.includes('@') ? u : u + "@rekindle.ink";
            auth.signInWithEmailAndPassword(email, p).catch(e => { document.getElementById('login-msg').innerText = "Error: " + e.message; });
        }
        function isForbiddenUsername(u) { const forbidden = ["ukiyo", "rekindle", "wantban"]; const lowerU = u.toLowerCase(); return forbidden.some(word => lowerU.includes(word)); }
        function doRegister() {
            if (!isFirebaseAvailable || !auth) { document.getElementById('login-msg').innerText = "Error: Offline / No Database Connection"; return; }
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (!u || !p) { document.getElementById('login-msg').innerText = "Error: Please enter a username and password."; return; }
            if (u.includes('@')) { document.getElementById('login-msg').innerText = "Error: Please enter a username only, not an email."; return; }
            if (isForbiddenUsername(u)) { document.getElementById('login-msg').innerText = "Error: Forbidden username."; return; }
            const email = u + "@rekindle.ink";
            auth.createUserWithEmailAndPassword(email, p).catch(e => { document.getElementById('login-msg').innerText = "Error: " + e.message; });
        }
        function confirmLogout() {
            if (isFirebaseAvailable && auth) auth.signOut().catch(e => console.error("Sign out error:", e));
            localStorage.removeItem('rekindle_uid'); localStorage.removeItem('rekindle_favorites');
            closeModal('logout-modal'); location.reload();
        }
        function autoDetectScale() { if (window.rekindleAutoDetectScale) window.rekindleAutoDetectScale(); }
        function updateProUI() {
            const titlePlus = document.getElementById('title-plus');
            if (isPro) { if (titlePlus) titlePlus.style.display = 'inline-block'; }
            else { if (titlePlus) titlePlus.style.display = 'none'; }
        }
    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675" data-utcoffset="11"
        defer></script>
</body>

</html>