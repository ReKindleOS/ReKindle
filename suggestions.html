<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suggestions</title>
    <style>
        /* SYSTEM 7 AESTHETICS (Shared with KindleChat/others) */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: pixelated;
            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 800px;
            /* Slightly wider for lists */
            position: relative;
        }

        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* APP LAYOUT */
        #app-content {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        /* HEADER / TOOLBAR */
        .toolbar {
            padding: 10px;
            border-bottom: 2px solid black;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eee;
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 5px 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sys-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        /* LIST VIEW */
        #suggestion-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .suggestion-item {
            border: 2px solid black;
            padding: 10px;
            background: white;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            box-shadow: 2px 2px 0 #ccc;
        }

        .sugg-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }

        .sugg-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .sugg-meta {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }



        /* DETAIL VIEW */
        #detail-view {
            display: none;
            /* Hidden by default */
            flex-direction: column;
            height: 100%;
        }

        .detail-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            background: white;
        }

        .comment-section {
            border-top: 2px solid black;
            background: #eee;
            padding: 10px;
            height: 40%;
            display: flex;
            flex-direction: column;
        }

        .comment-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            /* Inset look */
            background: #fafafa;
            padding: 5px;
        }

        .comment-item {
            border-bottom: 1px dotted #ccc;
            padding: 5px 0;
            font-size: 0.9rem;
        }

        .comment-author {
            font-weight: bold;
            font-size: 0.8rem;
        }


        .comment-input {
            display: flex;
            align-items: center;
            border: 2px solid black;
            background: white;
            padding: 5px 10px;
            margin-top: 5px;
        }

        /* MODALS */
        #modal-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 2px solid black;
            box-sizing: border-box;
            font-family: inherit;
        }

        #login-overlay {
            display: none;
            position: absolute;
            top: 35px;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 50;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        /* VOTE BUTTON IN DETAIL */
        .vote-btn {
            background: white;
            border: 2px solid black;
            padding: 5px 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            margin-top: 10px;
        }

        .vote-btn.voted {
            background: black;
            color: white;
        }

        .vote-badge {
            background: white;
            color: black;
            border: 2px solid black;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .vote-badge:hover {
            background: #eee;
        }

        .vote-badge.voted {
            background: black;
            color: white;
        }

        /* STATUS BADGE */
        .status-badge {
            background: #999;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
            text-transform: uppercase;
        }

        .problem-badge {
            background: black;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
            text-transform: uppercase;
        }

        .progress-badge {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
            text-transform: uppercase;
        }

        /* TABS */
        .tab-bar {
            display: flex;
            background: #eee;
            border-bottom: 2px solid black;
            padding-left: 10px;
        }

        .tab {
            padding: 8px 15px;
            border: 2px solid black;
            border-bottom: none;
            margin-right: 5px;
            background: #ccc;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            position: relative;
            top: 2px;
            /* Push down to overlap border */
        }

        .tab.active {
            background: #fafafa;
            /* Match app-content bg */
            border-bottom: 2px solid #fafafa;
            /* Hide line */
            z-index: 10;
        }

        .tab:hover:not(.active) {
            background: #ddd;
        }

        /* DONE ITEM STYLE */
        .suggestion-item.done {
            opacity: 0.6;
            background: #f0f0f0;
        }

        .suggestion-item.done .sugg-title {
            text-decoration: line-through;
        }
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text">Suggestions</span>
        </div>

        <!-- MAIN VIEW (LIST) -->
        <div id="app-content">
            <div class="toolbar" id="main-toolbar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-weight:bold;">View:</span>
                    <select id="sort-select" onchange="changeSort()"
                        style="font-family:inherit; font-size:0.8rem; border:2px solid black; padding:3px;">
                        <option value="popular">Popular</option>
                        <option value="newest">Newest</option>
                    </select>
                </div>
                <button class="sys-btn" onclick="openCreateModal()">+ New Idea</button>
            </div>

            <!-- TAB BAR -->
            <div class="tab-bar" id="tab-bar">
                <div class="tab active" onclick="switchTab('suggestion')">Suggestions</div>
                <div class="tab" onclick="switchTab('problem')">Problems</div>
                <div class="tab" onclick="switchTab('done')">Done</div>
            </div>

            <div id="suggestion-list">
                <!-- Items injected here -->
                <div style="text-align:center; padding:20px; color:#666;">Loading...</div>
            </div>

            <!-- DETAIL VIEW (Overlay inside app-content) -->
            <div id="detail-view">
                <div class="toolbar">
                    <button class="sys-btn" onclick="closeDetailView()">← Back</button>
                    <span id="detail-title-bar"
                        style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 60%;">...</span>
                    <div></div> <!-- spacer -->
                </div>

                <div class="detail-content">
                    <h2 id="detail-title" style="margin-top:0;">Title</h2>
                    <div class="sugg-meta" id="detail-meta">by Author</div>
                    <p id="detail-desc" style="white-space: pre-wrap; line-height: 1.5;"></p>

                    <button id="detail-vote-btn" class="vote-btn" onclick="toggleVote()">
                        <span>▲ Upvote</span>
                        <span id="detail-vote-count">0</span>
                    </button>

                    <div style="margin-top:20px; display:flex; justify-content:center; flex-wrap:wrap; gap:10px;">
                        <button id="detail-done-btn" class="vote-btn" onclick="cycleStatus()"
                            style="display:none; background:white; color:black; border:1px solid #ccc;">
                            <span>✓ Status</span>
                        </button>
                        <button id="detail-type-btn" class="vote-btn" onclick="toggleType()" style="display:none;">
                            <span>⇄ Switch Type</span>
                        </button>
                        <button id="detail-cat-btn" class="vote-btn" onclick="openEditCategoryModal()"
                            style="display:none;">
                            <span>✎ Edit Cat</span>
                        </button>
                    </div>
                </div>

                <div class="comment-section">
                    <div style="font-weight:bold; margin-bottom:5px;">Comments</div>
                    <div class="comment-list" id="detail-comments">
                        <!-- comments -->
                    </div>
                    <form class="comment-input" onsubmit="event.preventDefault(); postComment();">
                        <input type="text" id="comment-input" placeholder="Add a comment..." maxlength="200"
                            style="flex:1; border:none; outline:none; background:transparent;">
                        <button type="submit"
                            style="background:transparent; border:none; color:#333; cursor:pointer;">➤</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="login-overlay">
            <h2>Please Log In</h2>
            <p>You need to be logged in to enable suggestions.</p>
            <button class="sys-btn" onclick="window.location.href='index?login=true'">Log In</button>
        </div>
    </div>

    <!-- CREATE MODAL -->
    <div id="modal-overlay">
        <div class="modal-box">
            <h3>New Suggestion</h3>
            <div style="margin-bottom: 10px; display: flex; gap: 15px; justify-content: center;">
                <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    <input type="radio" name="sugg-type" value="suggestion" checked onchange="updateFormFields()">
                    Suggestion
                </label>
                <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    <input type="radio" name="sugg-type" value="problem" onchange="updateFormFields()"> Problem
                </label>
            </div>

            <select id="new-category" class="modal-input" style="margin-bottom:10px;">
                <!-- Populated via JS -->
            </select>

            <input type="text" id="new-device" class="modal-input"
                placeholder="Device (e.g. Kindle Paperwhite 11th Gen)" maxlength="50" style="display:none;">

            <input type="text" id="new-title" class="modal-input" placeholder="Title (e.g. Add Calculator)"
                maxlength="50">
            <textarea id="new-desc" class="modal-input" placeholder="Description..." style="height:100px; resize:none;"
                maxlength="500"></textarea>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="submitSuggestion()">Submit</button>
                <button class="sys-btn" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- MESSAGE MODAL -->
    <div id="msg-modal-overlay"
        style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center;">
        <div class="modal-box" style="width:250px;">
            <h3 id="msg-title" style="margin-top:0;">Message</h3>
            <p id="msg-body">Text</p>
            <button class="sys-btn" onclick="closeMsgModal()" style="margin-top:10px;">OK</button>
        </div>
    </div>

    <!-- ADMIN EDIT CATEGORY MODAL -->
    <div id="edit-cat-overlay"
        style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center;">
        <div class="modal-box" style="width:250px;">
            <h3>Edit Category</h3>
            <select id="edit-cat-select" class="modal-input"></select>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="submitEditCategory()">Save</button>
                <button class="sys-btn"
                    onclick="document.getElementById('edit-cat-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- APP LOGIC ---

        // GLOBAL ERROR HANDLER FOR KINDLE DEBUGGING
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            var string = msg.toLowerCase();
            var substring = "script error";
            if (string.indexOf(substring) > -1) {
                // creating a modal might fail if dom not ready, fallback to alert or console
                console.error('Script Error: See Console for Details');
            } else {
                var message = [
                    'Message: ' + msg,
                    'URL: ' + url,
                    'Line: ' + lineNo,
                    'Column: ' + columnNo,
                    'Error object: ' + JSON.stringify(error)
                ].join(' - ');

                console.error(message);

                // Try to use modal if available
                if (window.showMessage) {
                    window.showMessage("Error", "An unexpected error occurred.");
                } else {
                    // Fallback for very early errors
                    // alert(message);
                }

                // If stuck on loading, show error there
                var listEl = document.getElementById('suggestion-list');
                if (listEl && listEl.innerText.indexOf('Loading...') !== -1) {
                    listEl.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Error Loading App:<br>' + msg + '</div>';
                }
            }
            return false;
        };

        // LOADING TIMEOUT
        setTimeout(function () {
            var listEl = document.getElementById('suggestion-list');
            if (listEl && listEl.innerText.indexOf('Loading...') !== -1) {
                listEl.innerHTML = '<div style="text-align:center; padding:20px;">Taking a while...<br><br><button class="sys-btn" onclick="window.location.reload()">Reload</button></div>';
            }
        }, 15000);

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            let currentUser = null;
            let currentSuggestionId = null;
            let unsubscribeComments = null;

            // AUTH LISTENER
            auth.onAuthStateChanged(function (user) {
                if (user) {
                    currentUser = user;
                    document.getElementById('login-overlay').style.display = 'none';
                    loadSuggestions();
                } else {
                    currentUser = null;
                    document.getElementById('login-overlay').style.display = 'flex';
                }
            });

            // WALLPAPER
            function loadWallpaper() {
                // MATCHING READING.HTML: No sanitization on this read
                const wallpaperImg = localStorage.getItem('rekindle_bg_image');
                const wallpaperSize = localStorage.getItem('rekindle_bg_size');
                if (wallpaperImg) {
                    document.body.style.backgroundImage = wallpaperImg;
                }
                if (wallpaperSize) {
                    document.body.style.backgroundSize = wallpaperSize;
                }
            }

            // Call immediately (like reading.html) and on load
            loadWallpaper();
            window.onload = function () {
                loadWallpaper();
            };

            function sanitizeBackgroundImage(imageString) {
                if (!imageString) return '';
                if (imageString.startsWith('url("data:image/png;base64,')) {
                    return imageString;
                }
                if (imageString.startsWith('url("') && imageString.endsWith('")')) {
                    const url = imageString.substring(5, imageString.length - 2);
                    if ((url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) && !url.includes('javascript:')) {
                        return imageString;
                    }
                }
                return '';
            }

            let allSuggestions = []; // Cache for client-side sorting
            let currentSort = 'popular';
            let currentFilter = 'suggestion'; // Default to suggestions

            window.changeSort = function () {
                currentSort = document.getElementById('sort-select').value;
                renderList();
            };

            window.switchTab = function (tab) {
                currentFilter = tab;
                // Update UI
                document.querySelectorAll('.tab-bar .tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.tab-bar .tab[onclick="switchTab('${tab}')"]`).classList.add('active');
                renderList();
            };

            // LOAD SUGGESTIONS
            function loadSuggestions() {
                db.collection('suggestions').orderBy('createdAt', 'desc').limit(100).onSnapshot(function (snapshot) {
                    allSuggestions = [];
                    snapshot.forEach(function (doc) {
                        var data = doc.data();
                        data.id = doc.id;
                        allSuggestions.push(data);
                    });
                    renderList();
                }, function (error) {
                    console.error("Error loading suggestions:", error);
                    document.getElementById('suggestion-list').innerHTML = '<div style="text-align:center; padding:20px; color:red;">Failed to load suggestions. <br> ' + error.message + '</div>';
                });
            }

            function renderList() {
                const listEl = document.getElementById('suggestion-list');
                listEl.innerHTML = '';

                // FILTER
                const filtered = allSuggestions.filter(function (item) {
                    // If filter is 'done', show only DONE items (any type)
                    if (currentFilter === 'done') {
                        return item.status === 'done';
                    }

                    // If filter is 'suggestion', show type suggestion AND NOT done
                    // If filter is 'problem', show type problem AND NOT done
                    const type = item.type || 'suggestion';
                    const status = item.status || '';

                    if (status === 'done') return false; // Hide done items from main tabs

                    if (currentFilter === 'problem') {
                        return type === 'problem';
                    }
                    // default suggestion
                    return type !== 'problem';
                }); const sorted = [].concat(filtered);

                // Primary Sort: Status (In Progress first, Done last)
                // Secondary Sort: Selected Criteria

                sorted.sort(function (a, b) {
                    // Check status first
                    const statusA = a.status || '';
                    const statusB = b.status || '';

                    // Weights: In Progress (2), Open (1), Done (0)
                    const getWeight = s => {
                        if (s === 'in_progress') return 2;
                        if (s === 'done') return 0; // Though done are in separate tab, good to keep logic
                        return 1;
                    };

                    const wA = getWeight(statusA);
                    const wB = getWeight(statusB);

                    if (wA !== wB) return wB - wA; // Higher weight first

                    // If status same, check criteria
                    if (currentSort === 'popular') {
                        const votesA = (a.upvotes || []).length;
                        const votesB = (b.upvotes || []).length;
                        return votesB - votesA;
                    } else {
                        // Newest
                        // SAFE ACCESS: No optional chaining
                        const tA = (a.createdAt && a.createdAt.seconds) ? a.createdAt.seconds : 0;
                        const tB = (b.createdAt && b.createdAt.seconds) ? b.createdAt.seconds : 0;
                        return tB - tA;
                    }
                });

                sorted.forEach(function (data) {
                    const id = data.id;
                    const voteCount = (data.upvotes || []).length;
                    const isDone = data.status === 'done';
                    const isProgress = data.status === 'in_progress';
                    // SAFE ACCESS: No optional chaining
                    const hasVoted = (data.upvotes || []).includes(currentUser ? currentUser.uid : null);

                    const el = document.createElement('div');
                    el.className = 'suggestion-item' + (isDone ? ' done' : '');
                    el.onclick = function () { openSuggestion(id, data); };


                    // Badge Logic
                    let badgeText = (data.category || (data.type || 'suggestion')).toUpperCase();
                    if (badgeText === 'GENERAL') badgeText = (data.type || 'suggestion').toUpperCase();

                    const isProblem = (data.type === 'problem');
                    let badgeClass = isProblem ? 'problem-badge' : 'status-badge';

                    let badgeStyle = '';
                    if (!isProblem && !isDone && !isProgress) {
                        badgeStyle = 'background:white; color:black; border:1px solid black;';
                    }

                    let statusHtml = '';
                    if (isDone) {
                        statusHtml = '<span class="status-badge">DONE</span>';
                    } else if (isProgress) {
                        statusHtml = '<span class="progress-badge">IN PROGRESS</span>';
                    } else {
                        statusHtml = `<span class="${badgeClass}" style="${badgeStyle}">${badgeText}</span>`;
                    }

                    const voteClass = hasVoted ? 'vote-badge voted' : 'vote-badge';

                    el.innerHTML = `
                    <div class="sugg-header">
                        <div>
                            ${statusHtml}
                            <span class="sugg-title">${escapeHtml(data.title)}</span>
                        </div>
                        <button class="${voteClass}" onclick="event.stopPropagation(); toggleVote('${id}')">▲ ${voteCount}</button>
                    </div>
                    <div style="font-size:0.9rem; margin-bottom:5px; height: 1.2em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${escapeHtml(data.description)}
                    </div>
                    <div class="sugg-meta">by ${escapeHtml(data.authorName || 'Anon')}</div>
                `;
                    listEl.appendChild(el);
                });

                if (sorted.length === 0) {
                    listEl.innerHTML = '<div style="text-align:center; padding:20px;">No suggestions yet. Be the first!</div>';
                }
            }

            // OPEN DETAIL
            window.openSuggestion = function (id, data) {
                currentSuggestionId = id;
                document.getElementById('detail-view').style.display = 'flex';
                document.getElementById('suggestion-list').style.display = 'none'; // Hide list
                document.getElementById('main-toolbar').style.display = 'none';
                document.getElementById('tab-bar').style.display = 'none'; // Hide tabs

                document.getElementById('detail-title').textContent = data.title;
                document.getElementById('detail-title-bar').textContent = data.title;
                document.getElementById('detail-desc').textContent = data.description;

                let dateStr = 'Unknown Date';
                // SAFE ACCESS: No optional chaining
                if (data.createdAt && data.createdAt.toDate) {
                    dateStr = new Date(data.createdAt.toDate()).toLocaleDateString();
                }

                let metaText = `by ${data.authorName || 'Anonymous'} • ${dateStr}`;
                if (data.device) {
                    metaText += ` • Device: ${data.device}`;
                }

                document.getElementById('detail-meta').textContent = metaText;

                updateVoteBtn(data.upvotes || []);
                updateAdminControls(data);
                loadComments(id);
            };

            window.updateAdminControls = function (data) {
                // Simple check for "ukiyo" in email
                // Security is handled by rules, this adds UI convenience
                const isAdmin = currentUser && currentUser.email && currentUser.email.startsWith('ukiyo');
                const btnDone = document.getElementById('detail-done-btn');
                const btnType = document.getElementById('detail-type-btn');
                const btnCat = document.getElementById('detail-cat-btn');

                if (isAdmin) {
                    btnDone.style.display = 'inline-flex';
                    btnType.style.display = 'inline-flex';
                    btnCat.style.display = 'inline-flex';

                    // Done Button logic (Cycle: Open -> In Progress -> Done -> Open)
                    const status = data.status || '';
                    const span = btnDone.querySelector('span');

                    if (status === 'done') {
                        span.textContent = '✓ Done'; // Next: Open
                        btnDone.style.background = '#ccc';
                        btnDone.style.color = 'black';
                    } else if (status === 'in_progress') {
                        span.textContent = '➜ In Progress'; // Next: Done
                        btnDone.style.background = '#007bff';
                        btnDone.style.color = 'white';
                    } else {
                        span.textContent = '☐ Open'; // Next: In Progress
                        btnDone.style.background = 'white';
                        btnDone.style.color = 'black';
                    }

                    // Type Button
                    const currentType = data.type || 'suggestion';
                    if (currentType === 'problem') {
                        btnType.querySelector('span').textContent = '⇄ To Suggestion';
                    } else {
                        btnType.querySelector('span').textContent = '⇄ To Problem';
                    }

                } else {
                    btnDone.style.display = 'none';
                    btnType.style.display = 'none';
                    btnCat.style.display = 'none';
                }
            };

            window.cycleStatus = function () {
                if (!currentSuggestionId || !currentUser) return;

                const docRef = db.collection('suggestions').doc(currentSuggestionId);

                db.runTransaction(function (transaction) {
                    return transaction.get(docRef).then(function (doc) {
                        if (!doc.exists) throw "Document does not exist";

                        const currentStatus = doc.data().status || '';
                        let newStatus = '';

                        if (currentStatus === 'done') {
                            newStatus = null; // Open
                        } else if (currentStatus === 'in_progress') {
                            newStatus = 'done';
                        } else {
                            newStatus = 'in_progress';
                        }

                        transaction.update(docRef, { status: newStatus });
                        return newStatus;
                    });
                }).then(function (newStatus) {
                    updateLocalItem(currentSuggestionId, { status: newStatus });
                    closeDetailView();
                }).catch(function (err) {
                    console.error("Status update failed", err);
                    showMessage("Error", "Failed to update status.");
                });
            };

            window.openEditCategoryModal = function () {
                if (!currentSuggestionId) return;

                // Find current item
                let item = null;
                for (var i = 0; i < allSuggestions.length; i++) {
                    if (allSuggestions[i].id === currentSuggestionId) {
                        item = allSuggestions[i];
                        break;
                    }
                }
                if (!item) return;

                const type = item.type || 'suggestion';
                const currentCat = item.category || 'General';

                const sel = document.getElementById('edit-cat-select');
                sel.innerHTML = '';

                let opts = [];
                if (type === 'suggestion') {
                    opts = ['General', 'App Suggestion', 'Game Suggestion', 'Feature Suggestion', 'Other'];
                } else {
                    opts = ['General', 'Visual Problem', 'Technical Problem', 'Performance Issue', 'Accessibility Problem', 'Other'];
                }

                opts.forEach(function (o) {
                    const op = document.createElement('option');
                    op.value = o;
                    op.text = o;
                    if (o === currentCat) op.selected = true;
                    sel.appendChild(op);
                });

                document.getElementById('edit-cat-overlay').style.display = 'flex';
            };

            window.submitEditCategory = function () {
                if (!currentSuggestionId) return;
                const newCat = document.getElementById('edit-cat-select').value;

                db.collection('suggestions').doc(currentSuggestionId).update({
                    category: newCat
                }).then(function () {
                    document.getElementById('edit-cat-overlay').style.display = 'none';
                    updateLocalItem(currentSuggestionId, { category: newCat });
                }).catch(function (err) {
                    console.error(err);
                    showMessage("Error", "Failed to update category.");
                });
            };

            window.toggleType = function () {
                if (!currentSuggestionId || !currentUser) return;

                const docRef = db.collection('suggestions').doc(currentSuggestionId);

                db.runTransaction(function (transaction) {
                    return transaction.get(docRef).then(function (doc) {
                        if (!doc.exists) {
                            throw "Document does not exist!";
                        }

                        const currentType = doc.data().type || 'suggestion';
                        const newType = (currentType === 'problem') ? 'suggestion' : 'problem';

                        // Reset category to General when switching type to avoid mismatches
                        transaction.update(docRef, { type: newType, category: 'General' });
                        return newType;
                    });
                }).then(function (newType) {
                    updateLocalItem(currentSuggestionId, { type: newType, category: 'General' });
                    // Close detail view because item might disappear from current list
                    closeDetailView();
                    // Optional: Switch tab to follow the item?
                    // switchTab(newType); 
                }).catch(function (err) {
                    console.error("Type update failed", err);
                    showMessage("Error", "Failed to update type. Are you Ukiyo?");
                });
            };

            function updateLocalItem(id, updates) {
                for (var i = 0; i < allSuggestions.length; i++) {
                    if (allSuggestions[i].id === id) {
                        var item = allSuggestions[i];
                        for (var key in updates) {
                            item[key] = updates[key];
                        }
                        // If we are currently viewing this item, update controls
                        if (currentSuggestionId === id) {
                            updateAdminControls(item);
                        }
                        break;
                    }
                }
                renderList();
            }

            window.closeDetailView = function () {
                document.getElementById('detail-view').style.display = 'none';
                document.getElementById('suggestion-list').style.display = 'flex';
                document.getElementById('main-toolbar').style.display = 'flex';
                document.getElementById('tab-bar').style.display = 'flex';
                currentSuggestionId = null;
                if (unsubscribeComments) unsubscribeComments();
            };

            // VOTE LOGIC
            window.updateVoteBtn = function (upvotes) {
                const btn = document.getElementById('detail-vote-btn');
                const countSpan = document.getElementById('detail-vote-count');
                const count = upvotes.length;
                const hasVoted = currentUser && upvotes.includes(currentUser.uid);

                countSpan.textContent = count;
                if (hasVoted) {
                    btn.classList.add('voted');
                    btn.querySelector('span').textContent = '▼ Remove Upvote';
                } else {
                    btn.classList.remove('voted');
                    btn.querySelector('span').textContent = '▲ Upvote';
                }
            };

            window.toggleVote = function (id) {
                const targetId = id || currentSuggestionId;
                if (!targetId || !currentUser) return;

                const docRef = db.collection('suggestions').doc(targetId);

                db.runTransaction(function (transaction) {
                    return transaction.get(docRef).then(function (doc) {
                        if (!doc.exists) {
                            throw "Document does not exist!";
                        }

                        let upvotes = doc.data().upvotes || [];
                        if (upvotes.includes(currentUser.uid)) {
                            upvotes = upvotes.filter(function (uid) { return uid !== currentUser.uid; });
                        } else {
                            upvotes.push(currentUser.uid);
                        }

                        transaction.update(docRef, { upvotes: upvotes });
                        return upvotes;
                    });
                }).then(function (newUpvotes) {
                    if (targetId === currentSuggestionId) {
                        updateVoteBtn(newUpvotes);
                    }
                }).catch(function (err) { console.error("Vote failed", err); });
            };


            // COMMENTS
            function loadComments(id) {
                const list = document.getElementById('detail-comments');
                list.innerHTML = 'Loading comments...';

                unsubscribeComments = db.collection('suggestions').doc(id).collection('comments')
                    .orderBy('createdAt', 'asc')
                    .onSnapshot(function (snapshot) {
                        list.innerHTML = '';
                        snapshot.forEach(function (doc) {
                            const c = doc.data();
                            const el = document.createElement('div');
                            el.className = 'comment-item';
                            el.innerHTML = `
                            <span class="comment-author">${escapeHtml(c.authorName)}:</span>
                            <span>${escapeHtml(c.text)}</span>
                        `;
                            list.appendChild(el);
                        });
                        // Auto scroll to bottom
                        list.scrollTop = list.scrollHeight;
                    });
            }

            window.postComment = function () {
                const inp = document.getElementById('comment-input');
                const text = inp.value.trim();
                if (!text || !currentSuggestionId || !currentUser) return;

                db.collection('suggestions').doc(currentSuggestionId).collection('comments').add({
                    text: text,
                    authorName: currentUser.displayName || currentUser.email.split('@')[0],
                    authorUid: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                inp.value = '';
            };

            // SUBMIT SUGGESTION
            window.openCreateModal = function () {
                document.getElementById('modal-overlay').style.display = 'flex';
                updateFormFields(); // Init fields
                document.getElementById('new-title').focus();
            };

            window.updateFormFields = function () {
                const radios = document.getElementsByName('sugg-type');
                let type = 'suggestion';
                for (var i = 0; i < radios.length; i++) {
                    if (radios[i].checked) {
                        type = radios[i].value;
                        break;
                    }
                }

                const catSelect = document.getElementById('new-category');
                catSelect.innerHTML = '';

                const deviceInput = document.getElementById('new-device');

                if (type === 'suggestion') {
                    const opts = ['General', 'App Suggestion', 'Game Suggestion', 'Feature Suggestion', 'Other'];
                    opts.forEach(function (o) {
                        const op = document.createElement('option');
                        op.value = o;
                        op.text = o;
                        catSelect.appendChild(op);
                    });
                    deviceInput.style.display = 'none';
                } else {
                    const opts = ['General', 'Visual Problem', 'Technical Problem', 'Performance Issue', 'Accessibility Problem', 'Other'];
                    opts.forEach(function (o) {
                        const op = document.createElement('option');
                        op.value = o;
                        op.text = o;
                        catSelect.appendChild(op);
                    });
                    deviceInput.style.display = 'block';
                }
            };

            window.closeModal = function () {
                document.getElementById('modal-overlay').style.display = 'none';
                document.getElementById('new-title').value = '';
                document.getElementById('new-desc').value = '';
            };

            window.submitSuggestion = function () {
                const title = document.getElementById('new-title').value.trim();
                const desc = document.getElementById('new-desc').value.trim();
                const category = document.getElementById('new-category').value;
                const device = document.getElementById('new-device').value.trim();

                const radios = document.getElementsByName('sugg-type');
                let type = 'suggestion';
                for (var i = 0; i < radios.length; i++) {
                    if (radios[i].checked) {
                        type = radios[i].value;
                        break;
                    }
                }

                if (!title || !desc) {
                    showMessage("Missing Info", "Please fill in title and description.");
                    return;
                }

                if (type === 'problem' && !device) {
                    showMessage("Missing Info", "Please specify your device for problems.");
                    return;
                }


                // Logic moved to earlier in function for validation
                // const radios = ... 

                db.collection('suggestions').add({
                    title: title,
                    description: desc,
                    type: type,
                    category: category,
                    device: (type === 'problem') ? device : null,
                    authorUid: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email.split('@')[0],
                    upvotes: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(function () {
                    closeModal();
                }).catch(function (err) {
                    console.error(err);
                    showMessage("Error", "Error submitting. Content too long?");
                });
            };

            // MODAL SYSTEM
            window.showMessage = function (title, text) {
                document.getElementById('msg-title').textContent = title;
                document.getElementById('msg-body').textContent = text;
                document.getElementById('msg-modal-overlay').style.display = 'flex';
            };

            window.closeMsgModal = function () {
                document.getElementById('msg-modal-overlay').style.display = 'none';
            };

            // UTILS
            function escapeHtml(text) {
                if (!text) return "";
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

        } catch (e) {
            console.error("CRITICAL INIT ERROR", e);
            document.body.innerHTML = '<div style="padding:20px;">CRITICAL ERROR: ' + e.message + '</div>';
        }

    </script>

</body>

</html>