<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta charset="UTF-8">

    <title>AI Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            font-family: "Courier New", Courier, monospace;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            /* Background managed by settings */

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
            font-family: "Geneva", sans-serif;
        }

        /* CLOSE BUTTON (HOME) */
        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* CONTROLS */
        .controls {
            position: absolute;
            right: 10px;
            z-index: 1;
            background: white;
            display: flex;
        }

        .controls>*+* {
            margin-left: 10px;
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 4px 10px;
            font-family: "Geneva", sans-serif;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
        }

        .sys-btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* CHAT AREA */
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
            display: flex;
            flex-direction: column;
        }

        #chat-history>*+* {
            margin-top: 20px;
        }

        .message {
            line-height: 1.5;
            font-size: 1.1rem;
            max-width: 90%;
        }

        .message.user {
            align-self: flex-end;
            text-align: right;
            font-weight: bold;
        }

        .message.user::before {
            content: "> ";
        }

        .message.ai {
            align-self: flex-start;
            text-align: left;
        }

        /* INPUT AREA */
        .input-area {
            border-top: 2px solid black;
            padding: 10px;
            display: flex;
            background: #eee;
        }

        .input-area>*+* {
            margin-left: 10px;
        }

        textarea {
            flex-grow: 1;
            border: 2px solid black;
            padding: 10px;
            font-family: inherit;
            font-size: 1.1rem;
            resize: none;
            height: 50px;
        }

        #send-btn {
            height: 74px;
            /* Match textarea height + padding */
            width: 80px;
            font-size: 1.2rem;
        }

        /* Formatted Code Blocks */
        pre {
            white-space: pre-wrap;
            background: #eee;
            padding: 10px;
            border: 1px solid black;
            font-size: 0.9rem;
        }

        /* MODAL SYSTEM */
        #settings-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 2px solid black;
            font-family: inherit;
            box-sizing: border-box;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 15px 0;
            text-align: left;
        }

        /* Model Selector Under Titlebar */
        #model-selector-bar {
            display: flex;
            overflow-x: auto;
            border-bottom: 2px solid black;
            padding: 5px;
            background: #eee;
            font-size: 0.8rem;
            align-items: center;
            justify-content: center;
        }

        #model-selector-bar button {
            margin-right: 8px;
            /* Replaces gap: 8px */
            white-space: nowrap;
        }

        #model-selector-bar select {
            font-size: 0.8rem;
            padding: 2px 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
        }
    </style>
    <link rel="stylesheet" href="css/custom-select.css">
    <script src="time.js"></script>
    <script src="theme.js"></script>
    <script src="pro-gate.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/custom-select.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>

            <span class="title-text" data-i18n="app.title">AI Assistant</span>

            <div class="controls">
                <button class="sys-btn" onclick="openSettings()" style="margin-right:5px;"
                    data-i18n="btn.settings">Settings</button>
                <button class="sys-btn" onclick="clearChat()" data-i18n="btn.clear">Clear</button>
            </div>
        </div>

        <!-- MODEL SELECTOR BAR -->
        <div id="model-selector-bar">
            <span id="model-provider-label" style="font-weight:bold; color:#666;" data-i18n="label.gemini">Gemini</span>
            <select id="quick-model-select" onchange="quickUpdateModel()"></select>
        </div>

        <div id="chat-history">
            <!-- Chat starts empty -->
        </div>

        <div class="input-area">
            <textarea id="user-input" placeholder="Ask a question..."
                data-i18n-placeholder="input.placeholder"></textarea>
            <button id="send-btn" class="sys-btn" onclick="sendMessage()" disabled="" data-i18n="btn.send">Send</button>
        </div>
        <div id="message-counter"
            style="text-align:center; font-size:0.8rem; padding:5px; background:#eee; border-top:1px solid #ccc; color:#666;">
            Loading quota...
        </div>

        <!-- PAYWALL OVERLAY -->
        <div id="paywall-overlay"
            style="display:none; position:absolute; top:35px; left:0; width:100%; height:calc(100% - 35px); background:rgba(255,255,255,0.98); z-index:500; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box;">
            <h2 style="margin-top:0;" data-i18n="paywall.title">ReKindle+</h2>
            <p data-i18n-html="paywall.desc">Support ReKindle development and get<br>access to exclusive apps.</p>
            <button class="sys-btn" onclick="window.location.href='pay.html'" data-i18n="btn.subscribe">Subscribe /
                Login</button>
            <p style="font-size:0.8rem; margin-top:20px; color:#666;" id="paywall-status" data-i18n="status.checking">
                Checking subscription...</p>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal">
            <div class="modal-box">
                <h3 style="margin-top:0; border-bottom:2px solid black; padding-bottom:10px;"
                    data-i18n="settings.title">Settings</h3>

                <div class="setting-row">
                    <label for="byo-toggle" style="font-weight:bold;" data-i18n="settings.custom_key">Use Custom AI
                        Key</label>
                    <input type="checkbox" id="byo-toggle" onchange="toggleByoKey()" style="width:20px; height:20px;">
                </div>

                <!-- ALERT MODAL -->
                <div id="alert-modal"
                    style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:2000; align-items:center; justify-content:center; flex-direction:column;">
                    <div class="modal-box">
                        <p id="alert-message" style="margin:20px 0;">Message</p>
                        <button class="sys-btn" onclick="closeAlert()">OK</button>
                    </div>
                </div>

                <!-- PRO REQUIRED MODAL -->
                <div id="pro-required-modal"
                    style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:2001; align-items:center; justify-content:center; flex-direction:column;">
                    <div class="modal-box" style="text-align:center;">
                        <h3 style="margin-top:0;" data-i18n="settings.pro_required">Pro Required</h3>
                        <p style="margin:20px 0;" data-i18n="settings.pro_msg">Saving custom API keys requires a
                            ReKindle+ subscription.</p>
                        <button class="sys-btn"
                            onclick="document.getElementById('pro-required-modal').style.display='none'">OK</button>
                    </div>
                </div>

                <div id="ai-provider-settings"
                    style="display:none; background:#eee; padding:5px; border:1px solid #ccc; margin-top:5px;">
                    <div class="setting-row" style="margin:5px 0;">
                        <strong style="font-size:0.8rem;" data-i18n="settings.provider">Provider</strong>
                        <select id="ai-provider-select" onchange="updateAiProviderUI()"
                            style="font-size:0.8rem; padding:2px;">
                            <option value="gemini">Google Gemini</option>
                            <option value="openai">OpenAI</option>
                        </select>
                    </div>


                    <div class="setting-row" style="margin:5px 0;">
                        <strong style="font-size:0.8rem;" data-i18n="settings.model">Model</strong>
                        <div style="display: flex; align-items: center">
                            <select id="ai-model-select" onchange="saveSettings()"
                                style="font-size:0.8rem; padding:2px; max-width:150px;">
                                <!-- Options populated by JS -->
                            </select>
                            <button class="sys-btn" onclick="fetchModels(true)"
                                style="font-size:0.7rem; padding:2px 5px;; margin-left: 5px"
                                title="Fetch latest models using API Key">↻</button>
                        </div>
                    </div>

                    <!-- GEMINI KEY -->
                    <div id="gemini-key-section">
                        <label style="font-size:0.8rem;">Gemini Key:</label>
                        <input type="password" id="ai-api-key" class="modal-input" placeholder="AIMz..."
                            style="margin:5px 0;">
                    </div>

                    <!-- OPENAI KEY -->
                    <div id="openai-key-section" style="display:none;">
                        <label style="font-size:0.8rem;">OpenAI Key:</label>
                        <input type="password" id="openai-api-key" class="modal-input" placeholder="sk-..."
                            style="margin:5px 0;">
                    </div>
                </div>
                <p style="font-size:0.7rem; color:#666; margin-top:5px;">
                    Key is stored locally. <a href="https://aistudio.google.com/app/apikey" target="_blank">Get Gemini
                        Key</a> / <a href="https://platform.openai.com/api-keys" target="_blank">Get OpenAI Key</a>
                </p>

                <div style="margin-top: 20px; display: flex; justify-content: center">
                    <button class="sys-btn" onclick="saveSettings()" data-i18n="settings.save">Save</button>
                    <button class="sys-btn" onclick="closeSettings()" data-i18n="settings.cancel"
                        style="margin-left: 10px">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // TODO: Replace with your Cloudflare Worker URL
        const WORKER_URL = "https://rekindle-oracle.timjarnott.workers.dev";
        const DAILY_MESSAGE_LIMIT = 10;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        let isPro = false;
        let dailyMessageCount = null; // Loading state (null = loading, -1 = error, >=0 = count)
        let currentUserId = null;

        // Get today's date string for tracking (YYYY-MM-DD)
        function getTodayString() {
            const now = window.rekindleGetZonedDate ? window.rekindleGetZonedDate() : new Date();
            return now.toISOString().split('T')[0];
        }

        // --- SETTINGS LOGIC ---
        let useByoKey = false;
        let customApiKey = "";
        let aiProvider = "gemini";
        let aiModel = "";
        let openAiKey = "";

        const AI_MODELS = {
            gemini: [],
            openai: []
        };

        // Custom Models Cache
        let customModels = {
            gemini: [],
            openai: []
        };

        function openSettings() {
            // Load from storage
            useByoKey = localStorage.getItem('chat_use_byo_key') === 'true';
            customApiKey = localStorage.getItem('chat_custom_api_key') || "";
            aiProvider = localStorage.getItem('chat_ai_provider') || "gemini";
            aiModel = localStorage.getItem('chat_ai_model') || "";
            openAiKey = localStorage.getItem('chat_openai_key') || "";

            try {
                const cm = JSON.parse(localStorage.getItem('chat_custom_models') || '{}');
                if (cm.gemini) customModels.gemini = cm.gemini;
                if (cm.openai) customModels.openai = cm.openai;
            } catch (e) { }

            document.getElementById('byo-toggle').checked = useByoKey;

            // Set fields
            document.getElementById('ai-provider-select').value = aiProvider;

            updateAiProviderUI(aiModel); // Populate models and set visibility

            document.getElementById('ai-api-key').value = customApiKey;
            document.getElementById('openai-api-key').value = openAiKey;

            toggleByoKey(); // Ensure top-level visibility
            updateQuickModelBar(); // Update the top bar
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function toggleByoKey() {
            const isChecked = document.getElementById('byo-toggle').checked;
            document.getElementById('ai-provider-settings').style.display = isChecked ? 'block' : 'none';
            // Update global immediately for UI checks
            useByoKey = isChecked;
            updateMessageCounter();
        }

        function updateQuickModelBar() {
            const bar = document.getElementById('model-selector-bar');

            // Only show if BYO Key is enabled AND a key is present
            let hasKey = false;
            if (aiProvider === 'openai' && openAiKey) hasKey = true;
            if (aiProvider === 'gemini' && customApiKey) hasKey = true;

            if (useByoKey && hasKey) {
                bar.style.display = 'flex';
                document.getElementById('model-provider-label').innerText = (aiProvider === 'openai' ? 'OpenAI' : 'Gemini');

                // Populate quick select
                const select = document.getElementById('quick-model-select');
                select.innerHTML = '';

                // Ensure custom models loaded
                try {
                    const cm = JSON.parse(localStorage.getItem('chat_custom_models') || '{}');
                    if (cm.gemini) customModels.gemini = cm.gemini;
                    if (cm.openai) customModels.openai = cm.openai;
                } catch (e) { }

                const models = (customModels[aiProvider] && customModels[aiProvider].length > 0)
                    ? customModels[aiProvider]
                    : (AI_MODELS[aiProvider] || []);

                models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.innerText = m.name;
                    select.appendChild(opt);
                });

                // Set value
                if (aiModel && models.find(m => m.id === aiModel)) {
                    select.value = aiModel;
                } else if (models.length > 0) {
                    select.value = models[0].id;
                }

            } else {
                bar.style.display = 'none';
            }
        }

        function quickUpdateModel() {
            const val = document.getElementById('quick-model-select').value;
            aiModel = val;
            localStorage.setItem('chat_ai_model', aiModel);

            // Also update firebase if logged in (lazy sync)
            if (currentUserId) {
                const db = firebase.firestore();
                db.collection('users').doc(currentUserId).collection('privateSettings').doc('ai').set({
                    model: aiModel
                }, { merge: true });
            }
        }

        function updateAiProviderUI(selectedModel) {
            const provider = document.getElementById('ai-provider-select').value;
            const modelSelect = document.getElementById('ai-model-select');

            // Populate Model Dropdown
            modelSelect.innerHTML = '';

            // Use custom models if available, otherwise defaults
            let models = (customModels[provider] && customModels[provider].length > 0)
                ? customModels[provider]
                : (AI_MODELS[provider] || []);

            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.innerText = m.name;
                modelSelect.appendChild(opt);
            });

            // Set selected model if valid for provider, else default to first
            if (selectedModel && models.find(m => m.id === selectedModel)) {
                modelSelect.value = selectedModel;
            } else if (models.length > 0) {
                modelSelect.value = models[0].id;
            }

            // Show/Hide sections based on provider
            if (provider === 'openai') {
                document.getElementById('gemini-key-section').style.display = 'none';
                document.getElementById('openai-key-section').style.display = 'block';
            } else {
                document.getElementById('gemini-key-section').style.display = 'block';
                document.getElementById('openai-key-section').style.display = 'none';
            }
        }

        async function fetchModels(alertUser = false, specificProvider = null, specificKey = null) {
            const provider = specificProvider || document.getElementById('ai-provider-select').value || aiProvider;

            let key = specificKey;
            if (!key) {
                if (provider === 'openai') {
                    const domEl = document.getElementById('openai-api-key');
                    key = domEl ? domEl.value.trim() : openAiKey;
                } else {
                    const domEl = document.getElementById('ai-api-key');
                    key = domEl ? domEl.value.trim() : customApiKey;
                }
            }

            if (!key) {
                if (alertUser) showAlert("Please enter an API Key first.");
                return;
            }

            if (alertUser) {
                const btn = document.querySelector('button[title="Fetch latest models using API Key"]');
                if (btn) btn.innerText = "...";
            }

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'list_models',
                        provider: provider,
                        apiKey: key
                    })
                });

                const data = await response.json();

                if (data.models && data.models.length > 0) {
                    customModels[provider] = data.models;
                    localStorage.setItem('chat_custom_models', JSON.stringify(customModels));

                    // Only update UI if settings modal is open or we need to refresh the quick bar
                    const modelSelect = document.getElementById('ai-model-select');
                    if (modelSelect && modelSelect.offsetParent !== null) {
                        updateAiProviderUI(modelSelect.value);
                    }
                    updateQuickModelBar();

                    if (alertUser) showAlert("Models updated successfully!");
                } else if (data.error) {
                    throw new Error(data.error.message || "Unknown error");
                } else {
                    throw new Error("No models returned.");
                }

            } catch (e) {
                console.error(e);
                if (alertUser) showAlert("Error fetching models: " + e.message);
            } finally {
                if (alertUser) {
                    const btn = document.querySelector('button[title="Fetch latest models using API Key"]');
                    if (btn) btn.innerText = "↻";
                }
            }
        }

        function saveSettings() {
            const isChecked = document.getElementById('byo-toggle').checked;
            const provider = document.getElementById('ai-provider-select').value;
            const model = document.getElementById('ai-model-select').value;
            const key = document.getElementById('ai-api-key').value.trim();
            const oKey = document.getElementById('openai-api-key').value.trim();

            useByoKey = isChecked;
            aiProvider = provider;
            aiModel = model;
            customApiKey = key;
            openAiKey = oKey;

            // Save Local
            localStorage.setItem('chat_use_byo_key', useByoKey);
            localStorage.setItem('chat_custom_api_key', customApiKey);
            localStorage.setItem('chat_ai_provider', aiProvider);
            localStorage.setItem('chat_ai_model', aiModel);
            localStorage.setItem('chat_openai_key', openAiKey);

            updateQuickModelBar();
            updateMessageCounter();

            // Save to Firestore (Pro Only for keys)
            if (currentUserId) {
                const db = firebase.firestore();
                // Pro Data (Keys)
                db.collection('users').doc(currentUserId).collection('pro_data').doc('chat').set({
                    apiKey: key,
                    openaiKey: oKey,
                    provider: provider,
                    model: model,
                    useByoKey: isChecked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }).then(() => {
                    closeSettings();
                }).catch(error => {
                    console.error("Save failed:", error);
                    closeSettings();
                });
            } else {
                closeSettings();
            }
        }

        // Settings Modal Controls
        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
            // Reload from Firestore to revert any unsaved changes
            loadSettingsFromFirebase();
        }

        function showAlert(msg) {
            document.getElementById('alert-message').innerText = msg;
            document.getElementById('alert-modal').style.display = 'flex';
        }

        function closeAlert() {
            document.getElementById('alert-modal').style.display = 'none';
        }

        async function loadSettingsFromFirebase() {
            if (!currentUserId) return;
            try {
                const db = firebase.firestore();
                // Load from Pro Data (Keys)
                const doc = await db.collection('users').doc(currentUserId).collection('pro_data').doc('chat').get();

                if (doc.exists) {
                    const data = doc.data();

                    // Refresh globals
                    useByoKey = data.useByoKey || false;
                    customApiKey = data.apiKey || "";
                    aiProvider = data.provider || "gemini";
                    aiModel = data.model || "";
                    openAiKey = data.openaiKey || "";


                    updateQuickModelBar();
                    updateMessageCounter();

                    // Auto-fetch if we have keys
                    if (useByoKey) {
                        if (aiProvider === 'gemini' && customApiKey) fetchModels(false, 'gemini', customApiKey);
                        if (aiProvider === 'openai' && openAiKey) fetchModels(false, 'openai', openAiKey);
                    }

                } else {
                    // No cloud settings (or not Pro) - Reset to defaults/empty
                    useByoKey = false;
                    customApiKey = "";
                    aiProvider = "gemini";
                    aiModel = "";
                    openAiKey = "";
                    updateQuickModelBar();
                    updateMessageCounter();
                }
            } catch (e) {
                console.error("Error loading settings (likely not Pro or network)", e);
                // Safe defaults
                useByoKey = false;
                customApiKey = "";
                openAiKey = "";
                updateQuickModelBar();
                updateMessageCounter();
            }
        }

        // Load daily message count from Firestore
        async function loadDailyMessageCount() {
            if (!currentUserId) return;
            const db = firebase.firestore();
            const today = getTodayString();

            try {
                const doc = await db.collection('users').doc(currentUserId)
                    .collection('chatLimits').doc(today).get();

                if (doc.exists) {
                    dailyMessageCount = doc.data().count || 0;
                } else {
                    dailyMessageCount = 0;
                }
                updateMessageCounter();
            } catch (e) {
                console.error("Error loading message count:", e);
                dailyMessageCount = -1; // Error marker
                updateMessageCounter();
            }
        }

        // Increment and save message count
        async function incrementMessageCount() {
            if (!currentUserId) return false;
            const db = firebase.firestore();
            const today = getTodayString();

            try {
                await db.collection('users').doc(currentUserId)
                    .collection('chatLimits').doc(today).set({
                        count: firebase.firestore.FieldValue.increment(1),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                dailyMessageCount++;
                updateMessageCounter();
                return true;
            } catch (e) {
                console.error("Error saving message count:", e);
                return false;
            }
        }

        // Update the counter display
        function updateMessageCounter() {
            const counterEl = document.getElementById('message-counter');
            const sendBtn = document.getElementById('send-btn');
            if (counterEl) {
                if (useByoKey) {
                    counterEl.style.display = 'none';
                    if (sendBtn) sendBtn.disabled = false;
                } else {
                    counterEl.style.display = 'block';
                    if (dailyMessageCount === null) {
                        counterEl.innerText = "Loading quota...";
                        counterEl.style.color = '#666';
                        if (sendBtn) sendBtn.disabled = true;
                    } else if (dailyMessageCount === -1) {
                        counterEl.innerText = "Error loading quota. Refresh to try again.";
                        counterEl.style.color = '#cc0000';
                        if (sendBtn) sendBtn.disabled = true;
                    } else {
                        const remaining = DAILY_MESSAGE_LIMIT - dailyMessageCount;
                        counterEl.innerText = `${remaining}/${DAILY_MESSAGE_LIMIT} messages left today`;
                        counterEl.style.color = remaining <= 3 ? '#cc0000' : '#666';
                        if (sendBtn) sendBtn.disabled = remaining <= 0;
                    }
                }
            }
        }

        function checkSubscription() {
            const overlay = document.getElementById('paywall-overlay');
            const status = document.getElementById('paywall-status');
            const sendBtn = document.getElementById('send-btn');

            // 1. CACHE CHECK (Instant)
            try {
                const cachedExpiry = localStorage.getItem('rekindle_pro_expiry');
                if (cachedExpiry && parseInt(cachedExpiry) > Date.now()) {
                    isPro = true;
                    // Optimistically hide overlay / unlock features
                    overlay.style.display = 'none';
                } else {
                    // If no cache or expired, maybe show overlay? 
                    // For now, we wait for Firebase to confirm unless we want to be strict.
                    // But user asked for "instant verification".
                }
            } catch (e) { console.warn("Cache error", e); }

            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const db = firebase.firestore();

                if (db.settings) {
                    try {
                        db.settings({
                            experimentalForceLongPolling: true,
                            merge: true
                        });
                    } catch (e) { console.warn("Settings error:", e); }
                }

                const auth = firebase.auth();

                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUserId = user.uid;

                        // Load AI Settings
                        loadSettingsFromFirebase();

                        // Timeout fallback in case Firestore query hangs
                        const timeoutId = setTimeout(() => {
                            // Only warn if we haven't already verified via cache
                            if (!isPro) {
                                console.warn("Subscription check timed out");
                                status.innerText = "Verification timed out. Please refresh.";
                                overlay.style.display = 'flex';
                            }
                        }, 10000);

                        db.collection('users').doc(user.uid).get()
                            .then(doc => {
                                clearTimeout(timeoutId);
                                if (doc.exists) {
                                    const data = doc.data();
                                    const now = Date.now();
                                    let expires = 0;
                                    if (data.proExpiresAt) {
                                        expires = typeof data.proExpiresAt.toMillis === 'function'
                                            ? data.proExpiresAt.toMillis()
                                            : new Date(data.proExpiresAt).getTime();
                                    }

                                    // Always load usage for logged in users
                                    loadDailyMessageCount();

                                    // UPDATE CACHE
                                    if (expires > now) {
                                        localStorage.setItem('rekindle_pro_expiry', expires.toString());
                                    } else {
                                        localStorage.removeItem('rekindle_pro_expiry');
                                    }

                                    if (expires > now) {
                                        // UNLOCKED - Pro
                                        isPro = true;
                                        // Load daily message count for the user
                                        loadDailyMessageCount();
                                        overlay.style.display = 'none';
                                    } else {
                                        // LOCKED - Expired
                                        isPro = false;
                                        status.innerText = expires > 0 ? "Subscription expired." : "Subscription required.";
                                        overlay.style.display = 'flex';
                                    }
                                } else {
                                    // User exists but no data? Locked.
                                    isPro = false;
                                    status.innerText = "Subscription required.";
                                    overlay.style.display = 'flex';
                                }
                            })
                            .catch(e => {
                                clearTimeout(timeoutId);
                                if (!isPro) {
                                    console.error("Error checking sub", e);
                                    status.innerText = "Error verifying. Try again.";
                                    overlay.style.display = 'flex';
                                }
                            });
                    } else {
                        // Not logged in
                        status.innerText = "Please log in.";
                        overlay.style.display = 'flex';
                        if (sendBtn) sendBtn.disabled = true;
                        localStorage.removeItem('rekindle_pro_expiry');
                    }
                });
            } else {
                status.innerText = "Error: Firebase not loaded.";
                overlay.style.display = 'flex';
            }
        }


        // --- INIT ---
        function waitForFirebase(callback, attempts = 0) {
            if (typeof firebase !== 'undefined') {
                callback();
            } else if (attempts < 50) {
                // Retry every 100ms for up to 5 seconds
                setTimeout(() => waitForFirebase(callback, attempts + 1), 100);
            } else {
                // Give up after 5 seconds
                const overlay = document.getElementById('paywall-overlay');
                const status = document.getElementById('paywall-status');
                status.innerText = "Error: Firebase failed to load.";
                overlay.style.display = 'flex';
            }
        }

        // Initialize settings on load
        function initSettings() {
            // Load from storage
            useByoKey = localStorage.getItem('chat_use_byo_key') === 'true';
            customApiKey = localStorage.getItem('chat_custom_api_key') || "";
            aiProvider = localStorage.getItem('chat_ai_provider') || "gemini";
            aiModel = localStorage.getItem('chat_ai_model') || "";
            openAiKey = localStorage.getItem('chat_openai_key') || "";

            // Load Custom Models
            try {
                const cm = JSON.parse(localStorage.getItem('chat_custom_models') || '{}');
                if (cm.gemini) customModels.gemini = cm.gemini;
                if (cm.openai) customModels.openai = cm.openai;
            } catch (e) { }

            // Apply to UI (Hidden Checkbox needs to be set for toggleByoKey to work if called)
            const byoToggle = document.getElementById('byo-toggle');
            if (byoToggle) byoToggle.checked = useByoKey;

            // Trigger UI updates
            toggleByoKey();
            updateQuickModelBar();

            // Note: updateMessageCounter is called by toggleByoKey
        }

        window.onload = () => {
            initSettings();
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            waitForFirebase(checkSubscription);

            // Enter key to send
            document.getElementById('user-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        };

        // --- WALLPAPER LOADER ---

        // --- CHAT LOGIC ---
        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            const text = inputEl.value.trim();

            if (!text) return;

            // Check daily message limit (Skip if Custom Key)
            if (!useByoKey && dailyMessageCount >= DAILY_MESSAGE_LIMIT) {
                addMessage("You've reached your daily limit of " + DAILY_MESSAGE_LIMIT + " messages. Please try again tomorrow.", 'ai');
                return;
            }

            // Validation Check
            if (WORKER_URL.includes("your-worker-name")) {
                addMessage("System Error: Worker URL not configured in code.", 'ai');
                return;
            }

            // 1. Add User Message
            addMessage(text, 'user');
            inputEl.value = '';

            // 2. Show Loading
            const loadingId = addMessage("Thinking...", 'ai');

            // 3. API Call via Proxy
            try {
                const payload = { prompt: text };

                if (useByoKey) {
                    payload.provider = aiProvider; // 'gemini' or 'openai'
                    payload.model = aiModel;
                    if (aiProvider === 'openai') {
                        payload.apiKey = openAiKey;
                    } else {
                        payload.apiKey = customApiKey;
                    }
                }

                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // Remove loading message
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                if (data.error) {
                    addMessage("Error: " + (data.error.message || "Unknown worker error"), 'ai');
                } else if (data.text) {
                    addMessage(data.text, 'ai');
                    // Increment message count only if NOT using BYO Key
                    if (!useByoKey) {
                        await incrementMessageCount();
                    }
                } else {
                    addMessage("Error: Empty response from Oracle.", 'ai');
                }

            } catch (e) {
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();
                addMessage("Network Error. Check connection.", 'ai');
                console.error(e);
            }
        }

        function copyToNote(text) {
            localStorage.setItem('rekindle_new_note_content', text);
            window.location.href = 'notes.html?action=new_note';
        }

        function addMessage(text, sender) {
            const history = document.getElementById('chat-history');
            const msgDiv = document.createElement('div');
            const id = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            msgDiv.id = id;
            msgDiv.className = `message ${sender}`;

            if (sender === 'ai' && text !== "Thinking...") {
                try {
                    msgDiv.innerHTML = marked.parse(text);
                } catch (e) {
                    msgDiv.innerText = text;
                }

                // Add Copy to Note Button
                const btn = document.createElement('button');
                btn.className = 'sys-btn';
                btn.style.marginTop = '10px';
                btn.style.display = 'inline-block'; // Ensure it sits on its own line if needed, or inline
                btn.style.fontSize = '0.7rem';
                btn.innerText = 'Copy to Note';
                btn.onclick = () => copyToNote(text);

                // Append a line break or container if needed, but appendChild puts it at end
                msgDiv.appendChild(document.createElement('br'));
                msgDiv.appendChild(btn);

            } else {
                msgDiv.innerText = text;
            }

            history.appendChild(msgDiv);
            history.scrollTop = history.scrollHeight;
            return id;
        }

        function clearChat() {
            document.getElementById('chat-history').innerHTML = '';
            addMessage("Memory cleared.", 'ai');
        }

    </script>

    <script>
        // Helper to sanitize background image URLs from localStorage
        function sanitizeBackgroundImage(imageString) {
            if (!imageString) return '';
            if (imageString.startsWith('url("data:image/png;base64,')) {
                return imageString;
            }
            if (imageString.startsWith('url("') && imageString.endsWith('")')) {
                const url = imageString.substring(5, imageString.length - 2);
                if ((url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) && !url.includes('javascript:')) {
                    return imageString;
                }
            }
            return '';
        }




    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>


</body>

</html>