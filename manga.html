<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta charset="UTF-8">
    <title>Manga Reader</title>
    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        * {
            transition: none !important;
            animation: none !important;
        }

        body {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 900px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            margin: 0;
            z-index: 2000;
            transform-origin: top left !important;
        }

        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
            font-family: "Helvetica Neue", sans-serif;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        #back-btn {
            display: none;
            position: absolute;
            left: 36px;
            width: auto;
            padding: 0 6px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.7rem;
            line-height: 18px;
            box-shadow: 2px 2px 0 black;
        }

        #back-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* TABS */
        .tabs {
            display: flex;
            border-bottom: 2px solid black;
            background: #eee;
        }

        /* CONTROLS (Right side of Title Bar) */
        .title-controls {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            display: flex;
            align-items: center;
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
            flex-shrink: 0;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* Icon State Toggles */
        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        .tab {
            padding: 10px 20px;
            border-right: 2px solid black;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .tab.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }

        /* CONTENT */
        .window-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
            position: relative;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 20px;
            align-content: start;
        }

        .card {
            background: white;
            border: 2px solid black;
            padding: 15px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            position: relative;
        }

        .card:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .cover-img {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            border: 1px solid #000;
            margin-bottom: 10px;
            background: #eee;
            image-rendering: auto;
            /* Allow covers to be smooth if they aren't pixel art */
        }

        .book-title {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .book-author {
            font-size: 0.8rem;
            font-style: italic;
            color: #555;
            margin-bottom: 8px;
        }

        .book-type {
            font-size: 0.7rem;
            background: #000;
            color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
            align-self: flex-start;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .btn {
            background: white;
            border: 2px solid black;
            padding: 6px 12px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 2px 2px 0 black;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .btn:disabled {
            background: #ccc;
            color: #666;
            box-shadow: none;
            cursor: default;
            transform: none;
            border-color: #999;
        }

        /* READER VIEW */
        #reader-view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 10;
            flex-direction: column;
        }

        .reader-content {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fdfdfd;
            position: relative;
        }

        .reader-page {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
        }

        /* Tap Zones for page navigation */
        .tap-zone {
            position: absolute;
            top: 0;
            height: 100%;
            z-index: 5;
            cursor: pointer;
        }

        .tap-zone-prev {
            left: 0;
            width: 30%;
        }

        .tap-zone-next {
            right: 0;
            width: 70%;
        }

        #status-bar {
            border-top: 2px solid black;
            padding: 4px;
            font-size: 0.75rem;
            background: #eee;
            text-align: center;
            flex-shrink: 0;
            font-family: sans-serif;
        }
    </style>
    <script src="theme.js"></script>
    <script src="js/i18n.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="location.href='index'">X</div>
            <div id="back-btn" onclick="closeReader()">Back</div>
            <span class="title-text" id="app-title" data-i18n="manga.title">Manga Reader</span>
            <div class="title-controls">
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1"></path>
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" id="tab-library" onclick="switchTab('library')" data-i18n="manga.tab.library">
                Library</div>
            <div class="tab" id="tab-store" onclick="switchTab('store')" data-i18n="manga.tab.store">Store</div>
        </div>

        <div class="window-content">
            <!-- LIBRARY VIEW -->
            <div id="view-library" class="grid"></div>

            <!-- STORE VIEW -->
            <div id="view-store" class="grid" style="display: none;"></div>

            <!-- READER VIEW -->
            <div id="reader-view">
                <div class="reader-content" id="reader-content">
                </div>
                <div class="tap-zone tap-zone-prev" onclick="prevPage()"></div>
                <div class="tap-zone tap-zone-next" onclick="nextPage()"></div>
            </div>
        </div>

        <div id="status-bar" data-i18n="manga.msg.loading">Loading...</div>
    </div>

    <script>
        // --- MANGADEX API INTEGRATION ---
        const API_BASE = "https://api.mangadex.org";
        let library = [];
        let currentStorePage = 0;
        let isLoadingStore = false;
        let currentReading = null;
        let currentPage = 0;

        window.onload = async () => {
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            if (window.rekindleApplyScale) window.rekindleApplyScale();
            if (window.rekindleAutoDetectScale) window.rekindleAutoDetectScale();
            if (window.rekindleApplyDefaultFullscreen) window.rekindleApplyDefaultFullscreen();

            await loadLibrary();
            switchTab('library'); // default

            document.getElementById('status-bar').innerText = window.t('manga.msg.ready') || 'Ready';
        };

        async function loadLibrary() {
            try {
                const saved = await localforage.getItem('manga_library');
                if (saved) {
                    library = saved;
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function saveLibrary() {
            try {
                await localforage.setItem('manga_library', library);
            } catch (e) {
                console.error(e);
                showStatus("Storage Error!");
            }
        }

        function switchTab(tab) {
            document.getElementById('tab-library').classList.remove('active');
            document.getElementById('tab-store').classList.remove('active');
            document.getElementById('view-library').style.display = 'none';
            document.getElementById('view-store').style.display = 'none';

            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('view-' + tab).style.display = 'grid';

            if (tab === 'library') {
                renderLibrary();
            } else if (tab === 'store') {
                if (document.getElementById('view-store').innerHTML === '') {
                    loadStore(0);
                }
            }
        }

        function showStatus(msg) {
            document.getElementById('status-bar').innerText = msg;
        }

        async function fetchCORS(url) {
            const PROXIES = [
                "/api/proxy?url=",
            ];

            let lastError = null;
            for (let proxyBase of PROXIES) {
                try {
                    const res = await fetch(proxyBase + encodeURIComponent(url));
                    if (res.ok) {
                        return res;
                    }
                } catch (e) {
                    console.warn("Proxy failed:", proxyBase, e);
                    lastError = e;
                }
            }
            throw new Error("All CORS proxies failed: " + (lastError ? lastError.message : ""));
        }

        async function loadStore(offset) {
            if (isLoadingStore) return;
            isLoadingStore = true;
            showStatus("Loading MangaDex Catalog...");

            const container = document.getElementById('view-store');
            if (offset === 0) container.innerHTML = '';

            try {
                const url = `${API_BASE}/manga?limit=20&offset=${offset}&includes[]=cover_art&order[rating]=desc&order[followedCount]=desc`;
                const res = await fetchCORS(url);

                const data = await res.json();

                if (data.data.length === 0 && offset === 0) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center;">Store is empty.</div>';
                    return;
                }

                data.data.forEach(manga => {
                    const title = manga.attributes.title.en || Object.values(manga.attributes.title)[0] || "Unknown";
                    let coverFileName = null;

                    // Find cover art in relationships
                    for (let rel of manga.relationships) {
                        if (rel.type === 'cover_art' && rel.attributes && rel.attributes.fileName) {
                            coverFileName = rel.attributes.fileName;
                            break;
                        }
                    }

                    // Construct cover URL
                    let coverUrl = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="450"><rect width="300" height="450" fill="%23ccc"/></svg>';
                    if (coverFileName) {
                        const rawUrl = `https://uploads.mangadex.org/covers/${manga.id}/${coverFileName}.256.jpg`;
                        coverUrl = `/api/proxy?url=${encodeURIComponent(rawUrl)}`;
                    }

                    const isAdded = library.some(libItem => libItem.id === manga.id);
                    const card = document.createElement('div');
                    card.className = 'card';

                    card.innerHTML =
                        '<img src="' + coverUrl + '" class="cover-img" onerror="this.src=\'data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;300&quot; height=&quot;450&quot;><rect width=&quot;300&quot; height=&quot;450&quot; fill=&quot;%23ccc&quot;/></svg>\'">' +
                        '<div class="book-title">' + escapeHtml(title) + '</div>' +
                        '<div class="book-author" style="text-transform: capitalize">' + manga.attributes.status + '</div>';

                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.style.marginTop = 'auto';
                    if (isAdded) {
                        btn.innerText = window.t('manga.msg.added') || "Added";
                        btn.disabled = true;
                    } else {
                        btn.innerText = window.t('manga.btn.add') || "+ Add";
                        btn.onclick = (e) => {
                            e.stopPropagation();
                            addToLibrary({
                                id: manga.id,
                                title: title,
                                cover: coverUrl,
                                type: 'manga',
                                author: manga.attributes.status // lazy but works for now
                            });
                            btn.innerText = window.t('manga.msg.added') || "Added";
                            btn.disabled = true;
                        };
                    }

                    card.appendChild(btn);
                    container.appendChild(card);
                });

                // Add "Load More" button
                const moreBtn = document.createElement('button');
                moreBtn.className = 'btn';
                moreBtn.style.gridColumn = '1/-1';
                moreBtn.style.marginTop = '20px';
                moreBtn.innerText = "Load More";
                moreBtn.onclick = () => {
                    moreBtn.remove();
                    currentStorePage += 20;
                    loadStore(currentStorePage);
                };
                container.appendChild(moreBtn);

                showStatus(window.t('manga.msg.ready') || "Ready");
            } catch (e) {
                console.error(e);
                showStatus("Failed to load store: " + e.message);
                if (offset === 0) container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: red;">Network Error loading MangaDex.</div>';
            } finally {
                isLoadingStore = false;
            }
        }

        function escapeHtml(unsafe) {
            return (unsafe || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        async function renderLibrary() {
            const container = document.getElementById('view-library');
            container.innerHTML = '';

            if (library.length === 0) {
                const emptyMsg = window.t('manga.msg.empty_library') || 'Your library is empty. Go to the Store to add some.';
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center;" data-i18n="manga.msg.empty_library">' + emptyMsg + '</div>';
                return;
            }

            // Load all progress at once
            let allProgress = {};
            try {
                allProgress = await localforage.getItem('manga_progress') || {};
            } catch (e) { }

            library.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';

                const savedPage = allProgress[item.id] || 0;
                let progressText = '';
                if (savedPage > 0) {
                    progressText = '<div style="font-size:0.7rem; background:#000; color:#fff; padding:2px 6px; display:inline-block; margin-bottom:4px;">' + (window.t('manga.msg.page') || 'Page') + ' ' + (savedPage + 1) + '</div>';
                }

                // X remove button at top-right
                const removeBtn = document.createElement('div');
                removeBtn.style.cssText = 'position:absolute; top:4px; right:4px; width:18px; height:18px; border:2px solid black; background:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.8rem; cursor:pointer; z-index:3; box-shadow:1px 1px 0 black;';
                removeBtn.innerText = 'X';
                removeBtn.onclick = function (e) {
                    e.stopPropagation();
                    removeFromLibrary(item.id);
                };

                card.innerHTML =
                    '<img src="' + item.cover + '" class="cover-img">' +
                    '<div class="book-title">' + escapeHtml(item.title) + '</div>' +
                    '<div class="book-author">' + escapeHtml(item.author) + '</div>' +
                    progressText;

                card.appendChild(removeBtn);

                const btnRead = document.createElement('button');
                btnRead.className = 'btn';
                btnRead.style.marginTop = 'auto';
                btnRead.innerText = (savedPage > 0) ? (window.t('manga.btn.continue') || 'Continue') : (window.t('manga.btn.read') || 'Read');
                btnRead.onclick = (e) => {
                    e.stopPropagation();
                    openReader(item);
                };

                card.appendChild(btnRead);
                container.appendChild(card);
            });
        }

        async function addToLibrary(item) {
            if (!library.some(libItem => libItem.id === item.id)) {
                library.push(item);
                await saveLibrary();
            }
        }

        async function removeFromLibrary(id) {
            library = library.filter(item => item.id !== id);
            await saveLibrary();
            renderLibrary();
        }

        // --- READING PROGRESS ---
        async function saveProgress(mangaId, page) {
            try {
                const progress = await localforage.getItem('manga_progress') || {};
                progress[mangaId] = page;
                await localforage.setItem('manga_progress', progress);
            } catch (e) {
                console.error('Failed to save progress:', e);
            }
        }

        async function getProgress(mangaId) {
            try {
                const progress = await localforage.getItem('manga_progress') || {};
                return progress[mangaId] || 0;
            } catch (e) {
                return 0;
            }
        }

        // --- READER LOGIC ---
        let isReaderOpen = false;

        async function openReader(item) {
            currentReading = item;
            isReaderOpen = true;
            document.getElementById('reader-view').style.display = 'flex';

            // Show back button, update title, hide tabs
            document.getElementById('back-btn').style.display = 'block';
            document.querySelector('.tabs').style.display = 'none';
            document.getElementById('app-title').innerText = item.title;

            const content = document.getElementById('reader-content');
            content.innerHTML = '<div style="padding: 20px;">Fetching chapters...</div>';

            try {
                const url = `${API_BASE}/manga/${item.id}/feed?translatedLanguage[]=en&order[chapter]=asc&limit=100`;
                const res = await fetchCORS(url);
                const data = await res.json();

                if (data.data.length === 0) {
                    content.innerHTML = '<div style="padding: 20px;">No English chapters found.</div>';
                    return;
                }

                const firstChapter = data.data[0];
                await loadChapter(firstChapter.id);

            } catch (e) {
                content.innerHTML = '<div style="padding: 20px; color: red;">Error: ' + e.message + '</div>';
            }
        }

        async function loadChapter(chapterId) {
            const content = document.getElementById('reader-content');
            content.innerHTML = '<div style="padding: 20px;">Fetching pages...</div>';

            try {
                const url = `${API_BASE}/at-home/server/${chapterId}`;
                const res = await fetchCORS(url);
                const data = await res.json();

                const baseUrl = data.baseUrl;
                const hash = data.chapter.hash;
                const pages = data.chapter.data;

                if (!pages || pages.length === 0) {
                    content.innerHTML = '<div style="padding: 20px;">No pages found.</div>';
                    return;
                }

                const imageUrls = pages.map(file => {
                    const rawUrl = `${baseUrl}/data/${hash}/${file}`;
                    return `/api/proxy?url=${encodeURIComponent(rawUrl)}`;
                });

                currentReading.pages = imageUrls;

                // Restore reading progress
                currentPage = await getProgress(currentReading.id);
                if (currentPage >= imageUrls.length) currentPage = 0;

                updateMangaPage();

            } catch (e) {
                content.innerHTML = '<div style="padding: 20px; color: red;">Error: ' + e.message + '</div>';
            }
        }

        function toggleFullScreen() {
            var win = document.querySelector('.window');
            var entering = !win.classList.contains('fullscreen');
            win.classList.toggle('fullscreen');

            if (entering) {
                var scale = parseFloat(localStorage.getItem('rekindle_scale') || '1.0') || 1;
                win.style.width = (window.innerWidth / scale) + 'px';
                win.style.height = (window.innerHeight / scale) + 'px';
            } else {
                win.style.width = '';
                win.style.height = '';
            }
        }

        function closeReader() {
            isReaderOpen = false;
            document.getElementById('reader-view').style.display = 'none';
            document.getElementById('reader-content').innerHTML = '';

            // Hide back button, show tabs
            document.getElementById('back-btn').style.display = 'none';
            document.querySelector('.tabs').style.display = 'flex';

            // Restore title
            document.getElementById('app-title').innerText = 'Manga Reader';

            // Reset status bar
            showStatus(window.t('manga.msg.ready') || 'Ready');
            currentReading = null;

            // Refresh library to show updated progress
            renderLibrary();
        }

        function updateMangaPage() {
            if (!currentReading || !currentReading.pages) return;

            const pages = currentReading.pages;
            const content = document.getElementById('reader-content');
            content.innerHTML = '';

            const img = document.createElement('img');
            img.src = pages[currentPage];
            img.className = 'reader-page';

            showStatus('Loading ' + (currentPage + 1) + ' / ' + pages.length + '...');
            img.onload = function () {
                showStatus((currentPage + 1) + ' / ' + pages.length);
            };
            img.onerror = function () {
                showStatus('Error loading page ' + (currentPage + 1));
            };

            content.appendChild(img);
            content.scrollTop = 0;

            // Save progress
            saveProgress(currentReading.id, currentPage);
        }

        function prevPage() {
            if (!isReaderOpen) return;
            if (currentReading && currentReading.pages && currentPage > 0) {
                currentPage--;
                updateMangaPage();
            }
        }

        function nextPage() {
            if (!isReaderOpen) return;
            if (currentReading && currentReading.pages && currentPage < currentReading.pages.length - 1) {
                currentPage++;
                updateMangaPage();
            }
        }
    </script>
</body>

</html>