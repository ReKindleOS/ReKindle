<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dropbox</title>

    <!-- Global Error Handler for Kindle Debugging -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            var extra = !col ? '' : '\ncolumn: ' + col;
            extra += !error ? '' : '\nerror: ' + error;
            alert("Error: " + msg + "\nurl: " + url + "\nline: " + line + extra);
            return false;
        };

        // Polyfill Check
        window.onloadPolyfillCheck = function () {
            if (!window.crypto || !window.crypto.subtle) {
                alert("Warning: Web Crypto API not supported. Login may fail.");
            }
            if (typeof TextEncoder === 'undefined') {
                alert("Warning: TextEncoder not supported.");
            }
        }
        window.addEventListener('load', window.onloadPolyfillCheck);
    </script>

    <!-- Dropbox SDK -->
    <script src="https://cdn.jsdelivr.net/npm/dropbox@10.34.0/dist/Dropbox-sdk.min.js"></script>

    <!-- Firebase for optional auth sync -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Shared Theme & Scaling Logic -->
    <script src="theme.js"></script>

    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
            --ui-font: "Charcoal", "Geneva", "Verdana", sans-serif;
            --finder-header-bg: #cccccc;
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;

            font-family: var(--ui-font);
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 800px;
            position: relative;
        }

        /* FULL SCREEN MODE (Matches browser.html) */
        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
            margin: 0;
        }

        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        /* APP LAYOUT */
        .app-body {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            width: 100%;
        }

        /* SIDEBAR */
        .sidebar {
            width: 200px;
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .sidebar-header {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
            font-size: 0.8rem;
            background: #eee;
            text-align: center;
            text-transform: uppercase;
        }

        #favorites-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sidebar-item:hover {
            background: #d4d4d4;
        }

        .sidebar-item.active {
            background: #bbb;
            font-weight: bold;
        }

        /* MAIN VIEW */
        .main-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
            position: relative;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
            font-family: "Helvetica Neue", sans-serif;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        /* CLOSE BUTTON */
        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* HEADER CONTROLS */
        .header-controls {
            position: absolute;
            right: 10px;
            z-index: 2;
            display: flex;
            gap: 5px;
        }

        /* TOOLBAR */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 2px solid black;
            background: #eee;
            flex-shrink: 0;
            font-family: var(--ui-font);
        }

        .icon-btn {
            width: 28px;
            height: 28px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 2px 2px 0 black;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .path-display {
            flex: 1;
            font-size: 0.85rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .breadcrumb {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 0.85rem;
        }

        .breadcrumb-item {
            color: #0066cc;
            cursor: pointer;
            text-decoration: underline;
        }

        .breadcrumb-item:hover {
            color: #003366;
        }

        .breadcrumb-sep {
            color: #666;
        }

        /* FINDER LIST VIEW */
        .file-list {
            flex: 1;
            overflow-y: auto;
            background: white;
            font-family: var(--ui-font);
            display: flex;
            flex-direction: column;
        }

        .list-header {
            display: flex;
            background: var(--finder-header-bg);
            border-bottom: 1px solid black;
            font-size: 0.75rem;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-col {
            padding: 4px 8px;
            border-right: 1px solid #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .col-name {
            flex: 2;
            min-width: 150px;
        }

        .col-date {
            width: 140px;
            flex-shrink: 0;
        }

        .col-size {
            width: 70px;
            flex-shrink: 0;
            text-align: right;
        }

        .col-kind {
            width: 100px;
            flex-shrink: 0;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .file-item:nth-child(even) {
            background: #f2f2f2;
            /* Zebra striping */
        }

        .file-item:hover {
            background: #ccccff;
            /* Selection highlight */
        }

        .file-cell {
            padding: 2px 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-right: 1px solid transparent;
            /* Alignment placeholder */
        }

        /* Specific column styling in rows */
        .file-item .col-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-icon-small {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .download-btn {
            padding: 2px 6px;
            font-size: 0.7rem;
            background: white;
            border: 1px solid black;
            cursor: pointer;
            font-family: var(--ui-font);
            margin-left: auto;
        }

        /* STATUS BAR */
        .status-bar {
            border-top: 2px solid black;
            padding: 4px 10px;
            font-size: 0.75rem;
            background: #eee;
            text-align: center;
            flex-shrink: 0;
            font-family: sans-serif;
        }

        /* LOGIN VIEW */
        .login-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: "Helvetica Neue", sans-serif;
        }

        .login-desc {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 30px;
            max-width: 280px;
            line-height: 1.4;
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 10px 25px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 3px 3px 0 black;
            font-family: "Helvetica Neue", sans-serif;
            font-size: 0.95rem;
        }

        .sys-btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .mini-btn {
            background: white;
            border: 2px solid black;
            padding: 3px 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-family: sans-serif;
            font-size: 0.7rem;
        }

        .mini-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* LOADING */
        .loading {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }

        .loading::before {
            content: "‚è≥";
            font-size: 2rem;
            font-style: normal;
            margin-bottom: 10px;
        }

        /* EMPTY STATE */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
            padding: 40px;
        }

        .empty-state::before {
            content: "üìÇ";
            font-size: 3rem;
            font-style: normal;
            margin-bottom: 10px;
        }

        /* ERROR STATE */
        .error-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #c00;
            padding: 40px;
            text-align: center;
        }

        .error-state::before {
            content: "‚ö†Ô∏è";
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* PREVIEW MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            max-width: 90%;
            max-height: 85%;
            overflow: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 2px solid black;
            background: #eee;
            font-family: "Helvetica Neue", sans-serif;
            font-weight: bold;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow: auto;
        }

        .modal-body img {
            max-width: 100%;
            display: block;
        }

        .modal-body pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Courier New", monospace;
            font-size: 0.85rem;
            margin: 0;
        }

        /* TOAST */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: black;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 0.85rem;
            display: none;
            z-index: 2000;
        }

        .hidden {
            display: none !important;
        }

        /* GRID VIEW TOGGLE STYLES */
        .file-list.grid-mode {
            flex-direction: row;
            flex-wrap: wrap;
            align-content: flex-start;
            padding: 10px;
            gap: 15px;
        }

        .file-list.grid-mode .list-header {
            display: none;
        }

        .file-list.grid-mode .file-item {
            flex-direction: column;
            width: 100px;
            height: auto;
            border-bottom: none;
            padding: 10px 5px;
            align-items: center;
            border: 1px solid transparent;
            justify-content: flex-start;
        }

        .file-list.grid-mode .file-item:nth-child(even) {
            background: transparent;
        }

        .file-list.grid-mode .file-item:hover {
            background: #e5e5e5;
            border: 1px dashed #999;
            border-radius: 4px;
        }

        /* Hide extra columns in grid mode */
        .file-list.grid-mode .col-date,
        .file-list.grid-mode .col-size,
        .file-list.grid-mode .col-kind {
            display: none;
        }

        /* Adjust name column for grid */
        .file-list.grid-mode .col-name {
            flex: unset;
            width: 100%;
            min-width: unset;
            flex-direction: column;
            text-align: center;
            gap: 8px;
            white-space: normal;
        }

        .file-list.grid-mode .col-name span:not(.file-icon-small) {
            word-break: break-word;
            line-height: 1.2;
            max-height: 2.4em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Make icons bigger in grid mode */
        .file-list.grid-mode .file-icon-small {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-list.grid-mode .file-icon-small svg {
            width: 48px !important;
            height: 48px !important;
        }
    </style>
    <script src="theme.js"></script>
</head>

<body>
    <div class="window">
        <!-- Title Bar -->
        <!-- Title Bar -->
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="location.href='index'">X</div>

            <!-- Logout moved here -->
            <button class="mini-btn hidden" id="logout-btn" style="position:absolute; left: 35px; z-index:2;"
                onclick="logout()">Logout</button>

            <span class="title-text">Dropbox</span>

            <div class="header-controls" id="header-controls">
                <!-- Full Screen Toggle -->
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen"
                    style="width:22px; height:22px;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1" />
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6" />
                    </svg>
                </button>
            </div>
        </div>


        <div class="app-body">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar" style="display:none;">
                <div class="sidebar-header">Favorites</div>
                <div id="favorites-list"></div>
            </div>

            <!-- Main Content -->
            <div class="main-view">

                <!-- Login View -->
                <div id="login-view" class="login-view">
                    <div style="width: 64px; height: 64px; margin-bottom: 20px;">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="square" stroke-linejoin="miter">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                            <polyline points="2 17 12 22 22 17"></polyline>
                            <polyline points="2 12 12 17 22 12"></polyline>
                        </svg>
                    </div>
                    <h1>Dropbox</h1>
                    <p style="text-align:center; max-width: 300px; margin-bottom: 20px;">
                        Connect to view your files securely.
                    </p>
                    <button class="sys-btn" onclick="login()">Connect to Dropbox</button>
                </div>

                <!-- Toolbar (hidden until logged in) -->
                <div class="toolbar hidden" id="toolbar">
                    <button class="icon-btn" id="back-btn" onclick="goBack()" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7" />
                        </svg>
                    </button>

                    <button class="icon-btn" onclick="refreshFolder()" title="Refresh">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M23 4v6h-6" />
                            <path d="M1 20v-6h6" />
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                        </svg>
                    </button>

                    <!-- Favorite Toggle -->
                    <button class="icon-btn" id="fav-btn" onclick="toggleFavorite()" title="Favorite this folder">
                        ‚òÜ
                    </button>

                    <div id="breadcrumb" class="breadcrumb">
                        <!-- Injected JS -->
                    </div>

                    <!-- View Toggle -->
                    <button class="icon-btn" id="view-toggle-btn" onclick="toggleView()" title="Switch View"
                        style="margin-left: auto;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>

                <!-- Loading State -->
                <div class="loading hidden" id="loading-view">Loading...</div>

                <!-- File List -->
                <div class="file-list hidden" id="file-list"></div>

                <!-- Empty State -->
                <div class="empty-state hidden" id="empty-view">This folder is empty</div>

                <!-- Error State -->
                <div class="error-state hidden" id="error-view">
                    <span id="error-message">Something went wrong</span>
                    <button class="sys-btn" style="margin-top: 20px;" onclick="refreshFolder()">Try Again</button>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="status-bar">Not connected</div>

        <div id="paywall-overlay"
            style="display:none; position:absolute; top:35px; left:0; width:100%; height:calc(100% - 35px); background:rgba(255,255,255,0.98); z-index:500; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box;">
            <h2 style="margin-top:0;">ReKindle+</h2>
            <p>Support ReKindle development and get<br>access to exclusive apps.</p>
            <button class="sys-btn" onclick="window.location.href='pay.html'">Subscribe / Login</button>
            <p style="font-size:0.8rem; margin-top:20px; color:#666;" id="paywall-status">Checking subscription...</p>
        </div>
    </div>

    <!-- Preview Modal -->
    <!-- Preview Modal -->
    <div class="modal-overlay" id="preview-modal" onclick="closePreview(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="preview-title">Preview</span>
                <button class="icon-btn" onclick="closePreview()">X</button>
            </div>
            <div class="modal-body" id="preview-body"></div>
            <div class="modal-footer"
                style="padding:10px; border-top:2px solid black; background:#eee; text-align:right;">
                <button class="sys-btn" id="preview-download-btn">Download</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script>

        // =====================
        // FIREBASE CONFIG
        // =====================
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Configure for Safari/Mac compatibility
        if (db.settings) {
            try { db.settings({ experimentalForceLongPolling: true, merge: true }); } catch (e) { }
        }

        // =====================
        // CONFIGURATION
        // =====================

        // TODO: Replace with your Dropbox App Key from https://www.dropbox.com/developers/apps
        const DROPBOX_APP_KEY = 'i4h4u74yl1do8wo';
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // =====================
        // STATE
        // =====================

        let dbx = null;
        let accessToken = null;
        let currentPath = '';
        let pathHistory = [];
        let currentUser = null; // Dropbox User
        let firebaseUser = null; // ReKindle Cloud User
        let favorites = [];

        // =====================
        // INITIALIZATION
        // =====================

        let isPro = false;

        function waitForFirebase(callback, attempts = 0) {
            if (typeof firebase !== 'undefined') {
                callback();
            } else if (attempts < 50) {
                setTimeout(() => waitForFirebase(callback, attempts + 1), 100);
            } else {
                const overlay = document.getElementById('paywall-overlay');
                const status = document.getElementById('paywall-status');
                status.innerText = "Error: Firebase failed to load.";
                overlay.style.display = 'flex';
            }
        }

        window.onload = function () {
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            loadViewPreference();
            waitForFirebase(checkSubscription);
        };

        function checkSubscription() {
            const overlay = document.getElementById('paywall-overlay');
            const status = document.getElementById('paywall-status');

            // OPTIMISTIC: Keep overlay hidden by default for pro users

            if (typeof firebase !== 'undefined') {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        // Timeout fallback in case Firestore query hangs
                        const timeoutId = setTimeout(() => {
                            console.warn("Subscription check timed out");
                            status.innerText = "Verification timed out. Please refresh.";
                            overlay.style.display = 'flex';
                        }, 10000);

                        db.collection('users').doc(user.uid).get()
                            .then(doc => {
                                clearTimeout(timeoutId);
                                if (doc.exists) {
                                    const data = doc.data();
                                    const now = Date.now();
                                    let expires = 0;
                                    if (data.proExpiresAt) {
                                        expires = typeof data.proExpiresAt.toMillis === 'function'
                                            ? data.proExpiresAt.toMillis()
                                            : new Date(data.proExpiresAt).getTime();
                                    }

                                    if (expires > now) {
                                        // UNLOCKED - overlay stays hidden
                                        isPro = true;
                                        initDropboxApp();
                                    } else {
                                        // LOCKED
                                        status.innerText = expires > 0 ? "Subscription expired." : "Subscription required.";
                                        overlay.style.display = 'flex';
                                    }
                                } else {
                                    status.innerText = "Subscription required.";
                                    overlay.style.display = 'flex';
                                }
                            })
                            .catch(e => {
                                clearTimeout(timeoutId);
                                console.error("Error checking sub", e);
                                status.innerText = "Error verifying. Try again.";
                                overlay.style.display = 'flex';
                            });
                    } else {
                        // NOT LOGGED IN
                        status.innerText = "Please log in.";
                        overlay.style.display = 'flex';
                    }
                });
            } else {
                status.innerText = "System Error";
                overlay.style.display = 'flex';
            }
        }

        async function initDropboxApp() {
            // Standard Init
            initAuthListener();

            // Check for OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                // Exchange code for token using PKCE
                await handleAuthCallback(code);
            } else {
                // Check for stored token
                accessToken = localStorage.getItem('dropbox_access_token');
                if (accessToken) {
                    initDropbox(accessToken);
                    await verifyAndLoadAccount();
                }
            }
        }

        // =====================
        // AUTHENTICATION
        // =====================

        async function login() {
            // Generate PKCE code verifier and challenge
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            // Store verifier for later
            localStorage.setItem('dropbox_code_verifier', codeVerifier);

            // Build auth URL
            const authUrl = `https://www.dropbox.com/oauth2/authorize?` +
                `client_id=${DROPBOX_APP_KEY}` +
                `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
                `&response_type=code` +
                `&code_challenge=${codeChallenge}` +
                `&code_challenge_method=S256` +
                `&token_access_type=offline`;

            window.location.href = authUrl;
        }

        async function handleAuthCallback(code) {
            showLoading('Connecting to Dropbox...');

            try {
                const codeVerifier = localStorage.getItem('dropbox_code_verifier');

                if (!codeVerifier) {
                    throw new Error('Code verifier not found. Please try logging in again.');
                }

                // Exchange code for token
                const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        code: code,
                        grant_type: 'authorization_code',
                        client_id: DROPBOX_APP_KEY,
                        redirect_uri: REDIRECT_URI,
                        code_verifier: codeVerifier
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error_description || 'Failed to get access token');
                }

                const tokenData = await response.json();
                accessToken = tokenData.access_token;

                // Store tokens
                localStorage.setItem('dropbox_access_token', accessToken);
                if (tokenData.refresh_token) {
                    localStorage.setItem('dropbox_refresh_token', tokenData.refresh_token);
                }
                localStorage.removeItem('dropbox_code_verifier');

                // Clear URL params
                window.history.replaceState({}, document.title, window.location.pathname);

                // Initialize and load
                initDropbox(accessToken);
                await verifyAndLoadAccount();

            } catch (error) {
                console.error('Auth error:', error);
                showError('Authentication failed: ' + error.message);
                localStorage.removeItem('dropbox_code_verifier');
            }
        }

        function initDropbox(token) {
            dbx = new Dropbox.Dropbox({ accessToken: token });
        }

        async function verifyAndLoadAccount() {
            try {
                const account = await dbx.usersGetCurrentAccount();
                currentUser = account.result;

                updateStatus(`Connected: ${currentUser.email}`);
                showFileView();
                await loadFolder('');

            } catch (error) {
                console.error('Account verification failed:', error);

                // Token might be expired, try refresh or logout
                if (error.status === 401) {
                    const refreshed = await tryRefreshToken();
                    if (!refreshed) {
                        logout();
                        showError('Session expired. Please log in again.');
                    }
                } else {
                    logout();
                    showError('Failed to connect: ' + error.message);
                }
            }
        }

        async function tryRefreshToken() {
            const refreshToken = localStorage.getItem('dropbox_refresh_token');
            if (!refreshToken) return false;

            try {
                const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken,
                        client_id: DROPBOX_APP_KEY
                    })
                });

                if (!response.ok) return false;

                const tokenData = await response.json();
                accessToken = tokenData.access_token;
                localStorage.setItem('dropbox_access_token', accessToken);

                initDropbox(accessToken);
                await verifyAndLoadAccount();
                return true;

            } catch (error) {
                console.error('Token refresh failed:', error);
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('dropbox_access_token');
            localStorage.removeItem('dropbox_refresh_token');
            dbx = null;
            accessToken = null;
            currentUser = null;
            currentPath = '';
            pathHistory = [];

            showLoginView();
            updateStatus('Not connected');
        }

        // =====================
        // PKCE HELPERS
        // =====================

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(hash));
        }

        function base64URLEncode(buffer) {
            return btoa(String.fromCharCode.apply(null, buffer))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        // =====================
        // FILE OPERATIONS
        // =====================

        async function loadFolder(path) {
            showLoading('Loading...');
            currentPath = path;
            updateBreadcrumb();

            try {
                const response = await dbx.filesListFolder({ path: path || '' });
                const entries = response.result.entries;

                if (entries.length === 0) {
                    showEmpty();
                } else {
                    renderFileList(entries);
                }

                updateBackButton();
                updateFavoriteButton();
                renderSidebar(); // Update active state

            } catch (error) {
                console.error('Load folder error:', error);

                if (error.status === 401) {
                    const refreshed = await tryRefreshToken();
                    if (!refreshed) {
                        logout();
                        showError('Session expired. Please log in again.');
                    }
                } else {
                    showError('Failed to load folder: ' + ((error.error && error.error.error_summary) || error.message));
                }
            }
        }

        function navigateTo(path) {
            if (path !== currentPath) {
                pathHistory.push(currentPath);
            }
            loadFolder(path);
        }

        function goBack() {
            if (pathHistory.length > 0) {
                const prevPath = pathHistory.pop();
                loadFolder(prevPath);
            }
        }

        function refreshFolder() {
            loadFolder(currentPath);
        }

        async function downloadFile(path, name, event) {
            if (event) event.stopPropagation();

            showToast('Getting download link...');

            try {
                const response = await dbx.filesGetTemporaryLink({ path: path });
                const link = response.result.link;

                // Create temporary link and click it
                const a = document.createElement('a');
                a.href = link;
                a.download = name;
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showToast('Download started!');

            } catch (error) {
                console.error('Download error:', error);
                showToast('Download failed: ' + error.message);
            }
        }

        async function previewFile(entry) {
            const ext = getFileExtension(entry.name).toLowerCase();
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const textExtensions = ['txt', 'md', 'json', 'xml', 'html', 'css', 'js', 'py', 'sh'];
            const docExtensions = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'];

            // Setup Download Button
            const downloadBtn = document.getElementById('preview-download-btn');
            if (downloadBtn) {
                downloadBtn.onclick = () => downloadFile(entry.path_lower, entry.name);
            }

            showToast('Loading preview...');

            if (imageExtensions.includes(ext)) {
                // Try Thumbnail first for images (usually faster/smaller) or Temp Link for full res
                // For Kindle, a large thumbnail is often safer/faster than full multi-MB images
                try {
                    // Try getting a large thumbnail first
                    const response = await dbx.filesGetThumbnail({
                        path: entry.path_lower,
                        size: 'w1024h768', // Good size for Kindle screen
                        format: 'jpeg'
                    });

                    const blob = response.result.fileBlob;
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = function () {
                        const base64data = reader.result;
                        document.getElementById('preview-title').textContent = entry.name;
                        document.getElementById('preview-body').innerHTML = `<img src="${base64data}" alt="${entry.name}">`;
                        document.getElementById('preview-modal').style.display = 'flex';
                    };

                } catch (error) {
                    console.log('Thumbnail failed, trying temp link...', error);
                    // Fallback to temp link
                    try {
                        const response = await dbx.filesGetTemporaryLink({ path: entry.path_lower });
                        const link = response.result.link;
                        document.getElementById('preview-title').textContent = entry.name;
                        document.getElementById('preview-body').innerHTML = `<img src="${link}" alt="${entry.name}">`;
                        document.getElementById('preview-modal').style.display = 'flex';
                    } catch (e) {
                        console.error('Preview error:', e);
                        showToast('Could not load preview');
                    }
                }

            } else if (docExtensions.includes(ext)) {
                // Use Thumbnail API to generate preview image for documents
                try {
                    const response = await dbx.filesGetThumbnail({
                        path: entry.path_lower,
                        size: 'w1024h768',
                        format: 'jpeg',
                        mode: 'bestfit' // Maintain aspect ratio
                    });

                    const blob = response.result.fileBlob;
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = function () {
                        const base64data = reader.result;
                        document.getElementById('preview-title').textContent = entry.name;
                        // Show "First Page Preview" note for docs
                        document.getElementById('preview-body').innerHTML = `
                    <div style="text-align:center; margin-bottom:10px; font-size:0.8rem; color:#666;">(First Page Preview)</div>
                    <img src="${base64data}" alt="${entry.name}" style="border:1px solid #ccc;">
                        `;
                        document.getElementById('preview-modal').style.display = 'flex';
                    };
                } catch (error) {
                    console.error('Doc preview error:', error);
                    // If thumbnail fails (e.g. unsupported doc type), show error/warning
                    showToast('Preview not available for this file');
                }

            } else if (textExtensions.includes(ext)) {
                try {
                    const response = await dbx.filesDownload({ path: entry.path_lower });
                    const blob = response.result.fileBlob;

                    const reader = new FileReader();
                    reader.onload = function () {
                        const text = reader.result;
                        document.getElementById('preview-title').textContent = entry.name;
                        document.getElementById('preview-body').innerHTML = `<pre>${escapeHtml(text)}</pre>`;
                        document.getElementById('preview-modal').style.display = 'flex';
                    };
                    reader.onerror = function () {
                        showToast('Failed to read file');
                    };
                    reader.readAsText(blob);

                } catch (error) {
                    console.error('Preview error:', error);
                    showToast('Could not load file');
                }

            } else {
                showToast('Preview not supported for this file type type');
            }
        }

        function closePreview(event) {
            if (!event || event.target.id === 'preview-modal') {
                document.getElementById('preview-modal').style.display = 'none';
            }
        }

        // =====================
        // UI RENDERING
        // =====================

        function renderFileList(entries) {
            const listEl = document.getElementById('file-list');
            listEl.innerHTML = '';

            // Header Row
            const header = document.createElement('div');
            header.className = 'list-header';
            header.innerHTML = `
                        <div class="header-col col-name">Name</div>
                        <div class="header-col col-date">Date Modified</div>
                        <div class="header-col col-size">Size</div>
                        <div class="header-col col-kind">Kind</div>
                        `;
            listEl.appendChild(header);

            // Sort: folders first, then files, alphabetically
            entries.sort((a, b) => {
                if (a['.tag'] === 'folder' && b['.tag'] !== 'folder') return -1;
                if (a['.tag'] !== 'folder' && b['.tag'] === 'folder') return 1;
                return a.name.localeCompare(b.name);
            });

            entries.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'file-item';

                const isFolder = entry['.tag'] === 'folder';
                const iconSvg = isFolder ? getIconSvg('folder') : getFileIcon(entry.name);

                // Adjust SVG for small size in list
                const smallIcon = iconSvg.replace('width="20" height="20"', 'width="16" height="16"');

                const size = isFolder ? '--' : formatSize(entry.size);
                const modified = entry.client_modified ? formatDate(entry.client_modified) : '--';
                const kind = isFolder ? 'Folder' : formatKind(entry.name);

                div.innerHTML = `
                        <div class="file-cell col-name">
                            <span class="file-icon-small">${smallIcon}</span>
                            <span>${escapeHtml(entry.name)}</span>
                        </div>
                        <div class="file-cell col-date">${modified}</div>
                        <div class="file-cell col-size">${size}</div>
                        <div class="file-cell col-kind">${kind}</div>
                        `;

                div.onclick = () => {
                    if (isFolder) {
                        navigateTo(entry.path_lower);
                    } else {
                        previewFile(entry);
                    }
                };

                listEl.appendChild(div);
            });

            showFileList();
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');

            if (!currentPath) {
                breadcrumb.innerHTML = '<span class="breadcrumb-item" onclick="navigateTo(\'\')">' + getIconSvg('folder') + ' Dropbox</span>';
                return;
            }

            const parts = currentPath.split('/').filter(p => p);
            let html = '<span class="breadcrumb-item" onclick="navigateTo(\'\')">' + getIconSvg('folder') + ' Dropbox</span>';

            let pathSoFar = '';
            parts.forEach((part, index) => {
                pathSoFar += '/' + part;
                const path = pathSoFar;
                html += `<span class="breadcrumb-sep">/</span>`;
                html += `<span class="breadcrumb-item" onclick="navigateTo('${path}')">${escapeHtml(part)}</span>`;
            });

            breadcrumb.innerHTML = html;
        }

        function updateBackButton() {
            document.getElementById('back-btn').disabled = pathHistory.length === 0;
        }

        // =====================
        // VIEW SWITCHING
        // =====================

        function showLoginView() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('toolbar').classList.add('hidden');
            document.getElementById('file-list').classList.add('hidden');
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('empty-view').classList.add('hidden');
            document.getElementById('error-view').classList.add('hidden');
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('sidebar').style.display = 'none';
        }

        function showFileView() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('toolbar').classList.remove('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('sidebar').style.display = 'flex';
        }

        function showLoading(msg) {
            document.getElementById('loading-view').textContent = msg || 'Loading...';
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('file-list').classList.add('hidden');
            document.getElementById('empty-view').classList.add('hidden');
            document.getElementById('error-view').classList.add('hidden');
        }

        function showFileList() {
            document.getElementById('file-list').classList.remove('hidden');
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('empty-view').classList.add('hidden');
            document.getElementById('error-view').classList.add('hidden');
        }

        function showEmpty() {
            document.getElementById('empty-view').classList.remove('hidden');
            document.getElementById('file-list').classList.add('hidden');
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('error-view').classList.add('hidden');
        }

        function showError(msg) {
            document.getElementById('error-message').textContent = msg;
            document.getElementById('error-view').classList.remove('hidden');
            document.getElementById('file-list').classList.add('hidden');
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('empty-view').classList.add('hidden');
        }

        function updateStatus(msg) {
            document.getElementById('status-bar').textContent = msg;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        // =====================
        // FAVORITES LOGIC
        // =====================

        function loadFavorites() {
            const stored = localStorage.getItem('dropbox_favorites');
            if (stored) {
                favorites = JSON.parse(stored);
            } else {
                // Default favorites
                favorites = [
                    { name: 'Dropbox', path: '' } // Root
                ];
            }
            renderSidebar();
        }

        function saveFavorites() {
            localStorage.setItem('dropbox_favorites', JSON.stringify(favorites));
            renderSidebar();
            updateFavoriteButton();
        }

        function toggleFavorite() {
            const currentName = currentPath === '' ? 'Dropbox' : currentPath.split('/').pop();
            const existsIndex = favorites.findIndex(f => f.path === currentPath);

            if (existsIndex === -1) {
                // Add
                favorites.push({ name: currentName, path: currentPath });
                showToast('Added to Favorites');
            } else {
                // Remove
                favorites.splice(existsIndex, 1);
                showToast('Removed from Favorites');
            }
            saveFavorites();
        }

        function updateFavoriteButton() {
            const btn = document.getElementById('fav-btn');
            const isFav = favorites.some(f => f.path === currentPath);
            btn.textContent = isFav ? '‚òÖ' : '‚òÜ';
            btn.style.color = isFav ? '#990000' : 'black';
        }

        function renderSidebar() {
            const list = document.getElementById('favorites-list');
            list.innerHTML = '';

            favorites.forEach(fav => {
                const div = document.createElement('div');
                div.className = 'sidebar-item' + (fav.path === currentPath ? ' active' : '');

                div.innerHTML = `${getIconSvg('folder')} <span>${escapeHtml(fav.name)}</span>`;

                div.onclick = () => {
                    navigateTo(fav.path);
                };

                list.appendChild(div);
            });
        }

        // =====================
        // FAVORITES LOGIC
        // =====================

        function initAuthListener() {
            auth.onAuthStateChanged(user => {
                firebaseUser = user;
                if (user) {
                    // Update Status Bar if not showing path
                    if (!currentPath) updateStatus('Cloud Sync: ' + user.email);
                    loadFavorites(); // Load cloud favorites
                } else {
                    if (!currentPath) updateStatus('Local Mode');
                    loadFavorites(); // Load local favorites
                }
            });
        }

        function loadFavorites() {
            if (firebaseUser) {
                // Cloud Load
                db.collection('users').doc(firebaseUser.uid).collection('apps').doc('dropbox')
                    .onSnapshot(doc => {
                        if (doc.exists && doc.data().favorites) {
                            favorites = doc.data().favorites;
                        } else {
                            // If cloud is empty but we have local, maybe prompt to sync?
                            // For now, if cloud is empty, save default or keep local?
                            // Let's stick to simple: If cloud doc doesn't exist, we save our current "default" to it.
                            if (!doc.exists) {
                                // First time sync -> Save defaults
                                saveFavorites();
                            }
                        }
                        renderSidebar();
                        updateFavoriteButton();
                    });
            } else {
                // Local Load
                const stored = localStorage.getItem('dropbox_favorites');
                if (stored) {
                    favorites = JSON.parse(stored);
                } else {
                    favorites = [{ name: 'Dropbox', path: '' }];
                }
                renderSidebar();
                updateFavoriteButton();
            }
        }

        function saveFavorites() {
            // Always save local backup
            localStorage.setItem('dropbox_favorites', JSON.stringify(favorites));

            // Save to Cloud if logged in
            if (firebaseUser) {
                db.collection('users').doc(firebaseUser.uid).collection('apps').doc('dropbox')
                    .set({ favorites: favorites }, { merge: true })
                    .catch(e => console.error("Cloud save failed:", e));
            }

            renderSidebar();
            updateFavoriteButton();
        }

        function toggleFavorite() {
            const currentName = currentPath === '' ? 'Dropbox' : currentPath.split('/').pop();
            const existsIndex = favorites.findIndex(f => f.path === currentPath);

            if (existsIndex === -1) {
                // Add
                favorites.push({ name: currentName, path: currentPath });
                showToast('Added to Favorites');
            } else {
                // Remove
                favorites.splice(existsIndex, 1);
                showToast('Removed from Favorites');
            }
            saveFavorites();
        }

        function updateFavoriteButton() {
            const btn = document.getElementById('fav-btn');
            if (!btn) return;
            const isFav = favorites.some(f => f.path === currentPath);
            btn.textContent = isFav ? '‚òÖ' : '‚òÜ';
            btn.style.color = isFav ? '#990000' : 'black';
        }

        function renderSidebar() {
            const list = document.getElementById('favorites-list');
            list.innerHTML = '';

            favorites.forEach(fav => {
                const div = document.createElement('div');
                div.className = 'sidebar-item' + (fav.path === currentPath ? ' active' : '');

                div.innerHTML = `${getIconSvg('folder')} <span>${escapeHtml(fav.name)}</span>`;

                div.onclick = () => {
                    navigateTo(fav.path);
                };

                list.appendChild(div);
            });
        }

        // =====================
        // =====================
        // VIEW TOGGLE LOGIC
        // =====================

        let isGridMode = false;

        function loadViewPreference() {
            const pref = localStorage.getItem('dropbox_view_mode');
            isGridMode = pref === 'grid';
            applyViewMode();
        }

        function toggleView() {
            isGridMode = !isGridMode;
            localStorage.setItem('dropbox_view_mode', isGridMode ? 'grid' : 'list');
            applyViewMode();
        }

        function applyViewMode() {
            const listEl = document.getElementById('file-list');
            const btn = document.getElementById('view-toggle-btn');

            if (isGridMode) {
                listEl.classList.add('grid-mode');
                // Set icon to List View (lines) to indicate "Switch to List"
                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`;
                btn.title = "Switch to List View";
            } else {
                listEl.classList.remove('grid-mode');
                // Set icon to Grid View (squares) to indicate "Switch to Grid"
                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>`;
                btn.title = "Switch to Grid View";
            }
        }

        // =====================
        // UTILITIES
        // =====================

        function toggleFullScreen() {
            document.querySelector('.window').classList.toggle('fullscreen');
        }

        function formatKind(filename) {
            const ext = getFileExtension(filename).toLowerCase();
            const map = {
                'jpg': 'JPEG Image', 'jpeg': 'JPEG Image', 'png': 'PNG Image', 'gif': 'GIF Image',
                'webp': 'WebP Image', 'svg': 'SVG Image',
                'txt': 'Text Document', 'md': 'Markdown', 'pdf': 'PDF Document', 'doc': 'Word Doc', 'docx': 'Word Doc',
                'zip': 'ZIP Archive', 'mp3': 'MP3 Audio', 'mp4': 'MPEG-4 Video'
            };
            if (map[ext]) return map[ext];
            return ext.toUpperCase() + ' File';
        }

        function getIconSvg(type) {
            const props = 'width="20" height="20" style="vertical-align: text-bottom; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';

            if (type === 'folder') return `<svg ${props}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`;

            if (type === 'image') return `<svg ${props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`;

            if (type === 'doc') return `<svg ${props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;

            if (type === 'archive') return `<svg ${props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>`;

            if (type === 'music') return `<svg ${props}><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>`;

            if (type === 'video') return `<svg ${props}><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>`;

            if (type === 'code') return `<svg ${props}><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>`;

            // Default File
            return `<svg ${props}><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`;
        }

        function getFileIcon(filename) {
            const ext = getFileExtension(filename).toLowerCase();
            const types = {
                'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'gif': 'image', 'bmp': 'image', 'webp': 'image', 'svg': 'image',
                'mp3': 'music', 'wav': 'music', 'flac': 'music', 'm4a': 'music', 'ogg': 'music',
                'mp4': 'video', 'mov': 'video', 'avi': 'video', 'mkv': 'video', 'webm': 'video',
                'zip': 'archive', 'rar': 'archive', 'tar': 'archive', 'gz': 'archive', '7z': 'archive',
                'js': 'code', 'html': 'code', 'css': 'code', 'py': 'code', 'java': 'code', 'json': 'code', 'xml': 'code',
                'txt': 'doc', 'doc': 'doc', 'docx': 'doc', 'pdf': 'doc'
            };
            return getIconSvg(types[ext] || 'file');
        }

        function getFileExtension(filename) {
            return filename.split('.').pop() || '';
        }

        function formatSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            const options = { month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }
    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>
</body>

</html>