<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta charset="UTF-8">
    <title>Journal</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="time.js"></script>
    <script src="js/i18n.js"></script>
    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        /* STATS VIEW STYLES */
        .stats-section h3 {
            margin: 0 0 10px 0;
            border-bottom: 2px solid black;
            padding-bottom: 5px;
        }

        .stats-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .stats-bar-label {
            width: 50px;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .stats-bar-track {
            flex-grow: 1;
            height: 16px;
            border: 2px solid black;
            background: white;
            margin: 0 10px;
            position: relative;
        }

        .stats-bar-fill {
            height: 100%;
            background: black;
        }

        .stats-bar-value {
            width: 40px;
            text-align: right;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .stats-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .stats-list li {
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .stats-list li span:last-child {
            font-weight: bold;
            font-family: monospace;
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            background-repeat: repeat;
            background-position: top left;
            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
            touch-action: none;
        }

        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            width: 95%;
            height: 95vh;
            max-width: 800px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
        }

        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
            flex-shrink: 0;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        .controls {
            position: absolute;
            right: 35px;
            z-index: 1;
            background: white;
            display: flex;
            align-items: center;
        }

        .controls>*+* {
            margin-left: 10px;
        }

        .title-controls {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            display: flex;
            align-items: center;
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 4px 10px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
        }

        .sys-btn.active {
            background: black;
            color: white;
            box-shadow: none;
        }

        .sys-btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* TABS NAVIGATION */
        .tabs {
            display: flex;
            border-bottom: 2px solid black;
            background: #eee;
            flex-shrink: 0;
            z-index: 5;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-right: 1px solid black;
            background: #eee;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .tab-btn:last-child {
            border-right: none;
        }

        .tab-btn.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
            z-index: 10;
        }

        .window-content {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }

        #list-view {
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .note-item {
            padding: 15px;
            border-bottom: 1px solid #ccc;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-item:hover {
            background-color: #eee;
        }

        .note-title {
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .note-date {
            font-size: 0.8rem;
            color: #666;
        }

        /* MOOD & CHART STYLES (SYSTEM 7) */
        .mood-selector {
            display: flex;
            justify-content: center;
            padding: 10px;
            background: #eee;
            border-bottom: 2px solid black;
        }

        .mood-btn {
            background: white;
            border: 2px solid black;
            padding: 10px;
            min-width: 60px;
            font-family: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            margin: 0 5px;
        }

        .mood-btn span {
            font-size: 0.7rem;
            margin-top: 4px;
            font-weight: bold;
            font-family: "Geneva", "Verdana", sans-serif;
        }

        .mood-btn.active {
            background: #ccc;
            box-shadow: inset 2px 2px 0 rgba(0, 0, 0, 0.2);
            transform: translate(2px, 2px);
        }

        .mood-btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .feelings-selector {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 10px;
            background: #f8f8f8;
            border-bottom: 2px solid black;
        }

        .feeling-btn {
            background: white;
            border: 2px solid black;
            padding: 6px 12px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            margin: 5px;
            font-weight: bold;
        }

        .feeling-btn.active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        .causes-selector {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 10px;
            background: #e6e6e6;
            border-bottom: 2px solid black;
        }

        .cause-btn {
            background: white;
            border: 2px solid black;
            padding: 4px 8px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            margin: 4px;
            border-radius: 10px;
        }

        .cause-btn.active {
            background: #555;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        .selector-header {
            width: 100%;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #444;
        }

        /* CALENDAR STYLES (SYSTEM 7) */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #eee;
            border-bottom: 2px solid black;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            background: transparent;
            padding: 0;
            margin-left: 10px;
        }

        .calendar-day-header {
            background: transparent;
            padding: 2px;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .calendar-cell {
            background: transparent;
            min-height: 48px;
            padding: 2px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            position: relative;
        }

        .calendar-cell:active {
            background: #e0e0e0;
        }

        .calendar-cell.empty-cell {
            background: transparent;
            border-color: transparent;
            cursor: default;
        }

        .calendar-cell.future-cell {
            background: transparent;
            cursor: not-allowed;
            color: #ccc;
        }

        .calendar-cell .date-num {
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .calendar-cell .mood-indicator {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-face {
            position: relative;
            display: inline-block;
            width: 32px;
            height: 32px;
        }

        .empty-face svg {
            opacity: 0.4;
        }

        .empty-face::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(45deg, white 25%, transparent 25%),
                linear-gradient(-45deg, white 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, white 75%),
                linear-gradient(-45deg, transparent 75%, white 75%);
            background-size: 3px 3px;
            background-position: 0 0, 0 1.5px, 1.5px -1.5px, -1.5px 0px;
            pointer-events: none;
            z-index: 4;
        }

        .calendar-cell.today {
            box-shadow: inset 0 0 0 2px black;
            border: 1px solid black;
        }

        #editor-view {
            display: none;
            flex-direction: column;
        }

        .editor-toolbar {
            padding: 8px;
            border-bottom: 2px solid black;
            display: flex;
            background: #eee;
            flex-shrink: 0;
            align-items: center;
        }

        .editor-toolbar>*+* {
            margin-left: 10px;
        }

        .editor-date {
            flex-grow: 1;
            padding: 5px;
            font-family: inherit;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
        }

        textarea {
            flex-grow: 1;
            width: 100%;
            border: none;
            padding: 20px;
            font-family: "Courier New", Courier, monospace;
            font-size: 1.2rem;
            line-height: 1.5;
            resize: none;
            box-sizing: border-box;
            outline: none;
            overflow-y: auto;
        }

        #text-container {
            flex-grow: 1;
            display: flex;
        }

        #status-bar {
            border-top: 2px solid black;
            padding: 4px;
            font-size: 0.75rem;
            background: #eee;
            text-align: center;
            flex-shrink: 0;
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .modal-buttons>*+* {
            margin-left: 10px;
        }
    </style>
    <script src="theme.js"></script>
    <script src="time.js"></script>
    <script src="js/i18n.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text" data-i18n="journal.title">Journal</span>
            <div class="title-controls">
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1"></path>
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- TAB BAR -->
        <div class="tabs" id="main-tabs">
            <div class="tab-btn active" onclick="switchTab('list')" id="tab-btn-list" data-i18n="journal.tab.calendar">
                Calendar</div>
            <div class="tab-btn" onclick="switchTab('stats')" id="tab-btn-stats" data-i18n="journal.tab.stats">Stats
            </div>
        </div>

        <div class="window-content">
            <!-- LIST VIEW -->
            <div id="list-view" class="view">
                <div style="padding:20px; text-align:center; color:#666;" data-i18n="common.loading">Loading entries...
                </div>
            </div>

            <!-- EDITOR VIEW -->
            <div id="editor-view" class="view">
                <div class="editor-toolbar">
                    <button class="sys-btn" onclick="showList()" data-i18n="common.back">Back</button>
                    <div class="editor-date" id="editor-date-display">Date</div>
                    <button class="sys-btn" onclick="promptDelete()" data-i18n="common.delete">Delete</button>
                </div>

                <div class="mood-selector" id="mood-selector">
                    <button class="mood-btn" onclick="setMood(1)" id="mood-btn-1">
                        <div style="margin-bottom: 2px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                width="24" height="24" stroke="black" stroke-width="2" fill="none">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M8 9l2 2m4 0l2-2m-8 6c2-2 6-2 8 0" />
                            </svg></div><span data-i18n="journal.mood.awful">Awful</span>
                    </button>
                    <button class="mood-btn" onclick="setMood(2)" id="mood-btn-2">
                        <div style="margin-bottom: 2px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                width="24" height="24" stroke="black" stroke-width="2" fill="none">
                                <circle cx="12" cy="12" r="10" />
                                <circle cx="9" cy="9" r="1" fill="black" />
                                <circle cx="15" cy="9" r="1" fill="black" />
                                <path d="M8 16c2-1 6-1 8 0" />
                            </svg></div><span data-i18n="journal.mood.bad">Bad</span>
                    </button>
                    <button class="mood-btn" onclick="setMood(3)" id="mood-btn-3">
                        <div style="margin-bottom: 2px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                width="24" height="24" stroke="black" stroke-width="2" fill="none">
                                <circle cx="12" cy="12" r="10" />
                                <circle cx="9" cy="9" r="1" fill="black" />
                                <circle cx="15" cy="9" r="1" fill="black" />
                                <path d="M8 15h8" />
                            </svg></div><span data-i18n="journal.mood.neutral">Neutral</span>
                    </button>
                    <button class="mood-btn" onclick="setMood(4)" id="mood-btn-4">
                        <div style="margin-bottom: 2px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                width="24" height="24" stroke="black" stroke-width="2" fill="none">
                                <circle cx="12" cy="12" r="10" />
                                <circle cx="9" cy="9" r="1" fill="black" />
                                <circle cx="15" cy="9" r="1" fill="black" />
                                <path d="M8 14c2 1 6 1 8 0" />
                            </svg></div><span data-i18n="journal.mood.good">Good</span>
                    </button>
                    <button class="mood-btn" onclick="setMood(5)" id="mood-btn-5">
                        <div style="margin-bottom: 2px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                width="24" height="24" stroke="black" stroke-width="2" fill="none">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M8 9c1-1 2-1 3 0m2 0c1-1 2-1 3 0m-8 5c2 2 6 2 8 0" />
                            </svg></div><span data-i18n="journal.mood.great">Great</span>
                    </button>
                </div>
                <div class="feelings-selector" id="feelings-selector"></div>
                <div class="causes-selector" id="causes-selector"></div>

                <div id="text-container">
                    <textarea id="note-content" placeholder="Notes" oninput="saveCurrentNote()"
                        data-i18n-placeholder="journal.placeholder.notes"></textarea>
                </div>
            </div>

            <!-- STATS VIEW -->
            <div id="stats-view" class="view"
                style="display:none; padding:15px; overflow-y:auto; background:white; height: 100%;">

                <div class="stats-section">
                    <h3 data-i18n="journal.stats.recent_trend">Recent Trend</h3>
                    <div id="stats-trend" style="font-size: 1.2rem; font-weight: bold; padding: 5px 0;"></div>
                </div>

                <div class="stats-section" style="margin-top: 25px;">
                    <h3 data-i18n="journal.stats.mood_distribution">Mood Distribution</h3>
                    <div id="stats-mood-bars"></div>
                </div>

                <div class="stats-section" style="margin-top: 25px;">
                    <h3 data-i18n="journal.stats.top_feelings">Top Feelings</h3>
                    <ul id="stats-top-feelings" class="stats-list"></ul>
                </div>

                <div class="stats-section" style="margin-top: 25px;">
                    <h3 data-i18n="journal.stats.top_causes">Top Causes</h3>
                    <ul id="stats-top-causes" class="stats-list"></ul>
                </div>
            </div>
        </div>
        <div id="status-bar" data-i18n="status.guest">Local Mode</div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title">Confirm</h3>
            <p id="modal-desc">Are you sure?</p>
            <div class="modal-buttons">
                <button class="sys-btn" id="modal-confirm-btn" data-i18n="common.ok">OK</button>
                <button class="sys-btn" onclick="closeModal()" data-i18n="common.cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        if (db.settings) {
            try { db.settings({ experimentalForceLongPolling: true, merge: true }); }
            catch (e) { console.warn("Settings error:", e); }
        }

        // --- STATE ---
        let notes = [];
        const NOTES_CACHE_KEY = 'rekindle_journal_cache';
        let currentNoteId = null;
        let currentUser = null;
        let saveTimer = null;
        let unsubscribe = null;
        let currentView = 'list';

        // Use timezone-aware date if available
        function getNow() {
            return window.rekindleGetZonedDate ? window.rekindleGetZonedDate() : new Date();
        }

        // Feelings Matrix
        const FEELINGS_MAP = {
            1: ['depressed', 'angry', 'anxious', 'hopeless', 'exhausted', 'worthless', 'panicked', 'numb', 'miserable', 'furious', 'terrified', 'despairing', 'drained', 'ashamed', 'devastated', 'trapped'],
            2: ['sad', 'frustrated', 'stressed', 'lonely', 'tired', 'disappointed', 'guilty', 'overwhelmed', 'upset', 'annoyed', 'tense', 'isolated', 'fatigued', 'let_down', 'regretful', 'pressured'],
            3: ['okay', 'bored', 'calm', 'apathetic', 'distracted', 'indifferent', 'content', 'meh', 'unfocused', 'peaceful', 'neutral', 'steady', 'balanced', 'unbothered', 'routine'],
            4: ['happy', 'relaxed', 'productive', 'hopeful', 'energetic', 'confident', 'amused', 'relieved', 'cheerful', 'chill', 'focused', 'active', 'proud_of_myself', 'entertained', 'supported'],
            5: ['joyful', 'excited', 'proud', 'grateful', 'inspired', 'loving', 'optimistic', 'thrilled', 'ecstatic', 'elated', 'triumphant', 'blessed', 'creative', 'affectionate', 'radiant', 'euphoric']
        };

        const CAUSES_LIST = ['health', 'hobbies', 'family', 'friends', 'partner', 'work', 'weather', 'money', 'sleep', 'food', 'travel', 'exercise', 'school', 'chores', 'news', 'commute', 'social_media', 'reading', 'gaming', 'music', 'art', 'nature', 'pets', 'spirituality', 'therapy', 'shopping', 'cleaning', 'cooking', 'relaxing', 'party'];

        // --- INIT ---
        window.onload = () => {
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            if (window.rekindleApplyDefaultFullscreen) window.rekindleApplyDefaultFullscreen();

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('status-bar').innerText = window.t('status.synced', "Synced: ") + user.email;
                    loadCachedNotes();
                    loadCloudNotes();
                } else {
                    document.getElementById('status-bar').innerText = window.t('status.guest', "Guest Mode (Local)");
                    loadLocalNotes();
                }
            });
        };

        // --- DATA MANAGEMENT ---
        function loadLocalNotes() {
            notes = JSON.parse(localStorage.getItem('rekindle_journal')) || [];
            renderList();
        }

        function loadCachedNotes() {
            try {
                const cached = localStorage.getItem(NOTES_CACHE_KEY);
                if (cached) {
                    notes = JSON.parse(cached);
                    notes.sort((a, b) => b.updated - a.updated);
                    renderList();
                }
            } catch (e) { console.error("Cache load error", e); }
        }

        function updateCache() {
            try {
                // To avoid massive local storage size, we could trim if necessary
                // localStorage limit is ~5MB, usually fine for a few base64 sketches.
                localStorage.setItem(currentUser ? NOTES_CACHE_KEY : 'rekindle_journal', JSON.stringify(notes));
            } catch (e) { console.error("Cache save error, might be full", e); }
        }

        function loadCloudNotes() {
            if (unsubscribe) unsubscribe();
            const notesRef = db.collection('users').doc(currentUser.uid).collection('journal');

            unsubscribe = notesRef.orderBy('updated', 'desc')
                .onSnapshot((snapshot) => {
                    const cloudNotes = [];
                    snapshot.forEach(doc => {
                        let data = doc.data();
                        data.id = doc.id;
                        cloudNotes.push(data);
                    });

                    if (cloudNotes.length > 0 || snapshot.size === 0) {
                        notes = cloudNotes;
                        updateCache();
                        renderList();
                    }
                }, (error) => {
                    console.error("Error getting notes: ", error);
                    document.getElementById('status-bar').innerText = window.t('status.offline', "Offline. Using Cache.");
                });
        }

        function saveNoteData(note) {
            updateCache();
            if (currentUser) {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    document.getElementById('status-bar').innerText = window.t('notes.status.saving', "Saving...");
                    db.collection('users').doc(currentUser.uid).collection('journal').doc(note.id).set({
                        mood: note.mood,
                        feelings: note.feelings || [],
                        causes: note.causes || [],
                        content: note.content,
                        updated: note.updated
                    }).then(() => {
                        document.getElementById('status-bar').innerText = window.t('notes.status.saved', "Saved.");
                        setTimeout(() => { document.getElementById('status-bar').innerText = window.t('status.synced', "Synced: ") + currentUser.email; }, 2000);
                    }).catch((e) => {
                        document.getElementById('status-bar').innerText = window.t('notes.status.failed', "Save Failed.");
                        console.error(e);
                    });
                }, 1000);
            }
        }

        function deleteNoteData(id) {
            notes = notes.filter(n => n.id !== id);
            updateCache();
            renderList();

            if (currentUser) {
                db.collection('users').doc(currentUser.uid).collection('journal').doc(id).delete().catch(err => {
                    console.error("Delete failed", err);
                });
            }
        }

        function getMoodEmoji(val) {
            let svg = '';
            if (val === 1) svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" stroke="black" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/><path d="M8 9l2 2m4 0l2-2m-8 6c2-2 6-2 8 0"/></svg>';
            else if (val === 2) svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" stroke="black" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/><circle cx="9" cy="9" r="1" fill="black"/><circle cx="15" cy="9" r="1" fill="black"/><path d="M8 16c2-1 6-1 8 0"/></svg>';
            else if (val === 3) svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" stroke="black" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/><circle cx="9" cy="9" r="1" fill="black"/><circle cx="15" cy="9" r="1" fill="black"/><path d="M8 15h8"/></svg>';
            else if (val === 4) svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" stroke="black" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/><circle cx="9" cy="9" r="1" fill="black"/><circle cx="15" cy="9" r="1" fill="black"/><path d="M8 14c2 1 6 1 8 0"/></svg>';
            else if (val === 5) svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" stroke="black" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/><path d="M8 9c1-1 2-1 3 0m2 0c1-1 2-1 3 0m-8 5c2 2 6 2 8 0"/></svg>';
            else return '<b>[ ]</b>'; // Default for old missing
            return `<div style="color: black;">${svg}</div>`;
        }

        function renderMonth(year, month, todayId, todayDateObj) {
            const gridDiv = document.createElement('div');
            gridDiv.className = 'calendar-grid';
            gridDiv.style.marginBottom = '20px'; // Space between months

            // Month Header (simpler for inline)
            const monthHeader = document.createElement('div');
            monthHeader.style.padding = '10px';
            monthHeader.style.background = 'black';
            monthHeader.style.color = 'white';
            monthHeader.style.fontWeight = 'bold';
            monthHeader.style.textAlign = 'center';
            const mDate = new Date(year, month, 1);
            monthHeader.innerText = mDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });

            // Container for this month
            const monthContainer = document.createElement('div');
            monthContainer.appendChild(monthHeader);
            monthContainer.appendChild(gridDiv);

            // Days of week header
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(d => {
                gridDiv.innerHTML += `<div class="calendar-day-header">${d}</div>`;
            });

            // Calculate days in month and starting day
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIdx = mDate.getDay();

            // Pad empty cells before 1st
            for (let i = 0; i < firstDayIdx; i++) {
                gridDiv.innerHTML += `<div class="calendar-cell empty-cell"></div>`;
            }

            // Create cells for each day
            for (let day = 1; day <= daysInMonth; day++) {
                const dateId = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const note = notes.find(n => n.id === dateId);
                const cellDateObj = new Date(year, month, day);

                // Future check (strip time for fair comparison)
                const isFuture = cellDateObj > todayDateObj;

                let cellHtml = '';
                if (isFuture) {
                    cellHtml = `<div class="calendar-cell future-cell" title="Future date">
                        <div class="date-num">${day}</div>
                        <div class="mood-indicator"></div>
                    </div>`;
                } else {
                    let classes = `calendar-cell ${dateId === todayId ? 'today' : ''}`;
                    cellHtml = `<div class="${classes}" onclick="createNote('${dateId}')" `;

                    if (note) {
                        cellHtml += `title="Click to edit">`;
                        cellHtml += `
                            <div class="date-num">${day}</div>
                            <div class="mood-indicator">${getMoodEmoji(note.mood)}</div>
                        `;
                    } else {
                        cellHtml += `title="Click to write">
                            <div class="date-num">${day}</div>
                            <div class="mood-indicator">
                                <div class="empty-face">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" stroke="black" stroke-width="2" fill="none">
                                        <circle cx="12" cy="12" r="10" />
                                        <circle cx="9" cy="9" r="1" fill="black" />
                                        <circle cx="15" cy="9" r="1" fill="black" />
                                    </svg>
                                </div>
                            </div>
                        `;
                    }
                    cellHtml += `</div>`;
                }
                gridDiv.innerHTML += cellHtml;
            }

            // Pad empty cells after last day to complete max 6 rows
            const totalCells = firstDayIdx + daysInMonth;
            const remaining = Math.ceil(totalCells / 7) * 7 - totalCells;
            for (let i = 0; i < remaining; i++) {
                gridDiv.innerHTML += `<div class="calendar-cell empty-cell"></div>`;
            }

            return monthContainer;
        }

        function renderList() {
            const listContainer = document.getElementById('list-view');
            listContainer.innerHTML = '';

            const scrollDiv = document.createElement('div');
            scrollDiv.style.flexGrow = '1';
            scrollDiv.style.overflowY = 'auto';
            listContainer.appendChild(scrollDiv);

            const today = getNow();
            // Create a normalized today object specifically for future checking boundary.
            const todayDateObj = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const todayId = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            let oldestM = today.getMonth();
            let oldestY = today.getFullYear();

            // Initial render of 6 months backwards
            for (let i = 0; i < 6; i++) {
                const monthBlock = renderMonth(oldestY, oldestM, todayId, todayDateObj);
                scrollDiv.prepend(monthBlock);
                oldestM--;
                if (oldestM < 0) {
                    oldestM = 11;
                    oldestY--;
                }
            }

            // Scroll to bottom immediately
            setTimeout(() => {
                scrollDiv.scrollTop = scrollDiv.scrollHeight;
            }, 10);

            // Infinite scroll logic
            scrollDiv.addEventListener('scroll', () => {
                if (scrollDiv.scrollTop < 300) {
                    const prevHeight = scrollDiv.scrollHeight;
                    for (let i = 0; i < 3; i++) {
                        const monthBlock = renderMonth(oldestY, oldestM, todayId, todayDateObj);
                        scrollDiv.prepend(monthBlock);
                        oldestM--;
                        if (oldestM < 0) {
                            oldestM = 11;
                            oldestY--;
                        }
                    }
                    scrollDiv.scrollTop = scrollDiv.scrollTop + (scrollDiv.scrollHeight - prevHeight);
                }
            });

            // Update mode/status display temporarily to force repaint if needed
            if (currentView === 'list') {
                listContainer.style.display = 'none';
                listContainer.offsetHeight; // layout trigger
                listContainer.style.display = 'flex';
            }
        }

        function createNote(dateStr = null) {
            const today = getNow();
            const id = dateStr || `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            // Check if note exists for this day
            const existing = notes.find(n => n.id === id);
            if (existing) {
                openNote(id);
                return;
            }

            const newNote = {
                id: id,
                mood: 3, // Default mood
                feelings: [],
                causes: [],
                content: '',
                updated: Date.now()
            };

            notes.push(newNote);
            saveNoteData(newNote);
            openNote(newNote.id, newNote);
        }

        function openNote(id, noteObj = null) {
            currentNoteId = id;
            const note = noteObj || notes.find(n => n.id === id);
            if (!note) return;

            // id is YYYY-MM-DD
            try {
                const parts = id.split('-');
                const localDate = new Date(parts[0], parts[1] - 1, parts[2]);
                document.getElementById('editor-date-display').innerText = localDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
            } catch (e) {
                document.getElementById('editor-date-display').innerText = id;
            }

            document.getElementById('note-content').value = note.content || '';

            // Set Mood UI
            setMoodUI(note.mood || 3);
            renderFeelingsUI(note.mood || 3, false);
            renderCausesUI(false);

            currentView = 'editor';
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('main-tabs').style.display = 'none';
            document.getElementById('editor-view').style.display = 'flex';
        }

        function setMood(val) {
            let note = notes.find(n => n.id === currentNoteId);
            if (note && note.mood !== val) {
                // If the user explicitly changes the active mood tire, clear their sub-feelings
                note.feelings = [];
            }
            setMoodUI(val);
            renderFeelingsUI(val, false);
            saveCurrentNote();
        }

        function renderFeelingsUI(moodVal, reset) {
            const container = document.getElementById('feelings-selector');
            container.innerHTML = '';

            const header = document.createElement('div');
            header.className = 'selector-header';
            header.setAttribute('data-i18n', 'journal.ui.feelings_header');
            header.innerText = window.t ? window.t('journal.ui.feelings_header', 'Feelings') : 'Feelings';
            container.appendChild(header);

            let note = notes.find(n => n.id === currentNoteId) || { feelings: [] };
            if (reset) note.feelings = [];
            if (!note.feelings) note.feelings = [];

            const feelingsList = FEELINGS_MAP[moodVal] || [];

            feelingsList.forEach(key => {
                const isActive = note.feelings.includes(key);
                const btn = document.createElement('button');
                btn.className = 'feeling-btn' + (isActive ? ' active' : '');
                btn.id = 'feeling-btn-' + key;
                btn.onclick = () => toggleFeeling(key);

                // Capitalize default translation fallback
                const fallback = key.charAt(0).toUpperCase() + key.slice(1);
                btn.innerText = window.t ? window.t('journal.feeling.' + key, fallback) : fallback;
                // Add i18n data attribute so it updates if language changes mid-view
                btn.setAttribute('data-i18n', 'journal.feeling.' + key);

                container.appendChild(btn);
            });
        }

        function toggleFeeling(key) {
            let note = notes.find(n => n.id === currentNoteId);
            if (!note) return;
            if (!note.feelings) note.feelings = [];

            const idx = note.feelings.indexOf(key);
            if (idx > -1) {
                note.feelings.splice(idx, 1);
            } else {
                note.feelings.push(key);
            }

            // Toggle visual button state instantly
            const btn = document.getElementById('feeling-btn-' + key);
            if (btn) btn.classList.toggle('active');

            saveCurrentNote();
        }

        function renderCausesUI(reset) {
            const container = document.getElementById('causes-selector');
            container.innerHTML = '';

            const header = document.createElement('div');
            header.className = 'selector-header';
            header.setAttribute('data-i18n', 'journal.ui.causes_header');
            header.innerText = window.t ? window.t('journal.ui.causes_header', 'Causes') : 'Causes';
            container.appendChild(header);

            let note = notes.find(n => n.id === currentNoteId) || { causes: [] };
            if (reset) note.causes = [];
            if (!note.causes) note.causes = [];

            CAUSES_LIST.forEach(key => {
                const isActive = note.causes.includes(key);
                const btn = document.createElement('button');
                btn.className = 'cause-btn' + (isActive ? ' active' : '');
                btn.id = 'cause-btn-' + key;
                btn.onclick = () => toggleCause(key);

                // Capitalize default translation fallback
                const fallback = key.charAt(0).toUpperCase() + key.slice(1);
                btn.innerText = window.t ? window.t('journal.cause.' + key, fallback) : fallback;
                // Add i18n data attribute so it updates if language changes mid-view
                btn.setAttribute('data-i18n', 'journal.cause.' + key);

                container.appendChild(btn);
            });
        }

        function toggleCause(key) {
            let note = notes.find(n => n.id === currentNoteId);
            if (!note) return;
            if (!note.causes) note.causes = [];

            const idx = note.causes.indexOf(key);
            if (idx > -1) {
                note.causes.splice(idx, 1);
            } else {
                note.causes.push(key);
            }

            // Toggle visual button state instantly
            const btn = document.getElementById('cause-btn-' + key);
            if (btn) btn.classList.toggle('active');

            saveCurrentNote();
        }

        function setMoodUI(val) {
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById('mood-btn-' + i);
                if (btn) {
                    if (i === val) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            }
        }

        function saveCurrentNote() {
            if (!currentNoteId) return;

            let note = notes.find(n => n.id === currentNoteId);
            if (!note) {
                note = { id: currentNoteId };
                notes.push(note);
            }

            note.updated = Date.now();

            // Find active mood
            let moodVal = 3;
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById('mood-btn-' + i);
                if (btn && btn.classList.contains('active')) {
                    moodVal = i;
                    break;
                }
            }
            note.mood = moodVal;
            note.content = document.getElementById('note-content').value;

            saveNoteData(note);
        }

        // --- MODAL & NAVIGATION LOGIC ---
        function promptDelete() {
            showModal(
                window.t ? window.t('notes.modal.delete.title', 'Delete Entry?') : 'Delete Entry?',
                window.t ? window.t('notes.modal.delete.desc', 'Are you sure you want to delete this?') : 'Are you sure you want to delete this?',
                () => {
                    deleteNoteData(currentNoteId);
                    showList();
                }
            );
        }

        function showModal(title, desc, onConfirm) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('modal-confirm-btn').onclick = () => {
                closeModal();
                if (onConfirm) onConfirm();
            };
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function switchTab(tabId) {
            // Update Tab UI Flags
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-btn-${tabId}`).classList.add('active');

            // Save active note if leaving editor
            if (currentView === 'editor' && currentNoteId && notes.some(n => n.id === currentNoteId)) {
                saveCurrentNote();
            }

            currentNoteId = null;
            currentView = tabId;

            document.getElementById('editor-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('main-tabs').style.display = 'flex';

            if (tabId === 'list') {
                document.getElementById('list-view').style.display = 'flex';
                renderList();
            } else if (tabId === 'stats') {
                renderStats();
            }
        }

        function showList() {
            switchTab('list');
        }

        function renderStats() {
            document.getElementById('stats-view').style.display = 'block';

            let moodCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            let feelingCounts = {};
            let causeCounts = {};
            let totalMoods = 0;

            const moodNotes = notes.filter(n => n.mood).sort((a, b) => b.id.localeCompare(a.id));
            let trendText = window.t ? window.t('journal.trend.insufficient', 'Not enough data') : 'Not enough data';
            if (moodNotes.length >= 3) {
                const recent = moodNotes.slice(0, 7);
                const avg = recent.reduce((sum, n) => sum + n.mood, 0) / recent.length;
                if (avg >= 3.5) trendText = window.t ? window.t('journal.trend.positive', 'Positive') : 'Positive';
                else if (avg <= 2.5) trendText = window.t ? window.t('journal.trend.negative', 'Negative') : 'Negative';
                else trendText = window.t ? window.t('journal.trend.stable', 'Stable') : 'Stable';
            }
            document.getElementById('stats-trend').innerText = trendText;

            notes.forEach(note => {
                if (note.mood) {
                    moodCounts[note.mood]++;
                    totalMoods++;
                }

                if (note.feelings && Array.isArray(note.feelings)) {
                    note.feelings.forEach(f => {
                        feelingCounts[f] = (feelingCounts[f] || 0) + 1;
                    });
                }

                if (note.causes && Array.isArray(note.causes)) {
                    note.causes.forEach(c => {
                        causeCounts[c] = (causeCounts[c] || 0) + 1;
                    });
                }
            });

            // Render Mood Bars
            const moodContainer = document.getElementById('stats-mood-bars');
            moodContainer.innerHTML = '';
            for (let i = 5; i >= 1; i--) {
                let pct = totalMoods > 0 ? Math.round((moodCounts[i] / totalMoods) * 100) : 0;
                // Get translated label
                let rawLabel = '';
                if (i === 5) rawLabel = 'journal.mood.great';
                else if (i === 4) rawLabel = 'journal.mood.good';
                else if (i === 3) rawLabel = 'journal.mood.neutral';
                else if (i === 2) rawLabel = 'journal.mood.bad';
                else if (i === 1) rawLabel = 'journal.mood.awful';

                let label = window.t ? window.t(rawLabel) : rawLabel.split('.').pop();

                moodContainer.innerHTML += `
                    <div class="stats-bar-container">
                        <div class="stats-bar-label">${label}</div>
                        <div class="stats-bar-track">
                            <div class="stats-bar-fill" style="width: ${pct}%"></div>
                        </div>
                        <div class="stats-bar-value">${pct}%</div>
                    </div>
                `;
            }

            // Render Top Feelings
            const feelingsList = document.getElementById('stats-top-feelings');
            feelingsList.innerHTML = '';
            let sortedFeelings = Object.entries(feelingCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            if (sortedFeelings.length === 0) {
                feelingsList.innerHTML = `<li style="font-style:italic; border-bottom:none; color:#666;">No feelings logged yet.</li>`;
            } else {
                sortedFeelings.forEach(([feeling, count]) => {
                    let label = window.t ? window.t(`journal.feeling.${feeling}`, feeling) : feeling;
                    feelingsList.innerHTML += `<li><span>${label}</span><span>${count}</span></li>`;
                });
            }

            // Render Top Causes
            const causesList = document.getElementById('stats-top-causes');
            causesList.innerHTML = '';
            let sortedCauses = Object.entries(causeCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            if (sortedCauses.length === 0) {
                causesList.innerHTML = `<li style="font-style:italic; border-bottom:none; color:#666;">No causes logged yet.</li>`;
            } else {
                sortedCauses.forEach(([cause, count]) => {
                    let label = window.t ? window.t(`journal.cause.${cause}`, cause) : cause;
                    causesList.innerHTML += `<li><span>${label}</span><span>${count}</span></li>`;
                });
            }
        }

        function toggleFullScreen() {
            document.querySelector('.window').classList.toggle('fullscreen');
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

    </script>

</body>

</html>