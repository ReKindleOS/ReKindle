<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Decider</title>
    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 600px;
            position: relative;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* CONTENT */
        .window-content {
            flex-grow: 1;
            overflow: hidden;
            padding: 10px;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        #wheel-container {
            width: 300px;
            height: 300px;
            position: relative;
            margin: 10px 0;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .pointer {
            position: absolute;
            top: 50%;
            right: -15px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 20px solid black;
            z-index: 10;
        }

        /* INPUTS */
        .controls {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 2px solid black;
            padding-top: 10px;
            flex-grow: 1;
            overflow: hidden;
        }

        .input-row {
            display: flex;
            gap: 5px;
        }

        input {
            flex-grow: 1;
            border: 2px solid black;
            padding: 8px;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
        }

        button {
            background: white;
            border: 2px solid black;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 2px 2px 0 black;
        }

        button:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .add-btn {
            padding: 0 15px;
            font-size: 1.2rem;
        }

        .spin-btn {
            padding: 15px;
            font-size: 1.2rem;
            text-transform: uppercase;
            width: 100%;
            margin-top: auto;
            /* Push to bottom */
        }

        .option-list {
            flex-grow: 1;
            overflow-y: auto;
            border: 2px solid black;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eee;
            padding: 5px 10px;
            border: 1px solid black;
        }

        .remove-btn {
            background: transparent;
            border: none;
            box-shadow: none;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 0 5px;
            cursor: pointer;
        }

        .remove-btn:active {
            transform: none;
            color: red;
            background: transparent;
        }

        /* POPUP RESULT */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            display: none;
        }

        .result-box {
            background: white;
            border: 4px solid black;
            padding: 30px;
            text-align: center;
            box-shadow: 8px 8px 0 black;
            min-width: 200px;
        }

        .result-text {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            word-break: break-word;
        }
    </style>
    <script src="js/i18n.js"></script>
    <script src="theme.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text" data-i18n="decider.title">Decider</span>
        </div>

        <div class="window-content">

            <div id="wheel-container">
                <canvas id="wheel" width="600" height="600"></canvas>
                <div class="pointer"></div>
            </div>

            <div class="controls">
                <div class="input-row">
                    <input type="text" id="new-option" placeholder="Add option (e.g. Pizza)"
                        data-i18n-placeholder="decider.placeholder" onkeydown="checkEnter(event)">
                    <button class="add-btn" onclick="addOption()">+</button>
                </div>

                <div class="option-list" id="option-list">
                    <!-- Items go here -->
                </div>

                <button class="spin-btn" onclick="spinWheel()" id="spin-btn" data-i18n="decider.spin">Spin!</button>
            </div>

        </div>

        <!-- Result Modal -->
        <div class="modal-overlay" id="result-modal" onclick="closeModal()">
            <div class="result-box" onclick="event.stopPropagation()">
                <div style="font-size:0.8rem; text-transform:uppercase; margin-bottom:5px;" data-i18n="decider.result">
                    Result</div>
                <div class="result-text" id="result-text">???</div>
                <button onclick="closeModal()" style="padding:10px 30px;" data-i18n="decider.ok">OK</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const size = 600;
        const center = size / 2;
        const radius = size / 2 - 10;

        let options = ["Yes", "No", "Maybe"];
        let currentRotation = 0;
        let isSpinning = false;

        // Colors for segments (High contrast B&W compliant)
        const colors = ['#ffffff', '#dddddd'];

        window.onload = () => {
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            loadOptions();
            drawWheel();
            renderList();
        };

        function checkEnter(e) {
            if (e.key === "Enter") addOption();
        }

        function addOption() {
            const input = document.getElementById('new-option');
            const val = input.value.trim();
            if (val) {
                options.push(val);
                input.value = '';
                saveOptions();
                renderList();
                drawWheel();
            }
        }

        function removeOption(index) {
            if (isSpinning) return;
            options.splice(index, 1);
            saveOptions();
            renderList();
            drawWheel();
        }

        function saveOptions() {
            localStorage.setItem('decider_options', JSON.stringify(options));
        }

        function loadOptions() {
            const saved = localStorage.getItem('decider_options');
            if (saved) {
                try {
                    options = JSON.parse(saved);
                } catch (e) { }
            }
            if (options.length === 0) options = ["Yes", "No"];
        }

        function renderList() {
            const list = document.getElementById('option-list');
            list.innerHTML = '';
            options.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'option-item';
                div.innerHTML = `
                    <span>${opt}</span>
                    <button class="remove-btn" onclick="removeOption(${i})">Ã—</button>
                `;
                list.appendChild(div);
            });
        }

        function drawWheel() {
            if (options.length === 0) return;

            ctx.clearRect(0, 0, size, size);

            const sliceAngle = (2 * Math.PI) / options.length;

            ctx.save();
            ctx.translate(center, center);
            ctx.rotate(currentRotation);

            for (let i = 0; i < options.length; i++) {
                const angle = i * sliceAngle;

                // Slice
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + sliceAngle);
                ctx.fillStyle = (i % 2 === 0) ? colors[0] : colors[1];
                ctx.fill();
                ctx.lineWidth = 4;
                ctx.strokeStyle = "black";
                ctx.stroke();

                // Text
                ctx.save();
                ctx.rotate(angle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "black";
                ctx.font = "bold 40px Arial"; // Canvas font relative to 600px width
                ctx.fillText(options[i], radius - 20, 15);
                ctx.restore();
            }

            ctx.restore();

            // Outer Border
            ctx.beginPath();
            ctx.arc(center, center, radius, 0, 2 * Math.PI);
            ctx.lineWidth = 10;
            ctx.strokeStyle = "black";
            ctx.stroke();

            // Center Pin
            ctx.beginPath();
            ctx.arc(center, center, 20, 0, 2 * Math.PI);
            ctx.fillStyle = "white";
            ctx.fill();
            ctx.stroke();
        }

        function spinWheel() {
            if (isSpinning || options.length === 0) return;
            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;

            const spinDuration = 6000 + Math.random() * 6000; // 6-12 seconds
            const startTime = Date.now();
            const totalRotation = (8 + Math.random() * 8) * Math.PI * 2; // 8-16 full rotations
            const startRotation = currentRotation;

            const animate = () => {
                const now = Date.now();
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / spinDuration, 1);

                // Ease-out cubic for smooth deceleration
                const eased = 1 - Math.pow(1 - progress, 3);

                currentRotation = startRotation + (totalRotation * eased);
                drawWheel();

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    document.getElementById('spin-btn').disabled = false;
                    calculateResult();
                }
            };

            requestAnimationFrame(animate);
        }

        function calculateResult() {
            // Normalize rotation to 0-2PI
            const normalized = currentRotation % (2 * Math.PI);

            // The pointer is at 0 rad (right side) in canvas space?
            // Actually, in standard arc, 0 is at 3 o'clock.
            // Our pointer CSS is at right: -15px, which corresponds to 0 rad.
            // So we just need to see which slice overlaps 0 rad.
            // But wait, we rotated the context by `currentRotation`.
            // The slice `i` starts at `i * sliceAngle`.
            // An angle `theta` on the wheel is now at `theta + currentRotation`.
            // We want `theta + currentRotation = 0` (or 2PI multiples)
            // So `theta = -currentRotation`.

            const sliceAngle = (2 * Math.PI) / options.length;

            // Calculate which index is under the pointer (angle 0)
            // We need positive modulo
            const effectiveAngle = (2 * Math.PI - normalized) % (2 * Math.PI);

            const index = Math.floor(effectiveAngle / sliceAngle);

            // Because our rendering loop goes 0, 1, 2... clockwise
            // The logic above is slightly tricky. let's verify.
            // If angle 0 is drawn from 0 to sliceAngle.
            // If we rotate +10 degrees. The slice is now 10 to 10+slice.
            // Pointer is at 0. It is NOT in slice 0.
            // We need more rigorous math or trial.
            // Let's assume the pointer is at 0 radians.
            // The wheel is rotated by `currentRotation`.
            // The pointer's angle relative to the wheel is `0 - currentRotation` = `-currentRotation`.
            // We normalize this to [0, 2PI).

            const pointerRelAngle = (2 * Math.PI - (currentRotation % (2 * Math.PI))) % (2 * Math.PI);
            // This is the angle on the wheel that is currently at 3 o'clock.

            const winningIndex = Math.floor(pointerRelAngle / sliceAngle);
            const winner = options[winningIndex];

            showResult(winner);
        }

        function showResult(text) {
            document.getElementById('result-text').innerText = text;
            document.getElementById('result-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('result-modal').style.display = 'none';
        }


    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>
</body>

</html>