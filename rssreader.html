<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RSS Reader</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            /* Background managed by settings */

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 800px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
        }

        /* Icon State Toggles */
        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        .controls {
            position: absolute;
            right: 10px;
            z-index: 1;
            background: white;
            display: flex;
            gap: 10px;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        /* CLOSE BUTTON */
        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* TABS */
        .tabs {
            display: flex;
            border-bottom: 2px solid black;
            background: #eee;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-right: 1px solid black;
            background: #eee;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .tab-btn:last-child {
            border-right: none;
        }

        .tab-btn.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
            z-index: 10;
        }

        /* CONTENT AREA */
        .window-content {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* VIEW: HEADLINES */
        #view-headlines {
            overflow-y: auto;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* FILTER BAR */
        .filter-bar {
            display: flex;
            padding: 8px;
            border-bottom: 1px solid #ccc;
            background: #f9f9f9;
            gap: 10px;
            justify-content: center;
            flex-shrink: 0;
        }

        .filter-btn {
            background: white;
            border: 1px solid #999;
            padding: 4px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 12px;
        }

        .filter-btn.active {
            background: black;
            color: white;
            border-color: black;
            font-weight: bold;
        }

        .article {
            padding: 15px;
            border-bottom: 1px solid #ccc;
            display: flex;
            flex-direction: row;
            /* Image on right */
            gap: 15px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .article:last-child {
            border-bottom: none;
        }

        .article:active {
            background: #f0f0f0;
        }

        /* Read State Styling */
        .article.read .article-title {
            color: #666;
            font-weight: normal;
        }

        .article.read .article-snippet {
            color: #999;
        }

        .article.read {
            background: #fafafa;
        }

        .article-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .article-source {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: bold;
            color: #666;
        }

        .article-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: black;
            text-decoration: none;
            line-height: 1.3;
        }

        .article-snippet {
            font-family: "Georgia", serif;
            font-size: 0.95rem;
            color: #333;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-meta {
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
        }

        .article-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 2px solid black;
            flex-shrink: 0;
            background: #eee;
        }

        /* LIST FOOTER CONTROLS */
        .list-footer-controls {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #ccc;
            margin-top: auto;
            /* Push to bottom of list content */
            background: #f9f9f9;
        }

        .wide-btn {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            font-size: 0.9rem;
        }

        /* VIEW: SOURCES (MANAGE) */
        #view-sources {
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .add-feed-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid black;
            padding-bottom: 20px;
        }

        input[type="text"] {
            flex-grow: 1;
            border: 2px solid black;
            padding: 8px;
            font-family: inherit;
            font-size: 1rem;
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 4px 10px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* Invert icon color on active/dark if needed, but 'color: white' handles stroke thanks to currentColor */

        .sys-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .sys-btn.small {
            padding: 4px 8px;
            font-size: 0.75rem;
            box-shadow: 1px 1px 0 black;
        }

        .read-toggle-btn {
            min-width: 100px;
        }

        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            background: #fafafa;
        }

        .source-name {
            font-weight: bold;
        }

        .source-url {
            font-size: 0.8rem;
            color: #666;
            display: block;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-btn {
            color: black;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: white;
        }

        .delete-btn:hover {
            background: #eee;
        }

        /* STATUS BAR */
        #status-bar {
            border-top: 2px solid black;
            padding: 4px;
            font-size: 0.75rem;
            background: #eee;
            text-align: center;
            flex-shrink: 0;
        }

        /* LOADING */
        .loading-msg {
            text-align: center;
            padding: 40px;
            font-style: italic;
            color: #666;
        }

        .refresh-float {
            position: absolute;
            bottom: 40px;
            right: 20px;
            background: white;
            border: 2px solid black;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 4px 4px 0 black;
            cursor: pointer;
            z-index: 10;
        }

        .refresh-float:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 black;
            background: black;
            color: white;
        }

        /* MODAL (IFRAME READER) */
        #article-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .article-view-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            width: 95%;
            height: 95%;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 2px solid black;
            background: #eee;
        }

        .modal-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .modal-title {
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .close-btn {
            border: 2px solid black;
            background: white;
            font-weight: bold;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .close-btn:active {
            background: black;
            color: white;
        }

        iframe {
            flex-grow: 1;
            border: none;
            background: white;
        }

        /* GENERAL MODAL STYLES */
        .modal-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
    <script src="theme.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text">RSS Reader</span>
            <div class="controls">
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1" />
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-btn active" id="tab-headlines" onclick="switchView('headlines')">Headlines</div>
            <div class="tab-btn" id="tab-sources" onclick="switchView('sources')">Sources</div>
        </div>

        <div class="window-content">

            <!-- HEADLINES -->
            <div id="view-headlines">
                <div class="filter-bar">
                    <button class="filter-btn active" id="filter-all" onclick="setFilter('all')">All</button>
                    <button class="filter-btn" id="filter-unread" onclick="setFilter('unread')">Unread</button>
                </div>
                <div id="articles-container">
                    <div class="loading-msg">Welcome. Add sources to begin.</div>
                </div>
            </div>

            <div class="refresh-float" onclick="resetAndFetch()" title="Refresh">â†»</div>

            <!-- SOURCES -->
            <div id="view-sources">
                <div class="add-feed-bar">
                    <input type="text" id="feed-url" placeholder="RSS Feed URL">
                    <button class="sys-btn" onclick="addFeed()">Add</button>
                </div>
                <div id="sources-list">
                    <!-- Injected via JS -->
                </div>

                <div style="margin-top:20px; border-top:1px solid #ccc; padding-top:20px;">
                    <strong>Preset Feeds:</strong>
                    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                        <button class="sys-btn"
                            onclick="addPreset('BBC World', 'http://feeds.bbci.co.uk/news/world/rss.xml')">BBC</button>
                        <button class="sys-btn"
                            onclick="addPreset('NPR', 'https://feeds.npr.org/1001/rss.xml')">NPR</button>
                        <button class="sys-btn"
                            onclick="addPreset('TechCrunch', 'https://techcrunch.com/feed/')">Tech</button>
                        <button class="sys-btn"
                            onclick="addPreset('HackerNews', 'https://news.ycombinator.com/rss')">HackerNews</button>
                        <button class="sys-btn"
                            onclick="addPreset('The Verge', 'https://www.theverge.com/rss/index.xml')">Verge</button>
                        <button class="sys-btn" onclick="addPreset('XKCD', 'https://xkcd.com/rss.xml')">XKCD</button>
                    </div>
                </div>
            </div>

        </div>

        <div id="status-bar">Local Mode</div>

        <!-- READER MODAL -->
        <div id="article-modal">
            <div class="article-view-box">
                <div class="modal-header">
                    <span class="modal-title">Reader</span>
                    <div class="modal-controls">
                        <button class="sys-btn small read-toggle-btn" id="read-toggle"
                            onclick="toggleReadStatusInModal()">Mark Unread</button>
                        <button class="sys-btn small" onclick="openExternal()">Open Ext</button>
                        <button class="close-btn" onclick="closeArticleModal()">X</button>
                    </div>
                </div>
                <iframe id="article-frame" src=""></iframe>
            </div>
        </div>

        <!-- DELETE CONFIRMATION MODAL -->
        <div id="delete-modal" class="modal-overlay">
            <div class="modal-box">
                <h3>Unsubscribe?</h3>
                <p>Remove this feed from your list?</p>
                <div class="modal-buttons">
                    <button class="sys-btn" onclick="confirmDelete()">Remove</button>
                    <button class="sys-btn" onclick="closeModal('delete-modal')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- MARK READ CONFIRMATION MODAL -->
        <div id="mark-read-modal" class="modal-overlay">
            <div class="modal-box">
                <h3>Mark All Read?</h3>
                <p>This will mark all currently visible articles as read.</p>
                <div class="modal-buttons">
                    <button class="sys-btn" onclick="confirmMarkAllRead()">Yes</button>
                    <button class="sys-btn" onclick="closeModal('mark-read-modal')">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- STATE ---
        let feeds = []; // { id, name, url }
        let currentUser = null;
        let articlesCache = [];
        let currentArticleUrl = "";
        let feedToDeleteId = null;
        let readItems = new Set(); // Store read article URLs
        let filterMode = 'all'; // 'all' or 'unread'
        let saveTimer = null;
        let fetchCount = 10; // Items per source to fetch

        // --- INIT ---
        window.onload = () => {
            loadWallpaper();
            loadReadStatus();

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('status-bar').innerText = "Synced: " + user.email;
                    loadCloudFeeds();
                    loadCloudReadStatus(); // Attempt to sync read status if we were doing that
                } else {
                    document.getElementById('status-bar').innerText = "Guest Mode (Local)";
                    loadLocalFeeds();
                }
            });
        };

        // Helper to HTML-escape text
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        // Helper to sanitize background image URLs from localStorage
        function sanitizeBackgroundImage(imageString) {
            if (!imageString) return '';
            if (imageString.startsWith('url("data:image/png;base64,')) {
                return imageString;
            }
            if (imageString.startsWith('url("') && imageString.endsWith('")')) {
                const url = imageString.substring(5, imageString.length - 2);
                if ((url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) && !url.includes('javascript:')) {
                    return imageString;
                }
            }
            return '';
        }


        // --- NAVIGATION ---
        function switchView(viewName) {
            document.getElementById('view-headlines').style.display = viewName === 'headlines' ? 'flex' : 'none';
            document.getElementById('view-sources').style.display = viewName === 'sources' ? 'flex' : 'none';

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${viewName}`).classList.add('active');

            const refreshBtn = document.querySelector('.refresh-float');
            refreshBtn.style.display = viewName === 'headlines' ? 'flex' : 'none';

            if (viewName === 'headlines') {
                // Reset fetch count when switching to headlines view for fresh start?
                // No, user might want to keep reading.
                if (articlesCache.length === 0) resetAndFetch();
            }
        }

        function setFilter(mode) {
            filterMode = mode;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`filter-${mode}`).classList.add('active');
            renderArticles();
        }

        function toggleFullScreen() {
            document.querySelector('.window').classList.toggle('fullscreen');
        }

        // --- READ STATUS MGMT ---
        function loadReadStatus() {
            try {
                const stored = JSON.parse(localStorage.getItem('rss_read_items'));
                if (Array.isArray(stored)) {
                    readItems = new Set(stored);
                }
            } catch (e) {
                readItems = new Set();
            }
        }

        function saveReadStatus() {
            const array = Array.from(readItems);
            localStorage.setItem('rss_read_items', JSON.stringify(array));

            // Simple Cloud Sync for read status
            if (currentUser) {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    // Store as a single document array to avoid write costs of individual docs
                    // Limit size to prevent document bloat (keep last 500 read items)
                    let saveArray = array;
                    if (saveArray.length > 500) saveArray = saveArray.slice(saveArray.length - 500);

                    db.collection('users').doc(currentUser.uid).collection('settings').doc('rss_read_status').set({
                        urls: saveArray
                    }, { merge: true });
                }, 2000);
            }
        }

        function loadCloudReadStatus() {
            db.collection('users').doc(currentUser.uid).collection('settings').doc('rss_read_status').get().then(doc => {
                if (doc.exists && doc.data().urls) {
                    const cloudUrls = doc.data().urls;
                    // Merge
                    cloudUrls.forEach(url => readItems.add(url));
                    saveReadStatus(); // Sync back merged to local
                    renderArticles(); // Refresh UI
                }
            });
        }

        function markAsRead(url) {
            if (!url) return;
            readItems.add(url);
            saveReadStatus();
        }

        function markAsUnread(url) {
            if (!url) return;
            readItems.delete(url);
            saveReadStatus();
        }

        function toggleReadStatusInModal() {
            if (!currentArticleUrl) return;

            const btn = document.getElementById('read-toggle');
            if (readItems.has(currentArticleUrl)) {
                markAsUnread(currentArticleUrl);
                btn.innerText = "Mark Read";
            } else {
                markAsRead(currentArticleUrl);
                btn.innerText = "Mark Unread";
            }
            // Refresh background list
            renderArticles();
        }

        function openMarkReadModal() {
            document.getElementById('mark-read-modal').style.display = 'flex';
        }

        function confirmMarkAllRead() {
            articlesCache.forEach(a => readItems.add(a.link));
            saveReadStatus();

            closeModal('mark-read-modal');
            renderArticles();
        }

        // --- FEED DATA MGMT ---
        function loadLocalFeeds() {
            feeds = JSON.parse(localStorage.getItem('rss_feeds')) || [];
            renderSources();
            if (feeds.length > 0) resetAndFetch();
        }

        function loadCloudFeeds() {
            db.collection('users').doc(currentUser.uid).collection('rss_feeds')
                .onSnapshot(snap => {
                    feeds = [];
                    snap.forEach(doc => {
                        feeds.push({ id: doc.id, ...doc.data() });
                    });
                    renderSources();
                    if (feeds.length > 0) resetAndFetch();
                    else {
                        document.getElementById('articles-container').innerHTML = '<div class="loading-msg">No feeds subscribed. Go to Sources to add some.</div>';
                    }
                });
        }

        function saveFeed(name, url) {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).collection('rss_feeds').add({
                    name: name,
                    url: url,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                feeds.push({ id: Date.now().toString(), name: name, url: url });
                localStorage.setItem('rss_feeds', JSON.stringify(feeds));
                renderSources();
                resetAndFetch();
            }
        }

        function removeFeed(id) {
            feedToDeleteId = id;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function confirmDelete() {
            if (!feedToDeleteId) return;
            const id = feedToDeleteId;

            if (currentUser) {
                db.collection('users').doc(currentUser.uid).collection('rss_feeds').doc(id).delete();
            } else {
                feeds = feeds.filter(f => f.id !== id);
                localStorage.setItem('rss_feeds', JSON.stringify(feeds));
                renderSources();
                resetAndFetch();
            }
            closeModal('delete-modal');
            feedToDeleteId = null;
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- SOURCES UI ---
        function renderSources() {
            const list = document.getElementById('sources-list');
            list.innerHTML = '';

            if (feeds.length === 0) {
                list.innerHTML = '<div style="padding:10px; color:#666; font-style:italic;">No subscriptions yet.</div>';
                return;
            }

            feeds.forEach(feed => {
                const div = document.createElement('div');
                div.className = 'source-item';
                div.innerHTML = `
                    <div>
                        <div class="source-name">${feed.name}</div>
                        <div class="source-url">${feed.url}</div>
                    </div>
                    <button class="delete-btn" onclick="removeFeed('${feed.id}')">Remove</button>
                `;
                list.appendChild(div);
            });
        }

        function addFeed() {
            const url = document.getElementById('feed-url').value.trim();
            if (!url) return;

            // Simple validation / Name guessing
            let name = "New Feed";
            try {
                const urlObj = new URL(url);
                name = urlObj.hostname.replace('www.', '');
            } catch (e) {
                alert("Invalid URL");
                return;
            }

            saveFeed(name, url);
            document.getElementById('feed-url').value = '';
            alert("Feed added! It may take a moment to fetch.");
        }

        function addPreset(name, url) {
            const exists = feeds.some(f => f.url === url);
            if (exists) {
                alert("Already subscribed.");
                return;
            }
            saveFeed(name, url);
        }

        // --- FETCHING & RENDERING NEWS ---

        function resetAndFetch() {
            fetchCount = 10;
            fetchAllFeeds();
        }

        async function fetchAllFeeds() {
            const container = document.getElementById('articles-container');
            const loadBtn = document.getElementById('load-more-btn');

            if (loadBtn) {
                loadBtn.disabled = true;
                loadBtn.innerText = "Loading...";
            }

            if (feeds.length === 0) {
                container.innerHTML = '<div class="loading-msg">No feeds subscribed.</div>';
                return;
            }

            if (fetchCount === 10 && articlesCache.length === 0) {
                container.innerHTML = '<div class="loading-msg">Fetching updates...</div>';
            }

            // Use a temp cache to collect new results
            let newArticlesCache = [];

            try {
                // Fetch in parallel
                const promises = feeds.map(feed => fetchFeed(feed, newArticlesCache));
                await Promise.all(promises);
            } catch (e) {
                console.error("Fetch error", e);
            }

            // SAFETY CHECK: If load more failed (0 items), don't wipe existing list
            if (fetchCount > 10 && newArticlesCache.length === 0) {
                console.warn("Load More failed. Restoring previous state.");
                fetchCount = Math.max(10, fetchCount - 10); // Revert count

                // Notify user via status bar
                const statusEl = document.getElementById('status-bar');
                const oldText = statusEl.innerText;
                statusEl.innerText = "Unable to load more articles.";
                setTimeout(() => statusEl.innerText = oldText, 3000);

                // Re-render existing list to reset button state
                renderArticles();
                return;
            }

            // Update cache
            articlesCache = newArticlesCache;

            // Sort by date desc
            articlesCache.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

            renderArticles();
        }

        async function fetchFeed(feed, targetArray) {
            // Request more items if available by using count parameter
            // Add cache buster time to avoid stale data if we just increased count
            const api = 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(feed.url) + '&count=' + fetchCount;

            try {
                const res = await fetch(api);
                const data = await res.json();

                if (data.status === 'ok') {
                    // Update Name if generic
                    if (feed.name === "New Feed" && data.feed.title) {
                        feed.name = data.feed.title;
                    }

                    data.items.forEach(item => {
                        // Image Extraction Logic
                        let imgUrl = item.thumbnail;

                        // Check enclosure if no thumbnail
                        if (!imgUrl && item.enclosure && item.enclosure.link) {
                            if (item.enclosure.type.startsWith('image/') || item.enclosure.link.match(/\.(jpeg|jpg|gif|png)$/)) {
                                imgUrl = item.enclosure.link;
                            }
                        }

                        // Last resort: Parse description for <img src>
                        if (!imgUrl && (item.description || item.content)) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = item.description || item.content;
                            const foundImg = tempDiv.querySelector('img');
                            if (foundImg) {
                                imgUrl = foundImg.src;
                            }
                        }

                        // Specialized extraction for XKCD "alt text" (title attribute)
                        let xkcdTitle = "";
                        if (feed.url.includes('xkcd.com')) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = item.description || item.content;
                            const foundImg = tempDiv.querySelector('img');
                            if (foundImg && foundImg.title) {
                                xkcdTitle = foundImg.title;
                            }
                        }

                        targetArray.push({
                            source: feed.name,
                            title: item.title,
                            link: item.link,
                            pubDate: item.pubDate,
                            image: imgUrl,
                            snippet: stripHtml(item.description || item.content || ""),
                            feedUrl: feed.url,
                            xkcdTitle: xkcdTitle
                        });
                    });
                }
            } catch (e) {
                console.error("Error fetching " + feed.name, e);
            }
        }

        function renderArticles() {
            const container = document.getElementById('articles-container');
            container.innerHTML = '';

            // Filter articles
            const filtered = articlesCache.filter(a => {
                if (filterMode === 'unread') {
                    return !readItems.has(a.link);
                }
                return true;
            });

            if (filtered.length === 0) {
                if (filterMode === 'unread' && articlesCache.length > 0) {
                    container.innerHTML = '<div class="loading-msg">All caught up!</div>';
                } else if (articlesCache.length === 0) {
                    container.innerHTML = '<div class="loading-msg">No articles found. Check your feed URLs.</div>';
                } else {
                    container.innerHTML = '<div class="loading-msg">No articles match filter.</div>';
                }
                return;
            }

            // Display All (No limit slicing anymore)
            filtered.forEach(article => {
                const date = new Date(article.pubDate);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isRead = readItems.has(article.link);

                const div = document.createElement('div');
                div.className = `article ${isRead ? 'read' : ''}`;
                div.onclick = () => openArticle(article);

                let imgHtml = '';
                if (article.image) {
                    imgHtml = `<img src="${article.image}" class="article-img" alt="Thumbnail" onerror="this.style.display='none'">`;
                }

                div.innerHTML = `
                    <div class="article-content">
                        <div class="article-source">${article.source}</div>
                        <div class="article-title">${article.title}</div>
                        <div class="article-snippet">${article.snippet}</div>
                        <div class="article-meta">${dateStr}</div>
                    </div>
                    ${imgHtml}
                `;
                container.appendChild(div);
            });

            // FOOTER CONTROLS
            const footer = document.createElement('div');
            footer.className = 'list-footer-controls';

            // Container for side-by-side buttons
            const btnGroup = document.createElement('div');
            btnGroup.style.display = 'flex';
            btnGroup.style.gap = '10px';
            btnGroup.style.width = '100%';
            btnGroup.style.justifyContent = 'center';

            // Always show Load More button to allow fetching deeper into history
            const moreBtn = document.createElement('button');
            moreBtn.className = 'sys-btn wide-btn';
            moreBtn.id = 'load-more-btn';
            moreBtn.innerText = `Load More`;
            moreBtn.style.flex = '1';
            moreBtn.onclick = loadMore;
            btnGroup.appendChild(moreBtn);

            if (filtered.length > 0) {
                const markBtn = document.createElement('button');
                markBtn.className = 'sys-btn wide-btn';
                markBtn.innerText = 'Mark All Read';
                markBtn.style.flex = '1';
                markBtn.onclick = openMarkReadModal;
                btnGroup.appendChild(markBtn);
            }

            footer.appendChild(btnGroup);
            container.appendChild(footer);
        }

        function loadMore() {
            fetchCount += 10;
            fetchAllFeeds();
        }

        function stripHtml(html) {
            let tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            let text = tmp.textContent || tmp.innerText || "";
            return text.length > 200 ? text.substring(0, 200) + "..." : text;
        }

        // --- MODAL READER ---
        async function openArticle(articleOrUrl) {
            let url = typeof articleOrUrl === 'string' ? articleOrUrl : articleOrUrl.link;
            let article = typeof articleOrUrl === 'object' ? articleOrUrl : null;

            currentArticleUrl = url;

            // Mark as Read
            markAsRead(url);
            // Update UI in background so it shows as read when closed
            renderArticles();

            const modal = document.getElementById('article-modal');
            const frame = document.getElementById('article-frame');
            const btn = document.getElementById('read-toggle');

            // Set button text correctly
            btn.innerText = "Mark Unread";

            modal.style.display = 'flex';

            // SPECIAL HANDLING FOR XKCD
            if (article && article.feedUrl && article.feedUrl.includes('xkcd.com')) {
                frame.removeAttribute('src');
                frame.srcdoc = `
                    <html>
                    <head>
                        <style>
                            body { 
                                font-family: "Geneva", "Verdana", sans-serif; 
                                text-align: center; 
                                padding: 20px; 
                                background-color: white; 
                                display: flex; 
                                flex-direction: column; 
                                align-items: center; 
                                justify-content: center;
                                min-height: 100vh;
                                margin: 0;
                            }
                            img { 
                                max-width: 100%; 
                                height: auto; 
                                border: 2px solid black; 
                                box-shadow: 4px 4px 0 black;
                                margin-bottom: 20px;
                            }
                            .alt-text {
                                font-size: 1rem;
                                color: #333;
                                max-width: 600px;
                                line-height: 1.4;
                                border: 1px dashed #999;
                                padding: 15px;
                                background: #f9f9f9;
                            }
                            .title {
                                font-weight: bold;
                                font-size: 1.2rem;
                                margin-bottom: 20px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="title">${article.title}</div>
                        <img src="${article.image}">
                        <div class="alt-text">${article.xkcdTitle || "No title text found."}</div>
                    </body>
                    </html>`;
                return;
            }

            // Show loading state
            frame.srcdoc = `
                <html>
                <body style="font-family:sans-serif; text-align:center; padding-top:50px; background-color:white;">
                    <h2>Loading...</h2>
                    <p style="color:#666;">Cleaning up article for E-ink display...</p>
                </body>
                </html>`;

            try {
                // 1. Get clean text version via FrogFind (Readability)
                const frogUrl = `https://frogfind.com/read.php?a=${encodeURIComponent(url)}`;
                // 2. Proxy it to bypass CORS and load into iframe
                const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(frogUrl)}`;

                // TIMEOUT WRAPPER
                const fetchWithTimeout = (url, ms) => {
                    const controller = new AbortController();
                    const promise = fetch(url, { signal: controller.signal });
                    const timeout = new Promise((_, reject) =>
                        setTimeout(() => {
                            controller.abort();
                            reject(new Error("Request timed out"));
                        }, ms)
                    );
                    return Promise.race([promise, timeout]);
                };

                const res = await fetchWithTimeout(proxyUrl, 15000); // 15s timeout

                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

                let html = await res.text();

                if (!html || html.length < 50) { // arbitrary small check for empty/fail
                    throw new Error("Empty or invalid response");
                }

                // CRITICAL: Use Blob URL for src to isolate content in a new origin
                const blob = new Blob([html], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);

                // FIX: srcdoc takes precedence over src, so we must REMOVE it first
                frame.removeAttribute('srcdoc');
                frame.src = blobUrl;

            } catch (e) {
                console.error("Reader Error:", e);
                let errorMsg = "Could not load article directly.";
                if (e.message.includes('time')) errorMsg = "Request timed out.";

                // Re-apply srcdoc for error message
                frame.removeAttribute('src'); // Clear src just in case
                frame.srcdoc = `
                    <html>
                    <body style="font-family:sans-serif; text-align:center; padding-top:50px;">
                        <h3>${errorMsg}</h3>
                        <p style="color:#666;">${e.message}</p>
                        <div style="margin-top:20px;">
                            <button onclick="parent.openArticle('${url}')" style="padding:10px; cursor:pointer; background:white; border:2px solid black; font-weight:bold; margin-right:10px;">Try Again</button>
                            <button onclick="parent.openExternal()" style="padding:10px; cursor:pointer; background:white; border:2px solid black; font-weight:bold;">Open External</button>
                        </div>
                    </body>
                    </html>`;
            }
        }

        function closeArticleModal() {
            const modal = document.getElementById('article-modal');
            const frame = document.getElementById('article-frame');

            modal.style.display = 'none';
            frame.removeAttribute('srcdoc');
            frame.src = '';
            currentArticleUrl = "";
        }

        function openExternal() {
            if (currentArticleUrl) {
                window.open(currentArticleUrl, '_blank');
            }
        }


        loadWallpaper();

        function loadWallpaper() {
            const wallpaperImg = localStorage.getItem('rekindle_bg_image');
            const wallpaperSize = localStorage.getItem('rekindle_bg_size');
            if (wallpaperImg) {
                document.body.style.backgroundImage = wallpaperImg;
            }
            if (wallpaperSize) {
                document.body.style.backgroundSize = wallpaperSize;
            }
        }
    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>
</body>

</html>