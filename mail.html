<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta charset="UTF-8">

    <title>Mail</title>

    <style>
        /* E-INK COMPATIBILITY */
        * {
            transition: none !important;
            animation: none !important;
        }

        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
            --highlight: #000000;
            --highlight-text: #ffffff;
        }

        body {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            font-family: "Geneva", "Verdana", sans-serif;
            background-color: #e5e5e5;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-sizing: border-box;
            user-select: none;
        }

        .window {
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0px black;
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 90%;
            max-width: 900px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
        }

        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .title-controls {
            position: absolute;
            right: 10px;
            z-index: 2;
            display: flex;
            align-items: center;
        }

        .title-controls>*+* {
            margin-left: 8px;
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
            flex-shrink: 0;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        /* TOOLBAR */
        .toolbar {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 2px solid black;
            background: #f5f5f5;
            flex-wrap: wrap;
        }

        .toolbar>*+* {
            margin-left: 8px;
        }

        .toolbar-btn {
            background: white;
            border: 2px solid black;
            padding: 4px 10px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-family: inherit;
        }

        .toolbar-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .toolbar-btn.primary {
            background: black;
            color: white;
        }

        .toolbar-btn.primary:active {
            background: white;
            color: black;
        }

        .folder-select {
            padding: 4px 8px;
            font-size: 0.85rem;
            border: 2px solid black;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }

        .toolbar-spacer {
            flex-grow: 1;
        }

        .content-area {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .email-list-pane {
            width: 40%;
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .search-box {
            padding: 10px;
            border-bottom: 2px solid black;
            background: #eee;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 8px;
            font-family: inherit;
            font-size: 1rem;
            border: 2px solid black;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        #list-container {
            overflow-y: auto;
            flex-grow: 1;
        }

        .email-item {
            padding: 12px 10px;
            border-bottom: 1px solid #ccc;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .email-item:hover {
            background: #f5f5f5;
        }

        .email-item.selected {
            background-color: var(--highlight);
            color: var(--highlight-text);
        }

        .email-item.unread {
            font-weight: bold;
        }

        .email-sender {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .email-sender-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
            min-width: 0;
        }

        .email-subject {
            margin-bottom: 2px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
            line-clamp: 2;
        }

        .email-snippet {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .email-item.selected .email-snippet {
            color: #ccc;
        }

        .email-date {
            font-size: 0.75rem;
            color: #888;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .email-item.selected .email-date {
            color: #ccc;
        }

        .details-pane {
            width: 60%;
            padding: 20px;
            overflow-y: auto;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .email-header {
            border-bottom: 4px double black;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .email-title {
            font-size: 1.4rem;
            font-weight: 900;
            margin: 0 0 10px 0;
        }

        .email-meta {
            font-size: 0.85rem;
            color: #555;
        }

        .email-meta span {
            display: block;
            margin-bottom: 3px;
        }

        .email-actions {
            display: flex;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .email-actions>*+* {
            margin-left: 8px;
        }

        .email-body {
            font-size: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #auth-overlay {
            position: absolute;
            top: 35px;
            left: 0;
            width: 100%;
            height: calc(100% - 35px);
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }

        .sys-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            background: white;
            color: black;
            border: 2px solid black;
            cursor: pointer;
            box-shadow: 4px 4px 0 black;
        }

        .sys-btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        #status-bar {
            border-top: 2px solid black;
            padding: 4px;
            font-size: 0.75rem;
            background: #eee;
            text-align: center;
            flex-shrink: 0;
        }

        .load-more-btn {
            width: 100%;
            padding: 10px;
            background: #eee;
            border: none;
            border-top: 1px solid #ccc;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }

        .load-more-btn:hover {
            background: #ddd;
        }

        /* COMPOSE MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            /* Changed to fixed for fullscreen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-box h3 {
            margin: 0 0 15px 0;
            border-bottom: 2px solid black;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .modal-btns {
            display: flex;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .modal-btns>*+* {
            margin-left: 10px;
        }

        /* CONFIRM MODAL */
        .confirm-modal {
            text-align: center;
        }

        .confirm-modal p {
            margin: 15px 0;
        }

        /* STANDARD MODAL SYSTEM */
        #generic-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            font-family: "Geneva", "Verdana", sans-serif;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            padding: 20px;
            box-shadow: 6px 6px 0 black;
            max-width: 300px;
            width: 80%;
            text-align: center;
        }

        .modal-text {
            margin-bottom: 20px;
            font-weight: bold;
            line-height: 1.4;
            color: black;
        }

        .modal-btns {
            display: flex;
            justify-content: center;
        }

        .modal-btns>*+* {
            margin-left: 10px;
        }

        .modal-btn {
            background: white;
            border: 2px solid black;
            padding: 6px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-family: inherit;
        }

        .modal-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .provider-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid black;
            font-family: inherit;
            font-weight: bold;
            text-align: left;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 1rem;
        }

        .provider-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .provider-btn:hover {
            background: #f0f0f0;
        }
    </style>
    <link rel="stylesheet" href="css/custom-select.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
    <script src="time.js"></script>
    <script src="theme.js"></script>
    <script src="pro-gate.js"></script>
    <script src="pro-gate.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/custom-select.js"></script>
    <style>
        .login-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 2px solid black;
            font-family: inherit;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 300px;
        }
    </style>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text" data-i18n="app.mail.name">Mail</span>
            <div class="title-controls">
                <button class="toolbar-btn" onclick="openSettings()">Settings</button>
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1"></path>
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="toolbar">
            <button class="toolbar-btn primary" onclick="openComposeModal()" data-i18n="mail.btn.compose">✎
                Compose</button>
            <select class="folder-select" id="folder-select" onchange="changeFolder()">
                <option value="INBOX" data-i18n="mail.folder.inbox">Inbox</option>
                <option value="SENT" data-i18n="mail.folder.sent">Sent</option>
                <option value="DRAFT" data-i18n="mail.folder.drafts">Drafts</option>
                <option value="STARRED" data-i18n="mail.folder.starred">Starred</option>
                <option value="ALL" data-i18n="mail.folder.all">All Mail (Archive)</option>
                <option value="SPAM" data-i18n="mail.folder.spam">Spam</option>
                <option value="TRASH" data-i18n="mail.folder.trash">Trash</option>
                <option value="IMPORTANT" data-i18n="mail.folder.important">Important</option>
            </select>
            <div class="toolbar-spacer"></div>
            <button class="toolbar-btn" onclick="loadEmails()" data-i18n="mail.btn.refresh">↻ Refresh</button>
        </div>

        <div class="content-area">
            <div class="email-list-pane">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search emails..."
                        data-i18n-placeholder="mail.ph.search" onkeyup="filterEmails()">
                </div>
                <div id="list-container"></div>
            </div>
            <div class="details-pane" id="details-pane">
                <div style="text-align:center; margin-top:50px; font-style:italic; color:#666;"
                    data-i18n="mail.details.select">Select an email to read.
                </div>
            </div>
        </div>

        <div id="status-bar" data-i18n="mail.status.loading">Loading...</div>

        <div id="paywall-overlay"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:10002; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box;">
            <h2 style="margin-top:0;" data-i18n="mail.paywall.title">ReKindle+</h2>
            <p data-i18n-html="mail.paywall.desc">Support ReKindle development and get<br>access to exclusive apps.</p>
            <button class="sys-btn" onclick="window.location.href='pay.html'" data-i18n="mail.paywall.btn">Subscribe /
                Login</button>
            <p style="font-size:0.8rem; margin-top:20px; color:#666;" id="paywall-status"
                data-i18n="mail.paywall.checking">Checking subscription...</p>
        </div>

        <div id="auth-overlay">
            <h2 style="margin-bottom:10px;" data-i18n="mail.auth.title">Email Client</h2>

            <!-- STEP 1: Provider List -->
            <div id="provider-step" style="width:100%; max-width:320px; display:flex; flex-direction:column;">
                <p style="margin-bottom:20px;" data-i18n="mail.auth.desc">Select your email provider.</p>
                <button class="provider-btn" onclick="selectProvider('gmail')"
                    style="margin-bottom:10px;">Gmail</button>
                <button class="provider-btn" onclick="selectProvider('outlook')" style="margin-bottom:10px;">Outlook /
                    Hotmail</button>
                <button class="provider-btn" onclick="selectProvider('yahoo')" style="margin-bottom:10px;">Yahoo
                    Mail</button>
                <button class="provider-btn" onclick="selectProvider('icloud')"
                    style="margin-bottom:10px;">iCloud</button>
                <button class="provider-btn" onclick="selectProvider('custom')" style="margin-bottom:10px;">Custom
                    (IMAP)</button>
                <button class="sys-btn" onclick="closeSettings()"
                    style="margin-top:10px; background:#ccc;">Cancel</button>
            </div>

            <!-- STEP 2: Login Form -->
            <div id="login-step" class="login-form" style="display:none;">
                <p id="provider-help-text"
                    style="font-size:0.85rem; margin-bottom:15px; background:#f9f9f9; padding:10px; border:1px solid #ccc; text-align:left;">
                </p>

                <input type="email" id="imap-user" class="login-input" placeholder="Email" value="">
                <input type="password" id="imap-pass" class="login-input" placeholder="Password" value="">

                <div id="custom-server-settings" style="display:none;">
                    <div style="display:flex;">
                        <input type="text" id="imap-host" class="login-input" placeholder="IMAP Host" value=""
                            style="margin-right:10px;">
                        <input type="number" id="imap-port" class="login-input" placeholder="Port" value="993"
                            style="width: 80px;">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="smtp-host" class="login-input" placeholder="SMTP Host" value=""
                            style="margin-right:10px;">
                        <input type="number" id="smtp-port" class="login-input" placeholder="Port" value="465"
                            style="width: 80px;">
                    </div>
                </div>

                <div style="display:flex; margin-top:10px;">
                    <button class="sys-btn" onclick="showProviderList()"
                        style="background:#eee; flex:1; margin-right:10px;">&lt;
                        Back</button>
                    <button id="btn-login" class="sys-btn" onclick="login()" data-i18n="mail.btn.connect"
                        style="flex:2;">Connect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- COMPOSE MODAL -->
    <div class="modal-overlay" id="compose-modal">
        <div class="modal-box">
            <h3 data-i18n="mail.compose.title">Compose Email</h3>
            <div class="form-group">
                <label data-i18n="mail.compose.label.to">To:</label>
                <input type="text" id="compose-to" placeholder="recipient@example.com"
                    data-i18n-placeholder="mail.compose.ph.to">
            </div>
            <div class="form-group">
                <label data-i18n="mail.compose.label.subject">Subject:</label>
                <input type="text" id="compose-subject" placeholder="Subject"
                    data-i18n-placeholder="mail.compose.ph.subject">
            </div>
            <div class="form-group">
                <label data-i18n="mail.compose.label.message">Message:</label>
                <textarea id="compose-body" placeholder="Write your message..."
                    data-i18n-placeholder="mail.compose.ph.message" style="height: 150px;"></textarea>
            </div>
            <div class="modal-btns">
                <button class="toolbar-btn" onclick="closeComposeModal()" data-i18n="btn.cancel">Cancel</button>
                <button class="toolbar-btn primary" onclick="sendEmail()" data-i18n="mail.btn.send">Send</button>
            </div>
        </div>
    </div>

    <!-- CONFIRM DELETE MODAL -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-box confirm-modal">
            <h3 id="confirm-title" data-i18n="mail.modal.confirm.title">Confirm</h3>
            <p id="confirm-message" data-i18n="mail.modal.confirm.desc">Are you sure?</p>
            <div class="modal-btns" style="justify-content: center;">
                <button class="toolbar-btn" onclick="closeConfirmModal()" data-i18n="btn.cancel">Cancel</button>
                <button class="toolbar-btn primary" id="confirm-btn" onclick="" data-i18n="btn.confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- PRO REQUIRED MODAL -->
    <div id="pro-required-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box" style="text-align:center;">
            <h3 style="margin-top:0;" data-i18n="mail.pro.title">Pro Required</h3>
            <p data-i18n="mail.pro.desc">A ReKindle+ subscription is required to use this app.</p>
            <button class="toolbar-btn primary" onclick="location.reload()">OK</button>
        </div>
    </div>

    <script>
        // IMAP/SMTP Config
        let imapConfig = null;
        let smtpConfig = null;

        let emails = [];
        let allFolders = [];
        let currentFolder = 'INBOX';
        let currentEmail = null;
        let userEmail = '';
        let functions;

        function waitForFirebase(callback, attempts = 0) {
            if (typeof firebase !== 'undefined') {
                callback();
            } else if (attempts < 50) {
                setTimeout(() => waitForFirebase(callback, attempts + 1), 100);
            } else {
                const overlay = document.getElementById('paywall-overlay');
                const status = document.getElementById('paywall-status');
                status.innerText = "Error: Firebase failed to load.";
                overlay.style.display = 'flex';
            }
        }

        window.onload = function () {
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            if (window.rekindleApplyDefaultFullscreen) window.rekindleApplyDefaultFullscreen();
            waitForFirebase(checkSubscription);
        };

        // FIREBASE SETUP
        const API_KEY = "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ";
        const firebaseConfig = {
            apiKey: API_KEY,
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        let auth, db;
        let isPro = false;

        function checkSubscription() {
            const overlay = document.getElementById('paywall-overlay');
            const status = document.getElementById('paywall-status');
            const btnLogin = document.getElementById('btn-login');

            // 1. CACHE CHECK (Instant)
            try {
                const cachedExpiry = localStorage.getItem('rekindle_pro_expiry');
                if (cachedExpiry && parseInt(cachedExpiry) > Date.now()) {
                    isPro = true;
                    if (btnLogin) btnLogin.disabled = false;
                    // Optimistically hide overlay / unlock features
                    overlay.style.display = 'none';
                    // REMOVED: initGmailMode(); return; 
                    // We must fall through to init Firebase so 'db' is defined for initGmailMode later.
                }
            } catch (e) { console.warn("Cache error", e); }

            if (typeof firebase !== 'undefined') {
                if (!auth) {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();

                    if (db.settings) {
                        try {
                            db.settings({
                                experimentalForceLongPolling: true,
                                merge: true
                            });
                        } catch (e) { console.warn("Settings error:", e); }
                    }
                }

                auth.onAuthStateChanged(user => {
                    if (user) {
                        // Timeout fallback in case Firestore query hangs
                        const timeoutId = setTimeout(() => {
                            if (!isPro) {
                                console.warn("Subscription check timed out");
                                status.innerText = "Verification timed out. Please refresh.";
                                overlay.style.display = 'flex';
                            }
                        }, 10000);

                        db.collection('users').doc(user.uid).get()
                            .then(doc => {
                                clearTimeout(timeoutId);
                                if (doc.exists) {
                                    const data = doc.data();
                                    const now = Date.now();
                                    let expires = 0;
                                    if (data.proExpiresAt) {
                                        expires = typeof data.proExpiresAt.toMillis === 'function'
                                            ? data.proExpiresAt.toMillis()
                                            : new Date(data.proExpiresAt).getTime();
                                    }

                                    // UPDATE CACHE
                                    if (expires > now) {
                                        localStorage.setItem('rekindle_pro_expiry', expires.toString());
                                    } else {
                                        localStorage.removeItem('rekindle_pro_expiry');
                                    }

                                    if (expires > now) {
                                        // UNLOCKED - overlay stays hidden
                                        isPro = true;
                                        if (btnLogin) btnLogin.disabled = false;
                                        // Load settings from cloud
                                        loadSettingsFromFirebase(user.uid).then(() => {
                                            initGmailMode();
                                        });
                                    } else {
                                        // LOCKED
                                        status.innerText = expires > 0 ? "Subscription expired." : "Subscription required.";
                                        overlay.style.display = 'flex';
                                    }
                                } else {
                                    status.innerText = "Subscription required.";
                                    overlay.style.display = 'flex';
                                }
                            })
                            .catch(e => {
                                clearTimeout(timeoutId);
                                if (!isPro) {
                                    console.error("Error checking sub", e);
                                    status.innerText = "Error verifying. Try again.";
                                    overlay.style.display = 'flex';
                                }
                            });
                    } else {
                        // NOT LOGGED IN
                        status.innerText = "Please log in.";
                        overlay.style.display = 'flex';
                        localStorage.removeItem('rekindle_pro_expiry');
                    }
                });
            } else {
                status.innerText = "System Error";
                overlay.style.display = 'flex';
            }
        }

        const PROVIDERS = {
            gmail: {
                name: 'Gmail',
                imapHost: 'imap.gmail.com', imapPort: 993,
                smtpHost: 'smtp.gmail.com', smtpPort: 465,
                helpHtml: '<b>Important:</b> You must use an <b>App Password</b>.<br><a href="https://myaccount.google.com/apppasswords" target="_blank">Generate App Password here</a> (requires 2FA).'
            },
            outlook: {
                name: 'Outlook / Hotmail',
                imapHost: 'outlook.office365.com', imapPort: 993,
                smtpHost: 'smtp.office365.com', smtpPort: 587,
                helpHtml: 'Use your Microsoft account password. If 2FA is enabled, you must generate an <b>App Password</b>.<br><a href="https://account.live.com/proofs/AppPassword" target="_blank">Generate App Password here</a>.'
            },
            yahoo: {
                name: 'Yahoo Mail',
                imapHost: 'imap.mail.yahoo.com', imapPort: 993,
                smtpHost: 'smtp.mail.yahoo.com', smtpPort: 465,
                helpHtml: '<b>Important:</b> You must generate and use an <b>App Password</b> via Yahoo Account Security.<br><a href="https://login.yahoo.com/account/security" target="_blank">Manage App Passwords</a>'
            },
            icloud: {
                name: 'iCloud',
                imapHost: 'imap.mail.me.com', imapPort: 993,
                smtpHost: 'smtp.mail.me.com', smtpPort: 587,
                helpHtml: '<b>Important:</b> You must use an <b>App-Specific Password</b>.<br><a href="https://appleid.apple.com/" target="_blank">Manage Apple ID</a> to generate one.'
            },
            custom: {
                name: 'Custom',
                imapHost: '', imapPort: 993,
                smtpHost: '', smtpPort: 465,
                helpHtml: 'Enter your provider\'s IMAP and SMTP settings manualy.'
            }
        };

        async function initGmailMode() {
            functions = firebase.functions();

            const savedUser = localStorage.getItem('rekindle_imap_user');
            const encryptedPass = localStorage.getItem('rekindle_imap_pass');
            const savedUid = localStorage.getItem('rekindle_imap_uid');

            if (savedUser && encryptedPass && savedUid) {
                // Decrypt password from localStorage
                const savedPass = await decryptPassword(encryptedPass, savedUid);
                if (!savedPass) {
                    console.error("Failed to decrypt password from localStorage");
                    openSettings();
                    return;
                }

                // Populate hidden fields just in case
                document.getElementById('imap-user').value = savedUser;
                document.getElementById('imap-pass').value = savedPass;
                document.getElementById('imap-host').value = localStorage.getItem('rekindle_imap_host') || 'imap.gmail.com';
                document.getElementById('imap-port').value = localStorage.getItem('rekindle_imap_port') || '993';
                document.getElementById('smtp-host').value = localStorage.getItem('rekindle_smtp_host') || 'smtp.gmail.com';
                document.getElementById('smtp-port').value = localStorage.getItem('rekindle_smtp_port') || '465';

                login();
            } else {
                openSettings(); // Shows provider list by default
            }
        }

        function openSettings() {
            // Restore from localStorage (if any)
            const savedUser = localStorage.getItem('rekindle_imap_user');
            if (savedUser) {
                document.getElementById('imap-user').value = savedUser;
                // Don't auto-fill pass for security/UX flow, user can re-enter or we could, but let's stick to flow
            }

            showProviderList();
            document.getElementById('auth-overlay').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('auth-overlay').style.display = 'none';
        }

        function showProviderList() {
            document.getElementById('provider-step').style.display = 'flex';
            document.getElementById('login-step').style.display = 'none';
        }

        function selectProvider(key) {
            const config = PROVIDERS[key];
            if (!config) return;

            document.getElementById('provider-step').style.display = 'none';
            document.getElementById('login-step').style.display = 'flex';

            document.getElementById('provider-help-text').innerHTML = config.helpHtml;

            // Set placeholders/values
            if (key === 'custom') {
                document.getElementById('custom-server-settings').style.display = 'block';
                // Clear values for custom if empty, or keep last
            } else {
                document.getElementById('custom-server-settings').style.display = 'none';
                document.getElementById('imap-host').value = config.imapHost;
                document.getElementById('imap-port').value = config.imapPort;
                document.getElementById('smtp-host').value = config.smtpHost;
                document.getElementById('smtp-port').value = config.smtpPort;
            }
        }

        async function login() {
            const user = document.getElementById('imap-user').value.trim();
            const pass = document.getElementById('imap-pass').value.replace(/\s/g, ''); // Strip spaces (Google App Passwords)
            const imapHost = document.getElementById('imap-host').value;
            const imapPort = parseInt(document.getElementById('imap-port').value);
            const smtpHost = document.getElementById('smtp-host').value;
            const smtpPort = parseInt(document.getElementById('smtp-port').value);

            if (!user || !pass) {
                showModal("Please enter email and password");
                return;
            }

            document.getElementById('btn-login').innerText = "Connecting...";
            document.getElementById('btn-login').disabled = true;

            imapConfig = {
                host: imapHost,
                port: imapPort,
                secure: imapPort === 993,
                auth: { user, pass }
            };

            smtpConfig = {
                host: smtpHost,
                port: smtpPort,
                secure: smtpPort === 465,
                auth: { user, pass }
            };

            userEmail = user;

            // Attempt to list emails to verify credentials
            try {
                await loadFolders();
                await loadEmails();

                // Save credentials if successful (encrypted)
                const authUser = firebase.auth().currentUser;
                if (authUser) {
                    const encryptedPass = await encryptPassword(pass, authUser.uid);
                    if (encryptedPass) {
                        localStorage.setItem('rekindle_imap_user', user);
                        localStorage.setItem('rekindle_imap_pass', encryptedPass);
                        localStorage.setItem('rekindle_imap_uid', authUser.uid);
                    } else {
                        console.error("Failed to encrypt password for localStorage");
                    }
                }
                localStorage.setItem('rekindle_imap_host', imapHost);
                localStorage.setItem('rekindle_imap_port', imapPort);
                localStorage.setItem('rekindle_smtp_host', smtpHost);
                localStorage.setItem('rekindle_smtp_port', smtpPort);

                document.getElementById('auth-overlay').style.display = 'none';

                // Save to Firebase (Pro Data)
                saveSettingsToFirebase(user, pass, imapHost, imapPort, smtpHost, smtpPort);
            } catch (e) {
                console.error("Login failed", e);
                showModal("Connection failed: " + e.message);
                document.getElementById('btn-login').innerText = "Connect";
                document.getElementById('btn-login').disabled = false;
            } finally {
                if (!document.getElementById('auth-overlay').style.display || document.getElementById('auth-overlay').style.display === 'none') {
                    // If success, overlay is closed. We reset for next time.
                    document.getElementById('btn-login').innerText = "Connect";
                    document.getElementById('btn-login').disabled = false;
                }
            }
        }

        function logout() {
            localStorage.removeItem('rekindle_imap_user');
            localStorage.removeItem('rekindle_imap_pass');
            localStorage.removeItem('rekindle_imap_uid');
            location.reload();
        }

        async function loadFolders() {
            if (!imapConfig) {
                console.error("loadFolders: missing imapConfig");
                return;
            }
            console.log("Loading folders with config", imapConfig); // DEBUG
            const getFoldersFn = functions.httpsCallable('getFolders');

            try {
                const result = await getFoldersFn({ imap: imapConfig });
                console.log("getFolders result:", result); // DEBUG
                if (result.data.success) {
                    const folders = result.data.folders;
                    allFolders = folders; // Store globally
                    const select = document.getElementById('folder-select');
                    select.innerHTML = '';

                    // Priority sorting: Inbox first
                    folders.sort((a, b) => {
                        if (a.specialUse === '\\Inbox') return -1;
                        if (b.specialUse === '\\Inbox') return 1;
                        return a.path.localeCompare(b.path);
                    });

                    folders.forEach(f => {
                        // Skip folders that are not selectable (e.g. "[Gmail]")
                        if (f.flags && f.flags.includes('\\Noselect')) {
                            return;
                        }

                        const opt = document.createElement('option');
                        opt.value = f.path;
                        // Use special use name if available, else path/name
                        let name = f.name || f.path;
                        if (f.specialUse && f.specialUse !== '\\Noselect') {
                            name = f.specialUse.replace('\\', '');
                        }
                        opt.innerText = name;
                        select.appendChild(opt);
                    });

                    // Set current folder to Inbox if available
                    const inbox = folders.find(f => f.specialUse === '\\Inbox' || f.path.toLowerCase() === 'inbox');
                    if (inbox) {
                        select.value = inbox.path;
                        currentFolder = inbox.path;
                    }
                }
            } catch (e) {
                console.error("Failed to load folders", e);
                // Propagate error for login
                throw e;
            }
        }

        // Pagination state
        let currentCursor = null;
        let isLoadingMore = false;

        async function loadEmails(reset = true) {
            if (reset) {
                currentCursor = null; // Reset cursor
                emails = []; // Clear list
                document.getElementById('status-bar').innerText = "Fetching emails...";
                document.getElementById('list-container').innerHTML = '<div style="padding:20px; text-align:center;">Loading...</div>';
            } else {
                isLoadingMore = true;
                const btn = document.getElementById('btn-load-more');
                if (btn) btn.innerText = "Loading...";
            }

            const fetchEmailsFn = functions.httpsCallable('fetchEmails');

            try {
                const result = await fetchEmailsFn({
                    imap: imapConfig,
                    path: currentFolder,
                    cursor: currentCursor,
                    limit: 20
                });

                if (result.data.success) {
                    if (reset) {
                        emails = result.data.messages;
                    } else {
                        emails = emails.concat(result.data.messages);
                        isLoadingMore = false;
                    }

                    // Sort emails by date (newest first)
                    emails.sort((a, b) => {
                        const dateA = new Date(a.envelope.date || a.internalDate);
                        const dateB = new Date(b.envelope.date || b.internalDate);
                        return dateB - dateA; // Descending order
                    });

                    currentCursor = result.data.nextCursor;
                    renderEmailList();
                    document.getElementById('status-bar').innerText = `Loaded ${emails.length} emails.`;
                } else {
                    throw new Error(result.data.error);
                }
            } catch (e) {
                console.error("Load error", e);
                document.getElementById('status-bar').innerText = "Error loading emails.";
                if (reset) {
                    document.getElementById('list-container').innerHTML = `<div style="padding:20px; text-align:center; color:red;">Error: ${e.message}</div>`;
                } else {
                    showModal("Error loading more: " + e.message);
                    isLoadingMore = false;
                    renderEmailList(); // Re-render to restore button
                }
                throw e; // Propagate for login check
            }
        }

        function renderEmailList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';

            emails.forEach(email => {
                const div = document.createElement('div');
                div.className = `email-item ${!email.flags.includes('\\Seen') ? 'unread' : ''}`;
                div.onclick = () => openEmail(email);

                const date = new Date(email.envelope.date || email.internalDate);
                const zonedDate = window.rekindleGetDateInZone ? window.rekindleGetDateInZone(date) : date;
                const nowZoned = window.rekindleGetZonedDate ? window.rekindleGetZonedDate() : new Date();

                const dateStr = !isNaN(date.getTime()) ? (
                    zonedDate.toLocaleDateString() === nowZoned.toLocaleDateString() ?
                        (window.rekindleFormatTime ? window.rekindleFormatTime(date, { hour: 'numeric', minute: '2-digit' }) : date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })) :
                        (window.rekindleFormatTime ? window.rekindleFormatTime(date, { month: 'numeric', day: 'numeric', year: 'numeric' }) : date.toLocaleDateString([], { month: 'numeric', day: 'numeric', year: 'numeric' }))
                ) : 'Unknown Date';

                // Snippet
                const snippet = email.snippet ? `<div class="email-snippet">${escapeHtml(email.snippet)}</div>` : '';

                div.innerHTML = `
                    <div class="email-sender">
                        <span class="email-sender-name">${escapeHtml(email.envelope.from[0].name || email.envelope.from[0].address)}</span>
                        <span class="email-date">${dateStr}</span>
                    </div>
                    <div class="email-subject">${escapeHtml(email.envelope.subject || '(No Subject)')}</div>
                    ${snippet}
                `;
                container.appendChild(div);
            });

            // Load More Button
            if (currentCursor) {
                const btn = document.createElement('button');
                btn.id = 'btn-load-more';
                btn.className = 'load-more-btn';
                btn.innerText = "Load More...";
                btn.onclick = () => loadEmails(false);
                container.appendChild(btn);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function filterEmails() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('list-container');
            const items = container.getElementsByClassName('email-item');

            Array.from(items).forEach((item, index) => {
                const email = emails[index];
                const text = (email.envelope.subject + (email.envelope.from[0].name || '')).toLowerCase();
                item.style.display = text.includes(query) ? '' : 'none';
            });
        }

        async function openEmail(email) {
            currentEmail = email;

            // Highlight selected
            const items = document.getElementsByClassName('email-item');
            Array.from(items).forEach(i => i.classList.remove('selected'));
            // Refine selection highlight later if needed

            // Mark as read locally and remotely
            if (!email.flags.includes('\\Seen')) {
                email.flags.push('\\Seen');
                renderEmailList(); // Update UI
                // Call modifyFlags backend
                functions.httpsCallable('modifyFlags')({
                    imap: imapConfig,
                    path: currentFolder,
                    uid: email.uid,
                    addFlags: ['\\Seen']
                }).catch(console.error);
            }

            const detailsPane = document.getElementById('details-pane');
            detailsPane.innerHTML = '<div style="padding:20px; text-align:center;">Loading body...</div>';

            const fetchBodyFn = functions.httpsCallable('fetchEmailBody');

            try {
                const result = await fetchBodyFn({
                    imap: imapConfig,
                    path: currentFolder,
                    uid: email.uid
                });

                if (result.data.success) {
                    const fullEmail = result.data.email;

                    // Reduce padding on container
                    detailsPane.innerHTML = `
                        <div class="email-header">
                            <h2 class="email-title">${escapeHtml(fullEmail.subject || '(No Subject)')}</h2>
                            <div class="email-meta">
                                <span><b>From:</b> ${escapeHtml(fullEmail.from ? fullEmail.from.text : 'Unknown')}</span>
                                <span><b>To:</b> ${escapeHtml(fullEmail.to ? fullEmail.to.text : 'Unknown')}</span>
                                <span><b>Date:</b> ${fullEmail.date ? (window.rekindleFormatTime ? window.rekindleFormatTime(new Date(fullEmail.date), { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : new Date(fullEmail.date).toLocaleString()) : 'Unknown Date'}</span>
                            </div>
                            <div class="email-actions">
                                <button class="toolbar-btn" onclick="replyEmail()">Reply</button>
                                <button class="toolbar-btn" onclick="toggleReadStatus()">Mark Unread</button>
                                <button class="toolbar-btn" onclick="archiveEmail()">Archive</button>
                                <button class="toolbar-btn" onclick="deleteEmail()">Delete</button>
                            </div>
                        </div>
                        <div id="email-body-host" class="email-body" style="border-top:1px solid #ccc; padding-top:10px;"></div>
                    `;

                    // Shadow DOM isolation for email body
                    const host = document.getElementById('email-body-host');
                    if (host) {
                        try {
                            const shadow = host.attachShadow({ mode: 'open' });

                            // Inject basic styles for the shadow content
                            const style = `
                                <style>
                                    /* GLOBAL RESET */
                                    :host { 
                                        display: block; 
                                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
                                        font-size: 14px; 
                                        line-height: normal;
                                        color: #000; 
                                        background: #fff;
                                        overflow-wrap: break-word;
                                        word-wrap: break-word;
                                    }

                                    /* Reset all margins/padding/heights first */
                                    * { margin: 0; padding: 0; box-sizing: border-box; max-width: 100%; min-height: 0; }

                                    /* Force block elements to not have explicit height */
                                    html, body, div, p, span, h1, h2, h3, h4, h5, h6 { 
                                        height: auto !important; 
                                        min-height: 0 !important;
                                    }

                                    /* Re-apply minimal spacing */
                                    p, ul, ol, dl, blockquote, pre { margin-bottom: 0.8em; }
                                    ul, ol { margin-left: 1.5em; }
                                    li { margin-bottom: 0.2em; }
                                    
                                    /* Headers */
                                    h1, h2, h3, h4, h5, h6 { font-weight: bold; margin-bottom: 0.4em; line-height: 1.2; }
                                    h1 { font-size: 1.5em; } h2 { font-size: 1.3em; } h3 { font-size: 1.1em; }

                                    /* Images */
                                    img { height: auto !important; display: block; vertical-align: bottom; }
                                    
                                    /* Hide typical spacer images */
                                    img[src*="spacer"], img[src*="blank"], img[width="1"] {
                                        display: none !important;
                                        height: 0 !important;
                                        width: 0 !important;
                                    }

                                    /* Links */
                                    a { color: #0000EE; text-decoration: underline; word-break: break-all; cursor: pointer; }

                                    /* Tables - Aggressive Reset */
                                    table, tbody, thead, tfoot, tr, td, th { 
                                        border-collapse: collapse !important; 
                                        border-spacing: 0 !important; 
                                        width: 100% !important; 
                                        margin: 0 !important;
                                        padding: 0 !important;
                                        height: auto !important;
                                        min-height: 0 !important;
                                        line-height: inherit !important;
                                    }
                                    td, th { padding: 2px !important; vertical-align: top; }
                                    
                                    /* Hack for Outlook/Gmail spacers */
                                    div[style*="min-height"], div[style*="height"] { height: auto !important; min-height: 0 !important; }

                                    /* HIDDEN ELEMENTS */
                                    div:empty, p:empty, span:empty, h1:empty, h2:empty, h3:empty { display: none !important; height: 0 !important; margin: 0 !important; padding: 0 !important; }
                                    br[clear], br[style*="display:none"] { display: none !important; }
                                    
                                    /* Collapse stacked BRs (redundant with JS cleaning but good backup) */
                                    br + br { display: none; }

                                    /* Quote styling */
                                    blockquote { 
                                        border-left: 2px solid #ccc; 
                                        padding-left: 10px; 
                                        color: #555; 
                                        margin-left: 5px; 
                                    }
                                </style>
                            `;

                            shadow.innerHTML = style + (fullEmail.html || fullEmail.text.replace(/\n/g, '<br>'));

                            // Intercept links to open in Browser app
                            try {
                                shadow.querySelectorAll('a').forEach(link => {
                                    link.addEventListener('click', (e) => {
                                        const href = link.getAttribute('href');
                                        if (href && !href.startsWith('#') && !href.startsWith('mailto:') && !href.startsWith('javascript:')) {
                                            e.preventDefault();
                                            window.location.href = 'browser.html?url=' + encodeURIComponent(href);
                                        }
                                    });
                                });
                            } catch (e) {
                                console.warn("Error attaching link listeners", e);
                            }
                        } catch (e) {
                            console.error("Shadow DOM error", e);
                            host.innerHTML = "Error rendering email body.";
                        }
                    }

                } else {
                    detailsPane.innerHTML = `< div style = "padding:20px; color:red;" > Error loading body: ${result.data.error}</div > `;
                }

            } catch (e) {
                console.error("Body error", e);
                detailsPane.innerHTML = `< div style = "padding:20px; color:red;" > Error: ${e.message}</div >`;
            }
        }

        async function toggleReadStatus() {
            if (!currentEmail) return;
            // Currently it is read (we mark it on open). Toggle to unread.
            currentEmail.flags = currentEmail.flags.filter(f => f !== '\\Seen');
            renderEmailList();

            try {
                await functions.httpsCallable('modifyFlags')({
                    imap: imapConfig,
                    path: currentFolder,
                    uid: currentEmail.uid,
                    removeFlags: ['\\Seen']
                });
                showModal("Marked as Unread");
            } catch (e) {
                showModal("Error: " + e.message);
            }
        }

        async function archiveEmail() {
            if (!currentEmail) return;

            // Find Archive/All Mail folder
            const archiveFolder = allFolders.find(f =>
                f.specialUse === '\\All' ||
                f.specialUse === '\\Archive' ||
                f.path.toLowerCase().includes('all mail') ||
                f.path.toLowerCase() === 'archive'
            );

            if (!archiveFolder) {
                showModal("Could not find an Archive or All Mail folder.");
                return;
            }

            const moveEmailFn = functions.httpsCallable('moveEmail');

            // Optimistic UI update
            const uid = currentEmail.uid;
            emails = emails.filter(e => e.uid !== uid);
            renderEmailList();
            document.getElementById('details-pane').innerHTML = '<div style="padding:20px; text-align:center;">Archived</div>';
            currentEmail = null;

            try {
                await moveEmailFn({
                    imap: imapConfig,
                    path: currentFolder,
                    uid: uid,
                    destination: archiveFolder.path
                });
                // showModal("Archived"); // Optional feedback
            } catch (e) {
                console.error("Archive failed", e);
                showModal("Failed to archive: " + e.message);
                loadEmails(true);
            }
        }

        async function deleteEmail() {
            if (!currentEmail) return;

            // Find Trash folder
            const trashFolder = allFolders.find(f =>
                f.specialUse === '\\Trash' ||
                f.path.toLowerCase().includes('trash') ||
                f.path.toLowerCase() === 'bin'
            );

            if (!trashFolder) {
                showModal("Could not find a Trash folder.");
                return;
            }

            const moveEmailFn = functions.httpsCallable('moveEmail');

            // Optimistic UI update
            const uid = currentEmail.uid;
            emails = emails.filter(e => e.uid !== uid);
            renderEmailList();
            document.getElementById('details-pane').innerHTML = '<div style="padding:20px; text-align:center;">Deleted</div>';
            currentEmail = null;

            try {
                await moveEmailFn({
                    imap: imapConfig,
                    path: currentFolder,
                    uid: uid,
                    destination: trashFolder.path
                });
                // showModal("Moved to Trash"); // Optional
            } catch (e) {
                console.error("Delete failed", e);
                showModal("Failed to move to Trash: " + e.message);
                loadEmails(true);
            }
        }

        function changeFolder() {
            currentFolder = document.getElementById('folder-select').value;
            console.log("Changed folder to:", currentFolder); // DEBUG
            loadEmails();
        }

        function openComposeModal() {
            document.getElementById('compose-to').value = '';
            document.getElementById('compose-subject').value = '';
            document.getElementById('compose-body').value = '';
            document.getElementById('compose-modal').style.display = 'flex';
        }

        function closeComposeModal() {
            document.getElementById('compose-modal').style.display = 'none';
        }

        function replyEmail() {
            if (!currentEmail) return;
            // Need the full body details which we might not have stored globally ideally
            // simple reply setup
            openComposeModal();
            document.getElementById('compose-to').value = currentEmail.envelope.from[0].address;
            document.getElementById('compose-subject').value = "Re: " + currentEmail.envelope.subject;
        }

        async function sendEmail() {
            const to = document.getElementById('compose-to').value;
            const subject = document.getElementById('compose-subject').value;
            const body = document.getElementById('compose-body').value;

            if (!to) {
                showModal("Please specify a recipient.");
                return;
            }

            const sendBtn = document.querySelector('#compose-modal .primary');
            const originalText = sendBtn.innerText;
            sendBtn.innerText = "Sending...";
            sendBtn.disabled = true;

            const sendEmailFn = functions.httpsCallable('sendEmail');

            try {
                const result = await sendEmailFn({
                    smtp: smtpConfig,
                    message: {
                        to,
                        subject,
                        text: body,
                        html: body.replace(/\n/g, '<br>')
                    }
                });

                if (result.data.success) {
                    closeComposeModal();
                    showModal("Email sent!");
                } else {
                    showModal("Error sending: " + result.data.error);
                }
            } catch (e) {
                console.error("Send error", e);
                showModal("Error sending: " + e.message);
            } finally {
                sendBtn.innerText = originalText;
                sendBtn.disabled = false;
            }
        }



        function toggleFullScreen() {
            document.querySelector('.window').classList.toggle('fullscreen');
        }



    </script>

    <script>
        // --- PASSWORD ENCRYPTION ---
        async function encryptPassword(password, uid) {
            try {
                const encoder = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey(
                    'raw', encoder.encode(uid),
                    { name: 'PBKDF2' }, false, ['deriveKey']
                );

                const key = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: encoder.encode('rekindle-mail-salt'), iterations: 100000, hash: 'SHA-256' },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 }, false, ['encrypt']
                );

                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    encoder.encode(password)
                );

                // Return as base64 string with IV prepended
                return btoa(String.fromCharCode(...iv) + String.fromCharCode(...new Uint8Array(encrypted)));
            } catch (e) {
                console.error("Encryption failed:", e);
                return null;
            }
        }

        async function decryptPassword(encryptedStr, uid) {
            try {
                const encoder = new TextEncoder();
                const data = Uint8Array.from(atob(encryptedStr), c => c.charCodeAt(0));
                const iv = data.slice(0, 12);
                const encrypted = data.slice(12);

                const keyMaterial = await crypto.subtle.importKey(
                    'raw', encoder.encode(uid),
                    { name: 'PBKDF2' }, false, ['deriveKey']
                );

                const key = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: encoder.encode('rekindle-mail-salt'), iterations: 100000, hash: 'SHA-256' },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 }, false, ['decrypt']
                );

                const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encrypted);
                return new TextDecoder().decode(decrypted);
            } catch (e) {
                console.error("Decryption failed:", e);
                return null;
            }
        }

        // --- CLOUD SYNC ---
        async function loadSettingsFromFirebase(uid) {
            if (!uid) return;
            try {
                const db = firebase.firestore();
                const doc = await db.collection('users').doc(uid).collection('pro_data').doc('mail').get();

                if (doc.exists) {
                    const data = doc.data();
                    if (data.imapUser && data.imapPass) {
                        // Decrypt password before storing locally
                        let password = data.imapPass;
                        if (data.encrypted) {
                            password = await decryptPassword(data.imapPass, uid);
                            if (!password) {
                                console.error("Failed to decrypt password from cloud");
                                return;
                            }
                        }

                        // Store encrypted password in localStorage (re-encrypt with same uid)
                        const encryptedForLocal = await encryptPassword(password, uid);
                        if (encryptedForLocal) {
                            localStorage.setItem('rekindle_imap_user', data.imapUser);
                            localStorage.setItem('rekindle_imap_pass', encryptedForLocal);
                            localStorage.setItem('rekindle_imap_uid', uid);
                            localStorage.setItem('rekindle_imap_host', data.imapHost);
                            localStorage.setItem('rekindle_imap_port', data.imapPort);
                            localStorage.setItem('rekindle_smtp_host', data.smtpHost);
                            localStorage.setItem('rekindle_smtp_port', data.smtpPort);
                            console.log("Mail settings synced from cloud (encrypted in localStorage).");
                        } else {
                            console.error("Failed to encrypt password for localStorage");
                        }
                    }
                }
            } catch (e) {
                console.error("Error loading mail settings from cloud:", e);
            }
        }

        async function saveSettingsToFirebase(user, pass, imapHost, imapPort, smtpHost, smtpPort) {
            const authUser = firebase.auth().currentUser;
            if (!authUser) return;

            try {
                // Encrypt password before saving
                const encryptedPass = await encryptPassword(pass, authUser.uid);
                if (!encryptedPass) {
                    console.error("Failed to encrypt password, not saving to cloud");
                    return;
                }

                const db = firebase.firestore();
                await db.collection('users').doc(authUser.uid).collection('pro_data').doc('mail').set({
                    imapUser: user,
                    imapPass: encryptedPass,
                    encrypted: true,
                    imapHost: imapHost,
                    imapPort: imapPort,
                    smtpHost: smtpHost,
                    smtpPort: smtpPort,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log("Mail settings saved to cloud (encrypted).");
            } catch (e) {
                console.error("Error saving mail settings to cloud:", e);
            }
        }
    </script>

    <!-- STANDARD MODAL POPUP -->
    <div id="generic-modal-overlay">
        <div class="modal-box">
            <div id="generic-modal-text" class="modal-text"></div>
            <div class="modal-btns">
                <button class="modal-btn" onclick="closeGenericModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        function showModal(text) {
            const overlay = document.getElementById('generic-modal-overlay');
            const textEl = document.getElementById('generic-modal-text');
            if (overlay && textEl) {
                textEl.innerText = text;
                overlay.style.display = 'flex';
            } else {
                console.log("Modal fallback (elements missing):", text);
            }
        }

        function closeGenericModal() {
            document.getElementById('generic-modal-overlay').style.display = 'none';
        }
    </script>


</body>

</html>