<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta charset="UTF-8">
    <title>Files</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="pro-gate.js"></script>

    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #e5e5e5;
            user-select: none;
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Compatibility: Disable Animations */
        *,
        *::before,
        *::after {
            transition: none !important;
            animation: none !important;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            width: 95%;
            max-width: 800px;
            height: 90vh;
            position: relative;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* Content Area */
        .window-content {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
        }

        /* Toolbar */
        .toolbar {
            padding: 8px;
            border-bottom: 2px solid black;
            display: flex;
            /* gap: 10px; REMOVED KINDLE */
            align-items: center;
        }

        .toolbar>*+* {
            margin-left: 10px;
        }

        .btn {
            border: 2px solid black;
            background: white;
            box-shadow: 2px 2px 0 black;
            padding: 4px 12px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            /* gap: 6px; REMOVED KINDLE */
        }

        .btn>*+* {
            margin-left: 6px;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
            background: black;
            color: white;
        }

        .btn svg {
            width: 16px;
            height: 16px;
            stroke-width: 2;
        }

        .btn:active svg {
            stroke: white;
        }

        .storage-info {
            margin-left: auto;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .storage-bar-container {
            width: 100px;
            height: 10px;
            border: 2px solid black;
            margin-top: 4px;
            background: white;
            position: relative;
        }

        .storage-bar-fill {
            height: 100%;
            background: black;
            width: 0%;
        }

        .quota-text {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        /* File List */
        .file-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            grid-gap: 15px;
            /* Fallback for flex gap */
            gap: 15px;
            align-content: start;
        }

        /* File List Items */
        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            border: 2px solid transparent;
            position: relative;
            /* Needed for absolute positioning of menu in grid view */
        }

        .file-item:hover {
            background-color: #f0f0f0;
        }

        .file-item.selected {
            background-color: black;
            color: white;
        }

        .file-item.selected svg {
            stroke: white;
            fill: white;
        }

        .file-item.selected .file-icon {
            fill: white;
            stroke: white;
        }

        /* When selected, icon paths that were black should be white */
        .file-item.selected .file-icon path,
        .file-item.selected .file-icon rect,
        .file-item.selected .file-icon circle,
        .file-item.selected .file-icon line,
        .file-item.selected .file-icon polyline {
            stroke: white;
        }

        /* Except fills that were white should probably be black... handled by inversion usually but let's stick to simple stroke inversion */

        .file-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-icon svg {
            width: 100%;
            height: 100%;
            stroke: black;
            stroke-width: 2;
            fill: none;
        }

        .file-name {
            font-size: 0.85rem;
            word-break: break-word;
            max-width: 100%;
            line-height: 1.2;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .file-size {
            font-size: 0.7rem;
            margin-top: 2px;
            opacity: 0.6;
        }

        .file-item.selected .file-size {
            opacity: 0.9;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            opacity: 0.5;
            grid-column: 1 / -1;
        }

        /* Modal for Delete Confirmation */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            visibility: hidden;
        }

        .modal-overlay.active {
            visibility: visible;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            /* gap: 10px; REMOVED KINDLE */
            margin-top: 20px;
        }

        .modal-actions>*+* {
            margin-left: 10px;
        }

        /* List View Styles */
        .file-list.list-view {
            display: flex;
            flex-direction: column;
            /* gap: 0; REMOVED KINDLE */
        }

        .file-list.list-view .file-item {
            flex-direction: row;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
        }

        .file-list.list-view .file-item:hover {
            background-color: #f0f0f0;
        }

        .file-list.list-view .file-item.selected {
            background-color: black;
            color: white;
        }

        .file-list.list-view .file-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 0;
            margin-right: 15px;
        }

        .file-list.list-view .file-name {
            font-size: 0.9rem;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            -webkit-line-clamp: unset;
            line-clamp: unset;
        }

        .file-list.list-view .file-size {
            margin-top: 0;
            min-width: 60px;
            text-align: right;
        }

        /* 3-Dot Menu */
        .file-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid black;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 2px;
        }

        .menu-btn:hover {
            background: white;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            display: none;
            flex-direction: column;
            width: 120px;
            z-index: 20;
        }

        .menu-dropdown.active {
            display: flex;
        }

        .menu-item {
            padding: 8px 12px;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 1px solid #eee;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: black;
            color: white;
        }

        /* Adjust list view for actions */
        .file-list.list-view .file-actions {
            position: static;
            margin-left: 10px;
        }
    </style>

    <script src="theme.js"></script>
    <script src="js/i18n.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text" data-i18n="files.title">Files</span>
        </div>

        <div class="window-content">
            <div class="toolbar">
                <button class="btn" onclick="showUploadModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <span data-i18n="files.btn.upload">Upload</span>
                </button>
                <button class="btn" onclick="deleteSelected()" id="delete-btn" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="3 6 5 6 21 6" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    </svg>
                    <span data-i18n="files.btn.delete">Delete</span>
                </button>
                <div style="flex-grow:1"></div>
                <div class="storage-info">
                    <span id="storage-text" data-i18n="files.status.loading">Loading...</span>
                    <div class="storage-bar-container">
                        <div class="storage-bar-fill" id="storage-bar"></div>
                    </div>
                    <span class="quota-text" data-i18n="files.storage.max">Max 100MB</span>
                </div>
                <button class="btn" onclick="toggleView()" id="view-toggle-btn" title="Toggle View"
                    style="margin-left: 10px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </button>
            </div>

            <div class="file-list" id="file-list">
                <!-- Files will be injected here -->
                <div class="empty-state" data-i18n="files.empty.no_files">No files found.</div>
            </div>
        </div>
    </div>

    <!-- Global click listener to close menus -->
    <div id="click-catcher" style="position:fixed; inset:0; z-index:5; display:none;" onclick="closeAllMenus()"></div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal-box">
            <p data-i18n="files.modal.delete.title">Are you sure you want to delete this file?</p>
            <p id="delete-filename" style="font-weight:bold; margin: 10px 0;"></p>
            <div class="modal-actions">
                <button class="btn" onclick="closeDeleteModal()"
                    data-i18n="files.modal.delete.btn.cancel">Cancel</button>
                <button class="btn" onclick="confirmDelete()" data-i18n="files.modal.delete.btn.delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Select Document Modal (shown when redirected from Docs app) -->
    <div class="modal-overlay" id="select-doc-modal">
        <div class="modal-box">
            <p style="font-weight:bold;" data-i18n="files.modal.select_doc.title">Select a Document</p>
            <p style="margin-top:8px;" data-i18n="files.modal.select_doc.body">Tap a .doc or .docx file to open it in
                the editor.</p>
            <div class="modal-actions" style="margin-top:15px;">
                <button class="btn" onclick="document.getElementById('select-doc-modal').classList.remove('active')"
                    data-i18n="files.modal.select_doc.btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Upload Instruction Modal -->
    <div class="modal-overlay" id="upload-modal">
        <div class="modal-box">
            <p style="font-weight:bold;" data-i18n="files.modal.upload.title">Upload Files</p>
            <p style="margin: 10px 0;" data-i18n="files.modal.upload.body">Please upload files to ReKindle using your
                PC.</p>
            <div class="modal-actions">
                <button class="btn" onclick="closeUploadModal()"
                    data-i18n="files.modal.upload.btn.cancel">Cancel</button>
                <button class="btn" onclick="triggerUpload()" data-i18n="files.modal.upload.btn.upload">Upload</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="file-upload" style="display:none" accept=".doc,.docx" onchange="handleFileUpload(this)">
    </div>

    <script>
        // --- Firebase Config & Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // NOTE: In this environment, usually firebase is initialized in `theme.js` or `index.html`. 
        // If `theme.js` does it, great. If not, we might need to add it. 
        // I will proceed assuming I need to initialize it if `firebase.apps.length === 0`.
        // I'll genericize the config for now or fetch it from a known location if I could.
        // Since I don't have the config keys, I'll rely on the user to have them or `theme.js`.
        // WAIT: I should check `theme.js` to be sure. But I want to avoid extra reads if possible.
        // I'll add a safety check.

        const MAX_STORAGE_BYTES = 100 * 1024 * 1024; // 100MB

        let currentUser = null;
        let currentFiles = [];
        let totalUsage = 0;
        let selectedFile = null;

        let isListView = localStorage.getItem('files_view_mode') === 'list';

        document.addEventListener('DOMContentLoaded', async () => {
            // Apply View Mode
            if (isListView) applyViewMode();

            // Apply theme
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();

            // Check if redirected from Docs app
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('selectDoc') === 'true') {
                document.getElementById('select-doc-modal').classList.add('active');
                window.history.replaceState({}, document.title, 'files.html');
            }

            // Check Firebase
            if (!firebase.apps.length) {
                // If not initialized, we likely need the config. 
                // Since I don't have it, I'll assume it's injected or global.
                // For now, I'll log a warning if it's missing.
                console.warn("Firebase not initialized! App may not work.");
                // In a real scenario I'd copy from `index.html` or similar.
            }

            // Auth Listener
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadFiles();
                } else {
                    // Redirect to login or show error
                    // window.location.href = 'index.html'; // For now just show empty
                    document.querySelector('.empty-state').textContent = "Please sign in.";
                }
            });
        });

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        async function loadFiles() {
            if (!currentUser) return;

            const listRef = firebase.storage().ref(`users/${currentUser.uid}/files`);
            const fileListEl = document.getElementById('file-list');

            try {
                fileListEl.innerHTML = '<div class="empty-state">Loading...</div>';
                const res = await listRef.listAll();

                currentFiles = [];
                totalUsage = 0;

                const metaPromises = res.items.map(itemRef => itemRef.getMetadata());
                const metadataList = await Promise.all(metaPromises);

                metadataList.forEach(meta => {
                    currentFiles.push(meta);
                    totalUsage += meta.size;
                });

                updateStorageUI();
                renderFiles();

            } catch (error) {
                console.error("Error loading files:", error);
                fileListEl.innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
            }
        }

        function updateStorageUI() {
            const percentage = Math.min(100, (totalUsage / MAX_STORAGE_BYTES) * 100);
            document.getElementById('storage-bar').style.width = `${percentage}%`;
            document.getElementById('storage-text').textContent = `${formatSize(totalUsage)} used`;

            if (percentage > 90) {
                document.getElementById('storage-bar').style.backgroundColor = 'red';
            } else {
                document.getElementById('storage-bar').style.backgroundColor = 'black';
            }
        }

        function renderFiles() {
            const listEl = document.getElementById('file-list');
            listEl.innerHTML = '';

            if (currentFiles.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No files. Upload something!</div>';
                return;
            }

            currentFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                // Single click to open (moved from dblclick)
                item.onclick = (e) => {
                    // Ignore clicks on menu
                    if (e.target.closest('.file-actions')) return;
                    openFile(file);
                };

                const isImage = file.contentType && file.contentType.startsWith('image/');
                // Simple icon logic
                let iconSvg = '';
                if (isImage) {
                    iconSvg = '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
                } else {
                    iconSvg = '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>';
                }

                // Add 3-dot menu
                // ESCAPING FIX: We need to escape single quotes, double quotes, and backslashes for the inline JS calls.
                const safePath = file.fullPath.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeName = file.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                const fileActions = `
                    <div class="file-actions">
                        <div class="menu-btn" onclick="toggleMenu(event, '${safePath}')">
                            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="12" cy="5" r="1"></circle>
                                <circle cx="12" cy="19" r="1"></circle>
                            </svg>
                        </div>
                        <div class="menu-dropdown" id="menu-${file.fullPath.replace(/"/g, '\\"') /* ID doesn't need same escaping, just double quotes if any */}">
                            <div class="menu-item" onclick="downloadFile(event, '${safePath}')">Download</div>
                            <div class="menu-item" onclick="deleteFile(event, '${safePath}', '${safeName}')">Delete</div>
                        </div>
                    </div>
                `;

                item.innerHTML = `
                    <div class="file-icon">${iconSvg}</div>
                    <div class="file-name" title="${file.name}">${file.name}</div>
                    <div class="file-size">${formatSize(file.size)}</div>
                    ${fileActions}
                `;

                listEl.appendChild(item);
            });
        }

        function toggleMenu(e, path) {
            e.stopPropagation();
            closeAllMenus();
            const menu = document.getElementById(`menu-${path}`);
            if (menu) {
                menu.classList.add('active');
                document.getElementById('click-catcher').style.display = 'block';
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.menu-dropdown').forEach(el => el.classList.remove('active'));
            document.getElementById('click-catcher').style.display = 'none';
        }

        async function downloadFile(e, path) {
            e.stopPropagation();
            closeAllMenus();
            const ref = firebase.storage().ref(path);
            const url = await ref.getDownloadURL();

            // Create a temporary link to force download
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.download = ''; // Hint to browser
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function deleteFile(e, path, name) {
            e.stopPropagation();
            closeAllMenus();

            // Re-use logic for modal
            selectedFile = { fullPath: path, name: name }; // Mock file obj for compat with existing delete logic
            document.getElementById('delete-filename').textContent = name;
            document.getElementById('delete-modal').classList.add('active');
        }

        async function openFile(file) {
            // Check for doc/docx
            const name = file.name.toLowerCase();
            if (name.endsWith('.doc') || name.endsWith('.docx')) {
                // Open in Docs app
                // Pass path to enable saving back
                const encodedPath = encodeURIComponent(file.fullPath);
                window.location.href = `docs.html?path=${encodedPath}`;
                return;
            }

            // Prevent download/open for other types
            // alert("Preview not available for this file type.");
            // Actually, maybe we should just notify that they can use the menu to download?
            alert("Preview not available. Use the menu (...) to download this file.");
        }

        function toggleView() {
            isListView = !isListView;
            localStorage.setItem('files_view_mode', isListView ? 'list' : 'grid');
            applyViewMode();
        }

        function applyViewMode() {
            const listEl = document.getElementById('file-list');
            const btn = document.getElementById('view-toggle-btn');

            if (isListView) {
                listEl.classList.add('list-view');
                // Icon: List
                btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`;
            } else {
                listEl.classList.remove('list-view');
                // Icon: Grid
                btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>`;
            }
        }

        // --- Upload Modal Logic ---
        function showUploadModal() {
            document.getElementById('upload-modal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.remove('active');
        }

        function triggerUpload() {
            closeUploadModal();
            document.getElementById('file-upload').click();
        }

        async function handleFileUpload(input) {
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];

            // 0. Type Check
            const validExtensions = ['.doc', '.docx'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

            if (!validExtensions.includes(fileExtension)) {
                alert("Upload failed: Only .doc and .docx files are allowed.");
                input.value = '';
                return;
            }

            // 1. Quota Check
            if (totalUsage + file.size > MAX_STORAGE_BYTES) {
                alert(`Upload failed: Not enough space.\nFile size: ${formatSize(file.size)}\nSpace remaining: ${formatSize(MAX_STORAGE_BYTES - totalUsage)}`);
                input.value = ''; // Reset
                return;
            }

            // 2. Upload
            const ref = firebase.storage().ref(`users/${currentUser.uid}/files/${file.name}`);

            // UI Feedback (simple)
            const originalText = document.querySelector('.toolbar button').innerHTML;
            document.querySelector('.toolbar button').textContent = 'Uploading...';

            try {
                await ref.put(file);
                // Reload list
                loadFiles();
            } catch (err) {
                alert("Upload failed: " + err.message);
            } finally {
                document.querySelector('.toolbar button').innerHTML = originalText; // Restore icon
                input.value = '';
            }
        }

        function deleteSelected() {
            if (!selectedFile) return;
            document.getElementById('delete-filename').textContent = selectedFile.name;
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
        }

        async function confirmDelete() {
            if (!selectedFile) return;

            const ref = firebase.storage().ref(selectedFile.fullPath);
            try {
                await ref.delete();
                closeDeleteModal();
                selectedFile = null;
                document.getElementById('delete-btn').style.display = 'none';
                loadFiles();
            } catch (err) {
                alert("Delete failed: " + err.message);
                closeDeleteModal();
            }
        }
    </script>
</body>

</html>