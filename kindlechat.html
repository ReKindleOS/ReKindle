<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KindleChat</title>
    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            /* Background managed by settings */

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 900px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        /* CLOSE BUTTON */
        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            box-shadow: none;
        }

        /* CONTROLS (Right side of Title Bar) */
        .title-controls {
            position: absolute;
            right: 10px;
            z-index: 2;
            display: flex;
            align-items: center;
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
            flex-shrink: 0;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* Icon State Toggles */
        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        /* MAIN LAYOUT */
        #app-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            --sidebar-width: 252px;
            /* Default: 250px width + 2px border */
        }

        /* SIDEBAR */
        #sidebar {
            width: 250px;
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eee;
        }

        #room-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .room-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-item:hover {
            background: #f0f0f0;
        }

        .room-item.active {
            background: black;
            color: white;
            font-weight: bold;
        }

        /* DELETE BUTTON IN LIST */
        .del-room-btn {
            font-weight: bold;
            color: #999;
            padding: 5px 10px;
            cursor: pointer;
            font-family: sans-serif;
            font-size: 1.2rem;
            line-height: 0.8;
        }

        .del-room-btn:hover {
            color: black;
        }

        .room-item.active .del-room-btn {
            color: #ccc;
        }

        .room-item.active .del-room-btn:hover {
            color: white;
        }

        /* CHAT VIEW */
        #chat-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
            min-width: 0;
            max-width: calc(100% - var(--sidebar-width));
        }

        /* ROOM HEADER */
        .room-header {
            border-bottom: 2px solid black;
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #eee;
            font-size: 0.9rem;
            flex-shrink: 0;
            position: relative;
        }

        #header-new-chat-btn {
            position: absolute;
            left: 10px;
            display: none;
            /* Default hidden, overrides sys-btn flex */
            padding: 2px 8px;
            /* Compact */
        }

        .current-room {
            font-weight: bold;
            text-transform: uppercase;
        }

        /* CHAT HISTORY */
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            display: flex;
            flex-direction: column;
            /* Allow wrapping, max-width controls the break point */
            max-width: 85%;
            position: relative;
            max-width: 85%;
            position: relative;
            min-width: 0;
            /* Allow shrinking */
        }

        .msg.self {
            align-self: flex-end;
            align-items: flex-end;
        }

        .msg.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .msg-meta {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 2px;
            display: flex;
        }

        /* Manual spacing for Kindle browser */
        .msg-meta span {
            margin-right: 8px;
        }

        .msg-meta span:last-child {
            margin-right: 0;
        }

        .msg-bubble {
            border: 2px solid black;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            box-shadow: 2px 2px 0px #ccc;
            word-wrap: break-word;
            /* Legacy */
            word-break: break-word;
            /* Modern equivalent for long words */
            overflow-wrap: break-word;
            /* Standard */
            min-width: 0;
            /* Flex shrink fix */
            width: fit-content;
            /* Ensure it wraps tightly but respects max-width */
            position: relative;
            /* FIX: Crucial for allowing the bubble to shrink-wrap its content width */
            display: inline-block;
            max-width: 100%;
        }

        .msg-bubble a {
            color: inherit;
            text-decoration: underline;
            word-break: break-all;
        }

        .msg.self .msg-bubble {
            background: black;
            color: white;
            border-color: black;
            box-shadow: 2px 2px 0px #666;
        }

        /* ASCII art messages use a fixed-width font */
        .msg-bubble.ascii {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            /* Preserve whitespace/newlines */
            font-size: 0.8rem;
        }

        /* --- REACTIONS (Font only) --- */
        .reaction-bar {
            margin-top: 5px;
            display: flex;
            gap: 5px;
            font-size: 1rem;
            padding: 2px 0;
            flex-wrap: wrap;
        }

        .reaction-item {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 2px 6px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            line-height: 1;
            font-weight: bold;
        }

        .msg.self .reaction-item {
            background: #333;
            color: white;
            border-color: #555;
        }

        /* MODIFIED: CONSTANT PLUS BUTTON (REACTION TRIGGER) */
        .react-btn {
            position: absolute;
            top: 50%;
            /* Center vertically with message */
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 1px solid black;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            text-align: center;
            line-height: 18px;
            font-size: 0.9rem;
            box-shadow: 1px 1px 0 #999;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0.5;
            /* Initial opacity */
            transition: opacity 0.2s;
        }

        .react-btn:hover {
            opacity: 1.0;
        }

        /* Position for messages sent by others (button on right) */
        .msg.other .react-btn {
            right: -25px;
            left: auto;
        }

        /* Position for self messages (button on left) */
        .msg.self .react-btn {
            left: -25px;
            right: auto;
        }

        /* Hide the button if not logged in or a special message */
        .react-btn.hidden {
            display: none;
        }

        /* Game Link CONTAINER - CRITICAL ADJUSTMENTS HERE */
        .game-link-container {
            /* FIX: Make it the bubble and remove its top margin, use minimal padding */
            border: 2px solid black;
            padding: 5px;
            background: #eee;
            margin-top: 0;
            /* Remove redundant margin */
            text-align: center;
            /* FIX: Set display to a table-related value so it shrinks tightly to content */
            display: table;
            min-width: 100px;
            max-width: 100%;
            box-sizing: border-box;
            box-shadow: 2px 2px 0 #ccc;
            /* Inherit original bubble shadow */
        }

        /* Override bubble style for game link messages */
        .msg-bubble.game-link-bubble {
            padding: 0;
            border: none;
            box-shadow: none;
            background: transparent;
        }

        .game-link-container.disabled {
            opacity: 0.6;
            cursor: default;
        }

        /* Game Link INNER TEXT/BUTTON */
        .game-link {
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            color: black;
            display: block !important;
            font-size: 0.8rem;
            line-height: 1.3;
            word-break: break-word;
        }


        /* INPUT AREA */
        .input-area {
            border-top: 2px solid black;
            padding: 10px;
            display: flex;
            gap: 10px;
            background: #eee;
            flex-shrink: 0;
            position: relative;
        }

        textarea {
            flex-grow: 1;
            border: 2px solid black;
            padding: 10px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            height: 70px;
            /* Increased height for multi-line support */
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 5px 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sys-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        /* --- NEW: ASCII ART PICKER STYLES --- */
        .ascii-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 10px;
            right: 10px;
            /* NEW: Anchor to right for shrinking */
            width: auto;
            /* NEW: Auto width */
            max-width: 600px;
            /* Cap width */
            height: 400px;
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            z-index: 20;
            /* Layout Mode: Flex Column (Content top, Categories bottom) */
            flex-direction: column;
            padding: 0;
            /* Remove padding from main container */
            gap: 0;
            overflow: hidden;
            /* Inner containers handle scroll */
        }

        .ascii-picker.open {
            display: flex;
        }

        /* SIDEBAR (Now Bottom Bar) */
        .ascii-sidebar {
            width: 100%;
            height: auto;
            /* Allow it to take necessary height */
            background: #eee;
            border-top: 2px solid black;
            border-right: none;
            overflow-x: auto;
            /* Horizontal scroll */
            overflow-y: hidden;
            /* No vertical scroll */
            flex-shrink: 0;
            display: flex;
            flex-direction: row;
            /* Horizontal items */
        }

        .ascii-sidebar-item {
            padding: 10px;
            border-right: 1px solid #ccc;
            /* Separator between horizontal items */
            border-bottom: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            /* Prevent text wrapping */
            flex-shrink: 0;
        }

        .ascii-sidebar-item:last-child {
            border-right: none;
        }

        .ascii-sidebar-item:hover,
        .ascii-sidebar-item.active {
            background: black;
            color: white;
        }

        /* CONTENT (Top) */
        .ascii-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            /* gap: 15px;  <-- Kindle doesn't support flex gap */
        }

        /* CATEGORY SECTION */
        .ascii-category-section {
            scroll-margin-top: 10px;
            margin-bottom: 25px;
            /* Manual gap */
            border-bottom: 1px dashed #ccc;
            /* Extra visual separator */
            padding-bottom: 15px;
        }


        /* GRID for Emojis */
        .ascii-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .ascii-option {
            border: 1px solid #ccc;
            padding: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            text-align: center;
            background: #fafafa;
            min-width: 60px;
            flex-grow: 1;
        }

        .ascii-option:hover {
            background: black;
            color: white;
            border-color: black;
        }

        /* NEW: REACTION SELECTION MODAL */
        #reaction-selection-modal {
            position: absolute;
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            padding: 5px;
            z-index: 10;
            display: none;
            flex-direction: column;
            gap: 5px;
        }

        .reaction-option {
            padding: 5px 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            background: #eee;
            border: 1px solid #ccc;
        }

        .reaction-option:hover {
            background: black;
            color: white;
        }


        /* MODAL */
        #modal-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 2px solid black;
            box-sizing: border-box;
        }

        /* LOCKED INPUT (Guest) */
        #locked-input {
            border-top: 2px solid black;
            padding: 15px;
            background: #ddd;
            text-align: center;
            font-style: italic;
            color: #555;
            font-size: 0.9rem;
            display: none;
        }

        /* GUEST OVERLAY (New) */
        #guest-overlay {
            position: absolute;
            top: 35px;
            /* Below title bar */
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 50;
            display: none;
            /* Default hidden */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        #guest-overlay h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }

        /* --- USER THEMES --- */
        .msg-bubble.developer {
            border: 3px double black !important;
            box-shadow: 4px 4px 0px #000;
        }

        .msg.self .msg-bubble.developer {
            border-color: white !important;
            /* Ensure visibility on black background? No, self is black bg. */
            /* If bg is black, double border needs color. */
            box-shadow: 4px 4px 0px #666;
            background-image: none;
        }

        /* Developer Tag */
        .dev-tag {
            font-size: 0.7rem;
            background: black;
            color: white;
            padding: 1px 4px;
            border-radius: 4px;
            margin-right: 5px;
            vertical-align: middle;
            font-weight: bold;
        }

        .msg-bubble.supporter {
            background: black !important;
            color: white !important;
            border: 2px solid black !important;
            /* Matches bg but defines size */
            box-shadow: 4px 4px 0px #999;
            /* Grey shadow for contrast */
        }

        /* Ensure links in supporter bubbles are visible */
        .msg-bubble.supporter a {
            color: white;
            text-decoration: underline;
        }

        .supporter-crown {
            width: 14px;
            height: 14px;
            display: inline-block;
            vertical-align: middle;
            fill: black;
            /* Default */
            margin-right: 4px;
        }

        .msg.self .supporter-crown {
            fill: black;
        }

        /* STANDARD MODAL SYSTEM */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            font-family: "Geneva", "Verdana", sans-serif;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            padding: 20px;
            box-shadow: 6px 6px 0 black;
            max-width: 300px;
            width: 80%;
            text-align: center;
        }

        .modal-text {
            margin-bottom: 20px;
            font-weight: bold;
            line-height: 1.4;
            color: black;
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            background: white;
            border: 2px solid black;
            padding: 6px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-family: inherit;
        }

        .modal-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="emojis.js"></script>

    <script src="bad_words.js?v=2"></script>
    <script src="theme.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text">KindleChat</span>
            <div class="title-controls">
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1" />
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="app-layout">

            <div id="sidebar">
                <div class="sidebar-header">
                    <span style="font-weight:bold;">Chats</span>
                    <button class="sys-btn" onclick="openCreateModal()">+</button>
                </div>
                <div id="room-list">
                </div>
            </div>

            <div id="chat-view">
                <div class="room-header">
                    <!-- NEW: Conditional New Chat Button -->
                    <button id="header-new-chat-btn" class="sys-btn header-new-chat-btn"
                        onclick="openCreateModal()">+</button>
                    <span class="current-room" id="room-title">All of KindleChat</span>
                </div>

                <div id="chat-history">
                </div>

                <div class="input-area" id="active-input">
                    <!-- NEW ASCII PICKER AND BUTTON -->
                    <div id="ascii-picker-window" class="ascii-picker">
                        <!-- Items injected by JS -->
                    </div>

                    <button id="pixel-btn" class="sys-btn" onclick="window.location.href='pixel?source=kindlechat'"
                        style="font-size:1.2rem; padding: 0 10px;" title="Open Pixel">✎</button>

                    <button class="sys-btn" onclick="toggleAsciiPicker()"
                        style="font-size:1.2rem; padding: 0 10px;">☺</button>

                    <textarea id="msg-input" placeholder="Type a message..." rows="3"></textarea>
                    <button class="sys-btn" id="send-btn" onclick="sendMessage()" style="height: 100%;">Send</button>
                </div>

                <div id="locked-input">
                    Log in on the home screen to send messages.
                </div>
            </div>
        </div>

        <!-- GUEST OVERLAY HTML -->
        <div id="guest-overlay">
            <h2>You need to be logged in to use KindleChat</h2>
            <br>
            <button class="sys-btn" onclick="window.location.href='index?login=true'">Log In</button>
        </div>
    </div>

    <!-- SHARED MODAL OVERLAY -->
    <div id="modal-overlay">

        <!-- SEND DM MODAL CONTENT -->
        <div class="modal-box" id="create-modal-content">
            <h3>Send Message</h3>
            <div
                style="display: flex; align-items: stretch; width: 100%; margin: 10px 0; gap: 5px; box-sizing: border-box;">
                <input type="text" id="dm-username" class="modal-input" placeholder="Username (e.g. bob)"
                    style="flex-grow: 1; margin: 0; width: auto; font-family: inherit; font-size: 1rem; box-sizing: border-box;">
                <button
                    onclick="document.getElementById('dm-username').value='ukiyo'; document.getElementById('dm-message').focus();"
                    style="padding: 8px; background: white; border: 2px solid black; cursor: pointer; font-family: inherit; font-size: 1rem; font-weight: normal; color: black; box-sizing: border-box;">Ukiyo</button>
            </div>
            <textarea id="dm-message" class="modal-input" placeholder="Message..."
                style="height:60px; resize:none;"></textarea>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="sendDirectMessage()">Send</button>
                <button class="sys-btn" onclick="closeModal('modal-overlay')">Cancel</button>
            </div>
        </div>

        <!-- DELETE MODAL CONTENT -->
        <div class="modal-box" id="delete-modal-content" style="display:none;">
            <h3>Leave Chat?</h3>
            <p style="margin: 15px 0;">Remove this chat from your list?</p>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="confirmLeaveRoom()">Yes</button>
                <button class="sys-btn" onclick="closeModal('modal-overlay')">No</button>
            </div>
        </div>

    </div>

    <!-- NEW: REACTION SELECTION MODAL -->
    <div id="reaction-selection-modal" onclick="closeReactionModal(event)">
        <!-- Options injected by JS -->
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        // --- CONFIGURATION ---
        function showModal(msg, isConfirm = false, callback = null) {
            const overlay = document.getElementById('modal-overlay');
            const messageEl = document.getElementById('modal-message');
            const btnsEl = document.getElementById('modal-btns');
            messageEl.textContent = msg;
            if (isConfirm) {
                btnsEl.innerHTML = '<button class="modal-btn" id="modal-cancel">Cancel</button><button class="modal-btn" id="modal-ok">OK</button>';
                document.getElementById('modal-cancel').onclick = () => { overlay.style.display = 'none'; if (callback) callback(false); };
                document.getElementById('modal-ok').onclick = () => { overlay.style.display = 'none'; if (callback) callback(true); };
            } else {
                btnsEl.innerHTML = '<button class="modal-btn" onclick="hideModal()">OK</button>';
            }
            overlay.style.display = 'flex';
        }
        function hideModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- STATE ---
        let currentUser = null;
        let currentUsername = "";
        let currentRoomId = 'general';
        let roomToDeleteId = null;
        let unsubscribeMsg = null;
        let unsubscribeRooms = null;
        let oldestMsgDoc = null; // For pagination
        let isLoadingMore = false; // For pagination
        let supporterUsers = new Set(); // Store supporter usernames

        // --- Reaction Keys (Simplified to match the new constant button action) ---
        const FONT_REACTIONS = ['+1', '-1', '♥', '?', '!', 'XD']; // List of available reactions

        // --- ASCII ART DATA ---
        // Moved to emojis.js (ASCII_EMOJIS)

        // --- INIT ---
        window.onload = () => {
            loadWallpaper();
            initAsciiPicker(); // Initialize the ASCII picker
            fetchSupporters(); // Load supporters list

            // Check Auth
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    currentUsername = user.email.split('@')[0];

                    document.getElementById('active-input').style.display = 'flex';
                    document.getElementById('locked-input').style.display = 'none';

                    await cleanupEmptyChats();
                    loadRooms();
                } else {
                    currentUser = null;
                    document.getElementById('app-layout').style.display = 'none';
                    document.getElementById('guest-overlay').style.display = 'flex';
                }
                loadMessages();
            });

            // Enter key
            document.getElementById('msg-input').addEventListener("keypress", (e) => {
                // Shift+Enter should allow newline (for ASCII art)
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Populate the reaction modal once
            populateReactionModal();

            // Click outside close for ASCII picker
            document.addEventListener('click', function (event) {
                const picker = document.getElementById('ascii-picker-window');
                const btn = document.querySelector('.sys-btn[onclick="toggleAsciiPicker()"]');
                if (picker.classList.contains('open') &&
                    !picker.contains(event.target) &&
                    event.target !== btn) {
                    picker.classList.remove('open');
                }
            });

            // Scroll to top to load more messages
            document.getElementById('chat-history').addEventListener('scroll', handleScroll);
        };


        // --- ASCII PICKER LOGIC ---
        function initAsciiPicker() {
            const container = document.getElementById('ascii-picker-window');
            container.innerHTML = ''; // Clear previous content

            // ASCII_EMOJIS is defined in emojis.js
            if (typeof ASCII_EMOJIS !== 'undefined' && !Array.isArray(ASCII_EMOJIS)) {

                // Create Layout Containers
                const sidebar = document.createElement('div');
                sidebar.className = 'ascii-sidebar';

                const content = document.createElement('div');
                content.className = 'ascii-content';
                content.id = 'ascii-content-area';

                // APPEND ORDER: Content first, then Categories (Bottom)
                container.appendChild(content);
                container.appendChild(sidebar);

                // For ScrollSpy
                let isFirst = true;
                let autoHighlightEnabled = true; // NEW: Control flag

                // Helper to re-enable auto highlight on user interaction
                const enableAutoHighlight = () => { autoHighlightEnabled = true; };
                content.addEventListener('wheel', enableAutoHighlight);
                content.addEventListener('touchmove', enableAutoHighlight);
                content.addEventListener('keydown', enableAutoHighlight);
                content.addEventListener('mousedown', enableAutoHighlight);


                // Iterate Categories
                for (const [category, items] of Object.entries(ASCII_EMOJIS)) {
                    // ID Generation
                    const cleanName = category.replace(/\s+/g, '-').replace(/[&]/g, '').toLowerCase();
                    const sectionId = 'cat-' + cleanName;

                    // 1. Sidebar Item
                    const navItem = document.createElement('div');
                    navItem.className = 'ascii-sidebar-item';
                    if (isFirst) {
                        navItem.classList.add('active'); // Default active
                        isFirst = false;
                    }
                    navItem.innerText = category;
                    navItem.dataset.targetId = sectionId; // Store Link

                    navItem.onclick = (e) => {
                        e.stopPropagation(); // Prevent closing picker

                        // Disable auto-highlighting temporarily (until user scrolls manually)
                        autoHighlightEnabled = false;

                        // Manual activation
                        document.querySelectorAll('.ascii-sidebar-item').forEach(el => el.classList.remove('active'));
                        navItem.classList.add('active');

                        // Scroll to section INSTANTLY
                        const target = document.getElementById(sectionId);
                        if (target) {
                            target.scrollIntoView({ behavior: 'auto', block: 'start' });
                        }
                    };
                    sidebar.appendChild(navItem);

                    // 2. Content Section
                    const section = document.createElement('div');
                    section.className = 'ascii-category-section';
                    section.id = sectionId;

                    // Grid
                    const grid = document.createElement('div');
                    grid.className = 'ascii-grid';

                    // Items
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'ascii-option';
                        div.innerText = item.art;
                        if (item.name) div.title = item.name;
                        div.onclick = () => insertAscii(item.art);
                        grid.appendChild(div);
                    });

                    section.appendChild(grid);
                    content.appendChild(section);
                }

                // SCROLL SPY LOGIC: LINEAR INTERPOLATION
                content.addEventListener('scroll', () => {
                    if (!autoHighlightEnabled) return; // Skip if manually overridden

                    // Calculate scroll percentage (0 to 1)
                    // maxScroll is content height - client height
                    const maxScroll = content.scrollHeight - content.clientHeight;
                    if (maxScroll <= 0) return;

                    const scrollPos = content.scrollTop;
                    const percentage = scrollPos / maxScroll;

                    // Get all sidebar items
                    const sidebarItems = sidebar.querySelectorAll('.ascii-sidebar-item');
                    const totalItems = sidebarItems.length;

                    if (totalItems === 0) return;

                    // Map percentage to index range [0, totalItems - 1]
                    // We use Math.floor but clamp it to max index.
                    // We might want to round or floor. Math.floor(perc * count) maps 0..0.99 to 0..?

                    let activeIndex = Math.floor(percentage * totalItems);
                    // Clamp
                    if (activeIndex < 0) activeIndex = 0;
                    if (activeIndex >= totalItems) activeIndex = totalItems - 1;

                    // Update UI
                    sidebarItems.forEach((el, index) => {
                        if (index === activeIndex) {
                            el.classList.add('active');
                            el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        } else {
                            el.classList.remove('active');
                        }
                    });
                });

            } else if (Array.isArray(ASCII_EMOJIS)) {
                // ... Fallback omitted for brevity as it was unused ...
                // But preserving original fallback logic if needed
                ASCII_EMOJIS.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'ascii-option';
                    div.innerText = item.art;
                    div.onclick = () => insertAscii(item.art);
                    container.appendChild(div);
                });
            }
        }



        function toggleAsciiPicker() {
            const picker = document.getElementById('ascii-picker-window');
            picker.classList.toggle('open');
        }

        function insertAscii(text) {
            const input = document.getElementById('msg-input');
            input.value += text;
            input.focus();
            toggleAsciiPicker(); // Close after selection
        }

        // --- REACTION MODAL POPULATION ---
        function populateReactionModal() {
            const modal = document.getElementById('reaction-selection-modal');
            modal.innerHTML = '';
            FONT_REACTIONS.forEach(reaction => {
                const div = document.createElement('div');
                div.className = 'reaction-option';
                div.innerText = reaction;
                // Click handler is attached by openReactionTarget to pass the msgId
                modal.appendChild(div);
            });
        }

        // --- ROOM LOGIC ---

        async function cleanupEmptyChats() {
            if (!currentUsername) return;
            try {
                const roomsQuery = await db.collection('rooms')
                    .where('participants', 'array-contains', currentUsername)
                    // .where('type', '==', 'dm') // REMOVED: Apply to all types per user request
                    .get();

                const cleanupPromises = [];
                roomsQuery.forEach(doc => {
                    const roomData = doc.data();
                    // Don't clean up chats with ukiyo
                    if (roomData.participants.includes('ukiyo')) {
                        return;
                    }

                    const messagesRef = db.collection('rooms').doc(doc.id).collection('messages');
                    const promise = messagesRef.limit(1).get().then(messageSnap => {
                        if (messageSnap.empty) {
                            // This room is empty, remove user from it.
                            return db.collection('rooms').doc(doc.id).update({
                                participants: firebase.firestore.FieldValue.arrayRemove(currentUsername)
                            });
                        }
                    });
                    cleanupPromises.push(promise);
                });
                await Promise.all(cleanupPromises);
            } catch (e) { console.error("Error during empty chat cleanup:", e); }
        }

        function loadRooms() {
            if (unsubscribeRooms) unsubscribeRooms();

            const listEl = document.getElementById('room-list');
            listEl.innerHTML = '<div style="padding:10px;">Loading...</div>';

            unsubscribeRooms = db.collection('rooms')
                .where('participants', 'array-contains', currentUsername)
                .onSnapshot(snap => {
                    let rooms = [];
                    // 1. General
                    rooms.push({ id: 'general', name: 'All of KindleChat' });


                    snap.forEach(doc => {
                        let data = doc.data();
                        let r = {
                            id: doc.id,
                            type: data.type
                        };

                        // Smart Naming
                        if (data.type === 'dm') {
                            // Name the room after the OTHER person
                            const otherPerson = data.participants.find(p => p !== currentUsername);

                            if (otherPerson === 'ukiyo') {
                                r.name = "Ukiyo (Developer)";
                            } else {
                                // Fallback to "Me" if talking to self, otherwise other person's name
                                r.name = otherPerson || "Me";
                            }
                        } else {
                            // Group chat
                            r.name = data.name || "Untitled Group";
                        }

                        rooms.push(r);
                    });

                    // SIDEBAR VISIBILITY LOGIC
                    const sidebar = document.getElementById('sidebar');
                    const headerBtn = document.getElementById('header-new-chat-btn');

                    if (rooms.length <= 1) {
                        sidebar.style.display = 'none';
                        headerBtn.style.display = 'block'; // Show extra button
                        document.getElementById('app-layout').style.setProperty('--sidebar-width', '0px');
                    } else {
                        sidebar.style.display = 'flex';
                        headerBtn.style.display = 'none'; // Hide extra button
                        document.getElementById('app-layout').style.setProperty('--sidebar-width', '252px');
                    }

                    renderRoomList(rooms);
                });
        }

        function renderRoomList(rooms) {
            const listEl = document.getElementById('room-list');
            listEl.innerHTML = '';

            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = `room-item ${room.id === currentRoomId ? 'active' : ''}`;

                // Allow deletion of non-essential rooms
                let deleteHtml = '';
                // 'general' cannot be deleted.
                if (room.id !== 'general') {
                    deleteHtml = `<span class="del-room-btn" onclick="promptLeaveRoom('${room.id}', event)">×</span>`;
                }

                div.innerHTML = `<span>${room.name}</span>${deleteHtml}`;
                div.onclick = () => switchRoom(room.id, room.name);
                listEl.appendChild(div);
            });
        }

        async function switchRoom(id, name) {
            if (currentRoomId === id) return;



            currentRoomId = id;
            document.getElementById('room-title').innerText = name;

            // Update active state in sidebar
            document.querySelectorAll('.room-item').forEach(el => {
                el.classList.remove('active');
                // Use a check that finds the room by ID or name to robustly apply 'active' class
                const roomNameInEl = el.querySelector('span:first-child').innerText;
                if (roomNameInEl === name) el.classList.add('active');
            });

            // Clear previous messages to prevent ghosting
            document.getElementById('chat-history').innerHTML = '';

            // Update Pixel Button Visibility (Only show in 'general')
            const pixelBtn = document.getElementById('pixel-btn');
            if (pixelBtn) {
                // sys-btn uses display:flex by default
                pixelBtn.style.display = (id === 'general') ? 'flex' : 'none';
            }

            loadMessages();
        }

        // --- MESSAGE LOGIC (with pagination) ---

        async function handleScroll() {
            const historyEl = document.getElementById('chat-history');
            if (historyEl.scrollTop === 0 && !isLoadingMore && oldestMsgDoc) {
                isLoadingMore = true;
                const oldScrollHeight = historyEl.scrollHeight;

                try {
                    const querySnapshot = await db.collection('rooms').doc(currentRoomId).collection('messages')
                        .orderBy('timestamp', 'desc')
                        .startAfter(oldestMsgDoc)
                        .limit(25)
                        .get();

                    if (!querySnapshot.empty) {
                        oldestMsgDoc = querySnapshot.docs[querySnapshot.docs.length - 1]; // New oldest message

                        querySnapshot.docs.forEach(doc => {
                            renderMessage(doc.data(), doc.id, true); // Prepend messages
                        });

                        // Restore scroll position
                        historyEl.scrollTop = historyEl.scrollHeight - oldScrollHeight;
                    }
                } catch (e) {
                    console.error("Error loading more messages:", e);
                } finally {
                    isLoadingMore = false;
                }
            }
        }

        function loadMessages() {
            if (unsubscribeMsg) unsubscribeMsg();
            oldestMsgDoc = null;
            isLoadingMore = false;

            const history = document.getElementById('chat-history');

            // Only show connecting if empty to avoid flicker
            if (history.children.length === 0) {
                history.innerHTML = '<div style="text-align:center; padding:20px">Connecting...</div>';
            }

            unsubscribeMsg = db.collection('rooms').doc(currentRoomId).collection('messages')
                .orderBy('timestamp', 'asc')
                .limitToLast(50)
                .onSnapshot(snapshot => {
                    // Remove loading indicator if present
                    if (history.innerHTML.includes('Connecting...')) {
                        history.innerHTML = '';
                    }

                    if (snapshot.empty && history.innerHTML === '') {
                        history.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No messages yet.</div>';
                    }

                    const isScrolledToBottom = history.scrollHeight - history.clientHeight <= history.scrollTop + 100;

                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            renderMessage(change.doc.data(), change.doc.id);
                        }
                    });

                    if (isScrolledToBottom) {
                        history.scrollTop = history.scrollHeight;
                    }

                    if (snapshot.docs.length > 0) {
                        oldestMsgDoc = snapshot.docs[0];
                    }

                }, error => {
                    console.error("Error loading messages:", error);
                    history.innerHTML = '<div style="text-align:center; padding:20px;">Error connecting.</div>';
                });
        }


        let profanityRegex = null;
        function getProfanityRegex() {
            if (profanityRegex) return profanityRegex;
            if (typeof BAD_WORDS === 'undefined') return null;

            // Create regex once from the BAD_WORDS array
            const escaped = BAD_WORDS.filter(w => w).map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
            profanityRegex = new RegExp(`\\b(${escaped.join('|')})\\b`, 'gi');
            return profanityRegex;
        }

        function censorText(text) {
            const regex = getProfanityRegex();
            if (!regex) return text;
            return text.replace(regex, (match) => '*'.repeat(match.length));
        }

        function linkify(inputText) {
            let replacedText, replacePattern1, replacePattern2;

            // URLs starting with http://, https://, or ftp://
            replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

            // URLs starting with "www." (without // before it)
            replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

            return replacedText;
        }

        function renderMessage(msg, msgId, prepend = false) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');

            const isSelf = currentUser && (msg.user === currentUsername);
            div.className = `msg ${isSelf ? 'self' : 'other'}`;
            div.dataset.msgId = msgId;

            let nameHtml = isSelf ? '<span>You</span>' : `<span style="font-weight:bold;">${msg.user}</span>`;

            // Developer Badge in Name
            if (msg.user === 'ukiyo') {
                const devBadge = `<span class="dev-tag">DEV</span>`;
                nameHtml = isSelf ? `<span>${devBadge}You</span>` : `<span>${devBadge}<span style="font-weight:bold;">${msg.user}</span></span>`;
            } else if (supporterUsers.has(msg.user)) {
                // Supporter Crown (SVG for Kindle compatibility)
                const crownSvg = `<svg class="supporter-crown" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 4L5 18H19L22 4L15 11L12 4L9 11L2 4Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>`;
                const crown = `<a href="http://link.rekindle.ink/donate" target="_blank" style="text-decoration:none;" title="Supporter">${crownSvg}</a>`;
                nameHtml = isSelf ? `<span>${crown}You</span>` : `<span>${crown}<span style="font-weight:bold;">${msg.user}</span></span>`;
            }

            let timeStr = "";
            if (msg.timestamp) {
                const date = msg.timestamp.toDate();
                timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            let bubbleContent = '';
            let isSpecialMessage = false;
            let messageText = msg.text || '';

            // Censor Profanity Logic
            const censorProfanity = localStorage.getItem('rekindle_censor_profanity');
            if (messageText && (censorProfanity === null || censorProfanity === 'true')) {
                messageText = censorText(messageText);
            }

            // ASCII Art detection: Check for newlines (must have multiple lines)
            const isAscii = messageText.includes('\n');

            if (isAscii) {
                bubbleContent = `<div class="msg-bubble ascii">${escapeHtml(messageText)}</div>`;
                isSpecialMessage = true;
            } else if (msg.is_reaction_image) {
                // Legacy support for old reactions, though menu is gone
                bubbleContent = `<div class="msg-bubble ascii">${messageText}</div>`;
                isSpecialMessage = true;
            } else if (msg.is_game_link) {
                // Render Game Link
                const [gameType, gameId] = msg.text.split(':');
                const gameName = gameType.charAt(0).toUpperCase() + gameType.slice(1);

                // DETERMINE IF USER IS THE STARTER (AFFECTS CLICKABILITY)
                const isStarter = msg.user === currentUsername;

                // Determine display message based on game type
                let displayMsg = '';
                if (gameType === 'words') {
                    displayMsg = `
                        ${msg.user} started a Scrabble Game
                        ${isStarter ? 'Wait for a player to join!' : 'Click to Join!'}
                    `.trim();
                } else {
                    // Default/Fallback
                    displayMsg = `
                        New ${gameName} Game Ready! 
                        Click to Join!
                    `.trim();
                }

                // BUILD THE GAME LINK CONTAINER
                const linkDestination = isStarter && gameType === 'words' ? '#' : `${gameType}.html?gameId=${gameId}`;
                const containerClass = isStarter && gameType === 'words' ? 'game-link-container disabled' : 'game-link-container';

                // CRITICAL FIX: Use the special bubble class to remove standard padding/border
                bubbleContent = `
                    <div class="msg-bubble game-link-bubble">
                        <div class="${containerClass}">
                             <a href="${linkDestination}" class="game-link" ${isStarter && gameType === 'words' ? 'onclick="event.preventDefault()"' : ''}>
                                ${displayMsg}
                            </a>
                        </div>
                    </div>
                `;
                isSpecialMessage = true;
            } else if (msg.is_pixel_art) {
                // Pixel Art Message
                bubbleContent = `
                    <div class="msg-bubble" style="padding: 5px; background: white;">
                         <div style="font-weight:bold; margin-bottom:5px; font-size:0.8rem;">Pixel Art</div>
                         <img src="${msg.pixel_art}" style="
                            image-rendering: -webkit-optimize-contrast;
                            image-rendering: crisp-edges;
                            image-rendering: pixelated; 
                            width: 128px; 
                            height: 128px; 
                            border: 2px solid black; 
                            display:block;
                         ">
                         ${messageText ? `<div style="margin-top:5px; font-size:0.9rem;">${escapeHtml(messageText)}</div>` : ''}
                    </div>
                `;
                isSpecialMessage = true;
            } else {
                // Regular Text Message
                bubbleContent = `<div class="msg-bubble">${linkify(escapeHtml(messageText))}</div>`;
            }

            // --- THEME INJECTION ---
            if (msg.user === 'ukiyo') {
                // Inject developer class
                bubbleContent = bubbleContent.replace('class="msg-bubble', 'class="msg-bubble developer');
            } else if (supporterUsers.has(msg.user)) {
                // Inject supporter class
                bubbleContent = bubbleContent.replace('class="msg-bubble', 'class="msg-bubble supporter');
            }

            // MODIFIED: Reaction Button (Opens Modal)
            const reactButton = (currentUser && (!isSpecialMessage || msg.is_pixel_art))
                ? `<div class="react-btn" onclick="openReactionTarget('${msgId}', this, event)">+</div>`
                : '';

            // Build final HTML structure
            // Wrap bubble and button in a flex container for horizontal alignment
            div.innerHTML = `
                <div class="msg-meta">
                    ${nameHtml}
                    <span>${timeStr}</span>
                </div>
                <div style="display:flex; align-items:center; gap: 5px; min-width: 0;">
                    <!-- Button on left for self, on right for other -->
                    ${isSelf ? reactButton : ''}
                    ${bubbleContent}
                    ${isSelf ? '' : reactButton}
                </div>
            `;

            // Render Reactions if present
            if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                const reactionBar = document.createElement('div');
                reactionBar.className = isSelf ? 'reaction-bar self-bar' : 'reaction-bar other-bar'; // Added classes for potential styling

                const groupedReactions = {};
                for (const userUID in msg.reactions) {
                    const reaction = msg.reactions[userUID];
                    if (!groupedReactions[reaction]) groupedReactions[reaction] = [];
                    groupedReactions[reaction].push(userUID);
                }

                for (const reaction in groupedReactions) {
                    const count = groupedReactions[reaction].length;

                    // if (!FONT_REACTIONS.includes(reaction)) continue; 

                    const el = document.createElement('div');
                    el.className = 'reaction-item';
                    el.title = groupedReactions[reaction].map(uid => uid.split('@')[0]).join(', '); // Show usernames
                    el.innerHTML = `${reaction} ${count}`;

                    // Toggle functionality: clicking removes your reaction
                    el.onclick = () => toggleUserReaction(msgId, reaction);

                    reactionBar.appendChild(el);
                }
                if (reactionBar.children.length > 0) div.appendChild(reactionBar);
            }

            const existing = history.querySelector(`.msg[data-msg-id="${msgId}"]`);
            if (existing) {
                history.replaceChild(div, existing);
            } else if (prepend) {
                history.prepend(div);
            } else {
                history.appendChild(div);
            }
        }

        async function sendMessage() {
            const inputEl = document.getElementById('msg-input');
            const text = inputEl.value.trim();

            if (!text) return;
            if (!currentUser) return;

            inputEl.value = '';

            const messageData = {
                user: currentUsername,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                text: text // Text can include newlines for ASCII art
            };

            const roomRef = db.collection('rooms').doc(currentRoomId);

            try {
                // Add the message first
                await roomRef.collection('messages').add(messageData);

                // Then, check if we need to "activate" the room for other users
                const roomDoc = await roomRef.get();
                if (roomDoc.exists) {
                    const roomData = roomDoc.data();
                    // If it's a DM that hasn't been activated yet
                    if (roomData.type === 'dm' && roomData.intendedParticipants && roomData.participants.length < roomData.intendedParticipants.length) {
                        // Add all intended participants to the main participants list
                        await roomRef.update({
                            participants: roomData.intendedParticipants
                        });
                    }
                }

            } catch (e) {
                console.error("Error sending message:", e);
            }
        }

        // --- REACTION FUNCTIONS ---

        // Global tracker for currently open reaction menu
        let activeReactionMsgId = null;

        function openReactionTarget(msgId, btnElement, event) {
            event.stopPropagation();
            if (!currentUser) return;

            const modal = document.getElementById('reaction-selection-modal');

            // TOGGLE LOGIC: If clicking the same button while open, close it.
            if (modal.style.display === 'flex' && activeReactionMsgId === msgId) {
                closeReactionModal();
                return;
            }

            activeReactionMsgId = msgId;

            const rect = btnElement.getBoundingClientRect();

            // Position the modal near the button
            modal.style.top = `${rect.top}px`;

            // Adjust X position based on whether it's a self or other message
            const isSelf = btnElement.closest('.msg.self');

            // If self (button on left), position modal to the right of the button
            if (isSelf) {
                modal.style.left = `${rect.right + 5}px`;
                modal.style.right = 'auto';
            } else {
                // If other (button on right), position modal to the left of the button
                // Width is determined by content, calculate position dynamically 
                // Using left:auto and adjusting right position relative to the main chat-view width might be safer
                modal.style.left = `${rect.left - 130}px`; // Estimate width - adjustment
                modal.style.right = 'auto';
            }

            // Bind selection handlers to this message ID
            modal.querySelectorAll('.reaction-option').forEach(option => {
                option.onclick = () => selectReaction(msgId, option.innerText);
            });

            modal.style.display = 'flex';
        }

        function closeReactionModal(event) {
            const modal = document.getElementById('reaction-selection-modal');
            // If event is defined and click is outside the modal, hide it
            if (event && !modal.contains(event.target) && modal.style.display === 'flex') {
                modal.style.display = 'none';
                activeReactionMsgId = null;
            } else if (!event) {
                // Manual close trigger
                modal.style.display = 'none';
                activeReactionMsgId = null;
            }
        }

        async function selectReaction(msgId, reaction) {
            await toggleUserReaction(msgId, reaction);
            closeReactionModal();
        }

        async function toggleUserReaction(msgId, reaction) {
            if (!currentUser) return;

            const messageRef = db.collection('rooms').doc(currentRoomId).collection('messages').doc(msgId);
            const userUID = currentUser.uid;

            try {
                const doc = await messageRef.get();
                if (!doc.exists) return;

                let reactions = doc.data().reactions || {};

                const userReaction = reactions[userUID];

                if (userReaction === reaction) {
                    // REMOVE: User clicks the reaction they already left
                    const updates = { [`reactions.${userUID}`]: firebase.firestore.FieldValue.delete() };
                    await messageRef.update(updates);
                } else {
                    // ADD/CHANGE: User clicks a *different* reaction (or the default +1)
                    // We must update the entire 'reactions' field due to Firestore's limitation on updating sub-fields 
                    // within a map if the path involves an ID. We only pass the map itself.
                    reactions[userUID] = reaction;
                    await messageRef.update({ reactions: reactions });
                }
            } catch (e) {
                console.error("Error toggling reaction:", e);
            }
        }

        // --- MODAL LOGIC ---
        function openCreateModal() {
            if (!currentUser) return showModal("Please log in first.");
            document.getElementById('create-modal-content').style.display = 'block';
            document.getElementById('delete-modal-content').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal(id = 'modal-overlay') {
            document.getElementById(id).style.display = 'none';
        }

        // --- NEW: SEND DIRECT MESSAGE LOGIC ---
        async function sendDirectMessage() {
            const usernameInput = document.getElementById('dm-username').value.trim();
            const messageInput = document.getElementById('dm-message').value.trim();

            if (!usernameInput) return showModal("Please enter a username.");
            if (!messageInput) return showModal("Please enter a message.");

            closeModal(); // Close modal immediately

            const otherUser = usernameInput;
            const participants = [currentUsername, otherUser].sort(); // Sort for consistent querying if possible, though we rely on array-contains

            try {
                // 1. Check if a DM room already exists
                // Note: Firestore array-contains only allows one value. 
                // To find an exact match for 2 users, we query for current user's rooms and filter client-side.
                const roomsSnap = await db.collection('rooms')
                    .where('participants', 'array-contains', currentUsername)
                    .where('type', '==', 'dm')
                    .get();

                let existingRoomId = null;

                const roomsWithOther = roomsSnap.docs.filter(doc => {
                    const data = doc.data();
                    // Ensure it has exactly these 2 participants
                    return data.participants.length === 2 && data.participants.includes(otherPerson);
                });

                if (roomsWithOther.length > 0) {
                    existingRoomId = roomsWithOther[0].id;
                }

                if (existingRoomId) {
                    switchRoom(existingRoomId, otherPerson);
                } else {
                    // Create new DM room
                    const newRoomRef = await db.collection('rooms').add({
                        type: 'dm',
                        participants: [currentUsername], // Only start with me
                        intendedParticipants: participants, // Add the other person later when msg sent
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Add initial message
                    await newRoomRef.collection('messages').add({
                        user: currentUsername,
                        text: messageInput,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Activate room for both
                    await newRoomRef.update({
                        participants: participants
                    });

                    // Reload rooms and switch
                    // loadRooms(); // loadRooms is onSnapshot, should update auto
                    // But we want to switch immediately
                    switchRoom(newRoomRef.id, otherPerson);
                }

            } catch (e) {
                console.error("Error sending DM:", e);
                showModal("Error starting chat.");
            }
        }

        // --- SUPPORTER LOGIC ---
        async function fetchSupporters() {
            try {
                const doc = await db.collection('config').doc('supporters').get();
                if (doc.exists && doc.data().usernames) {
                    supporterUsers = new Set(doc.data().usernames);
                }
            } catch (e) {
                console.error("Error loading supporters:", e);
            }
        }


        // --- LEAVE ROOM ---
        function promptLeaveRoom(roomId, event) {
            event.stopPropagation();
            roomToDeleteId = roomId;
            document.getElementById('create-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        async function confirmLeaveRoom() {
            if (!roomToDeleteId) return;

            try {
                await db.collection('rooms').doc(roomToDeleteId).update({
                    participants: firebase.firestore.FieldValue.arrayRemove(currentUsername)
                });

                if (currentRoomId === roomToDeleteId) {
                    switchRoom('general', 'All of KindleChat');
                }

                closeModal();
            } catch (e) {
                // Replaced with custom modal in larger app context
                console.error("Error leaving chat:", e);
                closeModal();
            }
        }

        // Helper to handle escaping for text display within message bubbles
        function escapeHtml(text) {
            if (!text) return "";
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

    </script>

    <script>
        // Helper to sanitize background image URLs from localStorage
        function sanitizeBackgroundImage(imageString) {
            if (!imageString) return '';
            if (imageString.startsWith('url("data:image/png;base64,')) {
                return imageString;
            }
            if (imageString.startsWith('url("') && imageString.endsWith('")')) {
                const url = imageString.substring(5, imageString.length - 2);
                if ((url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) && !url.includes('javascript:')) {
                    return imageString;
                }
            }
            return '';
        }


        function toggleFullScreen() {
            document.querySelector('.window').classList.toggle('fullscreen');
        }

        loadWallpaper();

        function loadWallpaper() {
            const wallpaperImg = localStorage.getItem('rekindle_bg_image');
            const wallpaperSize = localStorage.getItem('rekindle_bg_size');
            if (wallpaperImg) {
                document.body.style.backgroundImage = wallpaperImg;
            }
            if (wallpaperSize) {
                document.body.style.backgroundSize = wallpaperSize;
            }
        }
    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>
    <!-- STANDARD MODAL POPUP -->
    <div id="modal-overlay">
        <div class="modal-box">
            <div id="modal-message" class="modal-text"></div>
            <div id="modal-btns" class="modal-btns"></div>
        </div>
    </div>
</body>

</html>