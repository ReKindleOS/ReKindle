<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KindleChat</title>
    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            /* Background managed by settings */

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 900px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        /* CLOSE BUTTON */
        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            box-shadow: none;
        }

        /* CONTROLS (Right side of Title Bar) */
        .title-controls {
            position: absolute;
            right: 10px;
            z-index: 2;
            display: flex;
            align-items: center;
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
            flex-shrink: 0;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* Icon State Toggles */
        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        /* MAIN LAYOUT */
        #app-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            --sidebar-width: 252px;
            /* Default: 250px width + 2px border */
        }

        /* SIDEBAR */
        #sidebar {
            width: 250px;
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eee;
        }

        #room-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .room-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .room-item:hover {
            background: #f0f0f0;
        }

        .room-item.active {
            background: black;
            color: white;
            font-weight: bold;
        }

        .room-top {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .room-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
            font-weight: normal;
        }

        .room-item.active .room-time {
            color: #ccc;
        }

        .sidebar-separator {
            height: 1px;
            background: #eee;
            margin: 5px 15px;
            border-bottom: 1px solid #ccc;
        }

        /* DELETE BUTTON IN LIST */
        .del-room-btn {
            font-weight: bold;
            color: #999;
            padding: 5px 10px;
            cursor: pointer;
            font-family: sans-serif;
            font-size: 1.2rem;
            line-height: 0.8;
        }

        .del-room-btn:hover {
            color: black;
        }

        .room-item.active .del-room-btn {
            color: #ccc;
        }

        .room-item.active .del-room-btn:hover {
            color: white;
        }

        /* CHAT VIEW */
        #chat-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
            min-width: 0;
            max-width: calc(100% - var(--sidebar-width));
        }

        /* ROOM HEADER */
        .room-header {
            border-bottom: 2px solid black;
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #eee;
            font-size: 0.9rem;
            flex-shrink: 0;
            position: relative;
        }

        #header-new-chat-btn {
            position: absolute;
            left: 10px;
            display: none;
            /* Default hidden, overrides sys-btn flex */
            padding: 2px 8px;
            /* Compact */
        }

        .current-room {
            font-weight: bold;
            text-transform: uppercase;
        }

        /* CHAT HISTORY */
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            display: flex;
            flex-direction: column;
            /* Allow wrapping, max-width controls the break point */
            max-width: 85%;
            position: relative;
            max-width: 85%;
            position: relative;
            min-width: 0;
            /* Allow shrinking */
        }

        .msg.self {
            align-self: flex-end;
            align-items: flex-end;
        }

        .msg.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .msg-meta {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 2px;
            display: flex;
        }

        /* Manual spacing for Kindle browser */
        .msg-meta span {
            margin-right: 8px;
        }

        .msg-meta span:last-child {
            margin-right: 0;
        }

        .msg-bubble {
            border: 2px solid black;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            box-shadow: 2px 2px 0px #ccc;
            word-wrap: break-word;
            /* Legacy */
            word-break: break-word;
            /* Modern equivalent for long words */
            overflow-wrap: break-word;
            /* Standard */
            min-width: 0;
            /* Flex shrink fix */
            width: fit-content;
            /* Ensure it wraps tightly but respects max-width */
            position: relative;
            /* FIX: Crucial for allowing the bubble to shrink-wrap its content width */
            display: inline-block;
            max-width: 100%;
        }

        .msg-bubble a {
            color: inherit;
            text-decoration: underline;
            word-break: break-all;
        }

        .msg.self .msg-bubble {
            background: black;
            color: white;
            border-color: black;
            box-shadow: 2px 2px 0px #666;
        }

        /* ASCII art messages use a fixed-width font */
        .msg-bubble.ascii {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            /* Preserve whitespace/newlines */
            font-size: 0.8rem;
        }

        /* --- REACTIONS (Font only) --- */
        .reaction-bar {
            margin-top: 5px;
            display: flex;
            gap: 5px;
            font-size: 1rem;
            padding: 2px 0;
            flex-wrap: wrap;
        }

        .reaction-item {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 2px 6px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            line-height: 1;
            font-weight: bold;
        }

        .msg.self .reaction-item {
            background: #333;
            color: white;
            border-color: #555;
        }

        /* MODIFIED: CONSTANT PLUS BUTTON (REACTION TRIGGER) */
        .react-btn {
            position: absolute;
            top: 50%;
            /* Center vertically with message */
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 1px solid black;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            text-align: center;
            line-height: 18px;
            font-size: 0.9rem;
            box-shadow: 1px 1px 0 #999;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0.5;
            /* Initial opacity */
            transition: opacity 0.2s;
        }

        .react-btn:hover {
            opacity: 1.0;
        }

        /* Position for messages sent by others (button on right) */
        .msg.other .react-btn {
            right: -25px;
            left: auto;
        }

        /* Position for self messages (button on left) */
        .msg.self .react-btn {
            left: -25px;
            right: auto;
        }

        /* Hide the button if not logged in or a special message */
        .react-btn.hidden {
            display: none;
        }

        /* Game Link CONTAINER - CRITICAL ADJUSTMENTS HERE */
        .game-link-container {
            /* FIX: Make it the bubble and remove its top margin, use minimal padding */
            border: 2px solid black;
            padding: 5px;
            background: #eee;
            margin-top: 0;
            /* Remove redundant margin */
            text-align: center;
            /* FIX: Set display to a table-related value so it shrinks tightly to content */
            display: table;
            min-width: 100px;
            max-width: 100%;
            box-sizing: border-box;
            box-shadow: 2px 2px 0 #ccc;
            /* Inherit original bubble shadow */
        }

        /* Override bubble style for game link messages */
        .msg-bubble.game-link-bubble {
            padding: 0;
            border: none;
            box-shadow: none;
            background: transparent;
        }

        .game-link-container.disabled {
            opacity: 0.6;
            cursor: default;
        }

        /* Game Link INNER TEXT/BUTTON */
        .game-link {
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            color: black;
            display: block !important;
            font-size: 0.8rem;
            line-height: 1.3;
            word-break: break-word;
        }


        /* INPUT AREA */
        .input-area {
            border-top: 2px solid black;
            padding: 10px;
            display: flex;
            gap: 10px;
            background: #eee;
            flex-shrink: 0;
            position: relative;
        }

        textarea {
            flex-grow: 1;
            border: 2px solid black;
            padding: 10px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            height: 70px;
            /* Increased height for multi-line support */
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 5px 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sys-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        /* --- NEW: ASCII ART PICKER STYLES --- */
        .ascii-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 10px;
            right: 10px;
            /* NEW: Anchor to right for shrinking */
            width: auto;
            /* NEW: Auto width */
            max-width: 600px;
            /* Cap width */
            height: 400px;
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            z-index: 20;
            /* Layout Mode: Flex Column (Content top, Categories bottom) */
            flex-direction: column;
            padding: 0;
            /* Remove padding from main container */
            gap: 0;
            overflow: hidden;
            /* Inner containers handle scroll */
        }

        .ascii-picker.open {
            display: flex;
        }

        /* SIDEBAR (Now Bottom Bar) */
        .ascii-sidebar {
            width: 100%;
            height: auto;
            /* Allow it to take necessary height */
            background: #eee;
            border-top: 2px solid black;
            border-right: none;
            overflow-x: auto;
            /* Horizontal scroll */
            overflow-y: hidden;
            /* No vertical scroll */
            flex-shrink: 0;
            display: flex;
            flex-direction: row;
            /* Horizontal items */
        }

        .ascii-sidebar-item {
            padding: 10px;
            border-right: 1px solid #ccc;
            /* Separator between horizontal items */
            border-bottom: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            /* Prevent text wrapping */
            flex-shrink: 0;
        }

        .ascii-sidebar-item:last-child {
            border-right: none;
        }

        .ascii-sidebar-item:hover,
        .ascii-sidebar-item.active {
            background: black;
            color: white;
        }

        /* CONTENT (Top) */
        .ascii-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            /* gap: 15px;  <-- Kindle doesn't support flex gap */
        }

        /* CATEGORY SECTION */
        .ascii-category-section {
            scroll-margin-top: 10px;
            margin-bottom: 25px;
            /* Manual gap */
            border-bottom: 1px dashed #ccc;
            /* Extra visual separator */
            padding-bottom: 15px;
        }


        /* GRID for Emojis */
        .ascii-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .ascii-option {
            border: 1px solid #ccc;
            padding: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            text-align: center;
            background: #fafafa;
            min-width: 60px;
            flex-grow: 1;
        }

        .ascii-option:hover {
            background: black;
            color: white;
            border-color: black;
        }

        /* NEW: REACTION SELECTION MODAL */
        #reaction-selection-modal {
            position: absolute;
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            padding: 5px;
            z-index: 10;
            display: none;
            flex-direction: column;
            gap: 5px;
        }

        .reaction-option {
            padding: 5px 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            background: #eee;
            border: 1px solid #ccc;
        }

        .reaction-option:hover {
            background: black;
            color: white;
        }


        /* MODAL */
        #modal-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 2px solid black;
            box-sizing: border-box;
        }

        /* LOCKED INPUT (Guest) */
        #locked-input {
            border-top: 2px solid black;
            padding: 15px;
            background: #ddd;
            text-align: center;
            font-style: italic;
            color: #555;
            font-size: 0.9rem;
            display: none;
        }

        /* GUEST OVERLAY (New) */
        #guest-overlay {
            position: absolute;
            top: 35px;
            /* Below title bar */
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 50;
            display: none;
            /* Default hidden */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        #guest-overlay h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }

        /* --- USER THEMES --- */
        .msg-bubble.developer {
            border: 3px double black !important;
            box-shadow: 4px 4px 0px #000;
        }

        .msg.self .msg-bubble.developer {
            border-color: white !important;
            /* Ensure visibility on black background? No, self is black bg. */
            /* If bg is black, double border needs color. */
            box-shadow: 4px 4px 0px #666;
            background-image: none;
        }

        /* Developer Tag */
        .dev-tag {
            font-size: 0.7rem;
            background: black;
            color: white;
            padding: 1px 4px;
            border-radius: 4px;
            margin-right: 5px;
            vertical-align: middle;
            font-weight: bold;
        }

        .msg-bubble.supporter {
            background: black !important;
            color: white !important;
            border: 2px solid black !important;
            /* Matches bg but defines size */
            box-shadow: 4px 4px 0px #999;
            /* Grey shadow for contrast */
        }

        /* Ensure links in supporter bubbles are visible */
        .msg-bubble.supporter a {
            color: white;
            text-decoration: underline;
        }

        .supporter-crown {
            width: 14px;
            height: 14px;
            display: inline-block;
            vertical-align: middle;
            fill: black;
            /* Default */
            margin-right: 4px;
        }

        .msg.self .supporter-crown {
            fill: black;
        }

        /* STANDARD MODAL SYSTEM */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            font-family: "Geneva", "Verdana", sans-serif;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            padding: 20px;
            box-shadow: 6px 6px 0 black;
            max-width: 300px;
            width: 80%;
            text-align: center;
        }

        .modal-text {
            margin-bottom: 20px;
            font-weight: bold;
            line-height: 1.4;
            color: black;
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            background: white;
            border: 2px solid black;
            padding: 6px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-family: inherit;
        }

        .modal-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="emojis.js"></script>

    <script src="bad_words.js?v=2"></script>
    <script src="time.js"></script>
    <script src="theme.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text">KindleChat</span>
            <div class="title-controls">
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1" />
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="app-layout">

            <div id="sidebar">
                <div class="sidebar-header">
                    <span style="font-weight:bold;">Chats</span>
                    <button class="sys-btn" onclick="openCreateModal()">+</button>
                </div>
                <div id="room-list">
                </div>
            </div>

            <div id="chat-view">
                <div class="room-header">
                    <!-- NEW: Conditional New Chat Button -->
                    <button id="header-new-chat-btn" class="sys-btn header-new-chat-btn"
                        onclick="openCreateModal()">+</button>
                    <span class="current-room" id="room-title">All of KindleChat</span>
                </div>

                <div id="chat-history">
                </div>

                <div class="input-area" id="active-input">
                    <!-- NEW ASCII PICKER AND BUTTON -->
                    <div id="ascii-picker-window" class="ascii-picker">
                        <!-- Items injected by JS -->
                    </div>

                    <button id="pixel-btn" class="sys-btn" onclick="window.location.href='pixel?source=kindlechat'"
                        style="font-size:1.2rem; padding: 0 10px;" title="Open Pixel">✎</button>

                    <button class="sys-btn" onclick="toggleAsciiPicker()"
                        style="font-size:1.2rem; padding: 0 10px;">☺</button>

                    <textarea id="msg-input" placeholder="Type a message..." rows="3"></textarea>
                    <button class="sys-btn" id="send-btn" onclick="sendMessage()" style="height: 100%;">Send</button>
                </div>

                <div id="locked-input">
                    Log in on the home screen to send messages.
                </div>
            </div>
        </div>

        <!-- GUEST OVERLAY HTML -->
        <div id="guest-overlay">
            <h2>You need to be logged in to use KindleChat</h2>
            <br>
            <button class="sys-btn" onclick="window.location.href='index?login=true'">Log In</button>
        </div>
    </div>

    <!-- SHARED MODAL OVERLAY -->
    <div id="modal-overlay">

        <!-- SEND DM MODAL CONTENT -->
        <div class="modal-box" id="create-modal-content">
            <h3>Send Message</h3>
            <div
                style="display: flex; align-items: stretch; width: 100%; margin: 10px 0; gap: 5px; box-sizing: border-box;">
                <input type="text" id="dm-username" class="modal-input" placeholder="Username (e.g. bob)"
                    style="flex-grow: 1; margin: 0; width: auto; font-family: inherit; font-size: 1rem; box-sizing: border-box;">
                <button
                    onclick="document.getElementById('dm-username').value='ukiyo'; document.getElementById('dm-message').focus();"
                    style="padding: 8px; background: white; border: 2px solid black; cursor: pointer; font-family: inherit; font-size: 1rem; font-weight: normal; color: black; box-sizing: border-box;">Ukiyo</button>
            </div>
            <textarea id="dm-message" class="modal-input" placeholder="Message..."
                style="height:60px; resize:none;"></textarea>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="sendDirectMessage()">Send</button>
                <button class="sys-btn" onclick="closeModal('modal-overlay')">Cancel</button>
            </div>
        </div>

        <!-- DELETE MODAL CONTENT -->
        <div class="modal-box" id="delete-modal-content" style="display:none;">
            <h3>Leave Chat?</h3>
            <p style="margin: 15px 0;">Remove this chat from your list?</p>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="confirmLeaveRoom()">Yes</button>
                <button class="sys-btn" onclick="closeModal('modal-overlay')">No</button>
            </div>
        </div>

        <!-- GENERIC MESSAGE MODAL -->
        <div class="modal-box" id="generic-modal-content" style="display:none;">
            <div id="modal-message" class="modal-text"></div>
            <div id="modal-btns" class="modal-btns"></div>
        </div>

    </div>

    <!-- NEW: REACTION SELECTION MODAL -->
    <div id="reaction-selection-modal" onclick="closeReactionModal(event)">
        <!-- Options injected by JS -->
    </div>

    <script>
        // --- GLOBAL ERROR CATCHER ---
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            console.error('Chat Error: ' + msg + ' at ' + url + ':' + lineNo + ':' + columnNo);
            return false;
        };

        // --- FIREBASE CONFIG ---
        var firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        // --- CONFIGURATION ---
        function showModal(msg, isConfirm, callback) {
            var overlay = document.getElementById('modal-overlay');
            var messageEl = document.getElementById('modal-message');
            var btnsEl = document.getElementById('modal-btns');

            // Show generic content, hide Others
            document.getElementById('create-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'none';
            document.getElementById('generic-modal-content').style.display = 'block';

            messageEl.textContent = msg;
            if (isConfirm) {
                btnsEl.innerHTML = '<button class="modal-btn" id="modal-cancel">Cancel</button><button class="modal-btn" id="modal-ok">OK</button>';
                document.getElementById('modal-cancel').onclick = function () { overlay.style.display = 'none'; if (callback) callback(false); };
                document.getElementById('modal-ok').onclick = function () { overlay.style.display = 'none'; if (callback) callback(true); };
            } else {
                btnsEl.innerHTML = '<button class="modal-btn" onclick="hideModal()">OK</button>';
            }
            overlay.style.display = 'flex';
        }
        function hideModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        // Fix Safari CORS errors and connection hangs
        if (db.settings) {
            db.settings({
                experimentalForceLongPolling: true,
                merge: true
            });
        }

        var auth = firebase.auth();

        // --- STATE ---
        var currentUser = null;
        var currentUsername = "";
        var currentRoomId = 'general';
        var roomToDeleteId = null;
        var unsubscribeMsg = null;
        var unsubscribeRooms = null;
        var unsubscribeGeneral = null;
        var oldestMsgDoc = null; // For pagination
        var isLoadingMore = false; // For pagination
        var supporterUsers = {}; // Store supporter usernames as object for ES5 compatibility
        var userRooms = [];
        var generalRoom = { id: 'general', name: 'All of KindleChat', lastMessageAt: null };

        // --- Reaction Keys (Simplified to match the new constant button action) ---
        var FONT_REACTIONS = ['+1', '-1', '♥', '?', '!', 'XD']; // List of available reactions

        // --- ASCII ART DATA ---
        // Moved to emojis.js (ASCII_EMOJIS)

        // --- INIT ---
        window.onload = function () {
            loadWallpaper();
            initAsciiPicker(); // Initialize the ASCII picker
            fetchSupporters(); // Load supporters list

            // Check Auth
            auth.onAuthStateChanged(function (user) {
                if (user) {
                    currentUser = user;
                    currentUsername = (user.email || user.uid).split('@')[0];

                    document.getElementById('active-input').style.display = 'flex';
                    document.getElementById('locked-input').style.display = 'none';

                    // Run cleanup in background (non-blocking)
                    cleanupEmptyChats();
                    loadRooms();
                } else {
                    currentUser = null;
                    document.getElementById('app-layout').style.display = 'none';
                    document.getElementById('guest-overlay').style.display = 'flex';
                }
                loadMessages();
            });

            // Enter key
            document.getElementById('msg-input').addEventListener("keypress", function (e) {
                // Shift+Enter should allow newline (for ASCII art)
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Populate the reaction modal once
            populateReactionModal();

            // Click outside close for ASCII picker
            document.addEventListener('click', function (event) {
                var picker = document.getElementById('ascii-picker-window');
                var btn = document.querySelector('.sys-btn[onclick="toggleAsciiPicker()"]');
                if (picker.classList.contains('open') &&
                    !picker.contains(event.target) &&
                    event.target !== btn) {
                    picker.classList.remove('open');
                }
            });

            // Scroll to top to load more messages
            document.getElementById('chat-history').addEventListener('scroll', handleScroll);
        };


        // --- ASCII PICKER LOGIC ---
        function initAsciiPicker() {
            var container = document.getElementById('ascii-picker-window');
            container.innerHTML = ''; // Clear previous content

            // ASCII_EMOJIS is defined in emojis.js
            if (typeof ASCII_EMOJIS !== 'undefined' && !Array.isArray(ASCII_EMOJIS)) {

                // Create Layout Containers
                var sidebar = document.createElement('div');
                sidebar.className = 'ascii-sidebar';

                var content = document.createElement('div');
                content.className = 'ascii-content';
                content.id = 'ascii-content-area';

                // APPEND ORDER: Content first, then Categories (Bottom)
                container.appendChild(content);
                container.appendChild(sidebar);

                // For ScrollSpy
                var isFirst = true;
                var autoHighlightEnabled = true; // NEW: Control flag

                // Helper to re-enable auto highlight on user interaction
                var enableAutoHighlight = function () { autoHighlightEnabled = true; };
                content.addEventListener('wheel', enableAutoHighlight);
                content.addEventListener('touchmove', enableAutoHighlight);
                content.addEventListener('keydown', enableAutoHighlight);
                content.addEventListener('mousedown', enableAutoHighlight);


                // Iterate Categories
                for (var category in ASCII_EMOJIS) {
                    if (!ASCII_EMOJIS.hasOwnProperty(category)) continue;
                    var items = ASCII_EMOJIS[category];

                    // ID Generation
                    var cleanName = category.replace(/\s+/g, '-').replace(/[&]/g, '').toLowerCase();
                    var sectionId = 'cat-' + cleanName;

                    // 1. Sidebar Item
                    var navItem = document.createElement('div');
                    navItem.className = 'ascii-sidebar-item';
                    if (isFirst) {
                        navItem.classList.add('active'); // Default active
                        isFirst = false;
                    }
                    navItem.innerText = category;
                    navItem.dataset.targetId = sectionId; // Store Link

                    navItem.onclick = (function (targetId, el) {
                        return function (e) {
                            e.stopPropagation(); // Prevent closing picker

                            // Disable auto-highlighting temporarily (until user scrolls manually)
                            autoHighlightEnabled = false;

                            // Manual activation
                            var siblings = el.parentNode.querySelectorAll('.ascii-sidebar-item');
                            for (var i = 0; i < siblings.length; i++) siblings[i].classList.remove('active');
                            el.classList.add('active');

                            // Scroll to section INSTANTLY
                            var target = document.getElementById(targetId);
                            if (target) {
                                target.scrollIntoView({ behavior: 'auto', block: 'start' });
                            }
                        };
                    })(sectionId, navItem);
                    sidebar.appendChild(navItem);

                    // 2. Content Section
                    var section = document.createElement('div');
                    section.className = 'ascii-category-section';
                    section.id = sectionId;

                    // Grid
                    var grid = document.createElement('div');
                    grid.className = 'ascii-grid';

                    // Items
                    for (var j = 0; j < items.length; j++) {
                        var item = items[j];
                        var div = document.createElement('div');
                        div.className = 'ascii-option';
                        div.innerText = item.art;
                        if (item.name) div.title = item.name;
                        div.onclick = (function (art) {
                            return function () { insertAscii(art); };
                        })(item.art);
                        grid.appendChild(div);
                    }

                    section.appendChild(grid);
                    content.appendChild(section);
                }

                // SCROLL SPY LOGIC: LINEAR INTERPOLATION
                content.addEventListener('scroll', function () {
                    if (!autoHighlightEnabled) return; // Skip if manually overridden

                    // Calculate scroll percentage (0 to 1)
                    var maxScroll = content.scrollHeight - content.clientHeight;
                    if (maxScroll <= 0) return;

                    var scrollPos = content.scrollTop;
                    var percentage = scrollPos / maxScroll;

                    // Get all sidebar items
                    var sidebarItems = sidebar.querySelectorAll('.ascii-sidebar-item');
                    var totalItems = sidebarItems.length;

                    if (totalItems === 0) return;

                    var activeIndex = Math.floor(percentage * totalItems);
                    // Clamp
                    if (activeIndex < 0) activeIndex = 0;
                    if (activeIndex >= totalItems) activeIndex = totalItems - 1;

                    // Update UI
                    for (var i = 0; i < sidebarItems.length; i++) {
                        var el = sidebarItems[i];
                        if (i === activeIndex) {
                            el.classList.add('active');
                            // Smooth scroll into view for the category name if it's outside visible sidebar
                            if (el.scrollIntoView) el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        } else {
                            el.classList.remove('active');
                        }
                    }
                });

            } else if (Array.isArray(ASCII_EMOJIS)) {
                for (var k = 0; k < ASCII_EMOJIS.length; k++) {
                    var itemArr = ASCII_EMOJIS[k];
                    var divArr = document.createElement('div');
                    divArr.className = 'ascii-option';
                    divArr.innerText = itemArr.art;
                    divArr.onclick = (function (art) {
                        return function () { insertAscii(art); };
                    })(itemArr.art);
                    container.appendChild(divArr);
                }
            }
        }



        function toggleAsciiPicker() {
            var picker = document.getElementById('ascii-picker-window');
            picker.classList.toggle('open');
        }

        function insertAscii(text) {
            var input = document.getElementById('msg-input');
            input.value += text;
            input.focus();
            toggleAsciiPicker(); // Close after selection
        }

        // --- REACTION MODAL POPULATION ---
        function populateReactionModal() {
            var modal = document.getElementById('reaction-selection-modal');
            modal.innerHTML = '';
            for (var i = 0; i < FONT_REACTIONS.length; i++) {
                var reaction = FONT_REACTIONS[i];
                var div = document.createElement('div');
                div.className = 'reaction-option';
                div.innerText = reaction;
                // Click handler is attached by openReactionTarget to pass the msgId
                modal.appendChild(div);
            }
        }

        // --- ROOM LOGIC ---

        function cleanupEmptyChats() {
            if (!currentUsername) return;

            // OPTIMIZATION: Only run cleanup once every 24 hours to save reads
            var lastCleanup = localStorage.getItem('kindlechat_last_cleanup');
            var now = Date.now();
            if (lastCleanup && (now - parseInt(lastCleanup)) < 86400000) {
                console.log("Chat: Cleanup skipped (Recently performed)");
                return;
            }

            db.collection('rooms')
                .where('participants', 'array-contains', currentUsername)
                .orderBy('lastMessageAt', 'desc')
                .limit(15)
                .get()
                .then(function (roomsQuery) {
                    var cleanupPromises = [];
                    roomsQuery.forEach(function (doc) {
                        var roomData = doc.data();
                        if (roomData.participants.indexOf('ukiyo') !== -1) return;

                        var messagesRef = db.collection('rooms').doc(doc.id).collection('messages');
                        var promise = messagesRef.limit(1).get().then(function (messageSnap) {
                            if (messageSnap.empty) {
                                return db.collection('rooms').doc(doc.id).update({
                                    participants: firebase.firestore.FieldValue.arrayRemove(currentUsername)
                                });
                            }
                        });
                        cleanupPromises.push(promise);
                    });
                    return Promise.all(cleanupPromises);
                })
                .then(function () {
                    localStorage.setItem('kindlechat_last_cleanup', now.toString());
                    console.log("Chat: Cleanup completed for active rooms");
                })
            ['catch'](function (e) {
                console.error("Error during empty chat cleanup:", e);
            });
        }

        function updateSidebar() {
            // Sort only user rooms by lastMessageAt descending
            userRooms.sort(function (a, b) {
                var timeA = getTimestampMillis(a.lastMessageAt);
                var timeB = getTimestampMillis(b.lastMessageAt);
                return timeB - timeA;
            });
            renderRoomList(generalRoom, userRooms);

            // Sidebar visibility logic
            var sidebar = document.getElementById('sidebar');
            var headerBtn = document.getElementById('header-new-chat-btn');

            // ALWAYS show sidebar if General exists so users can see activity/timestamps
            if (generalRoom || userRooms.length > 0) {
                sidebar.style.display = 'flex';
                headerBtn.style.display = 'none';
                document.getElementById('app-layout').style.setProperty('--sidebar-width', '252px');
            } else {
                sidebar.style.display = 'none';
                headerBtn.style.display = 'block';
                document.getElementById('app-layout').style.setProperty('--sidebar-width', '0px');
            }
        }

        function loadRooms() {
            if (unsubscribeRooms) unsubscribeRooms();
            if (unsubscribeGeneral) unsubscribeGeneral();

            var listEl = document.getElementById('room-list');
            listEl.innerHTML = '<div style="padding:10px;">Loading...</div>';

            // Listen to general room updates for timestamp
            unsubscribeGeneral = db.collection('rooms').doc('general').onSnapshot(function (doc) {
                if (doc.exists) {
                    generalRoom.lastMessageAt = doc.data().lastMessageAt;
                }
                updateSidebar();
            }, function (err) {
                console.error("Chat: General room snapshot error:", err);
                updateSidebar(); // Proceed anyway
            });

            unsubscribeRooms = db.collection('rooms')
                .where('participants', 'array-contains', currentUsername)
                .onSnapshot(function (snap) {
                    userRooms = [];
                    snap.forEach(function (doc) {
                        var data = doc.data();
                        var r = {
                            id: doc.id,
                            type: data.type,
                            lastMessageAt: data.lastMessageAt || data.createdAt // Fallback
                        };

                        if (data.type === 'dm') {
                            var otherPerson = data.participants.filter(function (p) { return p !== currentUsername; })[0];
                            if (otherPerson === 'ukiyo') {
                                r.name = "Ukiyo (Developer)";
                            } else {
                                r.name = otherPerson || "Me";
                            }
                        } else {
                            r.name = data.name || "Untitled Group";
                        }
                        userRooms.push(r);
                    });
                    updateSidebar();
                }, function (err) {
                    console.error("User rooms snapshot error:", err);
                    updateSidebar(); // Proceed anyway
                });
        }

        function renderRoomList(general, rooms) {
            var listEl = document.getElementById('room-list');
            listEl.innerHTML = '';

            // 1. Render General Room
            if (general) {
                renderRoomItem(general, listEl);
                // 2. Add Separator if there are other rooms
                if (rooms.length > 0) {
                    var sep = document.createElement('div');
                    sep.className = 'sidebar-separator';
                    listEl.appendChild(sep);
                }
            }

            // 3. Render Other Rooms
            for (var i = 0; i < rooms.length; i++) {
                renderRoomItem(rooms[i], listEl);
            }
        }

        function renderRoomItem(room, listEl) {
            var div = document.createElement('div');
            div.className = 'room-item' + (room.id === currentRoomId ? ' active' : '');

            var deleteHtml = '';
            if (room.id !== 'general') {
                deleteHtml = '<span class="del-room-btn" onclick="promptLeaveRoom(\'' + room.id + '\', event)">×</span>';
            }

            var timeStr = formatChatTime(room.lastMessageAt);

            div.innerHTML = '<div class="room-top"><span>' + room.name + '</span>' + deleteHtml + '</div>' +
                '<div class="room-time">' + timeStr + '</div>';
            div.onclick = function () { switchRoom(room.id, room.name); };
            listEl.appendChild(div);
        }

        function switchRoom(id, name) {
            if (currentRoomId === id) return;

            currentRoomId = id;
            document.getElementById('room-title').innerText = name;

            // Clear previous messages to prevent ghosting
            document.getElementById('chat-history').innerHTML = '';

            // Update Pixel Button Visibility (Only show in 'general')
            var pixelBtn = document.getElementById('pixel-btn');
            if (pixelBtn) {
                pixelBtn.style.display = (id === 'general') ? 'flex' : 'none';
            }

            loadMessages();
            updateSidebar(); // Refresh highlighting
        }

        // --- MESSAGE LOGIC (with pagination) ---

        function handleScroll() {
            var historyEl = document.getElementById('chat-history');
            if (historyEl.scrollTop === 0 && !isLoadingMore && oldestMsgDoc) {
                isLoadingMore = true;
                var oldScrollHeight = historyEl.scrollHeight;

                db.collection('rooms').doc(currentRoomId).collection('messages')
                    .orderBy('timestamp', 'desc')
                    .startAfter(oldestMsgDoc)
                    .limit(25)
                    .get()
                    .then(function (querySnapshot) {
                        if (!querySnapshot.empty) {
                            oldestMsgDoc = querySnapshot.docs[querySnapshot.docs.length - 1]; // New oldest message

                            querySnapshot.docs.forEach(function (doc) {
                                renderMessage(doc.data(), doc.id, true); // Prepend messages
                            });

                            // Restore scroll position
                            historyEl.scrollTop = historyEl.scrollHeight - oldScrollHeight;
                        }
                    })
                ['catch'](function (e) {
                    console.error("Error loading more messages:", e);
                })
                    .then(function () {
                        isLoadingMore = false;
                    });
            }
        }

        function loadMessages() {
            if (unsubscribeMsg) unsubscribeMsg();
            oldestMsgDoc = null;
            isLoadingMore = false;

            var history = document.getElementById('chat-history');

            // Only show connecting if empty to avoid flicker
            if (history.children.length === 0) {
                history.innerHTML = '<div style="text-align:center; padding:20px">Connecting...</div>';
            }

            unsubscribeMsg = db.collection('rooms').doc(currentRoomId).collection('messages')
                .orderBy('timestamp', 'asc')
                .limitToLast(50)
                .onSnapshot(function (snapshot) {
                    // Remove loading indicator if present
                    if (history.innerHTML.indexOf('Connecting...') !== -1) {
                        history.innerHTML = '';
                    }

                    if (snapshot.empty && history.innerHTML === '') {
                        history.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No messages yet.</div>';
                    }

                    var isScrolledToBottom = history.scrollHeight - history.clientHeight <= history.scrollTop + 100;

                    snapshot.docChanges().forEach(function (change) {
                        if (change.type === 'added' || change.type === 'modified') {
                            renderMessage(change.doc.data(), change.doc.id);
                        }
                    });

                    if (isScrolledToBottom) {
                        history.scrollTop = history.scrollHeight;
                    }

                    if (snapshot.docs.length > 0) {
                        oldestMsgDoc = snapshot.docs[0];
                    }

                }, function (error) {
                    console.error("Error loading messages:", error);
                    history.innerHTML = '<div style="text-align:center; padding:20px;">Error connecting.</div>';
                });
        }


        var profanityRegex = null;
        function getProfanityRegex() {
            if (profanityRegex) return profanityRegex;
            if (typeof BAD_WORDS === 'undefined') return null;

            // Create regex once from the BAD_WORDS array
            var escaped = BAD_WORDS.filter(function (w) { return w; }).map(function (w) { return w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); });
            profanityRegex = new RegExp('\\b(' + escaped.join('|') + ')\\b', 'gi');
            return profanityRegex;
        }

        function censorText(text) {
            var regex = getProfanityRegex();
            if (!regex) return text;
            return text.replace(regex, function (match) {
                var stars = '';
                for (var i = 0; i < match.length; i++) stars += '*';
                return stars;
            });
        }

        function linkify(inputText) {
            var replacedText, replacePattern1, replacePattern2;

            // URLs starting with http://, https://, or ftp://
            replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

            // URLs starting with "www." (without // before it)
            replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

            return replacedText;
        }

        function renderMessage(msg, msgId, prepend) {
            var history = document.getElementById('chat-history');
            var div = document.createElement('div');

            var isSelf = currentUser && (msg.user === currentUsername);
            div.className = 'msg ' + (isSelf ? 'self' : 'other');
            div.dataset.msgId = msgId;

            var nameHtml = isSelf ? '<span>You</span>' : '<span style="font-weight:bold;">' + msg.user + '</span>';

            // Developer Badge in Name
            if (msg.user === 'ukiyo') {
                var devBadge = '<span class="dev-tag">DEV</span>';
                nameHtml = isSelf ? '<span>' + devBadge + 'You</span>' : '<span>' + devBadge + '<span style="font-weight:bold;">' + msg.user + '</span></span>';
            } else if (supporterUsers[msg.user]) {
                // Supporter Crown (SVG for Kindle compatibility)
                var crownSvg = '<svg class="supporter-crown" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 4L5 18H19L22 4L15 11L12 4L9 11L2 4Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>';
                var crown = '<a href="http://link.rekindle.ink/donate" target="_blank" style="text-decoration:none;" title="Supporter">' + crownSvg + '</a>';
                nameHtml = isSelf ? '<span>' + crown + 'You</span>' : '<span>' + crown + '<span style="font-weight:bold;">' + msg.user + '</span></span>';
            }

            var timeStr = "";
            if (msg.timestamp) {
                var date = msg.timestamp.toDate();
                timeStr = formatZonedTime(date);
            }

            var bubbleContent = '';
            var isSpecialMessage = false;
            var messageText = msg.text || '';

            // Censor Profanity Logic
            var censorProfanity = localStorage.getItem('rekindle_censor_profanity');
            if (messageText && (censorProfanity === null || censorProfanity === 'true')) {
                messageText = censorText(messageText);
            }

            // ASCII Art detection
            var isAscii = messageText.indexOf('\n') !== -1;

            if (isAscii) {
                bubbleContent = '<div class="msg-bubble ascii">' + escapeHtml(messageText) + '</div>';
                isSpecialMessage = true;
            } else if (msg.is_reaction_image) {
                bubbleContent = '<div class="msg-bubble ascii">' + messageText + '</div>';
                isSpecialMessage = true;
            } else if (msg.is_game_link) {
                var parts = msg.text.split(':');
                var gameType = parts[0];
                var gameId = parts[1];
                var gameName = gameType.charAt(0).toUpperCase() + gameType.slice(1);
                var isStarter = msg.user === currentUsername;

                var displayMsg = '';
                if (gameType === 'words') {
                    displayMsg = msg.user + ' started a Scrabble Game\n' + (isStarter ? 'Wait for a player to join!' : 'Click to Join!');
                } else {
                    displayMsg = 'New ' + gameName + ' Game Ready!\nClick to Join!';
                }

                var linkDestination = isStarter && gameType === 'words' ? '#' : gameType + '.html?gameId=' + gameId;
                var containerClass = isStarter && gameType === 'words' ? 'game-link-container disabled' : 'game-link-container';

                bubbleContent = '<div class="msg-bubble game-link-bubble">' +
                    '<div class="' + containerClass + '">' +
                    '<a href="' + linkDestination + '" class="game-link" ' + (isStarter && gameType === 'words' ? 'onclick="event.preventDefault()"' : '') + '>' +
                    displayMsg +
                    '</a></div></div>';
                isSpecialMessage = true;
            } else if (msg.is_pixel_art) {
                bubbleContent = '<div class="msg-bubble" style="padding: 5px; background: white;">' +
                    '<div style="font-weight:bold; margin-bottom:5px; font-size:0.8rem;">Pixel Art</div>' +
                    '<img src="' + msg.pixel_art + '" style="' +
                    'image-rendering: -webkit-optimize-contrast; ' +
                    'image-rendering: crisp-edges; ' +
                    'image-rendering: pixelated; ' +
                    'width: 128px; ' +
                    'height: 128px; ' +
                    'border: 2px solid black; ' +
                    'display:block;' +
                    '">' +
                    (messageText ? '<div style="margin-top:5px; font-size:0.9rem;">' + escapeHtml(messageText) + '</div>' : '') +
                    '</div>';
                isSpecialMessage = true;
            } else {
                bubbleContent = '<div class="msg-bubble">' + linkify(escapeHtml(messageText)) + '</div>';
            }

            // Theme Injection
            if (msg.user === 'ukiyo') {
                bubbleContent = bubbleContent.replace('class="msg-bubble', 'class="msg-bubble developer');
            } else if (supporterUsers[msg.user]) {
                bubbleContent = bubbleContent.replace('class="msg-bubble', 'class="msg-bubble supporter');
            }

            var reactButton = (currentUser && (!isSpecialMessage || msg.is_pixel_art))
                ? '<div class="react-btn" onclick="openReactionTarget(\'' + msgId + '\', this, event)">+</div>'
                : '';

            div.innerHTML = '<div class="msg-meta">' + nameHtml + '<span>' + timeStr + '</span></div>' +
                '<div style="display:flex; align-items:center; gap: 5px; min-width: 0;">' +
                (isSelf ? reactButton : '') +
                bubbleContent +
                (isSelf ? '' : reactButton) +
                '</div>';

            if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                var reactionBar = document.createElement('div');
                reactionBar.className = 'reaction-bar' + (isSelf ? ' self-bar' : ' other-bar');

                var groupedReactions = {};
                for (var userUID in msg.reactions) {
                    var reaction = msg.reactions[userUID];
                    if (!groupedReactions[reaction]) groupedReactions[reaction] = [];
                    groupedReactions[reaction].push(userUID);
                }

                for (var reactionKey in groupedReactions) {
                    var count = groupedReactions[reactionKey].length;
                    var el = document.createElement('div');
                    el.className = 'reaction-item';
                    el.title = groupedReactions[reactionKey].map(function (uid) { return uid.split('@')[0]; }).join(', ');
                    el.innerHTML = reactionKey + ' ' + count;
                    el.onclick = (function (r) { return function () { toggleUserReaction(msgId, r); }; })(reactionKey);
                    reactionBar.appendChild(el);
                }
                if (reactionBar.children.length > 0) div.appendChild(reactionBar);
            }

            var existing = history.querySelector('.msg[data-msg-id="' + msgId + '"]');
            if (existing) {
                history.replaceChild(div, existing);
            } else if (prepend) {
                history.insertBefore(div, history.firstChild);
            } else {
                history.appendChild(div);
            }
        }

        function sendMessage() {
            var inputEl = document.getElementById('msg-input');
            var text = inputEl.value.trim();

            if (!text) return;
            if (!currentUser) return;

            inputEl.value = '';

            var messageData = {
                user: currentUsername,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                text: text // Text can include newlines for ASCII art
            };

            var roomRef = db.collection('rooms').doc(currentRoomId);

            // Add the message first
            roomRef.collection('messages').add(messageData)
                .then(function () {
                    // Update room activity
                    return roomRef.set({
                        lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                })
                .then(function () {
                    // Then, check if we need to "activate" the room for other users
                    return roomRef.get();
                })
                .then(function (roomDoc) {
                    if (roomDoc.exists) {
                        var roomData = roomDoc.data();
                        // If it's a DM that hasn't been activated yet
                        if (roomData.type === 'dm' && roomData.intendedParticipants && roomData.participants.length < roomData.intendedParticipants.length) {
                            // Add all intended participants to the main participants list
                            return roomRef.update({
                                participants: roomData.intendedParticipants
                            });
                        }
                    }
                })
            ['catch'](function (e) {
                console.error("Error sending message:", e);
            });
        }

        // --- REACTION FUNCTIONS ---

        // Global tracker for currently open reaction menu
        var activeReactionMsgId = null;

        function openReactionTarget(msgId, btnElement, event) {
            event.stopPropagation();
            if (!currentUser) return;

            var modal = document.getElementById('reaction-selection-modal');

            // TOGGLE LOGIC: If clicking the same button while open, close it.
            if (modal.style.display === 'flex' && activeReactionMsgId === msgId) {
                closeReactionModal();
                return;
            }

            activeReactionMsgId = msgId;

            var rect = btnElement.getBoundingClientRect();

            // Position the modal near the button
            modal.style.top = rect.top + 'px';

            // Adjust X position based on whether it's a self or other message
            var isSelf = btnElement.parentNode.parentNode.className.indexOf('self') !== -1;

            // If self (button on left), position modal to the right of the button
            if (isSelf) {
                modal.style.left = (rect.right + 5) + 'px';
                modal.style.right = 'auto';
            } else {
                // If other (button on right), position modal to the left of the button
                modal.style.left = (rect.left - 130) + 'px'; // Estimate width - adjustment
                modal.style.right = 'auto';
            }

            // Bind selection handlers to this message ID
            var options = modal.querySelectorAll('.reaction-option');
            for (var i = 0; i < options.length; i++) {
                (function (option) {
                    option.onclick = function () { selectReaction(msgId, option.innerText); };
                })(options[i]);
            }

            modal.style.display = 'flex';
        }

        function closeReactionModal(event) {
            var modal = document.getElementById('reaction-selection-modal');
            // If event is defined and click is outside the modal, hide it
            if (event && !modal.contains(event.target) && modal.style.display === 'flex') {
                modal.style.display = 'none';
                activeReactionMsgId = null;
            } else if (!event) {
                // Manual close trigger
                modal.style.display = 'none';
                activeReactionMsgId = null;
            }
        }

        function selectReaction(msgId, reaction) {
            toggleUserReaction(msgId, reaction);
            closeReactionModal();
        }

        function toggleUserReaction(msgId, reaction) {
            if (!currentUser) return;

            var messageRef = db.collection('rooms').doc(currentRoomId).collection('messages').doc(msgId);
            var userUID = currentUser.uid;

            messageRef.get().then(function (doc) {
                if (!doc.exists) return;

                var reactions = doc.data().reactions || {};
                var userReaction = reactions[userUID];

                if (userReaction === reaction) {
                    // REMOVE: User clicks the reaction they already left
                    var updates = {};
                    updates["reactions." + userUID] = firebase.firestore.FieldValue.delete();
                    messageRef.update(updates);
                } else {
                    // ADD/CHANGE
                    reactions[userUID] = reaction;
                    messageRef.update({ reactions: reactions });
                }
            })['catch'](function (e) {
                console.error("Error toggling reaction:", e);
            });
        }

        // --- MODAL LOGIC ---
        function openCreateModal() {
            if (!currentUser) return showModal("Please log in first.");
            document.getElementById('generic-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'none';
            document.getElementById('create-modal-content').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal(id) {
            if (!id) id = 'modal-overlay';
            document.getElementById(id).style.display = 'none';
        }

        // --- NEW: SEND DIRECT MESSAGE LOGIC ---
        function sendDirectMessage() {
            var usernameInput = document.getElementById('dm-username').value.trim();
            var messageInput = document.getElementById('dm-message').value.trim();

            if (!usernameInput) return showModal("Please enter a username.");
            if (!messageInput) return showModal("Please enter a message.");

            closeModal(); // Close modal immediately

            var otherUser = usernameInput;
            var participants = [currentUsername, otherUser].sort();

            // Check if DM exists
            db.collection('rooms')
                .where('participants', 'array-contains', currentUsername)
                .where('type', '==', 'dm')
                .get()
                .then(function (roomsSnap) {
                    var existingRoomId = null;
                    roomsSnap.forEach(function (doc) {
                        var data = doc.data();
                        if (data.participants.length === 2 && data.participants.indexOf(otherUser) !== -1) {
                            existingRoomId = doc.id;
                        }
                    });

                    if (existingRoomId) {
                        switchRoom(existingRoomId, otherUser);
                    } else {
                        // Create new DM
                        var newRoomRef;
                        db.collection('rooms').add({
                            type: 'dm',
                            participants: [currentUsername],
                            intendedParticipants: participants,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                        })
                            .then(function (ref) {
                                newRoomRef = ref;
                                return newRoomRef.collection('messages').add({
                                    user: currentUsername,
                                    text: messageInput,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            })
                            .then(function () {
                                return newRoomRef.update({ participants: participants });
                            })
                            .then(function () {
                                switchRoom(newRoomRef.id, otherUser);
                            });
                    }
                })
            ['catch'](function (e) {
                console.error("Error sending DM:", e);
                showModal("Error starting chat.");
            });
        }

        // --- SUPPORTER LOGIC ---
        function fetchSupporters() {
            db.collection('config').doc('supporters').get().then(function (doc) {
                if (doc.exists && doc.data().usernames) {
                    var list = doc.data().usernames;
                    supporterUsers = {};
                    for (var i = 0; i < list.length; i++) {
                        supporterUsers[list[i]] = true;
                    }
                }
            })['catch'](function (e) {
                console.error("Error loading supporters:", e);
            });
        }


        // --- LEAVE ROOM ---
        function promptLeaveRoom(roomId, event) {
            event.stopPropagation();
            roomToDeleteId = roomId;
            document.getElementById('generic-modal-content').style.display = 'none';
            document.getElementById('create-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function confirmLeaveRoom() {
            if (!roomToDeleteId) return;

            db.collection('rooms').doc(roomToDeleteId).update({
                participants: firebase.firestore.FieldValue.arrayRemove(currentUsername)
            })
                .then(function () {
                    if (currentRoomId === roomToDeleteId) {
                        switchRoom('general', 'All of KindleChat');
                    }
                    closeModal();
                })
            ['catch'](function (e) {
                console.error("Error leaving chat:", e);
                closeModal();
            });
        }

        // Helper to handle escaping for text display within message bubbles
        function escapeHtml(text) {
            if (!text) return "";
            var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        function formatChatTime(timestamp) {
            if (!timestamp) return "";
            try {
                var date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds ? timestamp.seconds * 1000 : timestamp);
                if (isNaN(date.getTime())) return "";

                // Use Shared Helper
                var now = window.rekindleGetZonedDate(new Date());
                var zonedDate = window.rekindleGetZonedDate(date);

                // Diff logic (robust way)
                // Set both to noon to compare just dates roughly
                var nowNoon = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0);
                var zonedNoon = new Date(zonedDate.getFullYear(), zonedDate.getMonth(), zonedDate.getDate(), 12, 0, 0);
                var diffDays = Math.round((nowNoon - zonedNoon) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    // Same day: Show Time
                    return window.rekindleFormatTime(date, { hour: 'numeric', minute: '2-digit', hour12: true });
                } else if (diffDays < 7 && diffDays > 0) {
                    // Within week: Show Day Name + Time
                    return window.rekindleFormatTime(date, { weekday: 'short', hour: 'numeric', minute: '2-digit', hour12: true });
                } else {
                    // Older: Show Date
                    return window.rekindleFormatTime(date, { month: 'short', day: 'numeric' });
                }
            } catch (e) {
                console.error(e);
                return "";
            }
        }

        // --- TIMEZONE HELPERS (Delegated to theme.js) ---
        // Legacy functions removed or mapped to shared logic if strict dependency exists
        // But we replaced usage in formatChatTime, so we can remove them.


        function getTimestampMillis(ts) {
            if (!ts) return 0;
            try {
                if (typeof ts.toMillis === 'function') return ts.toMillis();
                if (ts.seconds) return ts.seconds * 1000;
                if (ts instanceof Date) return ts.getTime();
                if (typeof ts === 'number') return ts;
            } catch (e) { }
            return 0;
        }

    </script>

    <script>
        // Helper to sanitize background image URLs from localStorage
        function sanitizeBackgroundImage(imageString) {
            if (!imageString) return '';
            if (imageString.indexOf('url("data:image/png;base64,') === 0) {
                return imageString;
            }
            if (imageString.indexOf('url("') === 0 && imageString.lastIndexOf('")') === (imageString.length - 2)) {
                var url = imageString.substring(5, imageString.length - 2);
                if ((url.indexOf('http://') === 0 || url.indexOf('https://') === 0 || url.indexOf('/') === 0) && url.indexOf('javascript:') === -1) {
                    return imageString;
                }
            }
            return '';
        }


        function toggleFullScreen() {
            var win = document.querySelector('.window');
            if (win) win.classList.toggle('fullscreen');
        }

        function loadWallpaper() {
            var wallpaperImg = localStorage.getItem('rekindle_bg_image');
            var wallpaperSize = localStorage.getItem('rekindle_bg_size');
            if (wallpaperImg) {
                document.body.style.backgroundImage = wallpaperImg;
            }
            if (wallpaperSize) {
                document.body.style.backgroundSize = wallpaperSize;
            }
        }
    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>
    <!-- Duplicate Modal Removed -->
</body>

</html>