<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>KindleChat</title>
    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            font-family: "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-color: #e5e5e5;
            /* Background managed by settings */

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 95%;
            max-width: 900px;
            position: relative;
        }

        .window.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw / var(--rekindle-scale, 1));
            height: calc(100vh / var(--rekindle-scale, 1));
            max-width: none;
            max-height: none;
            border: none;
            box-shadow: none;
            z-index: 2000;
            transform-origin: top left !important;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        /* CLOSE BUTTON */
        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            box-shadow: none;
        }

        /* CONTROLS (Right side of Title Bar) */
        .title-controls {
            position: absolute;
            right: 10px;
            z-index: 2;
            display: flex;
            align-items: center;
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            padding: 0;
            flex-shrink: 0;
        }

        .icon-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        /* Icon State Toggles */
        .icon-contract {
            display: none;
        }

        .window.fullscreen .icon-expand {
            display: none;
        }

        .window.fullscreen .icon-contract {
            display: inline;
        }

        /* MAIN LAYOUT */
        #app-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            --sidebar-width: 252px;
            /* Default: 250px width + 2px border */
        }

        /* SIDEBAR */
        #sidebar {
            width: 250px;
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eee;
        }

        #room-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .room-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .room-item:hover {
            background: #f0f0f0;
        }

        .room-item.active {
            background: black;
            color: white;
            font-weight: bold;
        }

        .room-top {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .room-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
            font-weight: normal;
        }

        .room-item.active .room-time {
            color: #ccc;
        }

        .sidebar-separator {
            height: 1px;
            background: #eee;
            margin: 5px 15px;
            border-bottom: 1px solid #ccc;
        }

        /* DELETE BUTTON IN LIST */
        .del-room-btn {
            font-weight: bold;
            color: #999;
            padding: 5px 10px;
            cursor: pointer;
            font-family: sans-serif;
            font-size: 1.2rem;
            line-height: 0.8;
        }

        .del-room-btn:hover {
            color: black;
        }

        .room-item.active .del-room-btn {
            color: #ccc;
        }

        .room-item.active .del-room-btn:hover {
            color: white;
        }

        /* CHAT VIEW */
        #chat-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
            min-width: 0;
            max-width: calc(100% - var(--sidebar-width));
        }

        /* ROOM HEADER */
        .room-header {
            border-bottom: 2px solid black;
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #eee;
            font-size: 0.9rem;
            flex-shrink: 0;
            position: relative;
        }

        #header-new-chat-btn {
            position: absolute;
            left: 10px;
            display: none;
            /* Default hidden, overrides sys-btn flex */
            padding: 2px 8px;
            /* Compact */
        }

        .current-room {
            font-weight: bold;
            text-transform: uppercase;
        }

        /* CHAT HISTORY */
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            display: flex;
            flex-direction: column;
            /* Allow wrapping, max-width controls the break point */
            max-width: 85%;
            position: relative;
            max-width: 85%;
            position: relative;
            min-width: 0;
            /* Allow shrinking */
        }

        .msg.self {
            align-self: flex-end;
            align-items: flex-end;
        }

        .msg.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .msg-meta {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 2px;
            display: flex;
        }

        /* Manual spacing for Kindle browser */
        .msg-meta span {
            margin-right: 8px;
        }

        .msg-meta span:last-child {
            margin-right: 0;
        }

        .msg-bubble {
            border: 2px solid black;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            box-shadow: 2px 2px 0px #ccc;
            word-wrap: break-word;
            /* Legacy */
            word-break: break-word;
            /* Modern equivalent for long words */
            overflow-wrap: break-word;
            /* Standard */
            min-width: 0;
            /* Flex shrink fix */
            width: fit-content;
            /* Ensure it wraps tightly but respects max-width */
            position: relative;
            /* FIX: Crucial for allowing the bubble to shrink-wrap its content width */
            display: inline-block;
            max-width: 100%;
        }

        .msg-bubble a {
            color: inherit;
            text-decoration: underline;
            word-break: break-all;
        }

        .msg.self .msg-bubble {
            background: black;
            color: white;
            border-color: black;
            box-shadow: 2px 2px 0px #666;
        }

        /* ASCII art messages use a fixed-width font */
        .msg-bubble.ascii {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            /* Preserve whitespace/newlines */
            font-size: 0.8rem;
        }

        /* --- REACTIONS (Font only) --- */
        .reaction-bar {
            margin-top: 5px;
            display: flex;
            gap: 5px;
            font-size: 1rem;
            padding: 2px 0;
            flex-wrap: wrap;
        }

        .reaction-item {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 2px 6px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 3px;
            line-height: 1;
            font-weight: bold;
        }

        .reaction-item svg {
            vertical-align: middle;
            flex-shrink: 0;
        }

        .msg.self .reaction-item {
            background: #333;
            color: white;
            border-color: #555;
        }

        /* MODIFIED: CONSTANT PLUS BUTTON (REACTION TRIGGER) */
        .react-btn {
            position: absolute;
            top: 50%;
            /* Center vertically with message */
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 1px solid black;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            text-align: center;
            line-height: 18px;
            font-size: 0.9rem;
            box-shadow: 1px 1px 0 #999;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0.5;
            /* Initial opacity */
            transition: opacity 0.2s;
        }

        .react-btn:hover {
            opacity: 1.0;
        }

        /* DELETE BUTTON (Admin) - matches reaction button style */
        .del-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 1px solid black;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            text-align: center;
            line-height: 18px;
            font-size: 0.9rem;
            box-shadow: 1px 1px 0 #999;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0.5;
            color: red;
            font-weight: bold;
        }

        .del-btn:hover {
            opacity: 1.0;
            background: #ffe6e6;
        }

        /* Position for messages sent by others (button on right) */
        .msg.other .react-btn {
            right: -25px;
            left: auto;
        }

        .msg.other .del-btn {
            right: -50px;
            left: auto;
        }

        /* Position for self messages (button on left) */
        .msg.self .react-btn {
            /* Shifted left to make room for delete btn if present */
            left: -50px;
            right: auto;
        }

        .msg.self .del-btn {
            left: -25px;
            right: auto;
        }

        /* Hide the button if not logged in or a special message */
        .react-btn.hidden {
            display: none;
        }

        /* Game Link CONTAINER - CRITICAL ADJUSTMENTS HERE */
        .game-link-container {
            /* FIX: Make it the bubble and remove its top margin, use minimal padding */
            border: 2px solid black;
            padding: 5px;
            background: #eee;
            margin-top: 0;
            /* Remove redundant margin */
            text-align: center;
            /* FIX: Set display to a table-related value so it shrinks tightly to content */
            display: table;
            min-width: 100px;
            max-width: 100%;
            box-sizing: border-box;
            box-shadow: 2px 2px 0 #ccc;
            /* Inherit original bubble shadow */
        }

        /* Override bubble style for game link messages */
        .msg-bubble.game-link-bubble {
            padding: 0;
            border: none;
            box-shadow: none;
            background: transparent;
        }

        .game-link-container.disabled {
            opacity: 0.6;
            cursor: default;
        }

        /* Game Link INNER TEXT/BUTTON */
        .game-link {
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            color: black;
            display: block !important;
            font-size: 0.8rem;
            line-height: 1.3;
            word-break: break-word;
        }

        /* User Tag Styling */
        .user-tag {
            font-weight: bold;
            cursor: pointer;
            color: #000;
        }

        .user-tag:hover {
            text-decoration: underline;
        }

        /* FIX: White text for tags inside self bubbles (black background) */
        .msg.self .user-tag {
            color: white;
        }

        /* Translated Message Styling */
        .msg-bubble[data-state="translated"] {
            font-style: italic;
        }

        /* INPUT AREA */
        .input-area {
            border-top: 2px solid black;
            padding: 10px;
            display: flex;
            gap: 10px;
            background: #eee;
            flex-shrink: 0;
            position: relative;
        }

        textarea {
            flex-grow: 1;
            border: 2px solid black;
            padding: 10px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            height: 70px;
            /* Increased height for multi-line support */
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 5px 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sys-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        /* --- NEW: ASCII ART PICKER STYLES --- */
        .ascii-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 10px;
            right: 10px;
            /* NEW: Anchor to right for shrinking */
            width: auto;
            /* NEW: Auto width */
            max-width: 600px;
            /* Cap width */
            height: 400px;
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            z-index: 20;
            /* Layout Mode: Flex Column (Content top, Categories bottom) */
            flex-direction: column;
            padding: 0;
            /* Remove padding from main container */
            gap: 0;
            overflow: hidden;
            /* Inner containers handle scroll */
        }

        .ascii-picker.open {
            display: flex;
        }

        /* SIDEBAR (Now Bottom Bar) */
        .ascii-sidebar {
            width: 100%;
            height: auto;
            /* Allow it to take necessary height */
            background: #eee;
            border-top: 2px solid black;
            border-right: none;
            overflow-x: auto;
            /* Horizontal scroll */
            overflow-y: hidden;
            /* No vertical scroll */
            flex-shrink: 0;
            display: flex;
            flex-direction: row;
            /* Horizontal items */
        }

        .ascii-sidebar-item {
            padding: 10px;
            border-right: 1px solid #ccc;
            /* Separator between horizontal items */
            border-bottom: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            /* Prevent text wrapping */
            flex-shrink: 0;
        }

        .ascii-sidebar-item:last-child {
            border-right: none;
        }

        .ascii-sidebar-item:hover,
        .ascii-sidebar-item.active {
            background: black;
            color: white;
        }

        /* CONTENT (Top) */
        .ascii-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            /* gap: 15px;  <-- Kindle doesn't support flex gap */
        }

        /* CATEGORY SECTION */
        .ascii-category-section {
            scroll-margin-top: 10px;
            margin-bottom: 25px;
            /* Manual gap */
            border-bottom: 1px dashed #ccc;
            /* Extra visual separator */
            padding-bottom: 15px;
        }


        /* GRID for Emojis */
        .ascii-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .ascii-option {
            border: 1px solid #ccc;
            padding: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            text-align: center;
            background: #fafafa;
            min-width: 60px;
            flex-grow: 1;
        }

        .ascii-option:hover {
            background: black;
            color: white;
            border-color: black;
        }

        /* NEW: REACTION SELECTION MODAL */
        #reaction-selection-modal {
            position: absolute;
            background: white;
            border: 2px solid black;
            box-shadow: 4px 4px 0 black;
            padding: 5px;
            z-index: 10;
            display: none;
            flex-direction: row;
            gap: 5px;
        }

        .reaction-option {
            padding: 8px;
            cursor: pointer;
            text-align: center;
            background: #eee;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reaction-option svg {
            width: 20px;
            height: 20px;
        }

        .reaction-option:hover {
            background: black;
            color: white;
        }

        .reaction-option:hover svg {
            fill: white;
        }


        /* MODAL */
        #modal-overlay {
            display: none;
            position: fixed;
            /* Changed to fixed for fullscreen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            border: 2px solid black;
            box-shadow: 8px 8px 0 black;
            padding: 20px;
            width: 300px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 2px solid black;
            box-sizing: border-box;
        }

        /* LOCKED INPUT (Guest) */
        #locked-input {
            border-top: 2px solid black;
            padding: 15px;
            background: #ddd;
            text-align: center;
            font-style: italic;
            color: #555;
            font-size: 0.9rem;
            display: none;
        }

        /* GUEST OVERLAY (New) */
        #guest-overlay {
            position: fixed;
            /* Changed to fixed for fullscreen */
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10001;
            display: none;
            /* Default hidden */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        #guest-overlay h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }

        /* --- USER THEMES --- */
        .msg-bubble.developer {
            border: 3px double black !important;
            box-shadow: 4px 4px 0px #000;
        }

        .msg.self .msg-bubble.developer {
            border-color: white !important;
            /* Ensure visibility on black background? No, self is black bg. */
            /* If bg is black, double border needs color. */
            box-shadow: 4px 4px 0px #666;
            background-image: none;
        }

        /* Developer Tag */
        .dev-tag {
            font-size: 0.7rem;
            background: black;
            color: white;
            padding: 1px 4px;
            border-radius: 4px;
            margin-right: 5px;
            vertical-align: middle;
            font-weight: bold;
        }

        .msg-bubble.supporter {
            background: black !important;
            color: white !important;
            border: 2px solid black !important;
            /* Matches bg but defines size */
            box-shadow: 4px 4px 0px #999;
            /* Grey shadow for contrast */
        }

        /* Ensure links in supporter bubbles are visible */
        .msg-bubble.supporter a {
            color: white;
            text-decoration: underline;
        }

        .supporter-crown {
            width: 14px;
            height: 14px;
            display: inline-block;
            vertical-align: middle;
            fill: black;
            /* Default */
            margin-right: 4px;
        }

        .msg.self .supporter-crown {
            fill: black;
        }


        .modal-box {
            background: white;
            border: 2px solid black;
            padding: 20px;
            box-shadow: 6px 6px 0 black;
            max-width: 300px;
            width: 80%;
            text-align: center;
        }

        .modal-text {
            margin-bottom: 20px;
            font-weight: bold;
            line-height: 1.4;
            color: black;
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            background: white;
            border: 2px solid black;
            padding: 6px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            font-family: inherit;
        }

        .modal-btn:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="emojis.js?v=2"></script>

    <script src="bad_words.js?v=2"></script>
    <script src="time.js"></script>
    <script src="theme.js"></script>
    <script src="js/i18n.js"></script>
</head>

<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text" data-i18n="kindlechat.title">KindleChat</span>
            <div class="title-controls">
                <button class="icon-btn" onclick="openSettingsModal()" title="Settings"
                    data-i18n-title="kindlechat.btn.settings" style="margin-right:5px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </button>
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen"
                    data-i18n-title="kindlechat.btn.fullscreen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="square" stroke-linejoin="miter">
                        <path class="icon-expand" d="M15 3h6v6M14 10l6.1-6.1M9 21H3v-6M10 14l-6.1 6.1" />
                        <path class="icon-contract" d="M21 9H15V3M21 3l-6 6M3 15h6v6M3 21l6-6" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="app-layout">

            <div id="sidebar">
                <div class="sidebar-header">
                    <span style="font-weight:bold;" data-i18n="kindlechat.title">Chats</span>
                    <button class="sys-btn" onclick="openCreateModal()">+</button>
                </div>
                <div id="room-list">
                </div>
            </div>

            <div id="chat-view">
                <div class="room-header">
                    <!-- NEW: Conditional New Chat Button -->
                    <button id="header-new-chat-btn" class="sys-btn header-new-chat-btn"
                        onclick="openCreateModal()">+</button>
                    <span class="current-room" id="room-title">All of KindleChat</span>
                </div>

                <div id="chat-history">
                </div>

                <div class="input-area" id="active-input">
                    <!-- NEW ASCII PICKER AND BUTTON -->
                    <div id="ascii-picker-window" class="ascii-picker">
                        <!-- Items injected by JS -->
                    </div>

                    <button id="pixel-btn" class="sys-btn" onclick="window.location.href='pixel?source=kindlechat'"
                        style="padding: 0 5px;" title="Pixel Art" data-i18n-title="kindlechat.btn.pixel">
                        <svg width="20" height="20" viewBox="0 0 32 32">
                            <rect x="4" y="4" width="24" height="24" fill="none" stroke="black" stroke-width="2" />
                            <rect x="8" y="8" width="4" height="4" fill="black" />
                            <rect x="20" y="12" width="4" height="4" fill="black" />
                            <rect x="12" y="20" width="4" height="4" fill="black" />
                        </svg>
                    </button>

                    <button id="flipbook-btn" class="sys-btn"
                        onclick="window.location.href='flipbook?source=kindlechat'" style="padding: 0 5px;"
                        title="Flipbook" data-i18n-title="kindlechat.btn.flipbook">
                        <svg width="20" height="20" viewBox="0 0 32 32">
                            <rect x="8" y="5" width="20" height="18" fill="white" stroke="black" stroke-width="2" />
                            <rect x="4" y="9" width="20" height="18" fill="white" stroke="black" stroke-width="2" />
                            <circle cx="14" cy="15" r="2" fill="black" />
                            <line x1="14" y1="17" x2="14" y2="21" stroke="black" stroke-width="1.5" />
                            <path d="M11 19 l6 -1" stroke="black" stroke-width="1.5" />
                            <path d="M11 25 l3 -4 l3 4" stroke="black" stroke-width="1.5" fill="none" />
                        </svg>
                    </button>

                    <button class="sys-btn" onclick="toggleAsciiPicker()" style="font-size:1.2rem; padding: 0 10px;"
                        title="ASCII Art" data-i18n-title="kindlechat.btn.ascii">â˜º</button>

                    <textarea id="msg-input" placeholder="Connecting..." data-i18n-placeholder="common.loading" rows="3"
                        disabled></textarea>
                    <button class="sys-btn" id="send-btn" onclick="sendMessage()" style="height: 100%; opacity: 0.5;"
                        disabled data-i18n="kindlechat.btn.send">Send</button>
                </div>

                <div id="locked-input" data-i18n="kindlechat.guest_hint">
                    Log in on the home screen to send messages.
                </div>
            </div>
        </div>

        <!-- GUEST OVERLAY HTML -->
        <div id="guest-overlay">
            <h2 data-i18n="kindlechat.guest_overlay">You need to be logged in to use KindleChat</h2>
            <br>
            <button class="sys-btn" onclick="window.location.href='index?login=true'"
                data-i18n="kindlechat.btn.login">Log In</button>
        </div>
    </div>

    <!-- SHARED MODAL OVERLAY -->
    <div id="modal-overlay">

        <!-- SEND DM MODAL CONTENT -->
        <div class="modal-box" id="create-modal-content">
            <h3 data-i18n="kindlechat.modal.dm.title">Send Message</h3>
            <div
                style="display: flex; align-items: stretch; width: 100%; margin: 10px 0; gap: 5px; box-sizing: border-box;">
                <input type="text" id="dm-username" class="modal-input" placeholder="Username (e.g. bob)"
                    data-i18n-placeholder="kindlechat.modal.dm.user"
                    style="flex-grow: 1; margin: 0; width: auto; font-family: inherit; font-size: 1rem; box-sizing: border-box;">
                <button
                    onclick="document.getElementById('dm-username').value='ukiyo'; document.getElementById('dm-message').focus();"
                    style="padding: 8px; background: white; border: 2px solid black; cursor: pointer; font-family: inherit; font-size: 1rem; font-weight: normal; color: black; box-sizing: border-box;">Ukiyo</button>
            </div>
            <textarea id="dm-message" class="modal-input" placeholder="Message..."
                data-i18n-placeholder="kindlechat.modal.dm.msg" style="height:60px; resize:none;"></textarea>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="sendDirectMessage()" data-i18n="kindlechat.modal.dm.send">Send</button>
                <button class="sys-btn" onclick="closeModal('modal-overlay')" data-i18n="common.cancel">Cancel</button>
            </div>
        </div>

        <!-- DELETE MODAL CONTENT -->
        <div class="modal-box" id="delete-modal-content" style="display:none;">
            <h3 data-i18n="kindlechat.modal.leave.title">Leave Chat?</h3>
            <p style="margin: 15px 0;" data-i18n="kindlechat.modal.leave.text">Remove this chat from your list?</p>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <button class="sys-btn" onclick="confirmLeaveRoom()" data-i18n="kindlechat.modal.leave.yes">Yes</button>
                <button class="sys-btn" onclick="closeModal('modal-overlay')"
                    data-i18n="kindlechat.modal.leave.no">No</button>
            </div>
        </div>

        <!-- GENERIC MESSAGE MODAL -->
        <div class="modal-box" id="generic-modal-content" style="display:none;">
            <div id="modal-message" class="modal-text"></div>
            <div id="modal-btns" class="modal-btns"></div>
        </div>

        <!-- SETTINGS MODAL CONTENT -->
        <div class="modal-box" id="settings-modal-content" style="display:none; text-align:left;">
            <h3 style="text-align:center; margin-top:0;" data-i18n="kindlechat.settings.title">Settings</h3>

            <div style="margin: 15px 0;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="setting-show-translations"
                        style="width:20px; height:20px; margin-right:10px;">
                    <span data-i18n="kindlechat.settings.trans">Show Translations</span>
                </label>
                <div style="margin-left:34px; font-size:0.8rem; color:#666;" data-i18n="kindlechat.settings.trans_desc">
                    View automatically translated messages in
                    General chat.</div>
            </div>

            <div id="admin-tools-setting" style="margin: 15px 0; display:none;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="setting-show-admin-tools"
                        style="width:20px; height:20px; margin-right:10px;">
                    <span>Show Admin Tools</span>
                </label>
                <div style="margin-left:34px; font-size:0.8rem; color:#666;">Enable Reprocess and Delete buttons.</div>
            </div>

            <div style="margin-top:20px; display:flex; justify-content:center;">
                <button class="sys-btn" onclick="saveSettings()" data-i18n="kindlechat.settings.save">Save &
                    Close</button>
            </div>
        </div>

    </div>

    <!-- NEW: REACTION SELECTION MODAL -->
    <div id="reaction-selection-modal">
        <!-- Options injected by JS -->
    </div>

    <script>
        // --- GLOBAL ERROR CATCHER ---
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            console.error('Chat Error: ' + msg + ' at ' + url + ':' + lineNo + ':' + columnNo);
            return false;
        };

        // --- FIREBASE CONFIG ---
        var firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77",
            databaseURL: "https://rekindle-dd1fa-default-rtdb.firebaseio.com/"
        };

        // --- CONFIGURATION ---
        function showModal(msg, isConfirm, callback) {
            var overlay = document.getElementById('modal-overlay');
            var messageEl = document.getElementById('modal-message');
            var btnsEl = document.getElementById('modal-btns');

            // Show generic content, hide Others
            document.getElementById('create-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'none';
            document.getElementById('create-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'none';
            document.getElementById('settings-modal-content').style.display = 'none';
            document.getElementById('generic-modal-content').style.display = 'block';

            messageEl.textContent = msg;
            if (isConfirm) {
                btnsEl.innerHTML = '<button class="modal-btn" id="modal-cancel">Cancel</button><button class="modal-btn" id="modal-ok">OK</button>';
                document.getElementById('modal-cancel').onclick = function () { overlay.style.display = 'none'; if (callback) callback(false); };
                document.getElementById('modal-ok').onclick = function () { overlay.style.display = 'none'; if (callback) callback(true); };
            } else {
                btnsEl.innerHTML = '<button class="modal-btn" onclick="hideModal()">OK</button>';
            }
            overlay.style.display = 'flex';
        }
        function hideModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        // Configure for Safari/Mac compatibility (fixes CORS errors)
        if (db.settings) {
            try {
                db.settings({
                    experimentalForceLongPolling: true,
                    merge: true
                });
            } catch (e) { console.warn("Settings error:", e); }
        }

        // Note: Persistence disabled for KindleChat due to IndexedDB hangs on some browsers

        var auth = firebase.auth();
        var rtdb = firebase.database();
        var generalChatRef = rtdb.ref('kindlechat/messages');
        var generalListener = null;

        // --- STATE ---
        var currentUser = null;
        var currentUsername = "";

        // TODO: START HERE - User must deploy cloudflare-worker.js and paste URL here
        var TRANSLATION_WORKER_URL = "https://rekindle-translate.timjarnott.workers.dev";
        // Example: "https://rekindle-chat-worker.timothyarnott.workers.dev"
        var currentRoomId = 'general';
        var isPro = false; // Pro Status
        var roomToDeleteId = null;
        var unsubscribeMsg = null;
        var unsubscribeRooms = null;
        var unsubscribeGeneral = null;
        var oldestMsgDoc = null; // For pagination
        var oldestGeneralTimestamp = null; // For RTDB pagination
        var isLoadingMore = false; // For pagination
        var supporterUsers = {}; // Store supporter usernames as object for ES5 compatibility
        var userRooms = [];
        var userRooms = [];
        var userRooms = [];
        var generalRoom = { id: 'general', name: window.t('kindlechat.room.general', 'All of KindleChat'), lastMessageAt: null };

        // --- SETTINGS ---
        var userLang = localStorage.getItem('rekindle_language') || (navigator.language ? navigator.language.split('-')[0] : 'en');
        var settings = {
            showTranslations: userLang === 'en', // Default to true only for English
            showAdminTools: false
        };

        // --- SPAM PROTECTION FOR GENERAL CHANNEL ---
        var GENERAL_MSG_WINDOW = 50; // Check last 50 messages
        var GENERAL_MAX_USER_MSGS = 15; // Max messages from one user in that window (~30%)
        var recentGeneralMsgUsers = []; // Track usernames of recent messages in general channel

        // --- Reaction Keys (use new SVG-based keys) ---
        var FONT_REACTIONS = ['rekindle', 'thumbsup', 'thumbsdown', 'heart', 'question', 'exclaim', 'laugh'];

        // --- ASCII ART DATA ---
        // Moved to emojis.js (ASCII_EMOJIS)

        // --- INIT ---
        window.onload = function () {
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            if (window.rekindleApplyDefaultFullscreen) window.rekindleApplyDefaultFullscreen();
            initAsciiPicker(); // Initialize the ASCII picker
            if (window.rekindleApplyWallpaper) window.rekindleApplyWallpaper();
            if (window.rekindleApplyDefaultFullscreen) window.rekindleApplyDefaultFullscreen();
            initAsciiPicker(); // Initialize the ASCII picker
            loadSettings(); // Load user preferences
            fetchSupporters(); // Load supporters list

            // Check Auth
            auth.onAuthStateChanged(function (user) {
                if (user) {
                    currentUser = user;
                    currentUsername = (user.email || user.uid).split('@')[0];

                    // Check Pro Status (shared with other apps)
                    isPro = (localStorage.getItem('rekindle_is_pro') !== 'false');
                    const cachedExpiry = localStorage.getItem('rekindle_pro_expiry');
                    if (cachedExpiry && parseInt(cachedExpiry) > Date.now()) {
                        isPro = true;
                    }

                    document.getElementById('active-input').style.display = 'flex';
                    document.getElementById('locked-input').style.display = 'none';

                    // Run cleanup in background (non-blocking)
                    cleanupEmptyChats();
                    loadRooms();

                    // DEEP LINK: Open DM if requested
                    var params = new URLSearchParams(window.location.search);
                    var chatWithUid = params.get('chat_with_uid');
                    var chatWithName = params.get('name') || params.get('chat_with');

                    if (chatWithUid && chatWithUid !== currentUser.uid) {
                        // OPTIMIZED: Try O(1) fetch with deterministic Room ID
                        var uids = [currentUser.uid, chatWithUid].sort();
                        var roomId = "dm_" + uids[0] + "_" + uids[1];

                        db.collection('rooms').doc(roomId).get().then(function (doc) {
                            if (doc.exists) {
                                switchRoom(roomId, chatWithName || "Chat");
                                window.history.replaceState({}, document.title, window.location.pathname);
                            } else {
                                // Fallback: Check if old-style DM exists by name
                                handleLegacyDeepLink(chatWithName, chatWithUid);
                            }
                        })['catch'](function (err) {
                            console.error("Error fetching room:", err);
                            handleLegacyDeepLink(chatWithName, chatWithUid);
                        });
                    } else if (chatWithName && chatWithName !== currentUsername) {
                        handleLegacyDeepLink(chatWithName, null);
                    }

                    function handleLegacyDeepLink(targetName, targetUid) {
                        if (!targetName) return;
                        db.collection('rooms')
                            .where('participants', 'array-contains', currentUsername)
                            .where('type', '==', 'dm')
                            .get()
                            .then(function (snapshot) {
                                var foundRoomId = null;
                                snapshot.forEach(function (doc) {
                                    var data = doc.data();
                                    if (data.participants.includes(targetName)) {
                                        foundRoomId = doc.id;
                                    }
                                });

                                if (foundRoomId) {
                                    switchRoom(foundRoomId, targetName);
                                } else if (targetUid) {
                                    // NO existing room found: Create new DM with deterministic ID
                                    var uids = [currentUser.uid, targetUid].sort();
                                    var newRoomId = "dm_" + uids[0] + "_" + uids[1];
                                    db.collection('rooms').doc(newRoomId).set({
                                        type: 'dm',
                                        participants: [currentUsername, targetName],
                                        participantUids: [currentUser.uid, targetUid],
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                                    }).then(function () {
                                        switchRoom(newRoomId, targetName);
                                    });
                                }
                                window.history.replaceState({}, document.title, window.location.pathname);
                            })['catch'](function (err) {
                                console.error("Legacy deep link error:", err);
                            });
                    }
                } else {
                    currentUser = null;
                    document.getElementById('app-layout').style.display = 'none';
                    document.getElementById('guest-overlay').style.display = 'flex';
                }
                loadMessages();
            });

            // Enter key
            document.getElementById('msg-input').addEventListener("keypress", function (e) {
                // Shift+Enter should allow newline (for ASCII art)
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Populate the reaction modal once
            populateReactionModal();

            // Click outside close for ASCII picker & Reaction picker
            document.addEventListener('click', function (event) {
                // ASCII Picker
                var picker = document.getElementById('ascii-picker-window');
                var btn = document.querySelector('.sys-btn[onclick="toggleAsciiPicker()"]');
                if (picker && picker.classList.contains('open') &&
                    !picker.contains(event.target) &&
                    event.target !== btn) {
                    picker.classList.remove('open');
                }

                // Reaction Picker
                var reactionModal = document.getElementById('reaction-selection-modal');
                if (reactionModal && reactionModal.style.display === 'flex' && !reactionModal.contains(event.target)) {
                    closeReactionModal();
                }
            });

            // Scroll to top to load more messages
            document.getElementById('chat-history').addEventListener('scroll', handleScroll);
        };


        // --- ASCII PICKER LOGIC ---
        function initAsciiPicker() {
            var container = document.getElementById('ascii-picker-window');
            container.innerHTML = ''; // Clear previous content

            // ASCII_EMOJIS is defined in emojis.js
            if (typeof ASCII_EMOJIS !== 'undefined' && !Array.isArray(ASCII_EMOJIS)) {

                // Create Layout Containers
                var sidebar = document.createElement('div');
                sidebar.className = 'ascii-sidebar';

                var content = document.createElement('div');
                content.className = 'ascii-content';
                content.id = 'ascii-content-area';

                // APPEND ORDER: Content first, then Categories (Bottom)
                container.appendChild(content);
                container.appendChild(sidebar);

                // For ScrollSpy
                var isFirst = true;
                var autoHighlightEnabled = true; // NEW: Control flag

                // Helper to re-enable auto highlight on user interaction
                var enableAutoHighlight = function () { autoHighlightEnabled = true; };
                content.addEventListener('wheel', enableAutoHighlight);
                content.addEventListener('touchmove', enableAutoHighlight);
                content.addEventListener('keydown', enableAutoHighlight);
                content.addEventListener('mousedown', enableAutoHighlight);


                // Iterate Categories
                for (var category in ASCII_EMOJIS) {
                    if (!ASCII_EMOJIS.hasOwnProperty(category)) continue;
                    var items = ASCII_EMOJIS[category];

                    // ID Generation
                    var cleanName = category.replace(/\s+/g, '-').replace(/[&]/g, '').toLowerCase();
                    var sectionId = 'cat-' + cleanName;

                    // 1. Sidebar Item
                    var navItem = document.createElement('div');
                    navItem.className = 'ascii-sidebar-item';
                    if (isFirst) {
                        navItem.classList.add('active'); // Default active
                        isFirst = false;
                    }
                    navItem.innerText = category;
                    navItem.dataset.targetId = sectionId; // Store Link

                    navItem.onclick = (function (targetId, el) {
                        return function (e) {
                            e.stopPropagation(); // Prevent closing picker

                            // Disable auto-highlighting temporarily (until user scrolls manually)
                            autoHighlightEnabled = false;

                            // Manual activation
                            var siblings = el.parentNode.querySelectorAll('.ascii-sidebar-item');
                            for (var i = 0; i < siblings.length; i++) siblings[i].classList.remove('active');
                            el.classList.add('active');

                            // Scroll to section INSTANTLY
                            var target = document.getElementById(targetId);
                            if (target) {
                                target.scrollIntoView({ behavior: 'auto', block: 'start' });
                            }
                        };
                    })(sectionId, navItem);
                    sidebar.appendChild(navItem);

                    // 2. Content Section
                    var section = document.createElement('div');
                    section.className = 'ascii-category-section';
                    section.id = sectionId;

                    // Grid
                    var grid = document.createElement('div');
                    grid.className = 'ascii-grid';

                    // Items
                    for (var j = 0; j < items.length; j++) {
                        var item = items[j];
                        var div = document.createElement('div');
                        div.className = 'ascii-option';
                        div.innerText = item.art;
                        if (item.name) div.title = item.name;
                        div.onclick = (function (art) {
                            return function () { insertAscii(art); };
                        })(item.art);
                        grid.appendChild(div);
                    }

                    section.appendChild(grid);
                    content.appendChild(section);
                }

                // SCROLL SPY LOGIC: LINEAR INTERPOLATION
                content.addEventListener('scroll', function () {
                    if (!autoHighlightEnabled) return; // Skip if manually overridden

                    // Calculate scroll percentage (0 to 1)
                    var maxScroll = content.scrollHeight - content.clientHeight;
                    if (maxScroll <= 0) return;

                    var scrollPos = content.scrollTop;
                    var percentage = scrollPos / maxScroll;

                    // Get all sidebar items
                    var sidebarItems = sidebar.querySelectorAll('.ascii-sidebar-item');
                    var totalItems = sidebarItems.length;

                    if (totalItems === 0) return;

                    var activeIndex = Math.floor(percentage * totalItems);
                    // Clamp
                    if (activeIndex < 0) activeIndex = 0;
                    if (activeIndex >= totalItems) activeIndex = totalItems - 1;

                    // Update UI
                    for (var i = 0; i < sidebarItems.length; i++) {
                        var el = sidebarItems[i];
                        if (i === activeIndex) {
                            el.classList.add('active');
                            // Smooth scroll into view for the category name if it's outside visible sidebar
                            if (el.scrollIntoView) el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        } else {
                            el.classList.remove('active');
                        }
                    }
                });

            } else if (Array.isArray(ASCII_EMOJIS)) {
                for (var k = 0; k < ASCII_EMOJIS.length; k++) {
                    var itemArr = ASCII_EMOJIS[k];
                    var divArr = document.createElement('div');
                    divArr.className = 'ascii-option';
                    divArr.innerText = itemArr.art;
                    divArr.onclick = (function (art) {
                        return function () { insertAscii(art); };
                    })(itemArr.art);
                    container.appendChild(divArr);
                }
            }
        }



        function toggleAsciiPicker() {
            var picker = document.getElementById('ascii-picker-window');
            picker.classList.toggle('open');
        }

        function insertAscii(text) {
            var input = document.getElementById('msg-input');
            input.value += text;
            input.focus();
            toggleAsciiPicker(); // Close after selection
        }

        // --- REACTION MODAL POPULATION ---
        function populateReactionModal() {
            var modal = document.getElementById('reaction-selection-modal');
            modal.innerHTML = '';
            for (var i = 0; i < FONT_REACTIONS.length; i++) {
                var reaction = FONT_REACTIONS[i];
                var div = document.createElement('div');
                div.className = 'reaction-option';
                div.setAttribute('data-reaction', reaction);
                // Safely get reaction SVG with fallback
                var reactionDisplay = reaction;
                try {
                    if (typeof getReactionSvg === 'function') {
                        reactionDisplay = getReactionSvg(reaction);
                    }
                } catch (e) {
                    console.error('Error getting reaction SVG:', e);
                }
                div.innerHTML = reactionDisplay;
                // Click handler is attached by openReactionTarget to pass the msgId
                modal.appendChild(div);
            }
        }

        // --- ROOM LOGIC ---

        function cleanupEmptyChats() {
            if (!currentUsername) return;

            // OPTIMIZATION: Only run cleanup once every 24 hours to save reads
            var lastCleanup = localStorage.getItem('kindlechat_last_cleanup');
            var now = Date.now();
            if (lastCleanup && (now - parseInt(lastCleanup)) < 86400000) {
                console.log("Chat: Cleanup skipped (Recently performed)");
                return;
            }

            db.collection('rooms')
                .where('participants', 'array-contains', currentUsername)
                .limit(15)
                .get()
                .then(function (roomsQuery) {
                    var cleanupPromises = [];
                    roomsQuery.forEach(function (doc) {
                        var roomData = doc.data();
                        if (roomData.participants.indexOf('ukiyo') !== -1) return;

                        var messagesRef = db.collection('rooms').doc(doc.id).collection('messages');
                        var promise = messagesRef.limit(1).get().then(function (messageSnap) {
                            if (messageSnap.empty) {
                                return db.collection('rooms').doc(doc.id).update({
                                    participants: firebase.firestore.FieldValue.arrayRemove(currentUsername)
                                });
                            }
                        });
                        cleanupPromises.push(promise);
                    });
                    return Promise.all(cleanupPromises);
                })
                .then(function () {
                    localStorage.setItem('kindlechat_last_cleanup', now.toString());
                    console.log("Chat: Cleanup completed for active rooms");
                })
            ['catch'](function (e) {
                console.error("Error during empty chat cleanup:", e);
            });
        }

        function updateSidebar() {
            // Sort only user rooms by lastMessageAt descending
            userRooms.sort(function (a, b) {
                var timeA = getTimestampMillis(a.lastMessageAt);
                var timeB = getTimestampMillis(b.lastMessageAt);
                return timeB - timeA;
            });
            renderRoomList(generalRoom, userRooms);

            // Sidebar visibility logic
            var sidebar = document.getElementById('sidebar');
            var headerBtn = document.getElementById('header-new-chat-btn');

            // ALWAYS show sidebar if General exists so users can see activity/timestamps
            if (generalRoom || userRooms.length > 0) {
                sidebar.style.display = 'flex';
                headerBtn.style.display = 'none';
                document.getElementById('app-layout').style.setProperty('--sidebar-width', '252px');
            } else {
                sidebar.style.display = 'none';
                headerBtn.style.display = 'block';
                document.getElementById('app-layout').style.setProperty('--sidebar-width', '0px');
            }
        }

        // --- ROOM CACHING (localStorage) ---
        var ROOMS_CACHE_KEY = 'kindlechat_rooms_cache';

        function getCachedRooms() {
            try {
                var cached = localStorage.getItem(ROOMS_CACHE_KEY);
                if (cached) {
                    var data = JSON.parse(cached);
                    // Cache valid for 1 hour
                    if (data.timestamp && (Date.now() - data.timestamp) < 3600000) {
                        return data.rooms || [];
                    }
                }
            } catch (e) { }
            return [];
        }

        function cacheRooms(rooms) {
            try {
                localStorage.setItem(ROOMS_CACHE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    rooms: rooms.map(function (r) {
                        // Store timestamp as millis for robust serialization
                        var ts = r.lastMessageAt;
                        var tsMillis = ts ? (ts.toMillis ? ts.toMillis() : ts) : null;

                        // Also handle numeric timestamps from plain objects if previously cached
                        if (typeof ts === 'object' && ts !== null && ts.seconds) {
                            tsMillis = ts.seconds * 1000;
                        }

                        return {
                            id: r.id,
                            name: r.name,
                            type: r.type,
                            lastMessageAt: tsMillis
                        };
                    })
                }));
            } catch (e) { }
        }

        function loadRooms() {
            if (unsubscribeRooms) unsubscribeRooms();
            if (unsubscribeGeneral) unsubscribeGeneral();

            var listEl = document.getElementById('room-list');

            // Show cached rooms immediately for instant display
            var cachedRooms = getCachedRooms();
            if (cachedRooms.length > 0) {
                userRooms = cachedRooms;
                updateSidebar();
            } else {
                listEl.innerHTML = '<div style="padding:10px;">Loading...</div>';
            }

            // Listen to general room updates for timestamp
            // Listen to general room updates for timestamp (RTDB)
            var generalLastMsgRef = rtdb.ref('kindlechat/messages').orderByChild('timestamp').limitToLast(1);
            var onGeneralTimestamp = function (snapshot) {
                if (snapshot.exists()) {
                    snapshot.forEach(function (child) {
                        generalRoom.lastMessageAt = child.val().timestamp;
                    });
                }
                updateSidebar();
            };
            generalLastMsgRef.on('value', onGeneralTimestamp, function (err) {
                console.error("Chat: General RTDB snapshot error:", err);
                updateSidebar();
            });

            unsubscribeGeneral = function () {
                generalLastMsgRef.off('value', onGeneralTimestamp);
            };

            unsubscribeRooms = db.collection('rooms')
                .where('participants', 'array-contains', currentUsername)
                .onSnapshot(function (snap) {
                    userRooms = [];
                    snap.forEach(function (doc) {
                        var data = doc.data();
                        var r = {
                            id: doc.id,
                            type: data.type,
                            lastMessageAt: data.lastMessageAt || data.createdAt // Fallback
                        };

                        if (data.type === 'dm') {
                            var otherPerson = data.participants.filter(function (p) { return p !== currentUsername; })[0];
                            if (otherPerson === 'ukiyo') {
                                r.name = "Ukiyo (Developer)";
                            } else {
                                r.name = otherPerson || "Me";
                            }
                        } else {
                            r.name = data.name || "Untitled Group";
                        }
                        userRooms.push(r);
                    });

                    // Cache the fresh rooms
                    cacheRooms(userRooms);
                    updateSidebar();
                }, function (err) {
                    console.error("User rooms snapshot error:", err);
                    updateSidebar(); // Proceed anyway
                });
        }

        function renderRoomList(general, rooms) {
            var listEl = document.getElementById('room-list');
            listEl.innerHTML = '';

            // 1. Render General Room
            if (general) {
                renderRoomItem(general, listEl);
                // 2. Add Separator if there are other rooms
                if (rooms.length > 0) {
                    var sep = document.createElement('div');
                    sep.className = 'sidebar-separator';
                    listEl.appendChild(sep);
                }
            }

            // 3. Render Other Rooms
            for (var i = 0; i < rooms.length; i++) {
                renderRoomItem(rooms[i], listEl);
            }
        }

        function renderRoomItem(room, listEl) {
            var div = document.createElement('div');
            div.className = 'room-item' + (room.id === currentRoomId ? ' active' : '');

            var deleteHtml = '';
            if (room.id !== 'general') {
                deleteHtml = '<span class="del-room-btn" onclick="promptLeaveRoom(\'' + room.id + '\', event)">Ã—</span>';
            }

            var timeStr = formatChatTime(room.lastMessageAt);

            div.innerHTML = '<div class="room-top"><span>' + room.name + '</span>' + deleteHtml + '</div>' +
                '<div class="room-time">' + timeStr + '</div>';
            div.onclick = function () { switchRoom(room.id, room.name); };
            listEl.appendChild(div);
        }

        function switchRoom(id, name) {
            if (currentRoomId === id) return;

            currentRoomId = id;
            document.getElementById('room-title').innerText = name;

            // Clear previous messages to prevent ghosting
            document.getElementById('chat-history').innerHTML = '';

            // Update Pixel Button Visibility (Only show in 'general')
            var pixelBtn = document.getElementById('pixel-btn');
            if (pixelBtn) {
                pixelBtn.style.display = (id === 'general') ? 'flex' : 'none';
            }
            // Update Flipbook Button Visibility (Only show in 'general')
            var flipbookBtn = document.getElementById('flipbook-btn');
            if (flipbookBtn) {
                flipbookBtn.style.display = (id === 'general') ? 'flex' : 'none';
            }

            loadMessages();
            updateSidebar(); // Refresh highlighting
        }

        // --- MESSAGE LOGIC (with pagination) ---

        function handleScroll() {
            var historyEl = document.getElementById('chat-history');
            if (historyEl.scrollTop <= 50 && !isLoadingMore) {

                // BRANCH: General Chat (RTDB)
                if (currentRoomId === 'general') {
                    if (oldestGeneralTimestamp) {
                        loadMoreGeneralFromRTDB(historyEl);
                    }
                    return;
                }

                // BRANCH: Firestore DMs
                if (oldestMsgDoc) {
                    isLoadingMore = true;
                    var oldScrollHeight = historyEl.scrollHeight;

                    db.collection('rooms').doc(currentRoomId).collection('messages')
                        .orderBy('timestamp', 'desc')
                        .startAfter(oldestMsgDoc)
                        .limit(25)
                        .get()
                        .then(function (querySnapshot) {
                            if (!querySnapshot.empty) {
                                oldestMsgDoc = querySnapshot.docs[querySnapshot.docs.length - 1]; // New oldest message

                                querySnapshot.docs.forEach(function (doc) {
                                    renderMessage(doc.data(), doc.id, true); // Prepend messages
                                });

                                // Restore scroll position
                                historyEl.scrollTop = historyEl.scrollHeight - oldScrollHeight;
                            }
                        })
                    ['catch'](function (e) {
                        console.error("Error loading more messages:", e);
                    })
                        .then(function () {
                            isLoadingMore = false;
                        });
                }
            }
        }

        // --- NEW: Load More for General Chat (RTDB) ---
        function loadMoreGeneralFromRTDB(historyEl) {
            isLoadingMore = true;
            var oldScrollHeight = historyEl.scrollHeight;

            // Fetch older messages ending before the current oldest timestamp
            // Using logic: endAt(oldest - 1) to avoid duplicate of the boundary message
            generalChatRef.orderByChild('timestamp').endAt(oldestGeneralTimestamp - 0.001).limitToLast(25).once('value')
                .then(function (snapshot) {
                    if (snapshot.exists()) {
                        var messages = [];
                        snapshot.forEach(function (child) {
                            messages.push({ id: child.key, data: child.val() });
                        });

                        // RTDB returns in ascending order, so the first is the new oldest
                        if (messages.length > 0) {
                            oldestGeneralTimestamp = messages[0].data.timestamp;

                            // Render pre-pended (iteration order is oldest to newest)
                            // We need to render them and ensure they end up at the top.
                            // renderMessage handles placement, but we need to pass 'prepend' = true.
                            // ALSO: renderMessage inserts before firstChild. 
                            // To keep order correct when prepending a BATCH (which is sorted asc), 
                            // we should append them to a fragment or prepend them in REVERSE order.

                            // Example: Batch [A, B, C] (A is oldest). Current history: [D, E, F].
                            // If we prepend A, then B, then C -> C, B, A, D, E, F (Wrong order for batch)
                            // We need A, B, C, D, E, F. 
                            // So we must prepend C, then B, then A.

                            // Iterate backwards
                            for (var i = messages.length - 1; i >= 0; i--) {
                                renderMessage(messages[i].data, messages[i].id, true);
                            }

                            // Restore Scroll
                            historyEl.scrollTop = historyEl.scrollHeight - oldScrollHeight;
                        }
                    }
                    isLoadingMore = false;
                })
            ['catch'](function (e) {
                console.error("Error loading more general messages:", e);
                isLoadingMore = false;
            });
        }

        // --- MESSAGE CACHING (localStorage) ---
        var MSG_CACHE_PREFIX = 'kindlechat_msg_';
        var MAX_CACHED_MESSAGES = 50;

        function getMessageCacheKey(roomId) {
            return MSG_CACHE_PREFIX + roomId;
        }

        function getCachedMessages(roomId) {
            try {
                var cached = localStorage.getItem(getMessageCacheKey(roomId));
                if (cached) {
                    var data = JSON.parse(cached);
                    return data.messages || [];
                }
            } catch (e) { }
            return [];
        }

        function getLastCachedTimestamp(roomId) {
            try {
                var cached = localStorage.getItem(getMessageCacheKey(roomId));
                if (cached) {
                    var data = JSON.parse(cached);
                    return data.lastTimestamp || null;
                }
            } catch (e) { }
            return null;
        }

        function cacheMessages(roomId, messages, lastTimestamp) {
            try {
                // Only keep last N messages
                var toCache = messages.slice(-MAX_CACHED_MESSAGES);
                localStorage.setItem(getMessageCacheKey(roomId), JSON.stringify({
                    lastTimestamp: lastTimestamp,
                    messages: toCache
                }));
            } catch (e) { }
        }

        function addMessageToCache(roomId, msgData, msgId) {
            try {
                var cached = getCachedMessages(roomId);
                // Avoid duplicates
                var exists = cached.some(function (m) { return m.id === msgId; });
                if (!exists) {
                    cached.push({ id: msgId, data: msgData });
                    // Keep only last N
                    if (cached.length > MAX_CACHED_MESSAGES) {
                        cached = cached.slice(-MAX_CACHED_MESSAGES);
                    }
                    var ts = msgData.timestamp ? (msgData.timestamp.toMillis ? msgData.timestamp.toMillis() : msgData.timestamp) : Date.now();
                    localStorage.setItem(getMessageCacheKey(roomId), JSON.stringify({
                        lastTimestamp: ts,
                        messages: cached
                    }));
                }
            } catch (e) { }
        }

        // --- UI HELPERS ---
        function setChatInputEnabled(enabled) {
            var input = document.getElementById('msg-input');
            var btn = document.getElementById('send-btn');
            if (input) input.disabled = !enabled;
            if (btn) btn.disabled = !enabled;

            // Visual feedback
            if (enabled) {
                if (btn) btn.style.opacity = '1';
                if (input) input.placeholder = "Type a message...";
            } else {
                if (btn) btn.style.opacity = '0.5';
                if (input) input.placeholder = "Connecting...";
            }
        }

        function loadMessages() {
            // Update Title to Loading
            var titleEl = document.querySelector('.title-text');
            if (titleEl) titleEl.innerText = 'Loading...';

            // Cleanup previous listeners
            if (unsubscribeMsg) unsubscribeMsg();
            if (generalListener) {
                generalListener.off();
                generalListener = null;
            }
            oldestMsgDoc = null;
            oldestGeneralTimestamp = null;
            isLoadingMore = false;

            // Disable input while loading
            setChatInputEnabled(false);

            var history = document.getElementById('chat-history');
            var roomId = currentRoomId;

            // BRANCH: Use Realtime Database for general channel
            if (roomId === 'general') {
                loadGeneralFromRTDB(history);
                return;
            }

            // --- DMs: Continue with Firestore ---
            // Show cached messages immediately
            var cachedMsgs = getCachedMessages(roomId);
            if (cachedMsgs.length > 0) {
                history.innerHTML = '';
                cachedMsgs.forEach(function (m) {
                    renderMessage(m.data, m.id);
                });
                history.scrollTop = history.scrollHeight;
            } else if (history.children.length === 0) {
                history.innerHTML = '<div style="text-align:center; padding:20px">Connecting...</div>';
            }

            // SMART SYNC: Use limitToLast(50) to get recent messages
            // The real-time listener will catch modifications (reactions) to these messages
            var lastCachedTs = getLastCachedTimestamp(roomId);
            var query = db.collection('rooms').doc(roomId).collection('messages').orderBy('timestamp', 'asc');
            var isSmartSync = false;

            if (lastCachedTs && cachedMsgs.length > 0) {
                var startDate = new Date(lastCachedTs);
                if (!isNaN(startDate.getTime())) {
                    // Use limitToLast instead of startAfter to catch modifications to recent messages
                    query = query.limitToLast(50);
                    isSmartSync = true;
                    console.log("Smart Sync: Fetching last 50 with real-time updates");
                } else {
                    query = query.limitToLast(50);
                }
            } else {
                query = query.limitToLast(50);
            }

            unsubscribeMsg = query.onSnapshot(function (snapshot) {
                // Restore Title
                var titleEl = document.querySelector('.title-text');
                if (titleEl) titleEl.innerText = 'KindleChat';

                // Connection successful - enable input
                setChatInputEnabled(true);

                // Remove loading indicator if present
                if (history.innerHTML.indexOf('Connecting...') !== -1) {
                    history.innerHTML = '';
                }

                if (snapshot.empty && history.innerHTML === '') {
                    history.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No messages yet.</div>';
                }

                var isScrolledToBottom = history.scrollHeight - history.clientHeight <= history.scrollTop + 100;
                var allMessages = [];

                snapshot.docChanges().forEach(function (change) {
                    if (change.type === 'added' || change.type === 'modified') {
                        var msgData = change.doc.data();
                        var msgId = change.doc.id;
                        renderMessage(msgData, msgId);
                        allMessages.push({ id: msgId, data: msgData });
                    }
                });

                // Cache messages for next load
                if (snapshot.docs.length > 0) {
                    var lastDoc = snapshot.docs[snapshot.docs.length - 1];
                    var lastTsData = lastDoc.data().timestamp;
                    var newLastTs = lastTsData ? (lastTsData.toMillis ? lastTsData.toMillis() : lastTsData) : Date.now();

                    var newMsgs = snapshot.docs.map(function (doc) {
                        return { id: doc.id, data: doc.data() };
                    });

                    // Merge new messages with existing cache
                    var currentCache = getCachedMessages(roomId);
                    var merged = currentCache;

                    newMsgs.forEach(function (nm) {
                        // Update or Append
                        var idx = merged.findIndex(function (cm) { return cm.id === nm.id; });
                        if (idx !== -1) {
                            merged[idx] = nm;
                        } else {
                            merged.push(nm);
                        }
                    });

                    cacheMessages(roomId, merged, newLastTs);
                }

                if (isScrolledToBottom) {
                    history.scrollTop = history.scrollHeight;
                }

                if (snapshot.docs.length > 0) {
                    oldestMsgDoc = snapshot.docs[0];
                }

            }, function (error) {
                var titleEl = document.querySelector('.title-text');
                if (titleEl) titleEl.innerText = 'KindleChat';
                console.error("Error loading messages:", error);
                history.innerHTML = '<div style="text-align:center; padding:20px;">Error connecting.</div>';
            });
        }

        // --- GENERAL CHANNEL: Realtime Database ---
        function loadGeneralFromRTDB(history) {
            history.innerHTML = '<div style="text-align:center; padding:20px">Connecting...</div>';

            // Query last 50 messages ordered by timestamp
            generalListener = generalChatRef.orderByChild('timestamp').limitToLast(50);

            generalListener.on('value', function (snapshot) {
                // Restore title and enable input
                var titleEl = document.querySelector('.title-text');
                if (titleEl) titleEl.innerText = 'KindleChat';
                setChatInputEnabled(true);

                history.innerHTML = '';

                if (!snapshot.exists()) {
                    history.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No messages yet.</div>';
                    return;
                }

                var isScrolledToBottom = history.scrollHeight - history.clientHeight <= history.scrollTop + 100;
                recentGeneralMsgUsers = []; // Reset for spam protection

                // Convert snapshot to array and sort by timestamp
                var messages = [];
                snapshot.forEach(function (child) {
                    messages.push({ id: child.key, data: child.val() });
                });

                // Track oldest timestamp for pagination
                if (messages.length > 0) {
                    // Since iteration is in order (oldest to newest), the first one is the oldest
                    oldestGeneralTimestamp = messages[0].data.timestamp;
                }

                // Render each message
                messages.forEach(function (msg) {
                    renderMessage(msg.data, msg.id);
                    // Track for spam protection
                    if (msg.data.user) {
                        recentGeneralMsgUsers.push(msg.data.user);
                    }
                });

                // Keep only last GENERAL_MSG_WINDOW for spam protection
                if (recentGeneralMsgUsers.length > GENERAL_MSG_WINDOW) {
                    recentGeneralMsgUsers = recentGeneralMsgUsers.slice(-GENERAL_MSG_WINDOW);
                }

                if (isScrolledToBottom) {
                    history.scrollTop = history.scrollHeight;
                }
            }, function (error) {
                var titleEl = document.querySelector('.title-text');
                if (titleEl) titleEl.innerText = 'KindleChat';
                console.error("Error loading general messages:", error);
                history.innerHTML = '<div style="text-align:center; padding:20px;">Error connecting.</div>';
            });
        }


        var profanityRegex = null;
        function getProfanityRegex() {
            if (profanityRegex) return profanityRegex;
            if (typeof BAD_WORDS === 'undefined') return null;

            // Create regex once from the BAD_WORDS array
            var escaped = BAD_WORDS.filter(function (w) { return w; }).map(function (w) { return w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); });
            profanityRegex = new RegExp('\\b(' + escaped.join('|') + ')\\b', 'gi');
            return profanityRegex;
        }

        function censorText(text) {
            var regex = getProfanityRegex();
            if (!regex) return text;
            return text.replace(regex, function (match) {
                var stars = '';
                for (var i = 0; i < match.length; i++) stars += '*';
                return stars;
            });
        }

        function linkify(inputText) {
            var replacedText, replacePattern1, replacePattern2;

            // URLs starting with http://, https://, or ftp://
            replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

            // URLs starting with "www." (without // before it)
            replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

            return replacedText;
        }

        function renderMessage(msg, msgId, prepend) {
            var history = document.getElementById('chat-history');
            var div = document.createElement('div');
            var toggleBtnHtml = '';

            var isSelf = currentUser && (msg.user === currentUsername);
            div.className = 'msg ' + (isSelf ? 'self' : 'other');
            div.dataset.msgId = msgId;
            div.dataset.user = msg.user;

            var isSelf = currentUser && (msg.user === currentUsername);
            div.className = 'msg ' + (isSelf ? 'self' : 'other');
            div.dataset.msgId = msgId;
            div.dataset.user = msg.user;

            var nameHtml = isSelf ? '<span>' + window.t('kindlechat.msg.you', 'You') + '</span>' : '<span style="font-weight:bold;">' + msg.user + '</span>';

            // Developer Badge in Name
            var isDev = (msg.user === 'ukiyo' || msg.user === 'ukiyo@rekindle.ink');
            if (isDev) {
                var devBadge = '<span class="dev-tag">DEV</span>';
                nameHtml = isSelf ? '<span>' + devBadge + window.t('kindlechat.msg.you', 'You') + '</span>' : '<span>' + devBadge + '<span style="font-weight:bold;">' + msg.user + '</span></span>';
            } else if (supporterUsers[msg.user] || msg.isPro) {
                // Supporter Crown (SVG for Kindle compatibility)
                var crownSvg = '<svg class="supporter-crown" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2 4L5 18H19L22 4L15 11L12 4L9 11L2 4Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>';
                var crown = '<a href="http://link.rekindle.ink/donate" target="_blank" style="text-decoration:none;" title="Supporter">' + crownSvg + '</a>';
                nameHtml = isSelf ? '<span>' + crown + window.t('kindlechat.msg.you', 'You') + '</span>' : '<span>' + crown + '<span style="font-weight:bold;">' + msg.user + '</span></span>';
            }

            // ADMIN DELETE BUTTON - REMOVED (Handled in adminControlsHtml below)
            var delBtnHtml = '';

            // TRANSLATE BUTTON (On-Demand)
            // Show for everyone. Simple text button.
            // Escape single quotes in text for the function call
            var safeText = msg.text ? msg.text.replace(/'/g, "\\'") : "";
            var trLabel = window.t('kindlechat.btn.translate', 'Tr');
            var transBtnHtml = ' <button class="tr-btn" onclick="translateMessage(\'' + msgId + '\', \'' + safeText + '\')" style="margin-left:5px; background:none; border:none; cursor:pointer; font-size:0.7rem; color:#666; padding:0;">[' + trLabel + ']</button>';

            var timeStr = "";
            if (msg.timestamp) {
                var date;
                // Handle various timestamp formats (Firestore object vs Cached JSON)
                if (msg.timestamp.toDate && typeof msg.timestamp.toDate === 'function') {
                    date = msg.timestamp.toDate();
                } else if (msg.timestamp.seconds) {
                    // Serialized Firestore timestamp
                    date = new Date(msg.timestamp.seconds * 1000);
                } else {
                    // Millis or Date string
                    date = new Date(msg.timestamp);
                }
                timeStr = formatZonedTime(date);
            }

            // ADMIN CONTROLS (Delete + Reprocess)
            var adminControlsHtml = '';
            if (currentUser && currentUsername === 'ukiyo') {
                if (settings.showAdminTools) {
                    // Escape single quotes in text for the function call
                    var safeText = msg.text ? msg.text.replace(/'/g, "\\'") : "";

                    // Calculate positioning for Reprocess button (further out than Delete/React)
                    var posStyle = isSelf ? 'left: -75px; right: auto;' : 'right: -75px; left: auto;';

                    // Reprocess Button
                    if (currentRoomId === 'general') {
                        adminControlsHtml += '<div class="del-btn" style="' + posStyle + ' color: blue; border-color: blue;" onclick="reprocessMessage(\'' + msgId + '\', \'' + safeText + '\')" title="Reprocess Translation">Rp</div>';
                    }

                    // Delete Button (Shifted further left if reprocess is present)
                    // Actually, let's stack them or put them side by side? 
                    // To keep it simple, let's use the existing absolute positioning logic but offset them.
                    // The CSS below defines .del-btn. Let's make a specific class or inline style overrides.

                    // Standard Delete Button
                    adminControlsHtml += '<div class="del-btn" onclick="deleteGeneralMessage(\'' + msgId + '\')">âœ•</div>';
                }
            }

            var bubbleContent = '';
            var isSpecialMessage = false;
            var messageText = msg.text || '';

            // Censor Profanity Logic
            var censorProfanity = localStorage.getItem('rekindle_censor_profanity');
            if (messageText && (censorProfanity === null || censorProfanity === 'true')) {
                messageText = censorText(messageText);
            }

            // ASCII Art detection
            var isAscii = messageText.indexOf('\n') !== -1;

            if (isAscii) {
                bubbleContent = '<div class="msg-bubble ascii">' + escapeHtml(messageText) + '</div>';
                isSpecialMessage = true;
            } else if (msg.is_reaction_image) {
                bubbleContent = '<div class="msg-bubble ascii">' + messageText + '</div>';
                isSpecialMessage = true;
            } else if (msg.is_game_link) {
                var parts = msg.text.split(':');
                var gameType = parts[0];
                var gameId = parts[1];
                var gameName = gameType.charAt(0).toUpperCase() + gameType.slice(1);
                var isStarter = msg.user === currentUsername;

                var displayMsg = '';
                if (gameType === 'words') {
                    // displayMsg = msg.user + ' started a Scrabble Game\n' + (isStarter ? 'Wait for a player to join!' : 'Click to Join!');
                    var line1 = window.t('kindlechat.game.started', '{{user}} started a {{game}} Game').replace('{{user}}', msg.user).replace('{{game}}', 'Scrabble');
                    var line2 = isStarter ? window.t('kindlechat.game.wait', 'Wait for a player to join!') : window.t('kindlechat.game.join', 'Click to Join!');
                    displayMsg = line1 + '\n' + line2;
                } else {
                    // displayMsg = 'New ' + gameName + ' Game Ready!\nClick to Join!';
                    displayMsg = window.t('kindlechat.game.ready', 'New {{game}} Game Ready!\nClick to Join!').replace('{{game}}', gameName);
                }

                var linkDestination = isStarter && gameType === 'words' ? '#' : gameType + '.html?gameId=' + gameId;
                var containerClass = isStarter && gameType === 'words' ? 'game-link-container disabled' : 'game-link-container';

                bubbleContent = '<div class="msg-bubble game-link-bubble">' +
                    '<div class="' + containerClass + '">' +
                    '<a href="' + linkDestination + '" class="game-link" ' + (isStarter && gameType === 'words' ? 'onclick="event.preventDefault()"' : '') + '>' +
                    displayMsg +
                    '</a></div></div>';
                isSpecialMessage = true;
            } else if (msg.is_flipnote && msg.flipnote_data) {
                // Register data for playback
                window.flipnoteData = window.flipnoteData || {};
                window.flipnoteData[msgId] = msg.flipnote_data;

                var thumb = (msg.flipnote_data.frames && msg.flipnote_data.frames[0]) ? msg.flipnote_data.frames[0] : '';

                bubbleContent = '<div class="msg-bubble" style="padding: 5px; background: white; text-align:center;">' +
                    '<a href="flipbook?source=kindlechat" style="font-weight:bold; margin-bottom:5px; font-size:0.8rem; display:block; text-decoration:none; color:black;">' + window.t('kindlechat.art.flipbook', 'Flipbook') + '</a>' +
                    '<div id="flipnote-view-' + msgId + '" style="width:128px; height:128px; border:2px solid black; margin:0 auto; background:white; position:relative; cursor:pointer;" onclick="playFlipnote(\'' + msgId + '\')">' +
                    '<img id="flipnote-img-' + msgId + '" src="' + thumb + '" style="width:100%; height:100%; image-rendering:pixelated; display:block;">' +
                    '<div id="flipnote-overlay-' + msgId + '" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.1); font-size:2rem; color:white; text-shadow:1px 1px 0 black;">â–¶</div>' +
                    '</div>' +
                    ((messageText && messageText !== 'undefined' && messageText !== 'null') ? ('<div style="margin-top:5px; font-size:0.9rem;">' + escapeHtml(messageText) + '</div>') : '') +
                    '</div>';
                isSpecialMessage = true;
            } else if (msg.is_pixel_art) {
                bubbleContent = '<div class="msg-bubble" style="padding: 5px; background: white;">' +
                    '<a href="pixel?source=kindlechat" style="font-weight:bold; margin-bottom:5px; font-size:0.8rem; display:block; text-decoration:none; color:black;">' + window.t('kindlechat.art.pixel', 'Pixel Art') + '</a>' +
                    '<img src="' + msg.pixel_art + '" style="' +
                    'image-rendering: -webkit-optimize-contrast; ' +
                    'image-rendering: crisp-edges; ' +
                    'image-rendering: pixelated; ' +
                    'width: 128px; ' +
                    'height: 128px; ' +
                    'border: 2px solid black; ' +
                    'display:block;' +
                    '">' +
                    (messageText ? '<div style="margin-top:5px; font-size:0.9rem;">' + escapeHtml(messageText) + '</div>' : '') +
                    '</div>';
                isSpecialMessage = true;
            } else {
                // DEFAULT / TEXT MESSAGE
                var textToDisplay = escapeHtml(messageText);
                var isTranslated = false;

                // SERVER-SIDE TRANSLATION DISPLAY
                var toggleBtnHtml = '';
                if (settings.showTranslations && msg.translation) {
                    textToDisplay = linkify(escapeHtml(msg.translation));
                    // Tagify translation too? Maybe not purely necessary but consistent. Let's tagify it.
                    textToDisplay = tagify(textToDisplay, msgId);

                    toggleBtnHtml = ' <span id="toggle-' + msgId + '" onclick="toggleTranslation(\'' + msgId + '\')" style="font-size:0.7rem; color:#666; text-decoration:underline; cursor:pointer; margin-left: 5px;">' + window.t('kindlechat.msg.show_original', 'Show Original') + '</span>';

                    // We also need to tagify the original text stored in data-original??? 
                    // No, data-original is raw html escaped. When restored, we run linkify/tagify on it?
                    // The toggleTranslation function currently does: bubble.innerHTML = linkify(originalText);
                    // It should also do tagify.

                    // Store escaped original text
                    bubbleContent = '<div id="bubble-' + msgId + '" class="msg-bubble" data-state="translated" data-original="' + escapeHtml(messageText) + '" data-translated="' + escapeHtml(msg.translation) + '">' + textToDisplay + '</div>';
                } else {
                    bubbleContent = '<div class="msg-bubble">' + tagify(linkify(textToDisplay), msgId) + '</div>';
                }
            }

            // Theme Injection
            var isDev = (msg.user === 'ukiyo' || msg.user === 'ukiyo@rekindle.ink');
            if (isDev) {
                bubbleContent = bubbleContent.replace('class="msg-bubble', 'class="msg-bubble developer');
            } else if (supporterUsers[msg.user] || msg.isPro) {
                bubbleContent = bubbleContent.replace('class="msg-bubble', 'class="msg-bubble supporter');
            }

            var reactButton = (currentUser && (!isSpecialMessage || msg.is_pixel_art))
                ? '<div class="react-btn" onclick="openReactionTarget(\'' + msgId + '\', this, event)">+</div>'
                : '';

            // TRANSLATION BUTTON (Client-side fallback) - REMOVED
            // TRANSLATION BUTTON (Client-side fallback) - REMOVED for special messages
            var transBtnHtml = (isSpecialMessage || msg.is_pixel_art) ? '' : toggleBtnHtml;

            div.innerHTML = '<div class="msg-meta">' + nameHtml + '<span>' + timeStr + '</span>' + transBtnHtml + '</div>' +
                '<div style="display:flex; align-items:center; gap: 5px; min-width: 0;">' +
                (isSelf ? reactButton + adminControlsHtml : '') +
                bubbleContent +
                (isSelf ? '' : reactButton + adminControlsHtml) +
                '</div>';

            if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                var reactionBar = document.createElement('div');
                reactionBar.className = 'reaction-bar' + (isSelf ? ' self-bar' : ' other-bar');

                var groupedReactions = {};
                for (var userUID in msg.reactions) {
                    var val = msg.reactions[userUID];
                    var reactionKey, displayName;

                    if (typeof val === 'object' && val !== null) {
                        reactionKey = val.reaction;
                        displayName = val.username || userUID;
                    } else {
                        reactionKey = val;
                        displayName = userUID.split('@')[0];
                    }

                    if (!groupedReactions[reactionKey]) groupedReactions[reactionKey] = [];
                    groupedReactions[reactionKey].push(displayName);
                }

                for (var reactionKey in groupedReactions) {
                    var count = groupedReactions[reactionKey].length;
                    var el = document.createElement('div');
                    el.className = 'reaction-item';
                    el.title = groupedReactions[reactionKey].join(', ');
                    // Safely get reaction SVG with fallback
                    var reactionDisplay = reactionKey;
                    try {
                        if (typeof getReactionSvg === 'function') {
                            reactionDisplay = getReactionSvg(reactionKey);
                        }
                    } catch (e) {
                        console.error('Error getting reaction SVG:', e);
                    }
                    el.innerHTML = reactionDisplay + ' ' + count;
                    el.onclick = (function (r) { return function (e) { toggleUserReaction(msgId, r, e); }; })(reactionKey);
                    reactionBar.appendChild(el);
                }
                if (reactionBar.children.length > 0) {
                    div.appendChild(reactionBar);
                }
            }

            var existing = history.querySelector('.msg[data-msg-id="' + msgId + '"]');

            if (existing) {
                history.replaceChild(div, existing);
            } else if (prepend) {
                history.insertBefore(div, history.firstChild);
            } else {
                history.appendChild(div);
            }

            if (msg.is_flipnote && msg.flipnote_data) {
                setTimeout(function () { playFlipnote(msgId); }, 200);
            }
        }

        function canUserSend(chatHistory, currentUserId) {
            // 1. CONFIGURATION
            const MAX_SCORE = 3.0;      // If user's score > 3, block them.
            const DECAY_RATE = 0.05;    // How much 'less' an older message counts.
            const SCAN_DEPTH = 50;      // Look at up to 50 messages.

            let score = 0;

            // 2. SAFETY CHECK (If chat is empty, let them send)
            if (!chatHistory || chatHistory.length === 0) return true;

            // 3. CALCULATE SCORE
            // Assumes chatHistory[0] is the MOST RECENT message
            const limit = Math.min(chatHistory.length, SCAN_DEPTH);

            for (let i = 0; i < limit; i++) {
                // Only count messages from this specific user
                if (chatHistory[i].userId === currentUserId) {

                    // Calculate weight: 1.0, 0.95, 0.90, etc.
                    let weight = 1.0 - (i * DECAY_RATE);

                    // If weight drops to 0 or below, we stop counting
                    if (weight <= 0) break;

                    score += weight;
                }
            }

            console.log(`User Score: ${score.toFixed(2)} / ${MAX_SCORE}`);

            // 4. VERDICT
            return score < MAX_SCORE;
        }

        function sendMessage() {
            var inputEl = document.getElementById('msg-input');
            var text = inputEl.value.trim();

            if (!text) return;
            if (!currentUser) return;

            // SPAM PROTECTION: Check if user is dominating the general channel
            if (currentRoomId === 'general') {
                // Construct history for algorithm (Newest is index 0)
                var historyForAlgo = recentGeneralMsgUsers.slice().reverse().map(function (u) { return { userId: u }; });

                if (!canUserSend(historyForAlgo, currentUsername)) {
                    showModal('To ensure a good experience for everyone, please slow down. You\'ve been posting a lot recently.', false);
                    return;
                }
            }

            inputEl.value = '';

            // BRANCH: Use Realtime Database via Worker (for translation) or direct
            if (currentRoomId === 'general') {
                if (TRANSLATION_WORKER_URL) {
                    sendGeneralMessageViaWorker(text);
                } else {
                    sendGeneralMessageToRTDB(text);
                }
            } else {
                sendDMToFirestore(text);
            }
        }

        // --- SETTINGS LOGIC ---
        function openSettingsModal() {
            var overlay = document.getElementById('modal-overlay');
            // Reset modal states
            document.getElementById('create-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'none';
            document.getElementById('generic-modal-content').style.display = 'none';

            var settingsModal = document.getElementById('settings-modal-content');
            settingsModal.style.display = 'block';

            // Populate Checkboxes
            document.getElementById('setting-show-translations').checked = settings.showTranslations;

            // Toggle Admin Tools Visibility
            var adminToolsDiv = document.getElementById('admin-tools-setting');
            if (currentUsername === 'ukiyo') {
                adminToolsDiv.style.display = 'block';
                document.getElementById('setting-show-admin-tools').checked = settings.showAdminTools;
            } else {
                adminToolsDiv.style.display = 'none';
            }

            overlay.style.display = 'flex';
        }

        function saveSettings() {
            settings.showTranslations = document.getElementById('setting-show-translations').checked;

            if (currentUsername === 'ukiyo') {
                settings.showAdminTools = document.getElementById('setting-show-admin-tools').checked;
            }

            localStorage.setItem('kindlechat_settings', JSON.stringify(settings));

            // Reload messages to apply changes
            loadMessages();

            hideModal();
        }

        function loadSettings() {
            var saved = localStorage.getItem('kindlechat_settings');
            if (saved) {
                try {
                    var parsed = JSON.parse(saved);
                    settings.showTranslations = parsed.showTranslations !== undefined ? parsed.showTranslations : settings.showTranslations;
                    settings.showAdminTools = parsed.showAdminTools !== undefined ? parsed.showAdminTools : false;
                } catch (e) { }
            }
        }

        // --- ADMIN ACTIONS ---
        function reprocessMessage(msgId, text) {
            if (!currentUser) return;

            // Visual feedback?
            console.log("Reprocessing message:", msgId);

            currentUser.getIdToken().then(function (token) {
                fetch(TRANSLATION_WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        user: currentUsername,
                        text: text,
                        msgId: msgId,
                        reprocess: true
                    })
                })
                    .then(function (resp) { return resp.json(); })
                    .then(function (data) {
                        if (data.success) {
                            console.log("Reprocess success:", data);
                            // No need to reload, RTDB listener will update the translation
                        } else {
                            console.error("Reprocess error:", data);
                            showModal("Reprocess failed: " + (data.error || "Unknown error"));
                        }
                    })
                ['catch'](function (err) {
                    console.error("Reprocess network error:", err);
                    showModal("Network error during reprocess.");
                });
            });
        }

        function deleteGeneralMessage(msgId) {
            if (!currentUser) return;
            if (currentRoomId === 'general') {
                if (confirm("Permanently delete this message?")) {
                    rtdb.ref('kindlechat/messages/' + msgId).remove()
                    ['catch'](function (e) {
                        showModal("Delete failed: " + e.message);
                    });
                }
            }
        }

        // --- GENERAL CHANNEL: Send via Worker ---
        function sendGeneralMessageViaWorker(text) {
            if (!currentUser) {
                console.error("Cannot send message: Not authenticated");
                sendGeneralMessageToRTDB(text);
                return;
            }

            currentUser.getIdToken().then(function (token) {
                fetch(TRANSLATION_WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        user: currentUsername,
                        text: text,
                        isPro: isPro
                    })
                })
                    .then(function (res) {
                        if (!res.ok) throw new Error("Worker Error " + res.status);
                        return res.json();
                    })
                    .then(function (data) {
                        if (data.translationError) {
                            console.warn("Translation Worker Report:", data.translationError);
                        }
                        return data;
                    })
                ['catch'](function (err) {
                    console.error("Worker failed, falling back to direct write:", err);
                    sendGeneralMessageToRTDB(text);
                });
            })['catch'](function (err) {
                console.error("Could not get auth token:", err);
                sendGeneralMessageToRTDB(text);
            });
        }

        // --- GENERAL CHANNEL: Send to Realtime Database (Direct/Fallback) ---
        function sendGeneralMessageToRTDB(text) {
            var messageData = {
                user: currentUsername,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                text: text,
                isPro: isPro
            };

            generalChatRef.push(messageData)['catch'](function (e) {
                console.error("Error sending general message:", e);
            });
        }

        // --- DMs: Send to Firestore ---
        function sendDMToFirestore(text) {
            var messageData = {
                user: currentUsername,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                text: text,
                isPro: isPro
            };

            var roomRef = db.collection('rooms').doc(currentRoomId);

            // Add the message first
            roomRef.collection('messages').add(messageData)
                .then(function () {
                    // Update room activity
                    return roomRef.set({
                        lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                })
                .then(function () {
                    // Then, check if we need to "activate" the room for other users
                    return roomRef.get();
                })
                .then(function (roomDoc) {
                    if (roomDoc.exists) {
                        var roomData = roomDoc.data();
                        // If it's a DM that hasn't been activated yet
                        if (roomData.type === 'dm' && roomData.intendedParticipants && roomData.participants.length < roomData.intendedParticipants.length) {
                            // Add all intended participants to the main participants list
                            return roomRef.update({
                                participants: roomData.intendedParticipants
                            });
                        }
                    }
                })
            ['catch'](function (e) {
                console.error("Error sending message:", e);
            });
        }

        // --- REACTION FUNCTIONS ---

        // Global tracker for currently open reaction menu
        var activeReactionMsgId = null;

        function openReactionTarget(msgId, btnElement, event) {
            event.stopPropagation();
            if (!currentUser) return;

            var modal = document.getElementById('reaction-selection-modal');

            // TOGGLE LOGIC: If clicking the same button while open, close it.
            if (modal.style.display === 'flex' && activeReactionMsgId === msgId) {
                closeReactionModal();
                return;
            }

            activeReactionMsgId = msgId;

            var rect = btnElement.getBoundingClientRect();

            // Position the modal near the button
            modal.style.top = rect.top + 'px';

            // Adjust X position based on whether it's a self or other message
            var isSelf = btnElement.parentNode.parentNode.className.indexOf('self') !== -1;

            // If self (button on left), position modal to the right of the button
            if (isSelf) {
                modal.style.left = (rect.right + 5) + 'px';
                modal.style.right = 'auto';
            } else {
                // If other (button on right), position modal to the left of the button
                modal.style.left = (rect.left - 130) + 'px'; // Estimate width - adjustment
                modal.style.right = 'auto';
            }

            // Bind selection handlers to this message ID
            var options = modal.querySelectorAll('.reaction-option');
            for (var i = 0; i < options.length; i++) {
                (function (option) {
                    option.onclick = function () { selectReaction(msgId, option.getAttribute('data-reaction')); };
                })(options[i]);
            }

            modal.style.display = 'flex';
        }

        function closeReactionModal() {
            var modal = document.getElementById('reaction-selection-modal');
            if (modal) {
                modal.style.display = 'none';
                activeReactionMsgId = null;
            }
        }

        function selectReaction(msgId, reaction) {
            toggleUserReaction(msgId, reaction);
            closeReactionModal();
        }

        function toggleUserReaction(msgId, reaction, event) {
            if (!currentUser) return;

            // ADMIN: Shift+Click to delete All Reactions of this type
            if (event && event.shiftKey && currentUsername === 'ukiyo' && currentRoomId === 'general') {
                deleteGeneralReactionType(msgId, reaction);
                return;
            }

            // BRANCH: Use RTDB for general, Firestore for DMs
            if (currentRoomId === 'general') {
                toggleGeneralReactionRTDB(msgId, reaction);
            } else {
                toggleDMReactionFirestore(msgId, reaction);
            }
        }

        // --- ADMIN FUNCTIONS ---
        // (deleteGeneralMessage moved above)

        function deleteGeneralReactionType(msgId, reactionType) {
            if (!confirm("Delete ALL '" + reactionType + "' reactions?")) return;

            var reactionsRef = rtdb.ref('kindlechat/messages/' + msgId + '/reactions');
            reactionsRef.once('value').then(function (snapshot) {
                if (!snapshot.exists()) return;

                var updates = {};
                snapshot.forEach(function (child) {
                    if (child.val() === reactionType) {
                        updates[child.key] = null; // Delete
                    }
                });

                if (Object.keys(updates).length > 0) {
                    return reactionsRef.update(updates);
                }
            })['catch'](function (e) {
                console.error("Delete reaction error:", e);
            });
        }

        // --- TRANSLATION FUNCTION ---
        function toggleTranslation(msgId) {
            var bubble = document.getElementById('bubble-' + msgId);
            var toggleBtn = document.getElementById('toggle-' + msgId);
            if (!bubble || !toggleBtn) return;

            var currentState = bubble.getAttribute('data-state');
            var originalText = bubble.getAttribute('data-original');
            var translatedText = bubble.getAttribute('data-translated');

            if (currentState === 'translated') {
                // Switch to Original
                // Need to re-apply linkify AND tagify
                bubble.innerHTML = tagify(linkify(originalText), msgId);
                bubble.setAttribute('data-state', 'original');
                toggleBtn.textContent = "Show Translated";
            } else {
                // Switch back to Translated
                bubble.innerHTML = tagify(linkify(translatedText), msgId);
                bubble.setAttribute('data-state', 'translated');
                toggleBtn.textContent = "Show Original";
            }
        }

        // --- TAGGING FUNCTIONS ---
        function tagify(htmlText, msgId) {
            // Regex to match @username. 
            // We use a negative lookbehind or simple boundary check.
            // Be careful not to break HTML attributes (like href from linkify).
            // A simple approach: match @username that is preceded by start-of-line or whitespace/tags
            // and followed by non-word char.
            return htmlText.replace(/(^|\s|>|&nbsp;)@([a-zA-Z0-9_]+)/g, function (match, prefix, username) {
                return prefix + '<span class="user-tag" onclick="scrollToLastUserMessage(\'' + username + '\', \'' + msgId + '\')">@' + username + '</span>';
            });
        }

        function scrollToLastUserMessage(targetUser, currentMsgId) {
            // Stop propagation not needed if we are careful, but good practice if bubble had click
            if (window.event) window.event.stopPropagation();

            var allMsgs = Array.from(document.querySelectorAll('.msg'));
            // Find index of current message
            var currentIdx = allMsgs.findIndex(function (m) { return m.dataset.msgId === currentMsgId; });

            if (currentIdx <= 0) {
                // alert("No previous messages found."); 
                return;
            }

            // Search backwards
            for (var i = currentIdx - 1; i >= 0; i--) {
                if (allMsgs[i].dataset.user === targetUser) {
                    var targetMsg = allMsgs[i];
                    targetMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Visual feedback (flash border)
                    var bubble = targetMsg.querySelector('.msg-bubble');
                    if (bubble) {
                        var originalBorder = bubble.style.borderColor;
                        var originalShadow = bubble.style.boxShadow;

                        bubble.style.borderColor = 'black';
                        bubble.style.boxShadow = '0 0 10px yellow'; // Highlight

                        setTimeout(function () {
                            bubble.style.borderColor = originalBorder;
                            bubble.style.boxShadow = originalShadow;
                        }, 1500);
                    }
                    return;
                }
            }
            // If not found
            // If not found
            showModal("No previous messages found from @" + targetUser + " in loaded history.", false);
        }

        // LEGACY: Old translateMessage removed.


        // --- SETTINGS LOGIC (Moved above) ---

        // --- GENERAL CHANNEL: Toggle reaction in Realtime Database ---
        function toggleGeneralReactionRTDB(msgId, reaction) {
            var userUID = currentUser.uid;
            var reactionRef = rtdb.ref('kindlechat/messages/' + msgId + '/reactions/' + userUID);
            var msgRef = rtdb.ref('kindlechat/messages/' + msgId);

            // Get current reaction first
            reactionRef.once('value').then(function (snapshot) {
                var val = snapshot.val();
                var currentReaction = (typeof val === 'object' && val !== null) ? val.reaction : val;

                if (currentReaction === reaction) {
                    // REMOVE: User clicks same reaction
                    return reactionRef.remove();
                } else {
                    // ADD/CHANGE
                    return reactionRef.set({ reaction: reaction, username: currentUsername });
                }
            }).then(function () {
                // RTDB listener will auto-update the UI, but let's re-fetch and render immediately for responsiveness
                msgRef.once('value').then(function (snap) {
                    if (snap.exists()) {
                        renderMessage(snap.val(), msgId);
                    }
                });
            })['catch'](function (e) {
                console.error("Error toggling general reaction:", e);
            });
        }

        // --- DMs: Toggle reaction in Firestore ---
        function toggleDMReactionFirestore(msgId, reaction) {
            var messageRef = db.collection('rooms').doc(currentRoomId).collection('messages').doc(msgId);
            var userUID = currentUser.uid;

            messageRef.get().then(function (doc) {
                if (!doc.exists) return;

                var msgData = doc.data();
                var reactions = msgData.reactions || {};
                var val = reactions[userUID];
                var userReaction = (typeof val === 'object' && val !== null) ? val.reaction : val;

                if (userReaction === reaction) {
                    // REMOVE: User clicks the reaction they already left
                    delete reactions[userUID];
                    var updates = {};
                    updates["reactions." + userUID] = firebase.firestore.FieldValue.delete();
                    messageRef.update(updates);
                } else {
                    // ADD/CHANGE
                    reactions[userUID] = { reaction: reaction, username: currentUsername };
                    messageRef.update({ reactions: reactions });
                }

                // UPDATE LOCAL CACHE with new reactions
                updateCachedMessageReactions(currentRoomId, msgId, reactions);

                // Re-render the message immediately with updated reactions
                msgData.reactions = reactions;
                renderMessage(msgData, msgId);

            })['catch'](function (e) {
                console.error("Error toggling reaction:", e);
            });
        }

        // Helper function to update reactions in cache (for DMs only)
        function updateCachedMessageReactions(roomId, msgId, newReactions) {
            try {
                var cached = getCachedMessages(roomId);
                for (var i = 0; i < cached.length; i++) {
                    if (cached[i].id === msgId) {
                        cached[i].data.reactions = newReactions;
                        break;
                    }
                }
                var lastTs = getLastCachedTimestamp(roomId) || Date.now();
                cacheMessages(roomId, cached, lastTs);
            } catch (e) {
                console.error("Error updating cache:", e);
            }
        }

        // --- MODAL LOGIC ---
        function openCreateModal() {
            if (!currentUser) return showModal("Please log in first.");
            document.getElementById('generic-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'none';
            document.getElementById('create-modal-content').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal(id) {
            if (!id) id = 'modal-overlay';
            document.getElementById(id).style.display = 'none';
        }

        // --- NEW: SEND DIRECT MESSAGE LOGIC ---
        function sendDirectMessage() {
            var usernameInput = document.getElementById('dm-username').value.trim();
            var messageInput = document.getElementById('dm-message').value.trim();

            if (!usernameInput) return showModal("Please enter a username.");
            if (!messageInput) return showModal("Please enter a message.");

            closeModal(); // Close modal immediately

            var otherUser = usernameInput;
            var participants = [currentUsername, otherUser].sort();

            // Check if DM exists
            db.collection('rooms')
                .where('participants', 'array-contains', currentUsername)
                .where('type', '==', 'dm')
                .get()
                .then(function (roomsSnap) {
                    var existingRoomId = null;
                    roomsSnap.forEach(function (doc) {
                        var data = doc.data();
                        if (data.participants.length === 2 && data.participants.indexOf(otherUser) !== -1) {
                            existingRoomId = doc.id;
                        }
                    });

                    if (existingRoomId) {
                        switchRoom(existingRoomId, otherUser);
                    } else {
                        // Create new DM
                        var newRoomRef;
                        db.collection('rooms').add({
                            type: 'dm',
                            participants: [currentUsername],
                            intendedParticipants: participants,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                        })
                            .then(function (ref) {
                                newRoomRef = ref;
                                return newRoomRef.collection('messages').add({
                                    user: currentUsername,
                                    text: messageInput,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            })
                            .then(function () {
                                return newRoomRef.update({ participants: participants });
                            })
                            .then(function () {
                                switchRoom(newRoomRef.id, otherUser);
                            })
                        ['catch'](function (e) {
                            console.error("Error creating DM:", e);
                            showModal("Error creating DM.");
                        });
                    }
                })
            ['catch'](function (e) {
                console.error("Error sending DM:", e);
                showModal("Error starting chat.");
            });
        }

        // --- FLIPNOTE PLAYER ---
        function playFlipnote(msgId) {
            if (!window.flipnoteData || !window.flipnoteData[msgId]) return;

            var data = window.flipnoteData[msgId];
            var frames = data.frames;
            var fps = data.fps || 6;
            if (!frames || frames.length === 0) return;

            var imgEl = document.getElementById('flipnote-img-' + msgId);
            var overlay = document.getElementById('flipnote-overlay-' + msgId);

            if (!imgEl || !overlay) return;

            if (imgEl.dataset.playing === "true") {
                // Stop
                imgEl.dataset.playing = "false";
                overlay.style.display = "flex";
                if (imgEl.playTimer) clearTimeout(imgEl.playTimer);
                imgEl.src = frames[0]; // Reset to first frame
                return;
            }

            // Start
            imgEl.dataset.playing = "true";
            overlay.style.display = "none";

            var frameIdx = 0;

            function loop() {
                if (imgEl.dataset.playing !== "true") return;
                frameIdx = (frameIdx + 1) % frames.length;
                imgEl.src = frames[frameIdx];
                imgEl.playTimer = setTimeout(loop, 1000 / fps);
            }

            loop();
        }

        // --- SUPPORTER LOGIC ---
        function fetchSupporters() {
            db.collection('config').doc('supporters').get().then(function (doc) {
                if (doc.exists) {
                    var data = doc.data();
                    supporterUsers = {};
                    // Handle new map format and legacy array format
                    if (data.usernames && Array.isArray(data.usernames)) {
                        for (var i = 0; i < data.usernames.length; i++) {
                            supporterUsers[data.usernames[i]] = true;
                        }
                    } else {
                        // Map format: keys are usernames
                        for (var key in data) {
                            if (key !== 'usernames' && key !== 'list') {
                                supporterUsers[key] = true;
                            }
                        }
                    }
                }
            })['catch'](function (e) {
                console.error("Error loading supporters:", e);
            });
        }


        // --- LEAVE ROOM ---
        function promptLeaveRoom(roomId, event) {
            event.stopPropagation();
            roomToDeleteId = roomId;
            document.getElementById('generic-modal-content').style.display = 'none';
            document.getElementById('create-modal-content').style.display = 'none';
            document.getElementById('delete-modal-content').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function confirmLeaveRoom() {
            if (!roomToDeleteId) return;

            db.collection('rooms').doc(roomToDeleteId).update({
                participants: firebase.firestore.FieldValue.arrayRemove(currentUsername)
            })
                .then(function () {
                    if (currentRoomId === roomToDeleteId) {
                        switchRoom('general', 'All of KindleChat');
                    }
                    closeModal();
                })
            ['catch'](function (e) {
                console.error("Error leaving chat:", e);
                closeModal();
            });
        }

        // Helper to handle escaping for text display within message bubbles
        function escapeHtml(text) {
            if (!text) return "";
            var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        function formatChatTime(timestamp) {
            if (!timestamp) return "";
            try {
                var date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds ? timestamp.seconds * 1000 : timestamp);
                if (isNaN(date.getTime())) return "";

                // Use Shared Helper
                var now = window.rekindleGetZonedDate(new Date());
                var zonedDate = window.rekindleGetZonedDate(date);

                // Diff logic (robust way)
                // Set both to noon to compare just dates roughly
                var nowNoon = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0);
                var zonedNoon = new Date(zonedDate.getFullYear(), zonedDate.getMonth(), zonedDate.getDate(), 12, 0, 0);
                var diffDays = Math.round((nowNoon - zonedNoon) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    // Same day: Show Time
                    return window.rekindleFormatTime(date, { hour: 'numeric', minute: '2-digit', hour12: true });
                } else if (diffDays < 7 && diffDays > 0) {
                    // Within week: Show Day Name + Time
                    return window.rekindleFormatTime(date, { weekday: 'short', hour: 'numeric', minute: '2-digit', hour12: true });
                } else {
                    // Older: Show Date
                    return window.rekindleFormatTime(date, { month: 'short', day: 'numeric' });
                }
            } catch (e) {
                console.error(e);
                return "";
            }
        }

        // --- TIMEZONE HELPERS (Delegated to theme.js) ---
        // Legacy functions removed or mapped to shared logic if strict dependency exists
        // But we replaced usage in formatChatTime, so we can remove them.


        function getTimestampMillis(ts) {
            if (!ts) return 0;
            try {
                if (typeof ts.toMillis === 'function') return ts.toMillis();
                if (ts.seconds) return ts.seconds * 1000;
                if (ts instanceof Date) return ts.getTime();
                if (typeof ts === 'number') return ts;
            } catch (e) { }
            return 0;
        }

        // Fix for missing formatZonedTime
        function formatZonedTime(date) {
            return window.rekindleFormatTime(date, { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function toggleFullScreen() {
            document.querySelector('.window').classList.toggle('fullscreen');
        }

    </script>

    <script>

    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="4e551911-0e5d-4c48-91a6-b828c3301675"
        data-utcoffset="11"></script>
    <!-- Duplicate Modal Removed -->
    <script>
        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js')
                    .then(function (registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, function (err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>