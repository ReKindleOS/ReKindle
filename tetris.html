<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blocks</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* SYSTEM 7 AESTHETICS */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border: 2px solid #000000;
            --shadow: 4px 4px 0px #000000;
            --stripe-pattern: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px, #000 4px);
        }

        body {
            image-rendering: -webkit-crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-repeat: repeat;
            background-position: top left;

            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #e5e5e5;
            /* Background managed by settings */
            
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-sizing: border-box;
            touch-action: none;
        }

        /* WINDOW FRAME */
        .window {
            background: white;
            border: 2px solid black;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: fit-content;
            max-height: 95vh;
            width: 95%;
            max-width: 500px;
            position: relative;
        }

        /* TITLE BAR */
        .title-bar {
            height: 35px;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 0 10px;
            position: relative;
            flex-shrink: 0;
        }

        .title-stripes {
            position: absolute;
            top: 4px; bottom: 4px; left: 4px; right: 4px;
            background-image: var(--stripe-pattern);
            z-index: 0;
        }

        .title-text {
            background: white;
            padding: 0 15px;
            font-weight: bold;
            z-index: 1;
            font-size: 1.1rem;
        }

        .close-box {
            position: absolute;
            left: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid black;
            background: white;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.9rem;
            line-height: 1;
            box-shadow: 2px 2px 0 black;
        }

        .close-box:active {
            background: black;
            color: white;
            transform: translate(1px, 1px);
            box-shadow: none;
        }
        
        /* LEADERBOARD BUTTON */
        .leaderboard-btn {
            position: absolute;
            right: 10px;
            z-index: 2;
            cursor: pointer;
            background: white;
            border: 2px solid black;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 2px 2px 0 black;
            font-family: inherit;
            text-transform: uppercase;
        }

        .leaderboard-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        /* GAME CONTENT */
        .window-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
        }

        #tetris {
            border: 4px solid black;
            background-color: #fff;
            display: block;
        }

        /* SCORE BOARD */
        .score-board {
            display: flex;
            justify-content: space-between;
            width: 240px;
            margin-bottom: 10px;
            font-family: "Courier New", monospace;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .high-score-label {
            text-align: right;
        }

        /* CONTROLS */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
        }

        .ctrl-btn {
            aspect-ratio: 1.5/1;
            background: white;
            border: 2px solid black;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 3px 3px 0 black;
            border-radius: 6px;
        }

        .ctrl-btn:active {
            background: black;
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .btn-drop {
            grid-column: 2;
            font-size: 1rem;
            text-transform: uppercase;
        }

        .btn-rotate {
            grid-column: 2;
            grid-row: 1;
        }

        /* MODALS */
        #game-over, #leaderboard-modal, #start-game-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 4px double black;
            padding: 20px;
            text-align: center;
            display: none;
            z-index: 10;
            width: 80%;
            max-width: 300px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
        }

        .sys-btn {
            background: white;
            border: 2px solid black;
            padding: 5px 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 black;
            margin-top: 10px;
        }
        
        .sys-btn:active {
            background: black;
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }
        
        /* Leaderboard List */
        .lb-list {
            text-align: left;
            margin-top: 10px;
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
        }
        
        .lb-row {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-family: "Courier New", monospace;
        }
        
        .lb-row.me {
            background: black;
            color: white;
        }

    </style>
    <script src="theme.js"></script>
</head>
<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-stripes"></div>
            <div class="close-box" onclick="window.location.href='index'">X</div>
            <span class="title-text">Blocks</span>
            <button class="leaderboard-btn" onclick="openLeaderboard()">Leaderboard</button>
        </div>

        <div class="window-content">
            <div class="score-board">
                <span>Score: <span id="score">0</span></span>
                <span class="high-score-label">High: <span id="high-score">0</span></span>
            </div>

            <canvas id="tetris" width="240" height="400"></canvas>

            <div class="controls">
                <div></div>
                <div class="ctrl-btn btn-rotate" onclick="playerRotate(1)">↻</div>
                <div></div>
                
                <div class="ctrl-btn" onclick="playerMove(-1)">←</div>
                <div class="ctrl-btn btn-drop" onclick="playerDrop()">Drop</div>
                <div class="ctrl-btn" onclick="playerMove(1)">→</div>
            </div>
        </div>

        <div id="game-over">
            <h2>GAME OVER</h2>
            <p>Score: <span id="final-score">0</span></p>
            <button class="sys-btn" onclick="playerReset()">Retry</button>
        </div>

        <div id="start-game-modal" style="display: block;">
            <h2>Ready to Play?</h2>
            <!-- Button is disabled until initGame is fully complete -->
            <button class="sys-btn" onclick="startGame()" disabled>Loading...</button>
        </div>

        <div id="leaderboard-modal">
            <h3>Top Scores</h3>
            <div class="lb-list" id="lb-content">
                Loading...
            </div>
            <button class="sys-btn" onclick="document.getElementById('leaderboard-modal').style.display='none'">Close</button>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDY7x7vVmlYUyVZNLuCCmIQYa6PWFVfZqQ",
            authDomain: "rekindle-dd1fa.firebaseapp.com",
            projectId: "rekindle-dd1fa",
            storageBucket: "rekindle-dd1fa.firebasestorage.app",
            messagingSenderId: "748026882518",
            appId: "1:748026882518:web:6877dd4329318070c11c77"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // if already initialized, use that one
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // User Data
        let uid = null;
        let username = "Guest";
        let personalHighScore = 0;

        // --- TETRIS SETUP ---
        let canvas, context, scoreElement, highScoreElement, gameOverModal, finalScoreElement;


        const PIECES = 'ILJOTSZ';

        function createPiece(type) {
            if (type === 'I') return [[0, 1, 0, 0],[0, 1, 0, 0],[0, 1, 0, 0],[0, 1, 0, 0]];
            if (type === 'L') return [[0, 2, 0],[0, 2, 0],[0, 2, 2]];
            if (type === 'J') return [[0, 3, 0],[0, 3, 0],[3, 3, 0]];
            if (type === 'O') return [[4, 4],[4, 4]];
            if (type === 'Z') return [[5, 5, 0],[0, 5, 5],[0, 0, 0]];
            if (type === 'S') return [[0, 6, 6],[6, 6, 0],[0, 0, 0]];
            if (type === 'T') return [[0, 7, 0],[7, 7, 7],[0, 0, 0]];
        }

        const arena = createMatrix(12, 20);

        const player = {
            pos: {x: 0, y: 0},
            matrix: null,
            score: 0,
        };

        let dropCounter = 0;
        let dropInterval = 1000;
        let lastTime = 0;
        let isPaused = false;

        // --- INIT ---
        window.addEventListener('pageshow', function(event) {
            initializePage();
        });

        function initializePage() {
            // FIX: Check for existing user immediately, don't rely only on the listener.
            // This prevents a race condition when restoring from bfcache.
            const onAuthReady = new Promise((resolve) => {
                if (auth.currentUser) {
                    uid = auth.currentUser.uid;
                    username = auth.currentUser.email.split('@')[0];
                    return resolve();
                }
                const unsubscribe = auth.onAuthStateChanged(user => {
                    if (user) {
                        uid = user.uid;
                        username = user.email.split('@')[0];
                    }
                    unsubscribe();
                    return resolve();
                });
            });

            onAuthReady.then(() => {
                initGame(); // Initialize the game only after auth is confirmed.
            });
        };

        function initGame() {
            canvas = document.getElementById('tetris'); // Assign canvas element first
            context = canvas.getContext('2d');
            scoreElement = document.getElementById('score');
            highScoreElement = document.getElementById('high-score');
            gameOverModal = document.getElementById('game-over');
            finalScoreElement = document.getElementById('final-score');
            context.scale(20, 20);
            loadWallpaper();
            // Load high score and only then enable the start button.
            loadPersonalHighScore().then(() => {
                const startButton = document.querySelector('#start-game-modal .sys-btn');
                startButton.disabled = false;
                startButton.innerText = "Start Game";
            });
        }

        function startGame() {
            document.getElementById('start-game-modal').style.display = 'none';
            playerReset();
            update();
        }


        // --- HIGHSCORE LOGIC ---
        async function loadPersonalHighScore() {
            const localHigh = localStorage.getItem('tetris_high_score');
            if (localHigh) personalHighScore = parseInt(localHigh);
            
            if (uid) {
                try {
                    const doc = await db.collection('leaderboard_tetris').doc(uid).get();
                    if (doc.exists) {
                        const cloudHigh = doc.data().score;
                        if (cloudHigh > personalHighScore) {
                            personalHighScore = cloudHigh;
                            localStorage.setItem('tetris_high_score', cloudHigh);
                        }
                    }
                } catch(e) { console.error(e); }
            }
            
            highScoreElement.innerText = personalHighScore;
        }

        async function saveHighScore(newScore) {
            if (newScore > personalHighScore) {
                personalHighScore = newScore;
                highScoreElement.innerText = personalHighScore;
                localStorage.setItem('tetris_high_score', personalHighScore);
                
                // Save to Cloud
                if (uid) {
                    db.collection('leaderboard_tetris').doc(uid).set({
                        username: username,
                        score: newScore,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }
        }

        // Helper to prevent XSS from usernames in the database
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        // --- LEADERBOARD LOGIC ---
        async function openLeaderboard() {
            const modal = document.getElementById('leaderboard-modal');
            modal.style.display = 'block';
            const list = document.getElementById('lb-content');
            list.innerHTML = 'Loading...'; // Set loading state on open

            const user = auth.currentUser;
            if (user) {
                try {
                    const snapshot = await db.collection('leaderboard_tetris')
                        .orderBy('score', 'desc')
                        .limit(10)
                        .get();
                    
                    list.innerHTML = '';
                    let rank = 1;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const isMe = (doc.id === user.uid);
                        const div = document.createElement('div');
                        div.className = `lb-row ${isMe ? 'me' : ''}`;

                        const rankSpan = document.createElement('span');
                        rankSpan.textContent = `${rank}. ${escapeHtml(data.username)}`;
                        const scoreSpan = document.createElement('span');
                        scoreSpan.textContent = data.score;

                        div.appendChild(rankSpan);
                        div.appendChild(scoreSpan);
                        list.appendChild(div);
                        rank++;
                    });
                } catch(e) {
                    console.error("Error loading leaderboard:", e);
                    list.innerHTML = "Error loading scores.";
                }
            } else {
                list.innerHTML = "Log in to see global scores.";
            }
        }

        // --- GAME CORE ---
        function createMatrix(w, h) {
            const matrix = [];
            while (h--) {
                matrix.push(new Array(w).fill(0));
            }
            return matrix;
        }

        function collide(arena, player) {
            const m = player.matrix;
            const o = player.pos;
            for (let y = 0; y < m.length; ++y) {
                for (let x = 0; x < m[y].length; ++x) {
                    if (m[y][x] !== 0 &&
                       (arena[y + o.y] &&
                        arena[y + o.y][x + o.x]) !== 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        function draw() {
            context.fillStyle = '#fff'; 
            context.fillRect(0, 0, canvas.width, canvas.height);
            drawMatrix(arena, {x: 0, y: 0});
            drawMatrix(player.matrix, player.pos);
        }

        function drawMatrix(matrix, offset) {
            matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        context.fillStyle = '#000';
                        context.fillRect(x + offset.x, y + offset.y, 1, 1);
                        context.lineWidth = 0.1;
                        context.strokeStyle = '#fff';
                        context.strokeRect(x + offset.x, y + offset.y, 1, 1);
                    }
                });
            });
        }

        function merge(arena, player) {
            player.matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        arena[y + player.pos.y][x + player.pos.x] = value;
                    }
                });
            });
        }

        function rotate(matrix, dir) {
            for (let y = 0; y < matrix.length; ++y) {
                for (let x = 0; x < y; ++x) {
                    [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
                }
            }
            if (dir > 0) {
                matrix.forEach(row => row.reverse());
            } else {
                matrix.reverse();
            }
        }

        function playerDrop() {
            player.pos.y++;
            if (collide(arena, player)) {
                player.pos.y--;
                merge(arena, player);
                playerReset();
                arenaSweep();
                updateScore();
            }
            dropCounter = 0;
        }

        function playerMove(dir) {
            player.pos.x += dir;
            if (collide(arena, player)) {
                player.pos.x -= dir;
            }
        }

        function playerRotate(dir) {
            const pos = player.pos.x;
            let offset = 1;
            rotate(player.matrix, dir);
            while (collide(arena, player)) {
                player.pos.x += offset;
                offset = -(offset + (offset > 0 ? 1 : -1));
                if (offset > player.matrix[0].length) {
                    rotate(player.matrix, -dir);
                    player.pos.x = pos;
                    return;
                }
            }
        }

        function playerReset() {
            const pieces = 'ILJOTSZ';
            player.matrix = createPiece(pieces[pieces.length * Math.random() | 0]);
            player.pos.y = 0;
            player.pos.x = (arena[0].length / 2 | 0) - (player.matrix[0].length / 2 | 0);
            
            if (collide(arena, player)) {
                // Game Over
                isPaused = true;
                saveHighScore(player.score); 
                gameOverModal.style.display = 'block';
                finalScoreElement.innerText = player.score;
            } else {
                if(isPaused) {
                    isPaused = false;
                    gameOverModal.style.display = 'none';
                    if (gameOverModal.style.display === 'block' || player.score > 0) { 
                        arena.forEach(row => row.fill(0));
                        player.score = 0;
                        updateScore();
                    }
                    update();
                }
            }
        }

        function arenaSweep() {
            let rowCount = 1;
            outer: for (let y = arena.length - 1; y > 0; --y) {
                for (let x = 0; x < arena[y].length; ++x) {
                    if (arena[y][x] === 0) {
                        continue outer;
                    }
                }
                const row = arena.splice(y, 1)[0].fill(0);
                arena.unshift(row);
                ++y;
                player.score += rowCount * 10;
                rowCount *= 2;
            }
        }

        function update(time = 0) {
            if (isPaused) return;
            const deltaTime = time - lastTime;
            lastTime = time;
            dropCounter += deltaTime;
            if (dropCounter > dropInterval) {
                playerDrop();
            }
            draw();
            requestAnimationFrame(update);
        }

        function updateScore() {
            scoreElement.innerText = player.score;
        }

    </script>

    <script>
        // Helper to sanitize background image URLs from localStorage
        function sanitizeBackgroundImage(imageString) {
            if (!imageString) return '';
            if (imageString.startsWith('url("data:image/png;base64,')) {
                return imageString;
            }
            if (imageString.startsWith('url("') && imageString.endsWith('")')) {
                const url = imageString.substring(5, imageString.length - 2);
                if ((url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) && !url.includes('javascript:')) {
                    return imageString;
                }
            }
            return '';
        }

        
        loadWallpaper();

        function loadWallpaper() {
            const wallpaperImg = localStorage.getItem('rekindle_bg_image');
            const wallpaperSize = localStorage.getItem('rekindle_bg_size');
            if (wallpaperImg) {
                document.body.style.backgroundImage = wallpaperImg;
            }
            if (wallpaperSize) {
                document.body.style.backgroundSize = wallpaperSize;
            }
        }
    </script>
</body>
</html>